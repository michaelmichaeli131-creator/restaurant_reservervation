<% layout("_layout", it) %>

<%
  const restaurant = it.restaurant || {};
  const openTables = it.openTables || [];
  const rid = it.rid;
%>

<main class="waiter container">
  <header class="waiter-header">
    <div>
      <h1>××¡×š ××œ×¦×¨×™× â€” <%= restaurant.name %></h1>
      <p class="muted"><%= restaurant.city %> â€¢ <%= restaurant.address %></p>
    </div>
  </header>

  <section class="waiter-grid">
    <!-- ×›×¨×˜×™×¡×™×™×ª ×©×•×œ×—× ×•×ª ×¤×ª×•×—×™× -->
    <div class="panel card">
      <h2>×©×•×œ×—× ×•×ª ×¤×ª×•×—×™×</h2>

      <% if (openTables.length) { %>
        <ul class="list" id="open-tables-list">
          <% openTables.forEach(function(t){ 
              const tn = Number(t.tableNumber);
              const guestName = t.guestName || t.name || t.customerName || "â€”";
              const people = t.people || t.guests || t.covers || null;
              const time = t.time || t.startTime || "";
              // ğŸ”— ×§×™×©×•×¨ ×œ××¡×š ×”×”×–×× ×”:
              // 1) ×× ×”×©×¨×ª ×›×‘×¨ ×©×œ×— url/posUrl/href â€“ × ×©×ª××© ×‘×•
              // 2) ××—×¨×ª fallback ×œ××¡×œ×•×œ ×”×™×©×Ÿ ×‘×¡×’× ×•×Ÿ /pos/:rid?table=:tn
              const posUrl = t.posUrl || t.url || t.href || `/pos/${rid}?table=${tn}`;
          %>
            <li
              class="open-table-row"
              data-table="<%= tn %>"
              data-pos-url="<%= posUrl %>"
              data-guest="<%= guestName %>"
              data-people="<%= people || '' %>"
              data-time="<%= time || '' %>"
            >
              <div class="row-main">
                <div class="row-title">
                  <span class="badge">×©×•×œ×—×Ÿ <%= tn %></span>
                  <strong class="guest-name"><%= guestName %></strong>
                </div>
                <div class="row-meta small muted">
                  <% if (people) { %>
                    <span><%= people %> ×¡×•×¢×“×™×</span>
                    <span>â€¢</span>
                  <% } %>
                  <% if (time) { %>
                    <span>×”×–×× ×” ×œ×©×¢×” <%= time %></span>
                  <% } %>
                </div>
              </div>
              <div class="row-actions">
                <button type="button" class="btn ghost xs js-go-pos">
                  ×”××©×š ×”×–×× ×”
                </button>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="muted">××™×Ÿ ×›×¨×’×¢ ×©×•×œ×—× ×•×ª ×¤×ª×•×—×™×.</p>
      <% } %>
    </div>

    <!-- ×›×¨×˜×™×¡×™×™×ª ××¤×ª ××¡×¢×“×” -->
    <div class="panel card waiter-floor-panel">
      <div class="panel-header">
        <div>
          <h2>××¤×ª ×”××¡×¢×“×” (×—×™)</h2>
          <p class="muted small">
            ×œ×—×™×¦×” ×¢×œ ×©×•×œ×—×Ÿ ×¤× ×•×™ ×ª×¤×ª×— ×”×–×× ×” ×—×“×©×”. ×œ×—×™×¦×” ×¢×œ ×©×•×œ×—×Ÿ ×ª×¤×•×¡ ×ª×¦×™×’ ×¤×¨×˜×™ ×©×•×œ×—×Ÿ.
          </p>
        </div>
      </div>

      <div class="waiter-layout">
        <div id="floor" class="floor-wrapper">
          <!-- ×”××¤×” ×ª×™×˜×¢×Ÿ ×“×™× ××™×ª ×¢"×™ JS -->
        </div>

        <!-- ×›×¨×˜×™×¡×™×™×ª ×¦×“: ×¤×¨×˜×™ ×©×•×œ×—×Ÿ -->
        <aside id="table-details" class="table-details hidden">
          <button type="button" class="details-close" id="details-close-btn" aria-label="×¡×’×™×¨×ª ×¤×¨×˜×™ ×©×•×œ×—×Ÿ">
            âœ•
          </button>
          <div class="details-content">
            <h3 id="details-title">×¤×¨×˜×™ ×©×•×œ×—×Ÿ</h3>
            <dl class="details-list">
              <div class="details-row">
                <dt>×©×•×œ×—×Ÿ</dt>
                <dd id="details-table-num">â€”</dd>
              </div>
              <div class="details-row">
                <dt>×©× ×”×œ×§×•×—</dt>
                <dd id="details-guest-name">â€”</dd>
              </div>
              <div class="details-row">
                <dt>××¡×¤×¨ ×¡×•×¢×“×™×</dt>
                <dd id="details-people">â€”</dd>
              </div>
              <div class="details-row">
                <dt>×©×¢×ª ×”×–×× ×”</dt>
                <dd id="details-time">â€”</dd>
              </div>
              <div class="details-row">
                <dt>×¡×˜×˜×•×¡</dt>
                <dd id="details-status">â€”</dd>
              </div>
            </dl>

            <div class="details-actions">
              <button type="button" class="btn primary sm" id="details-open-pos">
                ××¢×‘×¨ ×œ××¡×š ×”×–×× ×”
              </button>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const rid = "<%= rid %>";

  const openList = document.getElementById("open-tables-list");
  const floorHolder = document.getElementById("floor");

  // side panel elements
  const detailsPanel = document.getElementById("table-details");
  const detailsCloseBtn = document.getElementById("details-close-btn");
  const detailsTableNum = document.getElementById("details-table-num");
  const detailsGuestName = document.getElementById("details-guest-name");
  const detailsPeople = document.getElementById("details-people");
  const detailsTime = document.getElementById("details-time");
  const detailsStatus = document.getElementById("details-status");
  const detailsOpenPos = document.getElementById("details-open-pos");

  const sideState = {
    currentTable: null,
    currentPosUrl: "",
    currentStatus: "",
  };

  // ---------- ×¢×–×¨ ×œ×¤×ª×™×—×ª ××¡×š POS ----------
  function goToPos(url){
    if (!url) {
      alert("×œ× ×”×•×’×“×¨ ×§×™×©×•×¨ ×œ××¡×š ×”×”×–×× ×” ×¢×‘×•×¨ ×©×•×œ×—×Ÿ ×–×”.");
      return;
    }
    window.location.href = url;
  }

  // ---------- ×©×•×œ×—× ×•×ª ×¤×ª×•×—×™× â€“ ×§×œ×™×§ ×¢×œ "×”××©×š ×”×–×× ×”" ××• ×¢×œ ×›×œ ×”×©×•×¨×” ----------
  if (openList) {
    openList.addEventListener("click", function(ev){
      const btn = ev.target.closest(".js-go-pos");
      const row = ev.target.closest("li.open-table-row");
      if (!row) return;

      const posUrl = row.getAttribute("data-pos-url") || "";

      // ×× ×œ×—×¦×• ×¢×œ ×”×›×¤×ª×•×¨ â€“ ×ª××™×“ × × ×•×•×˜
      if (btn) {
        goToPos(posUrl);
        return;
      }

      // ×× ×œ×—×¦×• ×¢×œ ×”×©×•×¨×” ×¢×¦××” â€“ ×’× × × ×•×•×˜ (×›××• ×‘×××©×§ ×”×§×•×“×)
      goToPos(posUrl);
    });
  }

  // ---------- ×˜×¢×™× ×ª ××¤×ª ×”××¡×¢×“×” ----------
  async function loadFloor(){
    if (!floorHolder) return;
    floorHolder.innerHTML = "";

    try{
      const res = await fetch(`/api/floor-plans/${encodeURIComponent(rid)}`);
      if (!res.ok) {
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "×œ× ×”×•×’×“×¨×” ××¤×ª ×©×•×œ×—× ×•×ª ×œ××¡×¢×“×” ×–×•.";
        floorHolder.appendChild(p);
        return;
      }
      const plan = await res.json();

      const gridRows = Number(plan.gridRows || 8);
      const gridCols = Number(plan.gridCols || 10);
      const tables = Array.isArray(plan.tables) ? plan.tables : [];
      const tableStatuses = Array.isArray(plan.tableStatuses) ? plan.tableStatuses : [];

      const statusMap = new Map();
      const guestMap = new Map();
      const tableMeta = new Map(); // people/time ×•×›×•'

      tableStatuses.forEach(function(s){
        const tn = Number(s.tableNumber);
        if (!Number.isFinite(tn)) return;

        const st = s.status || "empty";
        statusMap.set(tn, st);

        const gName = s.guestName || s.name || s.customerName || null;
        if (gName) guestMap.set(tn, String(gName));

        tableMeta.set(tn, {
          people: s.people || s.guests || s.covers || "",
          time: s.time || s.startTime || "",
        });
      });

      if (!tables.length) {
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "××™×Ÿ ×©×•×œ×—× ×•×ª ××•×’×“×¨×™× ×‘××¤×ª ×”××¡×¢×“×”.";
        floorHolder.appendChild(p);
        return;
      }

      const grid = document.createElement("div");
      grid.className = "floor-grid";
      grid.style.setProperty("--rows", gridRows);
      grid.style.setProperty("--cols", gridCols);
      floorHolder.appendChild(grid);

      tables.forEach(function(t){
        const num = Number(t.tableNumber);
        const status = statusMap.get(num) || "empty";
        const seats = Number(t.seats || 0);
        const guestName = guestMap.get(num) || "";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "table " + status;
        btn.dataset.tableNumber = String(num);

        const capText = seats > 0 ? (seats + " ××§×•××•×ª") : "";

        btn.innerHTML = `
          <div class="table-num">${num}</div>
          <div class="table-cap">${capText}</div>
          ${guestName ? `<div class="table-guest">${guestName}</div>` : ""}
        `;

        btn.style.gridRow = (t.gridY + 1) + " / span " + (t.spanY || 1);
        btn.style.gridColumn = (t.gridX + 1) + " / span " + (t.spanX || 1);

        btn.addEventListener("click", function(){
          const currentStatus = statusMap.get(num) || "empty";

          // ×× ×”×©×•×œ×—×Ÿ ×¤× ×•×™ â€“ ××¤×©×¨ ×œ×¤×ª×•×— POS ×—×“×© (××• ×œ×¢×©×•×ª future feature)
          if (currentStatus === "empty") {
            const url = `/pos/${rid}?table=${num}`;
            goToPos(url);
            return;
          }

          // ×©×•×œ×—×Ÿ ×ª×¤×•×¡ â€“ ××¦×™×’×™× ×—×œ×•× ×™×ª ×¦×“ ×¢× ×”×¤×¨×˜×™×
          const meta = tableMeta.get(num) || {};
          const people = meta.people || "";
          const time = meta.time || "";

          const listItem = openList
            ? openList.querySelector('li.open-table-row[data-table="'+num+'"]')
            : null;

          const posUrl =
            (listItem && listItem.getAttribute("data-pos-url")) ||
            `/pos/${rid}?table=${num}`;

          sideState.currentTable = num;
          sideState.currentPosUrl = posUrl;
          sideState.currentStatus = currentStatus;

          detailsTableNum.textContent = "#" + num;
          detailsGuestName.textContent = guestName || "â€”";
          detailsPeople.textContent = people ? String(people) : "â€”";
          detailsTime.textContent = time || "â€”";
          detailsStatus.textContent =
            currentStatus === "occupied" ? "×ª×¤×•×¡" :
            currentStatus === "reserved" ? "×©××•×¨" :
            currentStatus;

          detailsPanel.classList.remove("hidden");
        });

        grid.appendChild(btn);
      });
    }catch(e){
      console.error(e);
      const p = document.createElement("p");
      p.className = "muted";
      p.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ××¤×ª ×”××¡×¢×“×”.";
      floorHolder.appendChild(p);
    }
  }

  // ×¡×’×™×¨×ª ×—×œ×•× ×™×ª ×¦×“
  if (detailsCloseBtn) {
    detailsCloseBtn.addEventListener("click", function(){
      detailsPanel.classList.add("hidden");
    });
  }

  // ×›×¤×ª×•×¨ "××¢×‘×¨ ×œ××¡×š ×”×–×× ×”" ×‘×—×œ×•× ×™×ª
  if (detailsOpenPos) {
    detailsOpenPos.addEventListener("click", function(){
      if (!sideState.currentPosUrl) {
        alert("×œ× ×”×•×’×“×¨ ×§×™×©×•×¨ ×œ××¡×š ×”×”×–×× ×” ×¢×‘×•×¨ ×©×•×œ×—×Ÿ ×–×”.");
        return;
      }
      goToPos(sideState.currentPosUrl);
    });
  }

  loadFloor();
})();
</script>

<style>
  .waiter.container{
    max-width: 1100px;
    margin: 20px auto;
    padding: 0 16px;
  }

  .waiter-header{
    margin-bottom: 16px;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:8px;
  }

  .waiter-header h1{
    margin:0;
    font-size: clamp(20px, 2.6vw, 26px);
  }

  .muted{
    color: var(--ink-muted, #9aa3b2);
  }
  .small{ font-size: 12px; }

  .waiter-grid{
    display:grid;
    grid-template-columns: minmax(260px, 0.9fr) minmax(340px, 1.1fr);
    gap:16px;
  }

  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px;
    padding:16px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  /* --- ×¨×©×™××ª ×©×•×œ×—× ×•×ª ×¤×ª×•×—×™× --- */
  .list{
    list-style:none;
    padding:0;
    margin:8px 0 0;
  }
  .open-table-row{
    border-top:1px solid rgba(255,255,255,.06);
    padding:10px 0;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    cursor:pointer;
  }
  .open-table-row:first-child{
    border-top:none;
    padding-top:0;
  }

  .row-main{
    flex:1;
    min-width:0;
  }
  .row-title{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:2px;
  }
  .guest-name{
    font-size:14px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .row-meta{
    display:flex;
    gap:4px;
    align-items:center;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 8px;
    border-radius:999px;
    background:rgba(59,130,246,.16);
    color:#93c5fd;
    font-size:11px;
  }

  .row-actions{
    display:flex;
    align-items:center;
    gap:6px;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:8px 14px;
    border-radius:12px;
    border:1px solid #1f2937;
    background:transparent;
    color:#e5e7eb;
    cursor:pointer;
    font-size:14px;
    font-weight:600;
    gap:6px;
  }
  .btn.primary{
    background:#3b82f6;
    border-color:#2563eb;
    color:#ffffff;
  }
  .btn.sm{
    padding:6px 12px;
    border-radius:10px;
    font-size:13px;
  }
  .btn.ghost{
    background:rgba(15,23,42,.6);
    border-color:rgba(148,163,184,.5);
  }
  .btn.xs{
    padding:4px 10px;
    font-size:12px;
    border-radius:999px;
  }

  /* --- ××¤×ª ××¡×¢×“×” + ×—×œ×•× ×™×ª ×¦×“ --- */
  .waiter-floor-panel{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .waiter-layout{
    display:grid;
    grid-template-columns: minmax(260px, 1.2fr) minmax(220px, 0.8fr);
    gap:10px;
    align-items:flex-start;
  }

  .floor-wrapper{
    min-height: 260px;
    display:flex;
    align-items:flex-start;
    justify-content:center;
  }

  .floor-grid{
    display:grid;
    grid-template-rows: repeat(var(--rows,8), 40px);
    grid-template-columns: repeat(var(--cols,10), 40px);
    gap:6px;
    background: rgba(255,255,255,.03);
    padding:6px;
    border-radius:10px;
  }

  .table{
    border:1px solid rgba(255,255,255,.3);
    border-radius:10px;
    padding:6px;
    font-weight:700;
    font-size:14px;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    backdrop-filter: blur(8px);
    color:#fff;
    text-align:center;
    transition: transform .08s ease, box-shadow .12s ease, background-color .12s ease;
  }

  .table-num{
    font-size: 16px;
    font-weight: 700;
    line-height: 1.1;
  }
  .table-cap{
    font-size: 11px;
    opacity: .86;
    margin-top: 2px;
  }
  .table-guest{
    font-size: 11px;
    margin-top: 4px;
    opacity: 0.95;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 0 4px rgba(0,0,0,.4);
  }

  .table.empty{
    background:#2e7d32;
  }
  .table.occupied{
    background:#c62828;
  }
  .table.reserved{
    background:#f9a825;
  }
  .table.dirty{
    background:#6a1b9a;
  }

  /* --- ×—×œ×•× ×™×ª ×¦×“ --- */
  .table-details{
    position:relative;
    background:rgba(15,23,42,.85);
    border-radius:14px;
    border:1px solid rgba(148,163,184,.5);
    padding:12px 12px 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,.55);
  }
  .table-details.hidden{
    display:none;
  }
  .details-close{
    position:absolute;
    top:6px;
    left:6px;
    width:22px;
    height:22px;
    border-radius:999px;
    border:none;
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    font-size:13px;
    cursor:pointer;
  }
  .details-content h3{
    margin:0 0 8px;
    font-size:15px;
  }

  .details-list{
    margin:0;
    padding:0;
  }
  .details-row{
    display:flex;
    justify-content:space-between;
    gap:8px;
    font-size:13px;
    padding:3px 0;
    border-bottom:1px dashed rgba(148,163,184,.35);
  }
  .details-row:last-child{
    border-bottom:none;
  }
  .details-row dt{
    font-weight:500;
    color:#9ca3af;
  }
  .details-row dd{
    margin:0;
    font-weight:500;
  }

  .details-actions{
    margin-top:10px;
    display:flex;
    justify-content:flex-start;
  }

  @media (max-width: 900px){
    .waiter-grid{
      grid-template-columns:1fr;
    }
    .waiter-layout{
      grid-template-columns:1fr;
    }
    .table-details{
      margin-top:10px;
    }
  }
</style>
