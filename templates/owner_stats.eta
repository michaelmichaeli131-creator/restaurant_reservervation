<% layout("_layout", it) %>

<%
// tt: ×ª×¨×’×•× ×¢× fallback ×××™×ª×™
function tt(k, fb){
  try{
    if (it && typeof it.t==='function'){
      const s = it.t(k);
      if(!s || s===k || s===`(${k})`) return fb;
      return s;
    }
  }catch(e){}
  return fb;
}

const r = it.restaurant || {};
const stats = it.stats || {};
%>

<section class="sb-owner-stats container" aria-label="<%= tt('owner.stats.aria_section','×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×‘×¢×œ×™×') %>">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1><%= tt('owner.stats.title','×¡×˜×˜×™×¡×˜×™×§×•×ª ×•×“×•×—×•×ª') %></h1>
        <p class="muted">
          <strong><%= r.name || tt('owner.stats.restaurant_fallback','×”××¡×¢×“×” ×©×œ×š') %></strong>
          Â· <%= tt('owner.stats.subtitle','×ª××•× ×” ××œ××” ×¢×œ ×”×”×›× ×¡×•×ª, ×”×× ×•×ª ×•×”×¢×•××¡×™×') %>
        </p>
      </div>
      <div class="stats-filters">
        <div class="chip">
          ğŸ“…
          <span>
            <%= (stats.rangeLabel || tt('owner.stats.range_today','×”×™×•× ×•×”×™××™× ×”××—×¨×•× ×™×')) %>
          </span>
        </div>
        <% if (typeof stats.totalRevenue === 'number') { %>
          <div class="chip highlight">
            ğŸ’°
            <span>
              <%= tt('owner.stats.total_revenue','×¡×”×´×› ×”×›× ×¡×•×ª') %>:
              <strong><%= stats.totalRevenue.toLocaleString('he-IL') %></strong>
            </span>
          </div>
        <% } %>
      </div>
    </header>

    <!-- ×’×¨×™×“ ×©×œ ×›×¨×˜×™×¡×™ ×“×©×‘×•×¨×“ -->
    <div class="stats-grid">

      <!-- 1. ×× ×•×ª ×¤×•×¤×•×œ×¨×™×•×ª -->
      <section class="panel card stats-card">
        <header class="stats-card-hd">
          <div>
            <h2>ğŸ½ï¸ ×”×× ×•×ª ×”×¤×•×¤×•×œ×¨×™×•×ª</h2>
            <p class="muted">××—×•×–×™ ×”×–×× ×” ×•×›××•×ª ×¤×¨ ×× ×”</p>
          </div>
          <% if (stats.popularItems && stats.popularItems.length) { %>
            <span class="badge">
              <%= stats.popularItems.length %> ×× ×•×ª ××•×‘×™×œ×•×ª
            </span>
          <% } %>
        </header>
        <div class="chart-wrap">
          <canvas id="popularItemsChart" aria-label="Popular items chart" role="img"></canvas>
        </div>
        <ul class="mini-list">
          <% (stats.popularItems || []).slice(0,5).forEach(function(row){ %>
            <li>
              <span class="name"><%= row.name %></span>
              <span class="meta">
                <span><%= row.count %> ×”×–×× ×•×ª</span>
                <% if (typeof row.percent === 'number') { %>
                  <span><%= row.percent.toFixed(1) %>%</span>
                <% } %>
              </span>
            </li>
          <% }) %>
          <% if (!stats.popularItems || !stats.popularItems.length) { %>
            <li class="muted">××™×Ÿ ×¢×“×™×™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×œ×”×¦×’×”.</li>
          <% } %>
        </ul>
      </section>

      <!-- 2. ×”×›× ×¡×•×ª ×œ×¤×™ ×™×•× -->
      <section class="panel card stats-card">
        <header class="stats-card-hd">
          <div>
            <h2>ğŸ“ˆ ×”×›× ×¡×•×ª ×œ×¤×™ ×™×•×</h2>
            <p class="muted">×¨××™×™×” ×™×•××™×ª + ×¡×”×´×› ×›×œ×œ×™</p>
          </div>
          <% if (typeof stats.totalRevenue === 'number') { %>
            <span class="badge green">
              ×¡×”×´×›: <%= stats.totalRevenue.toLocaleString('he-IL') %>
            </span>
          <% } %>
        </header>
        <div class="chart-wrap">
          <canvas id="revenueByDayChart" aria-label="Revenue by day chart" role="img"></canvas>
        </div>
        <div class="footer-kpi">
          <% if (typeof stats.avgDailyRevenue === 'number') { %>
            <span>
              ğŸ’¸ ×××•×¦×¢ ×œ×™×•×:
              <strong><%= stats.avgDailyRevenue.toLocaleString('he-IL') %></strong>
            </span>
          <% } %>
          <% if (stats.bestRevenueDay) { %>
            <span>
              â­ ×™×•× ×—×–×§:
              <strong><%= stats.bestRevenueDay.label %></strong>
            </span>
          <% } %>
        </div>
      </section>

      <!-- 3. ×©×¢×•×ª ×—×–×§×•×ª / ×—×œ×©×•×ª -->
      <section class="panel card stats-card">
        <header class="stats-card-hd">
          <div>
            <h2>â° ×¢×•××¡ ×œ×¤×™ ×©×¢×•×ª</h2>
            <p class="muted">×‘××™×œ×• ×©×¢×•×ª ×™×© ×”×›×™ ×”×¨×‘×” ×”×–×× ×•×ª</p>
          </div>
        </header>
        <div class="chart-wrap">
          <canvas id="ordersByHourChart" aria-label="Orders by hour chart" role="img"></canvas>
        </div>
        <div class="footer-kpi">
          <% if (stats.peakHour) { %>
            <span>ğŸ”¥ ×©×¢×ª ×©×™×: <strong><%= stats.peakHour.label %></strong></span>
          <% } %>
          <% if (stats.suggestedHappyHour) { %>
            <span>ğŸ’¡ Happy hour ××•×¦×¢: <strong><%= stats.suggestedHappyHour.label %></strong></span>
          <% } %>
        </div>
      </section>

      <!-- 4. ×™××™× ×”×›×™ ×—×–×§×™× -->
      <section class="panel card stats-card">
        <header class="stats-card-hd">
          <div>
            <h2>ğŸ“… ×™××™× ×—×–×§×™×</h2>
            <p class="muted">×”×©×•×•××ª ×”×›× ×¡×•×ª ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢</p>
          </div>
        </header>
        <div class="chart-wrap">
          <canvas id="revenueByWeekdayChart" aria-label="Revenue by weekday chart" role="img"></canvas>
        </div>
        <ul class="mini-list">
          <% (stats.revenueByWeekday || []).slice(0,7).forEach(function(row){ %>
            <li>
              <span class="name"><%= row.label %></span>
              <span class="meta">
                <span><%= row.total.toLocaleString('he-IL') %></span>
              </span>
            </li>
          <% }) %>
          <% if (!stats.revenueByWeekday || !stats.revenueByWeekday.length) { %>
            <li class="muted">××™×Ÿ ×¢×“×™×™×Ÿ × ×ª×•× ×™× ×œ× ×™×ª×•×— ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢.</li>
          <% } %>
        </ul>
      </section>

      <!-- 5. ×”×•×¦××•×ª (×™×“× ×™ ×œ×¢×ª ×¢×ª×”) -->
      <section class="panel card stats-card">
        <header class="stats-card-hd">
          <div>
            <h2>ğŸ’µ ×”×•×¦××•×ª</h2>
            <p class="muted">×‘×™× ×ª×™×™× ××•×–× ×•×ª ×™×“× ×™×ª, ×‘×”××©×š ××¤×©×¨ ×œ×§×©×¨ ×œ××¢×¨×›×ª</p>
          </div>
          <% if (typeof stats.totalExpenses === 'number') { %>
            <span class="badge red">
              ×¡×”×´×› ×”×•×¦××•×ª: <%= stats.totalExpenses.toLocaleString('he-IL') %>
            </span>
          <% } %>
        </header>
        <div class="chart-wrap">
          <canvas id="expensesChart" aria-label="Expenses chart" role="img"></canvas>
        </div>
        <div class="footer-kpi">
          <% if (typeof stats.totalRevenue === 'number' && typeof stats.totalExpenses === 'number') { %>
            <span>
              ğŸ“Š ×¨×•×•×— ××©×•×¢×¨:
              <strong><%= (stats.totalRevenue - stats.totalExpenses).toLocaleString('he-IL') %></strong>
            </span>
          <% } else { %>
            <span class="muted">× ×™×ª×Ÿ ×œ×”×–×™×Ÿ ×”×•×¦××•×ª ×‘××¢×¨×›×ª ×”×‘×§Ö¾××•×¤×™×¡ (×‘×¢×ª×™×“ ğŸ™‚).</span>
          <% } %>
        </div>
      </section>

      <!-- 6. ×”×¦×¢×•×ª ×œ-Happy Hour -->
      <section class="panel card stats-card wide">
        <header class="stats-card-hd">
          <div>
            <h2>ğŸ¯ ×”×¦×¢×•×ª ×œ-Happy Hour</h2>
            <p class="muted">×–×™×”×•×™ ×©×¢×•×ª/×™××™× ×—×œ×©×™× ×•×”×¦×¢×” ×œ×©×™×¤×•×¨</p>
          </div>
        </header>

        <div class="happy-grid">
          <div class="happy-block">
            <h3>â° ×©×¢×•×ª ×—×œ×©×•×ª</h3>
            <ul class="mini-list">
              <% (stats.weakHours || []).slice(0,4).forEach(function(row){ %>
                <li>
                  <span class="name"><%= row.label %></span>
                  <span class="meta">
                    <span><%= row.orders %> ×”×–×× ×•×ª</span>
                  </span>
                </li>
              <% }) %>
              <% if (!stats.weakHours || !stats.weakHours.length) { %>
                <li class="muted">××™×Ÿ ×¢×“×™×™×Ÿ × ×ª×•× ×™× ×‘×¨×•×¨×™× ×¢×œ ×©×¢×•×ª ×—×œ×©×•×ª.</li>
              <% } %>
            </ul>
          </div>

          <div class="happy-block">
            <h3>ğŸ“… ×™××™× ×—×œ×©×™×</h3>
            <ul class="mini-list">
              <% (stats.weakDays || []).slice(0,3).forEach(function(row){ %>
                <li>
                  <span class="name"><%= row.label %></span>
                  <span class="meta">
                    <span><%= row.total.toLocaleString('he-IL') %></span>
                  </span>
                </li>
              <% }) %>
              <% if (!stats.weakDays || !stats.weakDays.length) { %>
                <li class="muted">×¢×“×™×™×Ÿ ××™×Ÿ ×–×™×”×•×™ ×‘×¨×•×¨ ×©×œ ×™××™× ×—×œ×©×™×.</li>
              <% } %>
            </ul>
          </div>

          <div class="happy-block rec-card">
            <h3>ğŸ’¡ ×¨×¢×™×•× ×•×ª ×œ×§××¤×™×™× ×™×</h3>
            <ul class="bullets">
              <li>2+1 ×¢×œ ×§×•×§×˜×™×™×œ×™× ×‘×©×¢×•×ª ×”×—×œ×©×•×ª.</li>
              <li>××‘×¦×¢ ×¢×¡×§×™×•×ª ××•×§×“××•×ª ×œ×¤× ×™ ×©×™× ×”×¢×¨×‘.</li>
              <li>×”× ×—×” ×¢×œ ×§×™× ×•×—×™× ×‘×™××™× ×”×—×œ×©×™×.</li>
              <li>Happy Hour ×œ××§×•××™×™× / ×¢×•×‘×“×™× ×‘××–×•×¨.</li>
            </ul>
            <p class="muted small">
              ×‘×”××©×š ××¤×©×¨ ×œ×—×‘×¨ ××ª ×–×” ×œ××•×“×•×œ ×§×•×¤×•× ×™×/×§××¤×™×™× ×™× ×•×œ××“×•×“ ×”×©×¤×¢×” ×××™×ª×™×ª.
            </p>
          </div>
        </div>
      </section>

    </div>
  </div>
</section>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  (function(){
    const stats = (window.__spotbookStats = <%- JSON.stringify(stats) %> ) || {};

    function get(ctxId){
      const el = document.getElementById(ctxId);
      if (!el) return null;
      if (typeof Chart === 'undefined') return null;
      return el.getContext('2d');
    }

    document.addEventListener('DOMContentLoaded', function(){

      // 1) ×× ×•×ª ×¤×•×¤×•×œ×¨×™×•×ª
      (function(){
        const ctx = get('popularItemsChart');
        if (!ctx || !Array.isArray(stats.popularItems) || !stats.popularItems.length) return;

        const labels = stats.popularItems.map(r => r.name);
        const dataCounts = stats.popularItems.map(r => r.count || 0);

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: '×›××•×ª ×”×–×× ×•×ª',
              data: dataCounts,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            },
            scales: {
              x: {
                ticks: { color: '#e5e7eb' },
                grid: { display: false }
              },
              y: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(148,163,184,0.2)' },
                beginAtZero: true
              }
            }
          }
        });
      })();

      // 2) ×”×›× ×¡×•×ª ×œ×¤×™ ×™×•×
      (function(){
        const ctx = get('revenueByDayChart');
        if (!ctx || !Array.isArray(stats.revenueByDay) || !stats.revenueByDay.length) return;

        const labels = stats.revenueByDay.map(r => r.label || r.date);
        const values = stats.revenueByDay.map(r => r.total || 0);

        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: '×”×›× ×¡×” ×œ×™×•×',
              data: values,
              tension: 0.35,
              pointRadius: 3,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            },
            scales: {
              x: {
                ticks: { color: '#e5e7eb' },
                grid: { display: false }
              },
              y: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(148,163,184,0.2)' },
                beginAtZero: true
              }
            }
          }
        });
      })();

      // 3) ×¢×•××¡ ×œ×¤×™ ×©×¢×•×ª
      (function(){
        const ctx = get('ordersByHourChart');
        if (!ctx || !Array.isArray(stats.ordersByHour) || !stats.ordersByHour.length) return;

        const labels = stats.ordersByHour.map(r => r.label || r.hour);
        const values = stats.ordersByHour.map(r => r.orders || 0);

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: '××¡×¤×¨ ×”×–×× ×•×ª',
              data: values,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            },
            scales: {
              x: {
                ticks: { color: '#e5e7eb', maxRotation: 0, minRotation: 0 },
                grid: { display: false }
              },
              y: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(148,163,184,0.2)' },
                beginAtZero: true
              }
            }
          }
        });
      })();

      // 4) ×™××™× ×—×–×§×™× (×”×›× ×¡×” ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢)
      (function(){
        const ctx = get('revenueByWeekdayChart');
        if (!ctx || !Array.isArray(stats.revenueByWeekday) || !stats.revenueByWeekday.length) return;

        const labels = stats.revenueByWeekday.map(r => r.label);
        const values = stats.revenueByWeekday.map(r => r.total || 0);

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: '×”×›× ×¡×” ×œ×™×•× ×‘×©×‘×•×¢',
              data: values,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            },
            scales: {
              x: {
                ticks: { color: '#e5e7eb' },
                grid: { display: false }
              },
              y: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(148,163,184,0.2)' },
                beginAtZero: true
              }
            }
          }
        });
      })();

      // 5) ×”×•×¦××•×ª ××•×œ ×”×›× ×¡×•×ª
      (function(){
        const ctx = get('expensesChart');
        if (!ctx) return;

        const revenue = typeof stats.totalRevenue === 'number' ? stats.totalRevenue : null;
        const expenses = typeof stats.totalExpenses === 'number' ? stats.totalExpenses : null;

        if (revenue == null && expenses == null) return;

        const labels = [];
        const data = [];

        if (revenue != null){
          labels.push('×”×›× ×¡×•×ª');
          data.push(revenue);
        }
        if (expenses != null){
          labels.push('×”×•×¦××•×ª');
          data.push(expenses);
        }

        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#e5e7eb' }
              },
              tooltip: { enabled: true }
            },
            cutout: '60%'
          }
        });
      })();

    });
  })();
</script>

<style>
  .sb-owner-stats.container{
    max-width:1200px;
    margin:20px auto;
    padding:0 16px;
  }

  .card{
    background: var(--panel, #0b1020);
    border:1px solid var(--bd, #1f2937);
    border-radius:20px;
    padding:20px;
    margin-bottom:18px;
    color: var(--ink, #e5e7eb);
    box-shadow: 0 18px 45px rgba(0,0,0,.55);
  }

  .owner-hd{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
    margin-bottom:18px;
  }

  .owner-hd h1{
    margin:0;
    font-size:clamp(20px, 2.4vw, 26px);
  }

  .muted{
    color: var(--ink-muted, #9ca3af);
    margin:4px 0 0;
  }

  .stats-filters{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:flex-end;
  }

  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    background: radial-gradient(circle at top left, rgba(59,130,246,.18), transparent 55%);
    font-size:12px;
    color:#e5e7eb;
  }
  .chip.highlight{
    border-color:rgba(52,211,153,.7);
    background: radial-gradient(circle at top left, rgba(16,185,129,.25), transparent 55%);
  }

  .stats-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:16px;
  }

  .stats-card{
    background: radial-gradient(circle at top left, rgba(59,130,246,.12), #020617);
    border-radius:18px;
    border:1px solid rgba(15,23,42,.9);
    padding:14px 14px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .stats-card.wide{
    grid-column:1 / -1;
  }

  .stats-card-hd{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
  }

  .stats-card-hd h2{
    margin:0;
    font-size:15px;
  }

  .badge{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    background: rgba(148,163,184,.18);
    border:1px solid rgba(148,163,184,.45);
    color:#e5e7eb;
    white-space:nowrap;
  }
  .badge.green{
    background:rgba(16,185,129,.16);
    border-color:rgba(16,185,129,.6);
  }
  .badge.red{
    background:rgba(248,113,113,.16);
    border-color:rgba(248,113,113,.6);
  }

  .chart-wrap{
    position:relative;
    width:100%;
    min-height:180px;
    max-height:260px;
  }

  .mini-list{
    list-style:none;
    padding:0;
    margin:4px 0 0;
    font-size:12px;
  }

  .mini-list li{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:4px 0;
    border-top:1px solid rgba(15,23,42,.7);
  }
  .mini-list li:first-child{
    border-top:none;
  }
  .mini-list .name{
    font-weight:500;
  }
  .mini-list .meta{
    display:flex;
    gap:8px;
    color:#9ca3af;
    font-size:11px;
  }

  .footer-kpi{
    margin-top:4px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    font-size:12px;
    color:#e5e7eb;
  }

  .happy-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:12px;
    margin-top:4px;
  }

  .happy-block h3{
    margin:0 0 6px;
    font-size:13px;
  }

  .happy-block.rec-card{
    background: radial-gradient(circle at top left, rgba(244,114,182,.22), transparent 55%);
    border-radius:14px;
    border:1px solid rgba(244,114,182,.45);
    padding:10px;
  }

  .bullets{
    list-style:disc;
    padding-left:16px;
    margin:0 0 6px;
    font-size:12px;
  }

  .small{
    font-size:11px;
  }

  @media (max-width:900px){
    .owner-hd{
      flex-direction:column;
      align-items:flex-start;
    }
    .stats-grid{
      grid-template-columns:1fr;
    }
    .happy-grid{
      grid-template-columns:1fr;
    }
  }
</style>
