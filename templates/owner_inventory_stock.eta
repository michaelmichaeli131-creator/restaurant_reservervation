<% layout("_layout", it) %>

<section class="sb-owner container" aria-label="××œ××™ ×—×•××¨×™ ×’×œ×">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1>××œ××™ ×—×•××¨×™ ×’×œ×</h1>
        <div class="muted">
          <strong><%= it.restaurant?.name %></strong>
        </div>
      </div>
      <a class="btn ghost" href="/owner/<%= it.restaurant.id %>/inventory/recipes">
        ğŸ“– ××ª×›×•× ×™ ×× ×•×ª
      </a>
    </header>

    <div class="owner-grid inv-grid">
      <!-- ×˜×‘×œ×ª ××œ××™ -->
      <div class="panel card">
        <h2 class="card-title">×¨×©×™××ª ×—×•××¨×™ ×’×œ×</h2>

        <% if (it.ingredients && it.ingredients.length) { %>
          <div class="inv-table-wrapper">
            <table class="inv-table">
              <thead>
                <tr>
                  <th>×©×</th>
                  <th>×™×—×™×“×”</th>
                  <th>×›××•×ª × ×•×›×—×™×ª</th>
                  <th>××™× ×™××•×</th>
                  <th>×¢×œ×•×ª / ×™×—×™×“×”</th>
                  <th>×¡×¤×§</th>
                  <th>×”×¢×¨×•×ª</th>
                  <th>×¡×˜×˜×•×¡</th>
                  <th>×¢×¨×™×›×”</th>
                </tr>
              </thead>
              <tbody>
                <% it.ingredients.forEach(function(ing){ 
                     const low = ing.minQty > 0 && ing.currentQty <= ing.minQty;
                %>
                  <tr class="<%= low ? 'low-stock' : '' %>">
                    <td><strong><%= ing.name %></strong></td>
                    <td><%= ing.unit || '-' %></td>
                    <td><%= ing.currentQty ?? 0 %></td>
                    <td><%= ing.minQty ?? 0 %></td>
                    <td><%= typeof ing.costPerUnit === 'number' ? ing.costPerUnit.toFixed(2) + ' â‚ª' : '-' %></td>
                    <td><%= ing.supplierName || '-' %></td>
                    <td class="muted"><%= ing.notes || '-' %></td>
                    <td>
                      <% if (low) { %>
                        <span class="badge danger">××ª×—×ª ×œ××™× ×™××•×</span>
                      <% } else { %>
                        <span class="badge ok">×ª×§×™×Ÿ</span>
                      <% } %>
                    </td>
                    <td>
                      <!-- ×›×¤×ª×•×¨ ×©×××œ× ××ª ×”×˜×•×¤×¡ ××©×××œ ×‘×¢×–×¨×ª JS -->
                      <button class="btn sm ghost js-fill-ingredient"
                              type="button"
                              data-id="<%= ing.id %>"
                              data-name="<%= ing.name %>"
                              data-unit="<%= ing.unit %>"
                              data-current="<%= ing.currentQty ?? 0 %>"
                              data-min="<%= ing.minQty ?? 0 %>"
                              data-cost="<%= ing.costPerUnit ?? '' %>"
                              data-supplier="<%= ing.supplierName || '' %>"
                              data-notes="<%= ing.notes || '' %>">
                        ×¢×¨×•×š
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <p class="muted">×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×• ×—×•××¨×™ ×’×œ×.</p>
        <% } %>
      </div>

      <!-- ×˜×¤×¡×™×: ×™×¦×™×¨×”/×¢×“×›×•×Ÿ + ×ª× ×•×¢×ª ××œ××™ -->
      <div class="panel card">
        <h2 class="card-title">×”×•×¡×¤×” / ×¢×“×›×•×Ÿ ×—×•××¨ ×’×œ×</h2>

        <form
          action="/owner/<%= it.restaurant.id %>/inventory/stock/ingredient"
          method="post"
          class="form"
          id="ingredient-form"
        >
          <input type="hidden" name="id" id="ing-id">

          <label>
            ×©× ×—×•××¨ ×’×œ×
            <input name="name" id="ing-name" required placeholder="×œ××©×œ: ×¤×™×œ×” ×¡×œ××•×Ÿ">
          </label>

          <label>
            ×™×—×™×“×”
            <input name="unit" id="ing-unit" placeholder="kg / g / ml / unit" value="kg">
          </label>

          <div class="form-row">
            <label>
              ×›××•×ª × ×•×›×—×™×ª
              <input name="currentQty" id="ing-current" type="number" step="0.01" value="0">
            </label>
            <label>
              ×¨×£ ××™× ×™××•×
              <input name="minQty" id="ing-min" type="number" step="0.01" value="0">
            </label>
          </div>

          <div class="form-row">
            <label>
              ×¢×œ×•×ª ×œ×™×—×™×“×” (â‚ª)
              <input name="costPerUnit" id="ing-cost" type="number" step="0.01">
            </label>
            <label>
              ×¡×¤×§
              <input name="supplierName" id="ing-supplier" placeholder="×©× ×¡×¤×§">
            </label>
          </div>

          <label>
            ×”×¢×¨×•×ª
            <input name="notes" id="ing-notes" placeholder="×œ××©×œ: ×›×©×¨ ×œ××”×“×¨×™×Ÿ, ×œ×©××•×¨ ×‘×§×™×¨×•×¨">
          </label>

          <button class="btn primary sm" type="submit" style="margin-top:10px">
            ×©××™×¨×”
          </button>
          <button class="btn ghost sm" type="button" id="ing-reset" style="margin-top:10px">
            × ×™×§×•×™ ×˜×•×¤×¡
          </button>
        </form>

        <div class="sep"></div>

        <h2 class="card-title" style="margin-top:10px">×ª× ×•×¢×ª ××œ××™ (××©×œ×•×— / ×”×ª×××”)</h2>
        <p class="muted">×›××Ÿ ××¤×©×¨ ×œ×¢×“×›×Ÿ ×”×’×¢×” ×©×œ ××©×œ×•×—, ×”×ª×××” ×™×“× ×™×ª ××• ×ª×™×§×•×Ÿ ×˜×¢×•×ª.</p>

        <form
          action="/owner/<%= it.restaurant.id %>/inventory/stock/tx"
          method="post"
          class="form"
        >
          <label>
            ×—×•××¨ ×’×œ×
            <select name="ingredientId" required>
              <option value="">×‘×—×¨ ×—×•××¨ ×’×œ×...</option>
              <% (it.ingredients || []).forEach(function(ing){ %>
                <option value="<%= ing.id %>"><%= ing.name %> (×›××•×ª: <%= ing.currentQty ?? 0 %> <%= ing.unit || '' %>)</option>
              <% }) %>
            </select>
          </label>

          <div class="form-row">
            <label>
              ×¡×•×’ ×ª× ×•×¢×”
              <select name="type">
                <option value="delivery">××©×œ×•×— × ×›× ×¡</option>
                <option value="adjustment">×”×ª×××ª ××œ××™ ×™×“× ×™×ª</option>
              </select>
            </label>
            <label>
              ×©×™× ×•×™ ×›××•×ª
              <input name="deltaQty" type="number" step="0.01" required placeholder="×œ××©×œ: 5 ××• -2">
            </label>
          </div>

          <label>
            ×¢×œ×•×ª ×¡×”"×› (××•×¤×¦×™×•× ×œ×™)
            <input name="costTotal" type="number" step="0.01" placeholder="×›××” ×¢×œ×” ×”××©×œ×•×— ×”×–×”">
          </label>

          <label>
            ×¡×™×‘×” / ×”×¢×¨×”
            <input name="reason" placeholder="×œ××©×œ: ××©×œ×•×— ×©×‘×•×¢×™ / ×ª×™×§×•×Ÿ ×˜×¢×•×ª ×¡×¤×™×¨×”">
          </label>

          <button class="btn primary sm" type="submit" style="margin-top:10px">
            ×©××™×¨×ª ×ª× ×•×¢×”
          </button>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  (function(){
    var form = document.getElementById('ingredient-form');
    var resetBtn = document.getElementById('ing-reset');

    function setVal(id, v){
      var el = document.getElementById(id);
      if (!el) return;
      el.value = v == null ? '' : v;
    }

    document.addEventListener('click', function(ev){
      var btn = ev.target.closest && ev.target.closest('.js-fill-ingredient');
      if (!btn) return;

      setVal('ing-id', btn.getAttribute('data-id') || '');
      setVal('ing-name', btn.getAttribute('data-name') || '');
      setVal('ing-unit', btn.getAttribute('data-unit') || '');
      setVal('ing-current', btn.getAttribute('data-current') || '0');
      setVal('ing-min', btn.getAttribute('data-min') || '0');
      setVal('ing-cost', btn.getAttribute('data-cost') || '');
      setVal('ing-supplier', btn.getAttribute('data-supplier') || '');
      setVal('ing-notes', btn.getAttribute('data-notes') || '');
    });

    if (resetBtn) {
      resetBtn.addEventListener('click', function(){
        setVal('ing-id','');
        setVal('ing-name','');
        setVal('ing-unit','kg');
        setVal('ing-current','0');
        setVal('ing-min','0');
        setVal('ing-cost','');
        setVal('ing-supplier','');
        setVal('ing-notes','');
      });
    }
  })();
</script>

<style>
  .inv-grid{
    grid-template-columns: 1.5fr 1fr;
  }
  @media (max-width:900px){
    .inv-grid{
      grid-template-columns: 1fr;
    }
  }

  .inv-table-wrapper{
    max-height: 520px;
    overflow:auto;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.25);
    background: radial-gradient(circle at top left, rgba(56,189,248,.06), transparent 55%);
  }

  .inv-table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .inv-table th,
  .inv-table td{
    padding:8px 10px;
    border-bottom:1px solid rgba(148,163,184,.12);
    text-align:right;
    white-space:nowrap;
  }
  .inv-table thead th{
    position:sticky;
    top:0;
    background:rgba(15,23,42,.96);
    backdrop-filter:blur(10px);
    z-index:1;
  }
  .inv-table tbody tr:last-child td{
    border-bottom:none;
  }

  .inv-table tr.low-stock{
    background: linear-gradient(90deg, rgba(248,113,113,.13), transparent);
  }

  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid transparent;
  }
  .badge.ok{
    border-color:rgba(34,197,94,.6);
    color:#bbf7d0;
    background:rgba(22,163,74,.25);
  }
  .badge.danger{
    border-color:rgba(248,113,113,.7);
    color:#fecaca;
    background:rgba(239,68,68,.25);
  }

  .form-row{
    display:flex;
    gap:8px;
  }
  @media (max-width:600px){
    .form-row{flex-direction:column;}
  }

  .form select{
    width:100%;
    padding:10px 12px;
    margin-top:6px;
    background:#171b29;
    color:#e6e8ef;
    border:1px solid #23293a;
    border-radius:12px;
    font-size:14px;
    outline:none;
  }
  .form select:focus{
    border-color: color-mix(in srgb, var(--brand, #3b82f6) 60%, #23293a);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand, #3b82f6) 20%, transparent);
  }
</style>
