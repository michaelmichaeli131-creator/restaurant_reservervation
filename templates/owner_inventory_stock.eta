<% layout("_layout", it) %>

<%
  function tt(k, fb){
    try{
      if (it && typeof it.t==='function'){
        const s = it.t(k);
        if(!s || s===k || s===`(${k})`) return fb;
        return s;
      }
    }catch(e){}
    return fb;
  }

  const restaurant = it.restaurant || {};
  const ingredients = Array.isArray(it.ingredients) ? it.ingredients : [];
  const suppliers  = Array.isArray(it.suppliers) ? it.suppliers : [];

  function esc(s){ return String(s ?? ""); }

  const activeSuppliers = suppliers.filter(s => s && s.isActive !== false);
%>

<main class="sb-owner container sb-owner-page" aria-label="<%= tt('owner.inventory.title', 'Raw Materials Inventory') %>">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1><%= tt('owner.inventory.title', 'Raw Materials Inventory') %> Â· <%= restaurant.name || tt('common.restaurant', 'Restaurant') %></h1>
        <p class="muted">
          <%= tt('stock.description', 'Basic raw material management: quantity, minimum, unit cost, and preferred supplier. Purchase orders update inventory automatically when marked as delivered.') %>
        </p>
      </div>
      <div class="actions">
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/suppliers">ðŸ“¦ <%= tt('stock.btn_suppliers', 'Suppliers') %></a>
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/purchase_orders">ðŸ§¾ <%= tt('stock.btn_po', 'Purchase Orders') %></a>
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/costs">ðŸ“ˆ <%= tt('stock.btn_costs', 'Costs') %></a>
      </div>
    </header>

    <%~ include("components/_owner_tabs", { restaurant, active: "inventory", t: it.t }) %>


    <!-- New ingredient form -->
    <div class="panel card" style="margin-top:14px">
      <h2 class="card-title"><%= tt('owner.inventory.add_new', '×”×•×¡×¤×ª ×—×•×ž×¨ ×’×œ× ×—×“×©') %></h2>

      <form class="form row" method="post" action="/owner/<%= restaurant.id %>/inventory/stock/ingredient">
        <input type="hidden" name="id" value="">

        <label class="lbl">
          <%= tt('owner.inventory.form.name', '×©× ×—×•×ž×¨ ×’×œ×') %> *
          <input name="name" required placeholder="<%= tt('owner.inventory.placeholder.name', '×œ×“×•×’×ž×”: ×§×ž×— ×œ×‘×Ÿ 00') %>">
        </label>

        <label class="lbl">
          <%= tt('owner.inventory.form.unit', '×™×—×™×“×ª ×ž×™×“×”') %>
          <input name="unit" placeholder="<%= tt('stock.unit_placeholder', 'kg / liter / unit') %>" value="<%= tt('stock.unit_default', 'kg') %>">
        </label>

        <label class="lbl">
          <%= tt('owner.inventory.form.current_qty', '×›×ž×•×ª × ×•×›×—×™×ª') %>
          <input name="currentQty" type="number" step="0.01" placeholder="0">
        </label>

        <label class="lbl">
          <%= tt('owner.inventory.form.min_qty', '×ž×™× ×™×ž×•× ×¨×¦×•×™') %>
          <input name="minQty" type="number" step="0.01" placeholder="0">
        </label>

        <label class="lbl">
          <%= tt('owner.inventory.form.cost_per_unit', '×¢×œ×•×ª ×œ×™×—×™×“×” (â‚ª)') %>
          <input name="costPerUnit" type="number" step="0.01" placeholder="<%= tt('common.optional', '××•×¤×¦×™×•× ×œ×™') %>">
        </label>

        <label class="lbl">
          <%= tt('owner.inventory.form.supplier', '×¡×¤×§ ×ž×•×¢×“×£') %>
          <select name="supplierId">
            <option value="">â€” <%= tt('common.none', '×œ×œ×') %> â€”</option>
            <% activeSuppliers.forEach(function(s){ %>
              <option value="<%= esc(s.id) %>"><%= esc(s.name) %></option>
            <% }) %>
          </select>
        </label>

        <label class="lbl" style="min-width:220px;flex:1">
          <%= tt('owner.inventory.form.notes', '×”×¢×¨×•×ª') %>
          <input name="notes" placeholder="<%= tt('owner.inventory.placeholder.notes', '×ž×™×“×¢ × ×•×¡×£: ×¡×•×’, ××—×¡×•×Ÿ, ××œ×¨×’× ×™× ×•×›×•×³') %>">
        </label>

        <button class="btn primary sm" type="submit">âž• <%= tt('owner.inventory.btn_add', '×”×•×¡×£ ×—×•×ž×¨ ×’×œ×') %></button>
      </form>
    </div>

    <!-- All ingredients table -->
    <div class="panel card" style="margin-top:16px">
      <h2 class="card-title"><%= tt('owner.inventory.all_items', '×›×œ ×—×•×ž×¨×™ ×”×’×œ×') %></h2>

      <% if (!ingredients.length) { %>
        <p class="muted"><%= tt('owner.inventory.empty', '×¢×“×™×™×Ÿ ××™×Ÿ ×—×•×ž×¨×™ ×’×œ×. ×”×•×¡×£ ×—×•×ž×¨ ×’×œ× ×¨××©×•×Ÿ ×œ×ž×¢×œ×”.') %></p>
      <% } else { %>

        <div class="table">
          <div class="tr th">
            <div><%= tt('owner.inventory.form.name', '×©×') %></div>
            <div><%= tt('owner.inventory.form.current_qty', '×›×ž×•×ª × ×•×›×—×™×ª') %></div>
            <div><%= tt('owner.inventory.form.min_qty', '×ž×™× ×™×ž×•×') %></div>
            <div><%= tt('owner.inventory.form.cost_per_unit', '×¢×œ×•×ª ×œ×™×—×³') %></div>
            <div><%= tt('owner.inventory.form.supplier', '×¡×¤×§ ×ž×•×¢×“×£') %></div>
            <div></div>
          </div>

          <% ingredients.forEach(function(ing){ %>
            <form class="tr" method="post" action="/owner/<%= restaurant.id %>/inventory/stock/ingredient">
              <input type="hidden" name="id" value="<%= esc(ing.id) %>">

              <!-- Name + notes -->
              <div class="td">
                <input class="in" name="name" required value="<%= esc(ing.name || '') %>">
                <div class="muted small" style="margin-top:4px">
                  <%= tt('stock.unit_label', 'Unit') %>:
                  <input
                    class="in in-inline"
                    name="unit"
                    value="<%= esc(ing.unit || '') %>"
                    placeholder="<%= tt('stock.unit_placeholder', 'kg / liter / unit') %>"
                  >
                </div>
                <% if (ing.notes) { %>
                  <div class="muted small" style="margin-top:4px">
                    <%= tt('stock.notes_label', 'Notes') %>: <%= esc(ing.notes) %>
                  </div>
                <% } %>
              </div>

              <!-- Current quantity -->
              <div class="td">
                <input
                  class="in"
                  name="currentQty"
                  type="number"
                  step="0.01"
                  value="<%= esc(ing.currentQty ?? '') %>"
                  placeholder="0"
                >
              </div>

              <!-- Minimum -->
              <div class="td">
                <input
                  class="in"
                  name="minQty"
                  type="number"
                  step="0.01"
                  value="<%= esc(ing.minQty ?? '') %>"
                  placeholder="0"
                >
              </div>

              <!-- Unit cost -->
              <div class="td">
                <input
                  class="in"
                  name="costPerUnit"
                  type="number"
                  step="0.01"
                  value="<%= esc(ing.costPerUnit ?? '') %>"
                  placeholder="â€”"
                >
              </div>

              <!-- Preferred supplier -->
              <div class="td">
                <select class="in" name="supplierId">
                  <option value="">â€” <%= tt('common.none', 'None') %> â€”</option>
                  <% activeSuppliers.forEach(function(s){ %>
                    <option
                      value="<%= esc(s.id) %>"
                      <%= (ing.preferredSupplierId === s.id ? 'selected' : '') %>
                    >
                      <%= esc(s.name) %>
                    </option>
                  <% }) %>
                </select>
                <% if (ing.supplierName && !ing.preferredSupplierId) { %>
                  <div class="muted small" style="margin-top:4px">
                    <%= tt('stock.supplier_legacy', 'Supplier (legacy)') %>: <%= esc(ing.supplierName) %>
                  </div>
                <% } %>
              </div>

              <!-- Actions -->
              <div class="td right">
                <button class="btn primary sm" type="submit"><%= tt('common.btn_save', 'Save') %></button>

                <button
                  class="btn ghost sm danger"
                  type="submit"
                  formaction="/owner/<%= restaurant.id %>/inventory/stock/ingredient/<%= esc(ing.id) %>/delete"
                  formmethod="post"
                  onclick="return confirm('<%= tt('stock.confirm_delete', 'Delete this ingredient?') %>')"
                  style="margin-right:8px"
                >
                  <%= tt('common.btn_delete', 'Delete') %>
                </button>
              </div>
            </form>
          <% }) %>
        </div>

      <% } %>
    </div>
  </div>
</main>

<!-- styles moved to /public/css/sb-owner-modern.css -->
