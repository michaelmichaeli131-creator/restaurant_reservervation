<% layout("_layout", it) %>

<%
  const restaurant  = it.restaurant || {};
  const ingredients = Array.isArray(it.ingredients) ? it.ingredients : [];

  const lowStock = ingredients.filter(function(ing){
    return ing.minQty > 0 && ing.currentQty <= ing.minQty;
  });
%>

<section class="sb-owner container" aria-label="××œ××™ ×—×•××¨×™ ×’×œ×">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1>××œ××™ ×—×•××¨×™ ×’×œ× Â· <%= restaurant.name || '××¡×¢×“×”' %></h1>
        <p class="muted">
          × ×™×”×•×œ ××œ××™ ×‘×¡×™×¡×™ â€“ ×›××•×ª × ×•×›×—×™×ª, ×¨×£ ××™× ×™××•×, ×¢×œ×•×ª ×•×¡×¤×§×™×. × ×™×ª×Ÿ ×’× ×œ×”×–×™×Ÿ ××©×œ×•×—×™× ×•×ª× ×•×¢×•×ª ××œ××™.
        </p>
      </div>
    </header>

    <div class="inv-grid">
      <!-- ×¦×“ ×©×××œ: ×¨×©×™××ª ×—×•××¨×™ ×’×œ× -->
      <div class="panel card">
        <h2 class="card-title">×¨×©×™××ª ×—×•××¨×™ ×’×œ×</h2>

        <% if (!ingredients.length) { %>
          <p class="muted">
            ×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×• ×—×•××¨×™ ×’×œ×.
            <br>
            <small>×”×•×¡×£ ×—×•××¨×™ ×’×œ× ×‘×˜×•×¤×¡ "×—×•××¨ ×’×œ× ×—×“×©" ××™××™×Ÿ.</small>
          </p>
        <% } else { %>
          <div class="kpis" style="margin-bottom:8px">
            <span class="kpi">×¡×”"×› ×—×•××¨×™×: <%= ingredients.length %></span>
            <span class="kpi">×—×•×¡×¨×™× ×¤×•×˜× ×¦×™××œ×™×™×: <%= lowStock.length %></span>
          </div>

          <div class="table-wrapper">
            <table class="inv-table">
              <thead>
                <tr>
                  <th>×©×</th>
                  <th>×™×—×™×“×”</th>
                  <th>×›××•×ª</th>
                  <th>××™× ×™××•×</th>
                  <th>×¡×˜×˜×•×¡</th>
                  <th>×¢×œ×•×ª/×™×—'</th>
                  <th>×¡×¤×§</th>
                </tr>
              </thead>
              <tbody>
                <% ingredients.forEach(function(ing){ 
                     const isLow = ing.minQty > 0 && ing.currentQty <= ing.minQty;
                %>
                  <tr class="<%= isLow ? 'row-low' : '' %>">
                    <td><%= ing.name %></td>
                    <td><%= ing.unit || 'unit' %></td>
                    <td><%= Number(ing.currentQty || 0).toFixed(3) %></td>
                    <td><%= Number(ing.minQty || 0).toFixed(3) %></td>
                    <td>
                      <% if (ing.minQty > 0) { %>
                        <% if (isLow) { %>
                          <span class="badge bad">××ª×—×ª ×œ××™× ×™××•×</span>
                        <% } else { %>
                          <span class="badge ok">×ª×§×™×Ÿ</span>
                        <% } %>
                      <% } else { %>
                        <span class="badge">×œ×œ× ×¨×£</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (typeof ing.costPerUnit === 'number') { %>
                        <%= ing.costPerUnit.toFixed(2) %> â‚ª
                      <% } else { %>
                        â€”
                      <% } %>
                    </td>
                    <td><%= ing.supplierName || 'â€”' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>

      <!-- ×¦×“ ×™××™×Ÿ: ×˜×¤×¡×™× -->
      <div class="panel card">
        <h2 class="card-title">×—×•××¨ ×’×œ× ×—×“×© / ×¢×“×›×•×Ÿ</h2>

        <form
          action="/owner/<%= restaurant.id %>/inventory/stock/ingredient"
          method="post"
          class="form"
        >
          <!-- ×‘×©×œ×‘ ×¨××©×•×Ÿ ×œ× ×××¤×©×¨×™× ×¢×¨×™×›×ª ×—×•××¨ ×§×™×™× ×“×¨×š ×”×˜×•×¤×¡ ×”×–×” (××™×Ÿ hidden id) -->
          <label>
            ×©× ×—×•××¨ ×’×œ×
            <input name="name" required placeholder="×œ×“×•×’××”: ×§××— ×œ×‘×Ÿ 00">
          </label>

          <label>
            ×™×—×™×“×”
            <input name="unit" placeholder="kg / g / ml / unit" value="kg">
          </label>

          <label>
            ×›××•×ª ×”×ª×—×œ×ª×™×ª ×‘××œ××™
            <input name="currentQty" type="number" step="0.001" min="0" value="0">
          </label>

          <label>
            ×›××•×ª ××™× ×™××œ×™×ª ×œ×¤× ×™ ××–×”×¨×”
            <input name="minQty" type="number" step="0.001" min="0" value="0">
          </label>

          <label>
            ×¢×œ×•×ª ×œ×™×—×™×“×” (××•×¤×¦×™×•× ×œ×™)
            <input name="costPerUnit" type="number" step="0.01" min="0" placeholder="×œ×“×•×’××”: 5.20">
          </label>

          <label>
            ×¡×¤×§ (××•×¤×¦×™×•× ×œ×™)
            <input name="supplierName" placeholder="×©× ×¡×¤×§ / ×—×‘×¨×”">
          </label>

          <label>
            ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)
            <input name="notes" placeholder="×œ××©×œ: ×œ×©××•×¨ ×‘×§×™×¨×•×¨, ×ª×•×§×£ ×§×¦×¨ ×•×›×•'">
          </label>

          <button class="btn primary sm" type="submit" style="margin-top:10px">
            ğŸ’¾ ×©××™×¨×”
          </button>
        </form>

        <div class="sep"></div>

        <h3 class="card-title" style="margin-top:8px">×ª× ×•×¢×ª ××œ××™ (××©×œ×•×— / ×”×ª×××”)</h3>

        <% if (!ingredients.length) { %>
          <p class="muted small">
            ×™×© ×œ×”×•×¡×™×£ ×§×•×“× ×—×•××¨×™ ×’×œ× ×œ×¤× ×™ ×©××¤×©×¨ ×œ×¢×“×›×Ÿ ×ª× ×•×¢×•×ª ××œ××™.
          </p>
        <% } else { %>
          <form
            action="/owner/<%= restaurant.id %>/inventory/stock/tx"
            method="post"
            class="form"
          >
            <label>
              ×—×•××¨ ×’×œ×
              <select name="ingredientId" required>
                <option value="">×‘×—×¨ ×—×•××¨ ×’×œ×...</option>
                <% ingredients.forEach(function(ing){ %>
                  <option value="<%= ing.id %>">
                    <%= ing.name %> (×›×¨×’×¢: <%= Number(ing.currentQty || 0).toFixed(3) %> <%= ing.unit || '' %>)
                  </option>
                <% }) %>
              </select>
            </label>

            <label>
              ×¡×•×’ ×ª× ×•×¢×”
              <select name="type">
                <option value="delivery">××©×œ×•×— × ×›× ×¡</option>
                <option value="adjustment">×”×ª×××” ×™×“× ×™×ª</option>
              </select>
            </label>

            <label>
              ×©×™× ×•×™ ×›××•×ª
              <input
                name="deltaQty"
                type="number"
                step="0.001"
                placeholder="×œ×“×•×’××”: +5 (××©×œ×•×—), -0.3 (×”×¤×—×ª×”)"
              >
            </label>

            <label>
              ×¢×œ×•×ª ×›×•×œ×œ×ª (××•×¤×¦×™×•× ×œ×™)
              <input
                name="costTotal"
                type="number"
                step="0.01"
                min="0"
                placeholder="×›××” ×¢×œ×” ×”××©×œ×•×— ×”×–×” (â‚ª)"
              >
            </label>

            <label>
              ×¡×™×‘×” / ×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)
              <input name="reason" placeholder="×œ×“×•×’××”: ××©×œ×•×— ×¡×¤×§ X, ×¡×¤×™×¨×ª ××œ××™ ×™×“× ×™×ª">
            </label>

            <button class="btn ghost sm" type="submit" style="margin-top:10px">
              â• ×©××™×¨×ª ×ª× ×•×¢×”
            </button>
          </form>
        <% } %>
      </div>
    </div>
  </div>
</section>

<style>
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}
  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px; padding:18px; margin-bottom:18px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .owner-hd{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .muted{color:var(--ink-muted,#9aa3b2);}
  .small{font-size:12px;}

  .inv-grid{
    display:grid;
    grid-template-columns:1.4fr 1.1fr;
    gap:16px;
    margin-top:14px;
  }

  .table-wrapper{
    max-height:420px;
    overflow:auto;
    margin-top:8px;
  }

  .inv-table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .inv-table th,
  .inv-table td{
    padding:6px 8px;
    border-bottom:1px solid rgba(148,163,184,.18);
    text-align:right;
  }
  .inv-table th{
    font-weight:600;
    color:#e5e7eb;
    background:rgba(15,23,42,.8);
    position:sticky;
    top:0;
    z-index:1;
  }
  .row-low{
    background:rgba(248,113,113,.04);
  }

  .badge{
    display:inline-flex;
    align-items:center;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid transparent;
  }
  .badge.ok{
    border-color:rgba(52,211,153,.5);
    color:#6ee7b7;
    background:rgba(16,185,129,.08);
  }
  .badge.bad{
    border-color:rgba(248,113,113,.6);
    color:#fecaca;
    background:rgba(248,113,113,.08);
  }

  .kpis{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:6px;
  }
  .kpi{
    font-size:12px;color:#cbd5e1;
    background: rgba(148,163,184,.12);
    border:1px solid rgba(148,163,184,.25);
    border-radius:10px;padding:4px 6px
  }

  .form label{display:block;font-weight:600;font-size:14px;margin-top:8px}
  .form input,
  .form select{
    width:100%;padding:10px 12px;margin-top:6px;
    background:#171b29;color:#e6e8ef;border:1px solid #23293a;border-radius:12px;
    font-size:14px; outline:none;
  }

  .sep{height:1px;background:#23293a;margin:14px 0;border-radius:999px}

  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:8px 12px;border-radius:10px;border:1px solid #23293a;
    background:transparent;color:#e6e8ef;text-decoration:none;font-weight:600;
    cursor:pointer;
  }
  .btn.primary{
    background:var(--brand,#3b82f6);
    border-color:transparent;
    color:#fff;
  }
  .btn.ghost{background:rgba(15,23,42,.6);}
  .btn.sm{font-size:13px;padding:6px 10px}

  @media (max-width:900px){
    .inv-grid{
      grid-template-columns:1fr;
    }
  }
</style>
