<% layout("../_layout", it) %>

<style>
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}

  .card{
    background: var(--panel,#121622);
    border:1px solid var(--bd,#222834);
    border-radius:18px;
    padding:18px;
    margin-bottom:18px;
    color: var(--ink,#e6e8ef);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }

  .hdr{
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  }
  .hdr h1{margin:0;font-size:18px;letter-spacing:.2px}
  .muted{color:var(--ink-muted,#9aa3b2);font-size:13px;line-height:1.35}

  .pill-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    font-size:12px;padding:6px 10px;border-radius:999px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(15,23,42,.55);
    color:var(--ink,#e6e8ef);
  }
  .pill b{font-weight:700}

  .row{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
    margin-top:12px;
  }

  .split{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
    margin-top:14px;
  }
  @media (max-width: 980px){
    .split{grid-template-columns:1fr}
  }

  .section-title{display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin:0 0 10px 0}
  .section-title h2{margin:0;font-size:14px;letter-spacing:.2px}

  .staff-box{
    border-radius:16px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.35);
    padding:14px;
  }

  .avatar{
    width:34px;height:34px;border-radius:12px;
    display:inline-flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg, rgba(245,158,11,.25), rgba(59,130,246,.18));
    border:1px solid rgba(148,163,184,.22);
    font-weight:800;font-size:12px;color:var(--ink,#e6e8ef);
  }

  .staff-head{display:flex;gap:12px;align-items:flex-start}
  .staff-name{margin:0;font-size:15px}
  .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tag{
    font-size:12px;padding:5px 9px;border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.65);
    color:var(--ink,#e6e8ef);
  }

  /* Permissions */
  .perm-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px 10px;
  }
  @media (max-width: 680px){
    .perm-grid{grid-template-columns:1fr}
  }
  .perm-item{
    display:flex;gap:10px;align-items:flex-start;
    padding:8px 10px;border-radius:12px;
    border:1px solid rgba(148,163,184,.16);
    background:rgba(2,6,23,.25);
  }
  .perm-item input{margin-top:2px}
  .perm-item strong{font-size:12.5px}

  .perm-actions{
    margin-top:12px;
    display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;
  }

  .alert{
    margin-top:10px;padding:10px 12px;border-radius:12px;
    border:1px solid rgba(239,68,68,.35);
    background:rgba(239,68,68,.08);
    color:#fecaca;
    font-size:13px;
  }
  .hidden{display:none}

  /* Modal (reset link) */
  .sb-modal{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55);
    padding:18px;
    z-index:1200;
  }
  .sb-modal.hidden{display:none}
  .sb-modal .dialog{
    width:min(720px, 100%);
    background: var(--panel,#121622);
    border:1px solid var(--bd,#222834);
    border-radius:18px;
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    color: var(--ink,#e6e8ef);
    overflow:hidden;
  }
  .sb-modal .dialog-hd{
    padding:16px 18px;
    display:flex;justify-content:space-between;gap:12px;align-items:center;
    border-bottom:1px solid rgba(148,163,184,.12);
  }
  .sb-modal .dialog-bd{padding:16px 18px}
  .sb-modal .dialog-ft{
    padding:14px 18px;
    display:flex;justify-content:flex-end;gap:10px;
    border-top:1px solid rgba(148,163,184,.12);
    background:rgba(2,6,23,.18);
  }
  .field label{display:block;font-size:12px;color:var(--ink-muted,#9aa3b2);margin-bottom:6px}
  .field input{
    width:100%;padding:10px 12px;border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);
    color:var(--ink,#e6e8ef);
    outline:none;
  }
</style>

<%
  const owner = it.owner || null;

  // Be resilient to naming
  const staff = it.staff || it.staffMember || it.member || null;
  const restaurant = it.restaurant || it.res || null;

  const allPermissions = Array.isArray(it.allPermissions) ? it.allPermissions : [];
  const staffPermissions = Array.isArray(staff && staff.permissions) ? staff.permissions : [];

  const staffId = staff && staff.id ? String(staff.id) : "";
  const staffEmail = staff && staff.email ? String(staff.email) : "";
  const staffPhone = staff && staff.phone ? String(staff.phone) : "";
  const staffRole = staff && staff.role ? String(staff.role) : "";
  const staffStatus = staff && staff.status ? String(staff.status) : "active";
  const isInactive = staffStatus === "inactive";

  const staffFirst = staff && staff.firstName ? String(staff.firstName) : "";
  const staffLast  = staff && staff.lastName ? String(staff.lastName) : "";
  const fullName = (staffFirst + " " + staffLast).trim() || staffEmail || "Staff";

  const initials = ((staffFirst||"").slice(0,1) + (staffLast||"").slice(0,1)).toUpperCase() || "SB";

  const permLabels = {
    "pos.waiter": "POS - ××œ×¦×¨ (×§×œ×™×˜×ª ×”×–×× ×•×ª ×•×˜×™×¤×•×œ ×‘×©×•×œ×—× ×•×ª)",
    "pos.kitchen": "POS - ××˜×‘×— (××¡×š ×”×–×× ×•×ª ×œ××˜×‘×—/×‘×¨)",
    "host.seating": "×××¨×—×ª - ×”×©××ª ×©×•×œ×—× ×•×ª ×•× ×™×”×•×œ ×¨×¦×¤×ª ×”××¡×¢×“×”",
    "reservations.view": "×¦×¤×™×™×” ×‘×”×–×× ×•×ª ×œ××¡×¢×“×”",
    "reservations.manage": "× ×™×”×•×œ ×”×–×× ×•×ª (××™×©×•×¨/×‘×™×˜×•×œ/×¢×“×›×•×Ÿ)",
    "floor.view": "×¦×¤×™×™×” ×‘××¤×ª ×”×©×•×œ×—× ×•×ª",
    "floor.edit": "×¢×¨×™×›×ª ××¤×ª ×©×•×œ×—× ×•×ª",
    "shifts.view": "×¦×¤×™×™×” ×‘××©××¨×•×ª",
    "shifts.manage": "× ×™×”×•×œ ××©××¨×•×ª (×©×™×‘×•×¥, ×©×™× ×•×™, ×‘×™×˜×•×œ)",
    "inventory.view": "×¦×¤×™×™×” ×‘××œ××™ ×•×—×•××¨×™ ×’×œ×",
    "inventory.manage": "× ×™×”×•×œ ××œ××™ (×¢×“×›×•×Ÿ, ×”×–×× ×•×ª, ×”×ª×××•×ª)",
    "reports.view": "×¦×¤×™×™×” ×‘×“×•×—×•×ª (××›×™×¨×•×ª, ×ª×¤×•×¡×” ×•×›×•')",
    "menu.manage": "× ×™×”×•×œ ×ª×¤×¨×™×˜ (×× ×•×ª, ××—×™×¨×™×, ×–××™× ×•×ª)"
  };
%>

<div class="sb-owner container">
  <div class="card">
    <div class="hdr">
      <div>
        <h1>ğŸ‘¤ × ×™×”×•×œ ×¢×•×‘×“</h1>
        <div class="muted" style="margin-top:6px">
          <a href="/owner/staff" class="btn sm ghost">â† ×—×–×¨×” ×œ× ×™×”×•×œ ×¢×•×‘×“×™×</a>
          <% if (restaurant && restaurant.name) { %>
            <span class="pill" style="margin-inline-start:8px">××¡×¢×“×”: <b><%= restaurant.name %></b></span>
          <% } %>
        </div>
      </div>

      <div class="pill-row">
        <% if (owner && owner.email) { %>
          <span class="pill">×‘×¢×œ×™×: <b><%= owner.email %></b></span>
        <% } %>
      </div>
    </div>
  </div>

  <% if (!staffId) { %>
    <div class="card">
      <div class="alert">×©×’×™××”: ×œ× × ××¦× ××–×”×” ×¢×•×‘×“ (staffId). ×‘×“×•×§ ×©×”Ö¾route ××¢×‘×™×¨ it.staff ×¢× id.</div>
      <a class="btn" href="/owner/staff">×—×–×¨×”</a>
    </div>
  <% } else { %>
    <div class="card">
      <div class="section-title">
        <h2>×¤×¨×˜×™ ×¢×•×‘×“</h2>
        <span class="muted">ID: <%= staffId %></span>
      </div>

      <div class="staff-box">
        <div class="staff-head">
          <span class="avatar"><%= initials %></span>
          <div style="flex:1">
            <h3 class="staff-name"><%= fullName %></h3>
            <div class="muted" style="margin-top:4px">
              <%= staffEmail %><% if (staffPhone) { %> Â· <%= staffPhone %><% } %>
            </div>

            <div class="tags">
              <span class="tag">×ª×¤×§×™×“: <b><%= staffRole || "-" %></b></span>
              <% if (isInactive) { %>
                <span class="tag" style="border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)">×¡×˜×˜×•×¡: ××•×©×‘×ª</span>
              <% } else { %>
                <span class="tag" style="border-color:rgba(34,197,94,.28); background:rgba(34,197,94,.10)">×¡×˜×˜×•×¡: ×¤×¢×™×œ</span>
              <% } %>
            </div>

            <div class="row">
              <form method="post" action="/owner/staff/<%= staffId %>/status">
                <input type="hidden" name="redirectTo" value="/owner/staff/<%= staffId %>" />
                <input type="hidden" name="status" value="<%= isInactive ? "active" : "inactive" %>" />
                <% if (isInactive) { %>
                  <button class="btn sm" type="submit">×”×¤×¢×œ ×¢×•×‘×“</button>
                <% } else { %>
                  <button class="btn ghost sm" type="submit"
                    onclick="return confirm('×œ×”×©×‘×™×ª ××ª ×”×¢×•×‘×“? ×”×•× ×œ× ×™×•×›×œ ×œ×”×™×›× ×¡/×œ×¢×‘×•×“ ×‘××¢×¨×›×ª.');">×”×©×‘×ª ×¢×•×‘×“</button>
                <% } %>
              </form>

              <button type="button" class="btn ghost sm"
                onclick="openResetLinkModal('<%= staffId %>','<%= staffEmail %>')">
                ×¦×•×¨ ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××”
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <h2>×”×¨×©××•×ª</h2>
        <span class="muted">×›××Ÿ ×× ×”×œ×™× ×”×¨×©××•×ª (×‘×“×£ ×”×¨××©×™ ××•×¦×’×™× ××™× ×™××•× ×¤×¨×˜×™× ×‘×œ×‘×“).</span>
      </div>

      <% if (!allPermissions.length) { %>
        <div class="alert">××™×Ÿ allPermissions ×‘Ö¾render. ×‘×“×•×§ ×©×‘Ö¾route ××ª×” ××¢×‘×™×¨ it.allPermissions.</div>
      <% } %>

      <form method="post" action="/owner/staff/<%= staffId %>/permissions">
        <input type="hidden" name="redirectTo" value="/owner/staff/<%= staffId %>" />

        <div class="perm-grid" style="<%= isInactive ? "opacity:.55" : "" %>">
          <% (allPermissions || []).forEach(function(p){
               const checked = (staffPermissions || []).includes(p);
          %>
            <label class="perm-item">
              <input type="checkbox" name="permissions" value="<%= p %>" <%= checked ? "checked" : "" %> <%= isInactive ? "disabled" : "" %> />
              <div>
                <strong><%= p %></strong>
                <div class="muted"><%= permLabels[p] || "" %></div>
              </div>
            </label>
          <% }) %>
        </div>

        <div class="perm-actions">
          <div class="muted">
            <% if (isInactive) { %>
              ×”×¢×•×‘×“ ××•×©×‘×ª â€” ×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ×”×¨×©××•×ª ×¢×“ ×œ×”×¤×¢×œ×”.
            <% } else { %>
              ×©××•×¨ ×”×¨×©××•×ª ××• ××¤×¡ ×œ×‘×¨×™×¨×ª ××—×“×œ.
            <% } %>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button type="submit" class="btn sm" <%= isInactive ? "disabled" : "" %>>×©××•×¨ ×”×¨×©××•×ª</button>

            <button type="submit" class="btn ghost sm" name="resetToDefaults" value="on"
              <%= isInactive ? "disabled" : "" %>
              onclick="return confirm('×œ××¤×¡ ×”×¨×©××•×ª ×œ×‘×¨×™×¨×ª ××—×“×œ ×œ×¤×™ ×ª×¤×§×™×“?');">
              ××¤×¡ ×œ×‘×¨×™×¨×ª ××—×“×œ
            </button>
          </div>
        </div>
      </form>
    </div>
  <% } %>
</div>

<!-- Reset password link modal -->
<div class="sb-modal hidden" id="resetPwModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="resetTitle">
    <div class="dialog-hd">
      <div>
        <div style="font-size:16px;font-weight:800" id="resetTitle">×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××”</div>
        <div class="muted" style="margin-top:4px" id="resetPwSub">×¦×•×¨ ×§×™×©×•×¨ ×•×”×¢×ª×§ ×œ×¢×•×‘×“.</div>
      </div>
      <button class="btn ghost sm" type="button" id="btnCloseResetPw" aria-label="Close">âœ•</button>
    </div>

    <div class="dialog-bd">
      <div class="field">
        <label>×§×™×©×•×¨</label>
        <input id="resetPwLink" type="text" readonly value="" />
        <div style="display:flex; gap:8px; margin-top:10px">
          <button type="button" class="btn" id="btnCopyResetPw">×”×¢×ª×§</button>
          <button type="button" class="btn ghost" id="btnOpenResetPw">×¤×ª×—</button>
        </div>
        <div class="muted" style="margin-top:8px; opacity:.85">
          ××•××œ×¥ ×œ×©×œ×•×— ×œ×¢×•×‘×“ ××ª ×”×§×™×©×•×¨ ×‘×”×•×“×¢×” ×¤×¨×˜×™×ª. ×”×§×™×©×•×¨ ×—×“-×¤×¢××™.
        </div>
      </div>
      <div class="alert hidden" id="resetPwErr"></div>
    </div>

    <div class="dialog-ft">
      <button type="button" class="btn ghost" id="btnCloseResetPw2">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<script>
(function(){
  const resetModal = document.getElementById("resetPwModal");
  const resetCloseBtn = document.getElementById("btnCloseResetPw");
  const resetCloseBtn2 = document.getElementById("btnCloseResetPw2");
  const resetSub = document.getElementById("resetPwSub");
  const resetLinkInput = document.getElementById("resetPwLink");
  const resetErr = document.getElementById("resetPwErr");
  const btnCopy = document.getElementById("btnCopyResetPw");
  const btnOpen = document.getElementById("btnOpenResetPw");

  function showResetErr(msg){
    resetErr.textContent = msg || "";
    resetErr.classList.remove("hidden");
  }
  function clearResetErr(){
    resetErr.textContent = "";
    resetErr.classList.add("hidden");
  }
  function openResetModal(){
    clearResetErr();
    resetModal.classList.remove("hidden");
    resetModal.setAttribute("aria-hidden","false");
  }
  function closeResetModal(){
    resetModal.classList.add("hidden");
    resetModal.setAttribute("aria-hidden","true");
  }

  window.openResetLinkModal = async function(staffId, email){
    try{
      clearResetErr();
      resetSub.textContent = "×™×•×¦×¨ ×§×™×©×•×¨ ×¢×‘×•×¨: " + (email || "");
      resetLinkInput.value = "×˜×•×¢×Ÿ...";
      openResetModal();

      const res = await fetch(`/owner/staff/${staffId}/password-reset-link`, {
        method: "POST",
        headers: { "Accept": "application/json" }
      });
      const data = await res.json().catch(()=>null);

      if(!res.ok || !data || !data.ok){
        const err = (data && data.error) ? data.error : "unknown";
        const map = {
          "staff_not_found": "×”×¢×•×‘×“ ×œ× × ××¦×.",
          "not_your_restaurant": "××™×Ÿ ×œ×š ×”×¨×©××” ×œ××¡×¢×“×” ×”×–×•.",
          "user_not_found": "×”××©×ª××© ×œ× × ××¦×.",
          "non_local_user": "×œ× × ×™×ª×Ÿ ×œ××¤×¡ ×¡×™×¡××” ×œ××©×ª××© ×©××™× ×• Local.",
          "unknown": "×©×’×™××” ×œ× ×™×“×•×¢×”."
        };
        resetLinkInput.value = "";
        showResetErr(map[err] || ("×©×’×™××”: " + err));
        return;
      }

      const relative = String(data.resetUrl || "");
      const full = relative.startsWith("http") ? relative : (window.location.origin + relative);
      resetLinkInput.value = full;
    }catch(ex){
      resetLinkInput.value = "";
      showResetErr(String(ex));
    }
  };

  if(resetModal) resetModal.addEventListener("click", (e)=>{ if(e.target === resetModal) closeResetModal(); });
  if(resetCloseBtn) resetCloseBtn.addEventListener("click", closeResetModal);
  if(resetCloseBtn2) resetCloseBtn2.addEventListener("click", closeResetModal);

  if(btnCopy){
    btnCopy.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(resetLinkInput.value || "");
        btnCopy.textContent = "×”×•×¢×ª×§!";
        setTimeout(()=>btnCopy.textContent="×”×¢×ª×§", 900);
      }catch{
        showResetErr("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§. ××¤×©×¨ ×œ×¡××Ÿ ×•×œ×”×¢×ª×™×§ ×™×“× ×™×ª.");
      }
    });
  }
  if(btnOpen){
    btnOpen.addEventListener("click", ()=>{
      const v = resetLinkInput.value || "";
      if(v) window.open(v, "_blank");
    });
  }

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && resetModal && !resetModal.classList.contains("hidden")) closeResetModal();
  });
})();
</script>
