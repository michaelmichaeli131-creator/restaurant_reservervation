<% layout("../_layout", it) %>

<style>
  /* Match existing owner pages look (see owner_bills.eta style) */
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}

  .card{
    background: var(--panel,#121622);
    border:1px solid var(--bd,#222834);
    border-radius:18px;
    padding:18px;
    margin-bottom:18px;
    color: var(--ink,#e6e8ef);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }

  .owner-hd{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
  }

  .owner-hd h1{
    margin:0;
    font-size:18px;        /* smaller like other owner pages */
    line-height:1.2;
    letter-spacing:.2px;
  }
  .owner-hd .muted{
    color:var(--ink-muted,#9aa3b2);
    font-size:13px;
    line-height:1.35;
    margin-top:6px;
  }

  .pill-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(15,23,42,.55);
    color:var(--ink,#e6e8ef);
  }
  .pill b{font-weight:700}

  .grid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
    margin-top:14px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }

  .section-title{
    display:flex;align-items:baseline;justify-content:space-between;
    gap:12px;margin:0 0 8px 0;
  }
  .section-title h2{
    margin:0;
    font-size:14px;
    letter-spacing:.2px;
  }
  .section-title .muted{font-size:12px;color:var(--ink-muted,#9aa3b2)}

  .table-wrap{
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.35);
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px; /* compact */
  }
  thead tr{background:rgba(15,23,42,.85)}
  th, td{
    padding:8px 10px;
    text-align:right;
    border-bottom:1px solid rgba(148,163,184,.18);
    vertical-align:top;
    white-space:nowrap;
  }
  tbody tr:hover{background:rgba(59,130,246,.08)}

  .actions{white-space:nowrap}
  .actions .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

  /* Cards for approved staff */
  .cards{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  .staff-card{
    border-radius:16px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.35);
    padding:14px;
  }
  .staff-hd{
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:flex-start;
    margin-bottom:10px;
  }
  .staff-name{
    margin:0;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .avatar{
    width:28px;height:28px;border-radius:10px;
    display:inline-flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg, rgba(245,158,11,.25), rgba(59,130,246,.18));
    border:1px solid rgba(148,163,184,.22);
    font-weight:700;
    font-size:12px;
    color:var(--ink,#e6e8ef);
  }
  .staff-meta{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tag{
    font-size:12px;
    padding:5px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.65);
    color:var(--ink,#e6e8ef);
  }

  /* Permissions */
  .perm-title{
    margin:10px 0 8px 0;
    font-size:13px;
    color:var(--ink,#e6e8ef);
  }
  .perm-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px 10px;
  }
  @media (max-width: 680px){
    .perm-grid{grid-template-columns:1fr}
  }
  .perm-item{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.16);
    background:rgba(2,6,23,.25);
  }
  .perm-item input{margin-top:2px}
  .perm-item strong{font-size:12.5px}
  .perm-actions{
    margin-top:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .inline-check{
    display:flex;
    gap:8px;
    align-items:center;
    color:var(--ink-muted,#9aa3b2);
    font-size:12px;
  }

  /* Empty state */
  .empty{
    text-align:center;
    padding:26px 16px;
  }
  .empty .icon{font-size:28px;margin-bottom:8px}
  .empty h2{margin:0 0 6px 0;font-size:16px}
  .empty p{margin:0 0 14px 0;color:var(--ink-muted,#9aa3b2);font-size:13px}

  /* Modal */
  .sb-modal{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55);
    padding:18px;
    z-index:1000;
  }
  .sb-modal.hidden{display:none}
  .sb-modal .dialog{
    width:min(720px, 100%);
    background: var(--panel,#121622);
    border:1px solid var(--bd,#222834);
    border-radius:18px;
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    color: var(--ink,#e6e8ef);
    overflow:hidden;
  }
  .sb-modal .dialog-hd{
    padding:16px 18px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    border-bottom:1px solid rgba(148,163,184,.12);
  }
  .sb-modal .dialog-bd{padding:16px 18px}
  .sb-modal .dialog-ft{
    padding:14px 18px;
    display:flex;
    justify-content:flex-end;
    gap:10px;
    border-top:1px solid rgba(148,163,184,.12);
    background:rgba(2,6,23,.18);
  }
  .form-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-top:10px;
  }
  .form-grid .full{grid-column:1 / -1}
  .field label{
    display:block;
    font-size:12px;
    color:var(--ink-muted,#9aa3b2);
    margin-bottom:6px;
  }
  .field input, .field select{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.30);
    color:var(--ink,#e6e8ef);
    outline:none;
  }
  .hint{font-size:12px;color:var(--ink-muted,#9aa3b2);margin-top:6px}
  .errbox{
    display:none;
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(239,68,68,.35);
    background:rgba(239,68,68,.08);
    color:#fecaca;
    font-size:13px;
  }
  .perm-panel{margin-top:10px}

</style>

<%
  const owner = it.owner;
  const restaurantsData = it.restaurantsData || [];
  const allPermissions = it.allPermissions || [];

  const staffRoleOptions = it.staffRoleOptions || [];

  const restaurantOptions = (Array.isArray(restaurantsData) ? restaurantsData : [])
    .map((b) => (b && (b.restaurant || b.res)) || null)
    .filter(Boolean);

  const permLabels = {
    "pos.waiter": "POS - ××œ×¦×¨ (×§×œ×™×˜×ª ×”×–×× ×•×ª ×•×˜×™×¤×•×œ ×‘×©×•×œ×—× ×•×ª)",
    "pos.kitchen": "POS - ××˜×‘×— (××¡×š ×”×–×× ×•×ª ×œ××˜×‘×—/×‘×¨)",
    "host.seating": "×××¨×—×ª - ×”×©××ª ×©×•×œ×—× ×•×ª ×•× ×™×”×•×œ ×¨×¦×¤×ª ×”××¡×¢×“×”",
    "reservations.view": "×¦×¤×™×™×” ×‘×”×–×× ×•×ª ×œ××¡×¢×“×”",
    "reservations.manage": "× ×™×”×•×œ ×”×–×× ×•×ª (××™×©×•×¨/×‘×™×˜×•×œ/×¢×“×›×•×Ÿ)",
    "floor.view": "×¦×¤×™×™×” ×‘××¤×ª ×”×©×•×œ×—× ×•×ª",
    "floor.edit": "×¢×¨×™×›×ª ××¤×ª ×©×•×œ×—× ×•×ª",
    "shifts.view": "×¦×¤×™×™×” ×‘××©××¨×•×ª",
    "shifts.manage": "× ×™×”×•×œ ××©××¨×•×ª (×©×™×‘×•×¥, ×©×™× ×•×™, ×‘×™×˜×•×œ)",
    "inventory.view": "×¦×¤×™×™×” ×‘××œ××™ ×•×—×•××¨×™ ×’×œ×",
    "inventory.manage": "× ×™×”×•×œ ××œ××™ (×¢×“×›×•×Ÿ, ×”×–×× ×•×ª, ×”×ª×××•×ª)",
    "reports.view": "×¦×¤×™×™×” ×‘×“×•×—×•×ª (××›×™×¨×•×ª, ×ª×¤×•×¡×” ×•×›×•')",
    "menu.manage": "× ×™×”×•×œ ×ª×¤×¨×™×˜ (×× ×•×ª, ××—×™×¨×™×, ×–××™× ×•×ª)"
  };

  // âœ… MIN-FIX: ××œ ×ª×¢×©×” loop ×‘×ª×•×š <select>. ×‘×•× ×™× HTML ××•×›×Ÿ ×•××“×¤×™×¡×™× ×¢× <%~ %>
  function escAttr(s){
    return String(s || "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function escText(s){
    return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  const __restOpts = [];
  for (const r of (restaurantOptions || [])) {
    const id = String(r && r.id ? r.id : "");
    const name = String(r && r.name ? r.name : "");
    if (!id) continue;
    __restOpts.push(`<option value="${escAttr(id)}">${escText(name)}</option>`);
  }
  // âœ… FIX: keep on it (stable scope in Eta)
  it.__restOptsHtml = __restOpts.join("");

  const __roleOpts = [];
  for (const rr of (staffRoleOptions || [])) {
    const v = String(rr && rr.value ? rr.value : "");
    const l = String(rr && rr.label ? rr.label : "");
    if (!v) continue;
    __roleOpts.push(`<option value="${escAttr(v)}">${escText(l)}</option>`);
  }
  // âœ… FIX: keep on it (stable scope in Eta)
  it.__roleOptsHtml = __roleOpts.join("");

  // audit uses same restaurant options
  // âœ… FIX: keep on it (stable scope in Eta)
  it.__auditOptsHtml = it.__restOptsHtml;

  // âœ… FIX (MIN): store safe permissions on it (Eta scope-safe)
  it.__permsSafe = Array.isArray(allPermissions)
    ? allPermissions
    : (typeof allPermissions === "string"
        ? allPermissions.split(",").map((s)=>s.trim()).filter(Boolean)
        : []);
%>

<div class="sb-owner container">
  <div class="card">
    <div class="owner-hd">
      <div>
        <h1>ğŸ‘¥ × ×™×”×•×œ ×¢×•×‘×“×™×</h1>
        <div class="muted">
          ×××©×¨×™× ×¢×•×‘×“×™× ×•××’×“×™×¨×™× ×”×¨×©××•×ª ×œ×¤×™ ××–×•×¨×™× ×‘××¢×¨×›×ª.
        </div>
      </div>
      <div class="pill-row">
        <button type="button" class="btn sm" id="btnOpenCreateStaff">â• ×”×•×¡×£ ×¢×•×‘×“</button>
        <button type="button" class="btn sm ghost" id="btnOpenAudit">ğŸ§¾ ×œ×•×’ ×¤×¢×•×œ×•×ª</button>
        <span class="pill">×‘×¢×œ×™×: <b><%= owner?.firstName %> <%= owner?.lastName %></b></span>
        <span class="pill">××™××™×™×œ: <b><%= owner?.email %></b></span>
      </div>
    </div>
  </div>

  <% if (!restaurantsData.length) { %>
    <div class="card empty">
      <div class="icon">ğŸ½ï¸</div>
      <h2>××™×Ÿ ××¡×¢×“×•×ª ××©×•×™×›×•×ª ×œ×—×©×‘×•×Ÿ ×©×œ×š ×¢×“×™×™×Ÿ</h2>
      <p>×›×“×™ ×œ× ×”×œ ×¢×•×‘×“×™×, ×§×•×“× ×¦×•×¨ ××¡×¢×“×” ×‘××¢×¨×›×ª.</p>
      <a href="/owner/restaurants/new" class="btn">+ ×™×¦×™×¨×ª ××¡×¢×“×” ×—×“×©×”</a>
    </div>
  <% } %>

  <% restaurantsData.forEach(function(block) {
       const restaurant = block.restaurant;
       const staff = block.staff || [];
       const pending = block.pending || [];  %>
    <div class="card">
      <div class="owner-hd" style="margin-bottom:14px">
        <div>
          <h1 style="font-size:16px;margin:0"><%= restaurant.name %></h1>
          <div class="muted"><%= restaurant.city %> Â· <%= restaurant.address %></div>
        </div>
        <div class="pill-row">
          <span class="pill">×××•×©×¨×™×: <b><%= staff.length %></b></span>
          <span class="pill">pending (staff_db): <b><%= pending.length %></b></span>        </div>
      </div>


      <div class="grid">
        <!-- LEFT: pending staff -->
        <div>
          <div style="margin-bottom:14px">
            <div class="section-title">
              <h2>×××ª×™× ×™× ×œ××™×©×•×¨ (staff_db)</h2>
              <% if (!pending.length) { %><span class="muted">××™×Ÿ ×‘×§×©×•×ª ×›×¨×’×¢</span><% } %>
            </div>

            <% if (pending.length) { %>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>×©×</th>
                      <th>×ª×¤×§×™×“</th>
                      <th>××™××™×™×œ</th>
                      <th>×˜×œ×¤×•×Ÿ</th>
                      <th>× ×¨×©×</th>
                      <th class="actions">×¤×¢×•×œ×•×ª</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% pending.forEach(function(s){ %>
                      <tr>
                        <td><%= s.firstName %> <%= s.lastName %></td>
                        <td><%= s.role %></td>
                        <td><%= s.email %></td>
                        <td><%= s.phone || "-" %></td>
                        <td><%= s.createdAt ? new Date(s.createdAt).toLocaleString("he-IL") : "-" %></td>
                        <td class="actions">
                          <div class="row">
                            <form method="post" action="/owner/staff/<%= s.id %>/approve">
                              <input type="hidden" name="redirectTo" value="/owner/staff" />
                              <input type="hidden" name="useDefaults" value="on" />
                              <button type="submit" class="btn sm">âœ“ ××™×©×•×¨</button>
                            </form>
                            <form method="post" action="/owner/staff/<%= s.id %>/reject">
                              <input type="hidden" name="redirectTo" value="/owner/staff" />
                              <button type="submit" class="btn ghost sm">âœ• ×“×—×™×™×”</button>
                            </form>
                          </div>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } %>
          </div>
        </div>

        <!-- RIGHT: approved staff cards -->
        <div>
          <div class="section-title">
            <h2>×¢×•×‘×“×™× (×××•×©×¨×™×)</h2>
            <% if (!staff.length) { %><span class="muted">×¢×“×™×™×Ÿ ××™×Ÿ ×¢×•×‘×“×™×</span><% } %>
          </div>

          <% if (!staff.length) { %>
            <div class="staff-card empty" style="padding:18px">
              <div class="icon" style="font-size:22px">ğŸ§‘â€ğŸ³</div>
              <h2 style="font-size:14px">××™×Ÿ ×¢×•×‘×“×™× ×œ××¡×¢×“×” ×”×–×•</h2>
              <p>×œ×—×¥ ×œ××¢×œ×” ×¢×œ â€œ×”×•×¡×£ ×¢×•×‘×“â€ ×›×“×™ ×œ×™×¦×•×¨ ×¢×•×‘×“ ×œ××¡×¢×“×”.</p>
            </div>
          <% } else { %>
            <div class="cards">
              <% staff.forEach(function(s){
                   const initials = ((s.firstName||"").slice(0,1) + (s.lastName||"").slice(0,1)).toUpperCase() || "SB";
                   const isInactive = (s.status === "inactive");
              %>
                <div class="staff-card">
                  <div class="staff-hd">
                    <div>
                      <h3 class="staff-name">
                        <span class="avatar"><%= initials %></span>
                        <span><%= s.firstName %> <%= s.lastName %></span>
                      </h3>
                      <div class="muted" style="margin-top:4px;font-size:12px">
                        <%= s.email %><% if (s.phone) { %> Â· <%= s.phone %><% } %>
                      </div>
                    </div>

                    <div class="staff-meta">
                      <span class="tag">×ª×¤×§×™×“: <b><%= s.role %></b></span>
                      <% if (isInactive) { %>
                        <span class="tag" style="border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)">×¡×˜×˜×•×¡: ××•×©×‘×ª</span>
                      <% } else { %>
                        <span class="tag" style="border-color:rgba(34,197,94,.28); background:rgba(34,197,94,.10)">×¡×˜×˜×•×¡: ×¤×¢×™×œ</span>
                      <% } %>

                      <form method="post" action="/owner/staff/<%= s.id %>/status">
                        <input type="hidden" name="redirectTo" value="/owner/staff" />
                        <input type="hidden" name="status" value="<%= isInactive ? "active" : "inactive" %>" />
                        <% if (isInactive) { %>
                          <button class="btn sm" type="submit">×”×¤×¢×œ</button>
                        <% } else { %>
                          <button class="btn ghost sm" type="submit" onclick="return confirm('×œ×”×©×‘×™×ª ××ª ×”×¢×•×‘×“? ×”×•× ×œ× ×™×•×›×œ ×œ×”×™×›× ×¡/×œ×¢×‘×•×“ ×‘××¢×¨×›×ª.');">×”×©×‘×ª</button>
                        <% } %>
                      </form>

                      <button type="button" class="btn ghost sm" onclick="openResetLinkModal('<%= s.id %>','<%= s.email %>')" style="margin-inline-start:8px">
                        ×¦×•×¨ ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××”
                      </button>
                    </div>
                  </div>

                  <div class="perm-title">×”×¨×©××•×ª</div>

                  <form method="post" action="/owner/staff/<%= s.id %>/permissions">
                    <input type="hidden" name="redirectTo" value="/owner/staff" />

                    <div class="perm-grid" style="<%= isInactive ? "opacity:.55" : "" %>">
                      <% ((it.__permsSafe || [])).forEach(function(p){
                           const checked = (s.permissions || []).includes(p);
                      %>
                        <label class="perm-item">
                          <input type="checkbox" name="permissions" value="<%= p %>" <%= checked ? "checked" : "" %> <%= isInactive ? "disabled" : "" %> />
                          <div>
                            <strong><%= p %></strong>
                            <div class="muted"><%= permLabels[p] || "" %></div>
                          </div>
                        </label>
                      <% }) %>
                    </div>

                    <div class="perm-actions">
                      <div class="inline-check">
                        <% if (isInactive) { %>
                          <span>×”×¢×•×‘×“ ××•×©×‘×ª â€” ×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ×”×¨×©××•×ª ×¢×“ ×œ×”×¤×¢×œ×”.</span>
                        <% } else { %>
                          <span>×©××•×¨ ××• ××¤×¡ ×œ×‘×¨×™×¨×ª ××—×“×œ ×œ×¤×™ ×ª×¤×§×™×“.</span>
                        <% } %>
                      </div>
                      <div style="display:flex; gap:8px; flex-wrap:wrap">
                        <button type="submit" class="btn sm" <%= isInactive ? "disabled" : "" %>>×©××•×¨ ×”×¨×©××•×ª</button>
                      </div>
                    </div>
                  </form>
                </div>
                <form method="post" action="/owner/staff/<%= s.id %>/permissions/reset" style="margin-top:8px">
                  <input type="hidden" name="redirectTo" value="/owner/staff" />
                  <button type="submit" class="btn ghost sm" <%= isInactive ? "disabled" : "" %>>××¤×¡ ×œ×‘×¨×™×¨×ª ××—×“×œ</button>
                </form>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  <% }) %>
</div>



<div class="sb-modal hidden" id="createStaffModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="createStaffTitle">
    <div class="dialog-hd">
      <div>
        <div style="font-size:16px;font-weight:800" id="createStaffTitle">â• ×”×•×¡×£ ×¢×•×‘×“</div>
        <div class="muted" style="margin-top:4px">×™×•×¦×¨ ××©×ª××© ×¢×•×‘×“ (staff) ×œ××¡×¢×“×” ×”× ×‘×—×¨×ª. ××™×Ÿ ×”×¨×©××” ×¦×™×‘×•×¨×™×ª ×œ×¢×•×‘×“×™×.</div>
      </div>
      <button type="button" class="btn ghost sm" id="btnCloseCreateStaff">âœ•</button>
    </div>

    <div class="dialog-bd">
      <div class="errbox" id="createStaffError"></div>

      <form id="createStaffForm">
        <div class="form-grid">
          <div class="field full">
            <label>××¡×¢×“×” (×—×•×‘×”)</label>

            <!-- âœ… MIN-FIX: no loops inside select -->
            <select name="restaurantId" required>
              <option value="">×‘×—×¨ ××¡×¢×“×”â€¦</option>
              <%~ (it.__restOptsHtml || "") %>
            </select>
          </div>

          <div class="field">
            <label>××™××™×™×œ (×—×•×‘×”)</label>
            <input name="email" type="email" autocomplete="email" placeholder="staff@restaurant.com" required />
          </div>

          <div class="field">
            <label>×ª×¤×§×™×“ (×—×•×‘×”)</label>

            <!-- âœ… MIN-FIX: no loops inside select -->
            <select name="role" required>
              <option value="">×‘×—×¨ ×ª×¤×§×™×“â€¦</option>
              <%~ (it.__roleOptsHtml || "") %>
            </select>
          </div>

          <div class="field full">
            <label>×¡×™×¡××” ×–×× ×™×ª (×—×•×‘×”)</label>
            <div style="display:flex; gap:10px; align-items:center">
              <input name="password" type="text" autocomplete="new-password" placeholder="×œ×¤×—×•×ª 8 ×ª×•×•×™×" minlength="8" required />
              <button type="button" class="btn sm" id="btnGenTempPass">Generate</button>
            </div>
            <div class="hint">××•××œ×¥ ×©×”×¢×•×‘×“ ×™×©× ×” ×¡×™×¡××” ××—×¨×™ ×›× ×™×¡×” (××• ×“×¨×š â€œ×©×›×—×ª×™ ×¡×™×¡××”â€).</div>
          </div>

          <div class="field">
            <label>×©× ×¤×¨×˜×™ (×¨×©×•×ª)</label>
            <input name="firstName" type="text" autocomplete="given-name" />
          </div>

          <div class="field">
            <label>×©× ××©×¤×—×” (×¨×©×•×ª)</label>
            <input name="lastName" type="text" autocomplete="family-name" />
          </div>

          <div class="field full">
            <label>×˜×œ×¤×•×Ÿ (×¨×©×•×ª)</label>
            <input name="phone" type="tel" autocomplete="tel" />
          </div>

          <div class="field full perm-panel">
            <label style="display:flex; align-items:center; gap:10px">
              <input type="checkbox" name="useDefaults" checked />
              <span>×”×©×ª××© ×‘×”×¨×©××•×ª ×‘×¨×™×¨×ª ××—×“×œ ×œ×¤×™ ×ª×¤×§×™×“</span>
            </label>

            <div id="permOverrideBox" style="display:none; margin-top:10px">
              <div class="muted" style="margin-bottom:8px">×‘×—×¨ ×”×¨×©××•×ª ×¡×¤×¦×™×¤×™×•×ª (××•×¤×¦×™×•× ×œ×™):</div>
              <div class="perm-grid">
                <% ((it.__permsSafe || [])).forEach(function(p){ %>
                  <label class="perm-item">
                    <input type="checkbox" name="permissions" value="<%= p %>" />
                    <div>
                      <strong><%= p %></strong>
                      <div class="muted"><%= permLabels[p] || "" %></div>
                    </div>
                  </label>
                <% }) %>
              </div>
              <div class="hint">×× ×œ× ×ª×‘×—×¨ ×”×¨×©××•×ª, ×™×™×©××¨×• ×”×¨×©××•×ª ×‘×¨×™×¨×ª ××—×“×œ.</div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="dialog-ft">
      <button type="button" class="btn ghost" id="btnCancelCreateStaff">×‘×™×˜×•×œ</button>
      <button type="submit" class="btn" form="createStaffForm" id="btnSubmitCreateStaff">×¦×•×¨ ×¢×•×‘×“</button>
    </div>
  </div>
</div>

<!-- Reset password link modal -->
<div class="sb-modal hidden" id="resetPwModal" style="z-index:1200">
  <div class="sb-modal__overlay" id="resetPwOverlay"></div>
  <div class="sb-modal__panel" style="max-width:640px">
    <div class="sb-modal__head">
      <div>
        <div class="sb-modal__title">×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××”</div>
        <div class="sb-modal__sub" id="resetPwSub">×¦×•×¨ ×§×™×©×•×¨ ×•×”×¢×ª×§ ×œ×¢×•×‘×“.</div>
      </div>
      <button class="btn icon" type="button" id="btnCloseResetPw" aria-label="Close">âœ•</button>
    </div>

    <div class="sb-modal__body">
      <div class="field">
        <label>×§×™×©×•×¨</label>
        <input id="resetPwLink" type="text" readonly value="" />
        <div style="display:flex; gap:8px; margin-top:10px">
          <button type="button" class="btn" id="btnCopyResetPw">×”×¢×ª×§</button>
          <button type="button" class="btn ghost" id="btnOpenResetPw">×¤×ª×—</button>
        </div>
        <div class="hint" style="margin-top:8px; opacity:.85">
          ××•××œ×¥ ×œ×©×œ×•×— ×œ×¢×•×‘×“ ××ª ×”×§×™×©×•×¨ ×‘×”×•×“×¢×” ×¤×¨×˜×™×ª. ×”×§×™×©×•×¨ ×—×“-×¤×¢××™.
        </div>
      </div>
      <div class="alert err hidden" id="resetPwErr"></div>
    </div>

    <div class="sb-modal__foot">
      <button type="button" class="btn ghost" id="btnCloseResetPw2">×¡×’×•×¨</button>
    </div>
  </div>
</div>


<div class="sb-modal hidden" id="auditModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="auditTitle">
    <div class="dialog-hd">
      <div>
        <div style="font-size:16px;font-weight:800" id="auditTitle">ğŸ§¾ ×œ×•×’ ×¤×¢×•×œ×•×ª</div>
        <div class="muted" style="margin-top:4px">××¦×™×’ ××ª ×”×¤×¢×•×œ×•×ª ×”××—×¨×•× ×•×ª ×©×‘×•×¦×¢×• ×‘××¡×š × ×™×”×•×œ ×¢×•×‘×“×™×.</div>
      </div>
      <button class="x" type="button" id="auditCloseBtn" aria-label="Close">âœ•</button>
    </div>

    <div class="dialog-bd">
      <div class="grid">
        <label>
          <div class="lbl">××¡×¢×“×”</div>

          <!-- âœ… MIN-FIX: no loops inside select -->
          <select id="auditRestaurantId" class="input">
            <%~ (it.__auditOptsHtml || "") %>
          </select>
        </label>

        <label>
          <div class="lbl">×›××•×ª</div>
          <input id="auditLimit" class="input" type="number" min="1" max="200" value="50" />
        </label>

        <div style="display:flex; gap:10px; align-items:flex-end">
          <button type="button" class="btn sm" id="auditRefreshBtn">×¨×¢× ×Ÿ</button>
        </div>
      </div>

      <div class="muted" id="auditHint" style="margin-top:10px"></div>
      <div class="alert err hidden" id="auditErr" style="margin-top:10px"></div>

      <div class="card" style="margin-top:12px; padding:0">
        <div style="padding:12px 14px; border-bottom:1px solid rgba(148,163,184,.18); font-weight:800">
          ××™×¨×•×¢×™× ××—×¨×•× ×™×
        </div>
        <div id="auditList" style="padding:10px 14px"></div>
      </div>
    </div>

    <div class="dialog-ft">
      <button class="btn ghost" type="button" id="auditCloseBtn2">×¡×’×•×¨</button>
    </div>
  </div>
  <div class="overlay" id="auditOverlay"></div>
</div>


<script>
(function(){
  const modal = document.getElementById("createStaffModal");
  const openBtn = document.getElementById("btnOpenCreateStaff");
  const closeBtn = document.getElementById("btnCloseCreateStaff");
  const cancelBtn = document.getElementById("btnCancelCreateStaff");
  const form = document.getElementById("createStaffForm");
  const errBox = document.getElementById("createStaffError");
  const genBtn = document.getElementById("btnGenTempPass");
  const permToggle = form.querySelector('input[name="useDefaults"]');
  const permBox = document.getElementById("permOverrideBox");
  const submitBtn = document.getElementById("btnSubmitCreateStaff");

  function showModal(){
    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden","false");
    errBox.style.display="none";
    errBox.textContent="";
    // focus first field
    const sel = form.querySelector('select[name="restaurantId"]');
    if (sel) sel.focus();
  }
  function hideModal(){
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden","true");
  }
  function showError(msg){
    errBox.textContent = msg || "×©×’×™××” ×œ× ×™×“×•×¢×”";
    errBox.style.display="block";
  }
  function genPass(){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";
    let out = "";
    for(let i=0;i<12;i++){
      out += chars[Math.floor(Math.random()*chars.length)];
    }
    const inp = form.querySelector('input[name="password"]');
    inp.value = out;
    inp.focus();
    inp.select();
  }
  function setPermUi(){
    const useDefaults = !!permToggle.checked;
    permBox.style.display = useDefaults ? "none" : "block";
  }

  if(openBtn) openBtn.addEventListener("click", showModal);
  if(closeBtn) closeBtn.addEventListener("click", hideModal);
  if(cancelBtn) cancelBtn.addEventListener("click", hideModal);
  if(modal) modal.addEventListener("click", (e)=>{ if(e.target === modal) hideModal(); });
  if(genBtn) genBtn.addEventListener("click", genPass);
  if(permToggle) permToggle.addEventListener("change", setPermUi);
  setPermUi();

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    errBox.style.display="none";
    errBox.textContent="";
    submitBtn.disabled = true;
    submitBtn.textContent = "×™×•×¦×¨â€¦";

    try{
      const fd = new FormData(form);
      const useDefaults = fd.get("useDefaults") === "on";
      const permissions = [];
      if(!useDefaults){
        form.querySelectorAll('input[name="permissions"]:checked').forEach((x)=>permissions.push(x.value));
      }

      const payload = {
        restaurantId: String(fd.get("restaurantId")||""),
        email: String(fd.get("email")||"").trim(),
        password: String(fd.get("password")||""),
        firstName: String(fd.get("firstName")||"").trim() || undefined,
        lastName: String(fd.get("lastName")||"").trim() || undefined,
        phone: String(fd.get("phone")||"").trim() || undefined,
        role: String(fd.get("role")||""),
        useDefaults: useDefaults,
        permissions: permissions
      };

      const res = await fetch("/owner/staff/create", {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "accept": "application/json"
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>null);

      if(!res.ok || !data || data.ok !== true){
        const err = (data && (data.error || data.message)) ? (data.error || data.message) : ("HTTP " + res.status);
        const map = {
          "email_required": "×—×•×‘×” ×œ×”×–×™×Ÿ ××™××™×™×œ.",
          "password_too_short": "×”×¡×™×¡××” ×§×¦×¨×” ××“×™ (××™× ×™××•× 8).",
          "role_invalid": "×ª×¤×§×™×“ ×œ× ×ª×§×™×Ÿ.",
          "restaurant_required": "×—×•×‘×” ×œ×‘×—×•×¨ ××¡×¢×“×”.",
          "not_your_restaurant": "××™×Ÿ ×œ×š ×”×¨×©××” ×œ××¡×¢×“×” ×”×–×•.",
          "user_email_in_use": "×”××™××™×™×œ ×”×–×” ×›×‘×¨ ×©×™×™×š ×œ×œ×§×•×—/×‘×¢×œ×™×. ×‘×—×¨ ××™××™×™×œ ××—×¨.",
          "staff_exists": "×œ×¢×•×‘×“ ×”×–×” ×›×‘×¨ ×™×© ×©×™×•×š ×œ××¡×¢×“×” ×”×–×•.",
          "invalid_body": "×§×œ×˜ ×œ× ×ª×§×™×Ÿ."
        };
        showError(map[err] || ("×©×’×™××”: " + err));
        submitBtn.disabled = false;
        submitBtn.textContent = "×¦×•×¨ ×¢×•×‘×“";
        return;
      }

      hideModal();
      // refresh to show new staff in list
      window.location.reload();
    }catch(ex){
      showError(String(ex));
      submitBtn.disabled = false;
      submitBtn.textContent = "×¦×•×¨ ×¢×•×‘×“";
    }
  });

  

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Password reset link (Owner â†’ Staff) â”€â”€â”€â”€â”€â”€â”€â”€â”€
const resetModal = document.getElementById("resetPwModal");
const resetOverlay = document.getElementById("resetPwOverlay");
const resetCloseBtn = document.getElementById("btnCloseResetPw");
const resetCloseBtn2 = document.getElementById("btnCloseResetPw2");
const resetSub = document.getElementById("resetPwSub");
const resetLinkInput = document.getElementById("resetPwLink");
const resetErr = document.getElementById("resetPwErr");
const btnCopy = document.getElementById("btnCopyResetPw");
const btnOpen = document.getElementById("btnOpenResetPw");

function showResetErr(msg){
  resetErr.textContent = msg;
  resetErr.classList.remove("hidden");
}
function clearResetErr(){
  resetErr.textContent = "";
  resetErr.classList.add("hidden");
}
function openResetModal(){
  clearResetErr();
  resetModal.classList.remove("hidden");
}
function closeResetModal(){
  resetModal.classList.add("hidden");
}

window.openResetLinkModal = async function(staffId, email){
  try{
    clearResetErr();
    resetSub.textContent = "×™×•×¦×¨ ×§×™×©×•×¨ ×¢×‘×•×¨: " + (email || "");
    resetLinkInput.value = "×˜×•×¢×Ÿ...";
    openResetModal();

    const res = await fetch(`/owner/staff/${staffId}/password-reset-link`, {
      method: "POST",
      headers: { "Accept": "application/json" }
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok || !data || !data.ok){
      const err = (data && data.error) ? data.error : "unknown";
      const map = {
        "staff_not_found": "×”×¢×•×‘×“ ×œ× × ××¦×.",
        "not_your_restaurant": "××™×Ÿ ×œ×š ×”×¨×©××” ×œ××¡×¢×“×” ×”×–×•.",
        "user_not_found": "×”××©×ª××© ×œ× × ××¦×.",
        "non_local_user": "×œ× × ×™×ª×Ÿ ×œ××¤×¡ ×¡×™×¡××” ×œ××©×ª××© ×©××™× ×• Local.",
        "unknown": "×©×’×™××” ×œ× ×™×“×•×¢×”."
      };
      resetLinkInput.value = "";
      showResetErr(map[err] || ("×©×’×™××”: " + err));
      return;
    }

    const relative = String(data.resetUrl || "");
    const full = relative.startsWith("http") ? relative : (window.location.origin + relative);
    resetLinkInput.value = full;
  }catch(ex){
    resetLinkInput.value = "";
    showResetErr(String(ex));
  }
};

resetOverlay.addEventListener("click", closeResetModal);
resetCloseBtn.addEventListener("click", closeResetModal);
resetCloseBtn2.addEventListener("click", closeResetModal);

btnCopy.addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(resetLinkInput.value || "");
    btnCopy.textContent = "×”×•×¢×ª×§!";
    setTimeout(()=>btnCopy.textContent="×”×¢×ª×§", 900);
  }catch{
    showResetErr("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§. ××¤×©×¨ ×œ×¡××Ÿ ×•×œ×”×¢×ª×™×§ ×™×“× ×™×ª.");
  }
});
btnOpen.addEventListener("click", ()=>{
  const v = resetLinkInput.value || "";
  if(v) window.open(v, "_blank");
});

// ESC closes
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && !modal.classList.contains("hidden")) hideModal();
  });
})();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Audit modal (7.4 UI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function(){
  const auditModal = document.getElementById("auditModal");
  const auditOverlay = document.getElementById("auditOverlay");
  const btnOpenAudit = document.getElementById("btnOpenAudit");
  const btnClose1 = document.getElementById("auditCloseBtn");
  const btnClose2 = document.getElementById("auditCloseBtn2");
  const selRid = document.getElementById("auditRestaurantId");
  const inpLimit = document.getElementById("auditLimit");
  const btnRefresh = document.getElementById("auditRefreshBtn");
  const list = document.getElementById("auditList");
  const err = document.getElementById("auditErr");
  const hint = document.getElementById("auditHint");

  function open(){
    if(!auditModal) return;
    auditModal.classList.remove("hidden");
    auditModal.setAttribute("aria-hidden","false");
  }
  function close(){
    if(!auditModal) return;
    auditModal.classList.add("hidden");
    auditModal.setAttribute("aria-hidden","true");
  }
  function showErr(msg){
    err.textContent = msg || "";
    err.classList.toggle("hidden", !msg);
  }
  function setHint(msg){
    hint.textContent = msg || "";
  }

  function renderEvents(events){
    if(!Array.isArray(events) || !events.length){
      list.innerHTML = `<div class="muted" style="padding:10px 0">××™×Ÿ ××™×¨×•×¢×™× ×œ×”×¦×’×”.</div>`;
      return;
    }

    const rows = events.map(e=>{
      const when = e && e.ts ? new Date(e.ts).toLocaleString("he-IL") : "";
      const actor = e && e.actorEmail ? e.actorEmail : (e && e.actorUserId ? e.actorUserId : "");
      const action = e && e.action ? e.action : "";
      const target = e && (e.targetId || e.targetType) ? `${e.targetType || ""} ${e.targetId || ""}`.trim() : "";
      let meta = "";
      if(e && e.meta){
        try{
          const s = JSON.stringify(e.meta);
          meta = s.length > 280 ? (s.slice(0, 280) + "â€¦") : s;
        }catch{}
      }

      return `
        <div style="padding:12px 0; border-bottom:1px solid rgba(148,163,184,.14)">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:baseline">
            <div style="font-weight:800">${action}</div>
            <div class="pill sm">${when}</div>
            ${actor ? `<div class="pill sm">by <b>${escapeHtml(actor)}</b></div>` : ``}
            ${target ? `<div class="pill sm">target <b>${escapeHtml(target)}</b></div>` : ``}
          </div>
          ${meta ? `<div class="muted" style="margin-top:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; white-space:pre-wrap">${escapeHtml(meta)}</div>` : ``}
        </div>
      `;
    }).join("");

    list.innerHTML = `<div>${rows}</div>`;
  }

  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  async function refresh(){
    const restaurantId = selRid && selRid.value ? selRid.value : "";
    const limit = Math.max(1, Math.min(200, parseInt(inpLimit.value || "50",10) || 50));
    inpLimit.value = String(limit);

    showErr("");
    setHint("×˜×•×¢×Ÿâ€¦");
    list.innerHTML = "";

    try{
      const url = `/owner/staff/audit?restaurantId=${encodeURIComponent(restaurantId)}&limit=${encodeURIComponent(String(limit))}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || !data.ok){
        const msg = data && (data.message || data.error) ? (data.message || data.error) : `HTTP ${res.status}`;
        setHint("");
        showErr(String(msg));
        return;
      }
      setHint(`××¦×™×’ ${data.events?.length || 0} ××™×¨×•×¢×™× ××—×¨×•× ×™×.`);
      renderEvents(data.events || []);
    }catch(ex){
      setHint("");
      showErr(String(ex));
    }
  }

  if(btnOpenAudit){
    btnOpenAudit.addEventListener("click", ()=>{
      open();
      refresh();
    });
  }
  if(btnRefresh) btnRefresh.addEventListener("click", refresh);
  if(btnClose1) btnClose1.addEventListener("click", close);
  if(btnClose2) btnClose2.addEventListener("click", close);
  if(auditOverlay) auditOverlay.addEventListener("click", close);

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && auditModal && !auditModal.classList.contains("hidden")) close();
  });
})();

</script>
