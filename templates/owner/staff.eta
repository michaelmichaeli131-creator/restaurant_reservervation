<% layout("../_layout", it) %>

<style>
  /* Match existing owner pages look (see owner_bills.eta style) */
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}

  .card{
    background: var(--panel,#121622);
    border:1px solid var(--bd,#222834);
    border-radius:18px;
    padding:18px;
    margin-bottom:18px;
    color: var(--ink,#e6e8ef);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }

  .owner-hd{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
  }

  .owner-hd h1{
    margin:0;
    font-size:18px;        /* smaller like other owner pages */
    line-height:1.2;
    letter-spacing:.2px;
  }
  .owner-hd .muted{
    color:var(--ink-muted,#9aa3b2);
    font-size:13px;
    line-height:1.35;
    margin-top:6px;
  }

  .pill-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(15,23,42,.55);
    color:var(--ink,#e6e8ef);
  }
  .pill b{font-weight:700}

  .grid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
    margin-top:14px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }

  .section-title{
    display:flex;align-items:baseline;justify-content:space-between;
    gap:12px;margin:0 0 8px 0;
  }
  .section-title h2{
    margin:0;
    font-size:14px;
    letter-spacing:.2px;
  }
  .section-title .muted{font-size:12px;color:var(--ink-muted,#9aa3b2)}

  .table-wrap{
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.35);
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px; /* compact */
  }
  thead tr{background:rgba(15,23,42,.85)}
  th, td{
    padding:8px 10px;
    text-align:right;
    border-bottom:1px solid rgba(148,163,184,.18);
    vertical-align:top;
    white-space:nowrap;
  }
  tbody tr:hover{background:rgba(59,130,246,.08)}

  .actions{white-space:nowrap}
  .actions .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

  /* Cards for approved staff */
  .cards{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  .staff-card{
    border-radius:16px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.35);
    padding:14px;
  }
  .staff-hd{
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:flex-start;
    margin-bottom:10px;
  }
  .staff-name{
    margin:0;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .avatar{
    width:28px;height:28px;border-radius:10px;
    display:inline-flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg, rgba(245,158,11,.25), rgba(59,130,246,.18));
    border:1px solid rgba(148,163,184,.22);
    font-weight:700;
    font-size:12px;
    color:var(--ink,#e6e8ef);
  }
  .staff-meta{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .tag{
    font-size:12px;
    padding:5px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.65);
    color:var(--ink,#e6e8ef);
  }

  /* Permissions */
  .perm-title{
    margin:10px 0 8px 0;
    font-size:13px;
    color:var(--ink,#e6e8ef);
  }
  .perm-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px 10px;
  }
  @media (max-width: 680px){
    .perm-grid{grid-template-columns:1fr}
  }
  .perm-item{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.16);
    background:rgba(2,6,23,.25);
  }
  .perm-item input{margin-top:2px}
  .perm-item strong{font-size:12.5px}
  .perm-actions{
    margin-top:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .inline-check{
    display:flex;
    gap:8px;
    align-items:center;
    color:var(--ink-muted,#9aa3b2);
    font-size:12px;
  }

  /* Empty state */
  .empty{
    text-align:center;
    padding:26px 16px;
  }
  .empty .icon{font-size:28px;margin-bottom:8px}
  .empty h2{margin:0 0 6px 0;font-size:16px}
  .empty p{margin:0 0 14px 0;color:var(--ink-muted,#9aa3b2);font-size:13px}
</style>

<%
  const owner = it.owner;
  const restaurantsData = it.restaurantsData || [];
  const allPermissions = it.allPermissions || [];

  const permLabels = {
    "pos.waiter": "POS - ××œ×¦×¨ (×§×œ×™×˜×ª ×”×–×× ×•×ª ×•×˜×™×¤×•×œ ×‘×©×•×œ×—× ×•×ª)",
    "pos.kitchen": "POS - ××˜×‘×— (××¡×š ×”×–×× ×•×ª ×œ××˜×‘×—/×‘×¨)",
    "host.seating": "×××¨×—×ª - ×”×©××ª ×©×•×œ×—× ×•×ª ×•× ×™×”×•×œ ×¨×¦×¤×ª ×”××¡×¢×“×”",
    "reservations.view": "×¦×¤×™×™×” ×‘×”×–×× ×•×ª ×œ××¡×¢×“×”",
    "reservations.manage": "× ×™×”×•×œ ×”×–×× ×•×ª (××™×©×•×¨/×‘×™×˜×•×œ/×¢×“×›×•×Ÿ)",
    "floor.view": "×¦×¤×™×™×” ×‘××¤×ª ×”×©×•×œ×—× ×•×ª",
    "floor.edit": "×¢×¨×™×›×ª ××¤×ª ×©×•×œ×—× ×•×ª",
    "shifts.view": "×¦×¤×™×™×” ×‘××©××¨×•×ª",
    "shifts.manage": "× ×™×”×•×œ ××©××¨×•×ª (×©×™×‘×•×¥, ×©×™× ×•×™, ×‘×™×˜×•×œ)",
    "inventory.view": "×¦×¤×™×™×” ×‘××œ××™ ×•×—×•××¨×™ ×’×œ×",
    "inventory.manage": "× ×™×”×•×œ ××œ××™ (×¢×“×›×•×Ÿ, ×”×–×× ×•×ª, ×”×ª×××•×ª)",
    "reports.view": "×¦×¤×™×™×” ×‘×“×•×—×•×ª (××›×™×¨×•×ª, ×ª×¤×•×¡×” ×•×›×•')",
    "menu.manage": "× ×™×”×•×œ ×ª×¤×¨×™×˜ (×× ×•×ª, ××—×™×¨×™×, ×–××™× ×•×ª)"
  };
%>

<div class="sb-owner container">
  <div class="card">
    <div class="owner-hd">
      <div>
        <h1>ğŸ‘¥ × ×™×”×•×œ ×¢×•×‘×“×™×</h1>
        <div class="muted">
          ×××©×¨×™× ×¢×•×‘×“×™×, ××˜×¤×œ×™× ×‘×‘×§×©×•×ª ×”×¦×˜×¨×¤×•×ª ×•××’×“×™×¨×™× ×”×¨×©××•×ª ×œ×¤×™ ××–×•×¨×™× ×‘××¢×¨×›×ª.
        </div>
      </div>
      <div class="pill-row">
        <span class="pill">×‘×¢×œ×™×: <b><%= owner?.firstName %> <%= owner?.lastName %></b></span>
        <span class="pill">××™××™×™×œ: <b><%= owner?.email %></b></span>
      </div>
    </div>
  </div>

  <% if (!restaurantsData.length) { %>
    <div class="card empty">
      <div class="icon">ğŸ½ï¸</div>
      <h2>××™×Ÿ ××¡×¢×“×•×ª ××©×•×™×›×•×ª ×œ×—×©×‘×•×Ÿ ×©×œ×š ×¢×“×™×™×Ÿ</h2>
      <p>×›×“×™ ×œ× ×”×œ ×¢×•×‘×“×™×, ×§×•×“× ×¦×•×¨ ××¡×¢×“×” ×‘××¢×¨×›×ª.</p>
      <a href="/owner/restaurants/new" class="btn">+ ×™×¦×™×¨×ª ××¡×¢×“×” ×—×“×©×”</a>
    </div>
  <% } %>

  <% restaurantsData.forEach(function(block) {
       const restaurant = block.restaurant;
       const staff = block.staff || [];
       const pending = block.pending || [];
       const signupRequests = block.signupRequests || [];
  %>
    <div class="card">
      <div class="owner-hd" style="margin-bottom:14px">
        <div>
          <h1 style="font-size:16px;margin:0"><%= restaurant.name %></h1>
          <div class="muted"><%= restaurant.city %> Â· <%= restaurant.address %></div>
        </div>
        <div class="pill-row">
          <span class="pill">×××•×©×¨×™×: <b><%= staff.length %></b></span>
          <span class="pill">pending (staff_db): <b><%= pending.length %></b></span>
          <span class="pill">self-signup: <b><%= signupRequests.length %></b></span>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT: pending + signup requests -->
        <div>
          <!-- Pending staff_db -->
          <div style="margin-bottom:14px">
            <div class="section-title">
              <h2>×××ª×™× ×™× ×œ××™×©×•×¨ (staff_db)</h2>
              <% if (!pending.length) { %><span class="muted">××™×Ÿ ×‘×§×©×•×ª ×›×¨×’×¢</span><% } %>
            </div>

            <% if (pending.length) { %>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>×©×</th>
                      <th>×ª×¤×§×™×“</th>
                      <th>××™××™×™×œ</th>
                      <th>×˜×œ×¤×•×Ÿ</th>
                      <th>× ×¨×©×</th>
                      <th class="actions">×¤×¢×•×œ×•×ª</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% pending.forEach(function(s){ %>
                      <tr>
                        <td><%= s.firstName %> <%= s.lastName %></td>
                        <td><%= s.role %></td>
                        <td><%= s.email %></td>
                        <td><%= s.phone || "-" %></td>
                        <td><%= s.createdAt ? new Date(s.createdAt).toLocaleString("he-IL") : "-" %></td>
                        <td class="actions">
                          <div class="row">
                            <form method="post" action="/owner/staff/<%= s.id %>/approve">
                              <input type="hidden" name="redirectTo" value="/owner/staff" />
                              <input type="hidden" name="useDefaults" value="on" />
                              <button type="submit" class="btn sm">âœ“ ××™×©×•×¨</button>
                            </form>
                            <form method="post" action="/owner/staff/<%= s.id %>/reject">
                              <input type="hidden" name="redirectTo" value="/owner/staff" />
                              <button type="submit" class="btn ghost sm">âœ• ×“×—×™×™×”</button>
                            </form>
                          </div>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } %>
          </div>

          <!-- Signup requests -->
          <div>
            <div class="section-title">
              <h2>×‘×§×©×•×ª ×”×¦×˜×¨×¤×•×ª (self-signup)</h2>
              <% if (!signupRequests.length) { %><span class="muted">××™×Ÿ ×‘×§×©×•×ª ×›×¨×’×¢</span><% } %>
            </div>

            <% if (signupRequests.length) { %>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>×©×</th>
                      <th>×ª×¤×§×™×“</th>
                      <th>××™××™×™×œ</th>
                      <th>×˜×œ×¤×•×Ÿ</th>
                      <th>× ×©×œ×—</th>
                      <th>×¡×˜×˜×•×¡</th>
                      <th class="actions">×¤×¢×•×œ×•×ª</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% signupRequests.forEach(function(entry){
                         const req = entry.request;
                         const user = entry.user || {};
                    %>
                      <tr>
                        <td><%= user.firstName || "-" %> <%= user.lastName || "" %></td>
                        <td><%= req.staffRole %></td>
                        <td><%= user.email || req.userEmail || "-" %></td>
                        <td><%= user.phone || req.userPhone || "-" %></td>
                        <td><%= req.createdAt ? new Date(req.createdAt).toLocaleString("he-IL") : "-" %></td>
                        <td><%= req.status %></td>
                        <td class="actions">
                          <div class="row">
                            <form method="post" action="/owner/staff-signup/<%= req.id %>/approve">
                              <input type="hidden" name="redirectTo" value="/owner/staff" />
                              <button type="submit" class="btn sm">âœ“ ××©×¨</button>
                            </form>
                            <form method="post" action="/owner/staff-signup/<%= req.id %>/reject">
                              <input type="hidden" name="redirectTo" value="/owner/staff" />
                              <button type="submit" class="btn ghost sm">âœ• ×“×—×”</button>
                            </form>
                          </div>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } %>
          </div>
        </div>

        <!-- RIGHT: approved staff + permissions -->
        <div>
          <div class="section-title">
            <h2>×¢×•×‘×“×™× ×××•×©×¨×™× ×•×”×¨×©××•×ª</h2>
            <% if (!staff.length) { %><span class="muted">××™×Ÿ ×¢×•×‘×“×™× ×××•×©×¨×™×</span><% } %>
          </div>

          <% if (staff.length) { %>
            <div class="cards">
              <% staff.forEach(function(s){ %>
                <div class="staff-card">
                  <div class="staff-hd">
                    <div>
                      <div class="staff-name">
                        <span class="avatar"><%= (s.firstName || " ")[0] %></span>
                        <span><%= s.firstName %> <%= s.lastName %></span>
                      </div>
                      <div class="muted" style="margin-top:4px;font-size:12px">
                        ×ª×¤×§×™×“: <b><%= s.role %></b> Â· ××™××™×™×œ: <%= s.email %> Â· ×˜×œ×¤×•×Ÿ: <%= s.phone || "-" %>
                      </div>
                    </div>
                    <div class="staff-meta">
                      <span class="tag">status: <b><%= s.status %></b></span>
                      <span class="tag">approval: <b><%= s.approvalStatus %></b></span>
                    </div>
                  </div>

                  <div class="perm-title">×”×¨×©××•×ª</div>
                  <form method="post" action="/owner/staff/<%= s.id %>/permissions">
                    <input type="hidden" name="redirectTo" value="/owner/staff" />

                    <div class="perm-grid">
                      <%
                        const currentPerms = s.permissions || [];
                        allPermissions.forEach(function(p){
                          const checked = currentPerms.includes(p);
                      %>
                        <label class="perm-item">
                          <input type="checkbox" name="permissions" value="<%= p %>" <%= checked ? "checked" : "" %> />
                          <span><strong><%= permLabels[p] || p %></strong></span>
                        </label>
                      <% }) %>
                    </div>

                    <div class="perm-actions">
                      <label class="inline-check">
                        <input type="checkbox" name="resetToDefaults" />
                        <span>××™×¤×•×¡ ×œ×‘×¨×™×¨×ª ××—×“×œ ×œ×¤×™ ×ª×¤×§×™×“</span>
                      </label>

                      <button type="submit" class="btn sm">ğŸ’¾ ×©××•×¨</button>
                    </div>
                  </form>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  <% }) %>
</div>
