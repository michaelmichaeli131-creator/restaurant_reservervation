<% layout("_layout", it) %>

<%
  function tt(k, fb){
    try{
      if (it && typeof it.t==='function'){
        const s = it.t(k);
        if(!s || s===k || s===`(${k})`) return fb;
        return s;
      }
    }catch(e){}
    return fb;
  }

  const restaurant    = it.restaurant || {};
  const ingredients   = Array.isArray(it.ingredients) ? it.ingredients : [];
  const monthKey      = it.monthKey || '';
  const summary       = it.summary || {};
  const daily         = Array.isArray(it.daily) ? it.daily : [];
  const topIngredients = Array.isArray(it.topIngredients) ? it.topIngredients : [];

  const override      = it.override || null; // { overrideTotal, note } | null

  function num(n, digits=2){
    const x = Number(n || 0);
    if(!Number.isFinite(x)) return '0';
    return x.toFixed(digits);
  }

  const hasOverride = override && typeof override.overrideTotal === 'number' && Number.isFinite(override.overrideTotal);
%>

<main class="sb-owner container sb-owner-page" aria-label="<%= tt('owner.costs.title', 'Raw Material Costs') %>">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1><%= tt('owner.costs.title', 'Raw Material Costs') %> Â· <%= restaurant.name || tt('common.restaurant', 'Restaurant') %></h1>
        <p class="muted">
          <%= tt('owner.costs.description', 'Costs are calculated <strong>automatically</strong> from inventory movements of type <code>delivery</code> that have a <code>costTotal</code>.') %>
          <% if (hasOverride) { %>
            <span class="pill warn" title="<%= tt('owner.costs.override_active_hint', 'Manual override is active for this month') %>"><%= tt('owner.costs.override_active', 'Override active') %></span>
          <% } %>
        </p>
      </div>
      <div class="actions">
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/stock">â¬… <%= tt('owner.costs.btn_stock', 'Raw Materials Inventory') %></a>
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/recipes">ðŸ§¾ <%= tt('owner.costs.btn_recipes', 'Recipes') %></a>
      </div>
    </header>

    <%~ include("components/_owner_tabs", { restaurant, active: "inventory", t: it.t }) %>


    <div class="costs-top">
      <div class="panel card">
        <form method="get" action="/owner/<%= restaurant.id %>/inventory/costs" class="row">
          <label class="lbl">
            <%= tt('owner.costs.month', 'Month') %>
            <input name="month" value="<%= monthKey %>" placeholder="YYYY-MM" inputmode="numeric" />
          </label>
          <button class="btn primary sm" type="submit"><%= tt('owner.costs.btn_show', 'Show') %></button>
        </form>

        <div class="stats">
          <div class="stat">
            <div class="k"><%= tt('owner.costs.total_monthly', 'Total Monthly Spend') %></div>
            <div class="v">
              <%= tt('common.currency', 'â‚ª') %> <%= num(summary.totalSpend, 2) %>
              <% if (hasOverride) { %>
                <span class="badge warn" title="<%= tt('owner.costs.override_manual_hint', 'Amount entered manually, overrides calculation') %>">Override</span>
              <% } %>
            </div>
            <% if (hasOverride) { %>
              <div class="muted small" style="margin-top:4px">
                <%= tt('owner.costs.auto_computed', 'Auto-computed') %>: <%= tt('common.currency', 'â‚ª') %> <%= num(summary.computedTotal, 2) %>
              </div>
            <% } %>
          </div>

          <div class="stat">
            <div class="k"><%= tt('owner.costs.deliveries_with_cost', 'Deliveries with Cost') %></div>
            <div class="v"><%= Number(summary.deliveriesWithCost || 0) %></div>
            <% if (Number(summary.deliveriesMissingCost || 0) > 0) { %>
              <div class="muted small" style="margin-top:4px">
                <%= tt('owner.costs.missing_cost', 'Missing costTotal in') %> <%= Number(summary.deliveriesMissingCost) %> <%= tt('owner.costs.deliveries', 'deliveries') %>
              </div>
            <% } %>
          </div>

          <div class="stat">
            <div class="k"><%= tt('owner.costs.avg_per_delivery', 'Average Cost per Delivery') %></div>
            <div class="v"><%= tt('common.currency', 'â‚ª') %> <%= num(summary.avgPerDelivery, 2) %></div>
          </div>
        </div>

        <div class="spark">
          <div class="spark-hd">
            <span class="muted small"><%= tt('owner.costs.daily_spend', 'Daily Spend (Sparkline)') %></span>
            <span class="muted small">Max day: <%= tt('common.currency', 'â‚ª') %> <%= num(summary.maxDaily, 2) %></span>
          </div>
          <svg id="spark-svg" viewBox="0 0 300 60" preserveAspectRatio="none" aria-label="<%= tt('owner.costs.daily_spend_chart', 'Daily spend chart') %>"></svg>
        </div>

        <details class="override">
          <summary>
            <span><%= tt('owner.costs.override_monthly', 'Monthly Override (explicit â€” overrides auto)') %></span>
            <% if (hasOverride) { %><span class="pill warn"><%= tt('owner.costs.override_on', 'Active') %></span><% } else { %><span class="pill"><%= tt('owner.costs.override_off', 'Off') %></span><% } %>
          </summary>

          <form method="post" action="/owner/<%= restaurant.id %>/inventory/costs/override" class="form" style="margin-top:10px">
            <input type="hidden" name="month" value="<%= monthKey %>">

            <label class="lbl2">
              <%= tt('owner.costs.override_amount_label', 'Manual amount (â‚ª) â€” leave empty to revert to auto') %>
              <input
                class="in"
                name="overrideTotal"
                type="number"
                step="0.01"
                min="0"
                placeholder="<%= tt('owner.costs.override_placeholder', 'Leave empty = auto') %>"
                value="<%= hasOverride ? String(override.overrideTotal) : '' %>"
              />
            </label>

            <label class="lbl2">
              <%= tt('owner.costs.override_note_label', 'Note (optional)') %>
              <input class="in" name="note" placeholder="<%= tt('owner.costs.override_note_placeholder', 'e.g.: correction / irregular invoice') %>" value="<%= (override && override.note) ? String(override.note) : '' %>">
            </label>

            <div class="actions" style="margin-top:10px">
              <button class="btn primary sm" type="submit"><%= tt('owner.costs.btn_save_override', 'Save Override') %></button>
              <button class="btn ghost sm" type="submit" name="overrideTotal" value=""><%= tt('owner.costs.btn_reset_override', 'Reset Override') %></button>
            </div>

            <p class="muted small" style="margin-top:8px">
              <%= tt('owner.costs.override_warning', 'Override is saved only if you enter a number. If left empty and saved â€” reverts to auto calculation.') %>
            </p>
          </form>
        </details>
      </div>

      <div class="panel card">
        <h2 class="card-title"><%= tt('owner.costs.top_ingredients', 'Top Ingredients by Monthly Spend') %></h2>

        <% if (!topIngredients.length) { %>
          <p class="muted"><%= tt('owner.costs.no_cost_data', 'No cost data for this month yet (no deliveries with costTotal).') %></p>
        <% } else { %>
          <div class="top-list">
            <% const max = Math.max.apply(null, topIngredients.map(x => Number(x.spend||0)).concat([1])); %>
            <% topIngredients.forEach(function(x){
                 const pct = Math.max(2, Math.min(100, (Number(x.spend||0) / max) * 100));
            %>
              <div class="top-row">
                <div class="top-meta">
                  <div class="top-name"><strong><%= x.name %></strong></div>
                  <div class="top-sub muted small"><%= tt('common.currency', 'â‚ª') %> <%= num(x.spend, 2) %></div>
                </div>
                <div class="bar" aria-label="bar">
                  <div class="bar-fill" style="width:<%= pct %>%"></div>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>

    <div class="panel card" style="margin-top:16px">
      <h2 class="card-title"><%= tt('owner.costs.unit_price_title', 'Unit Price for Ingredients') %></h2>
      <p class="muted small">
        <%= tt('owner.costs.unit_price_desc', 'The <strong>unit price</strong> field is used for food cost calculation per dish. Leave empty for no manual override.') %>
      </p>

      <% if (!ingredients.length) { %>
        <p class="muted"><%= tt('owner.costs.no_ingredients', 'No ingredients yet. Go to the inventory page to add ingredients.') %></p>
      <% } else { %>
        <div class="table">
          <div class="tr th">
            <div><%= tt('owner.costs.tbl_ingredient', 'Ingredient') %></div>
            <div><%= tt('owner.costs.tbl_unit', 'Unit') %></div>
            <div><%= tt('owner.costs.tbl_unit_price', 'Unit Price (Manual Override)') %></div>
            <div></div>
          </div>

          <% ingredients.forEach(function(ing){ %>
            <form class="tr" method="post" action="/owner/<%= restaurant.id %>/inventory/costs/ingredient/<%= ing.id %>">
              <div class="td">
                <div class="name"><strong><%= ing.name %></strong></div>
                <div class="muted small">
                  <%= tt('owner.costs.in_stock', 'In stock') %>: <%= Number(ing.currentQty || 0) %> â€¢ <%= tt('owner.costs.min_threshold', 'Min') %>: <%= Number(ing.minQty || 0) %>
                  <% if (typeof ing.costPerUnitAuto === 'number' && Number.isFinite(ing.costPerUnitAuto)) { %>
                    â€¢ AUTO: <%= tt('common.currency', 'â‚ª') %> <%= num(ing.costPerUnitAuto, 2) %> / <%= ing.unit || 'unit' %>
                  <% } %>
                </div>
              </div>

              <div class="td">
                <span class="pill"><%= ing.unit || 'unit' %></span>
              </div>

              <div class="td">
                <input
                  class="in"
                  name="costPerUnit"
                  type="number"
                  step="0.01"
                  min="0"
                  placeholder="<%= tt('owner.costs.unit_price_placeholder', 'e.g.: 12.50 (empty = no override)') %>"
                  value="<%= (typeof ing.costPerUnit === 'number' ? String(ing.costPerUnit) : '') %>"
                />
                <div class="muted small"><%= tt('common.currency', 'â‚ª') %> / <%= ing.unit || 'unit' %></div>
              </div>

              <div class="td right">
                <input type="hidden" name="month" value="<%= monthKey %>">
                <button class="btn primary sm" type="submit"><%= tt('common.btn_save', 'Save') %></button>
              </div>
            </form>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>
</main>

<script>
  (function(){
    // daily data must be valid JS
    var daily = <%- JSON.stringify(daily || []) %>;
    var svg = document.getElementById('spark-svg');
    if(!svg || !Array.isArray(daily) || !daily.length) return;

    var w = 300, h = 60, pad = 6;
    var max = 0;
    for(var i=0;i<daily.length;i++){
      var v = Number(daily[i].total || 0);
      if(v > max) max = v;
    }
    if(!(max > 0)) max = 1;

    function x(i){ return pad + (i * (w - pad*2) / Math.max(1, daily.length-1)); }
    function y(v){
      var t = Number(v || 0);
      var yy = pad + (1 - (t/max)) * (h - pad*2);
      return Math.max(pad, Math.min(h-pad, yy));
    }

    var d = "";
    for(var i=0;i<daily.length;i++){
      var px = x(i);
      var py = y(daily[i].total);
      d += (i===0 ? "M" : "L") + px.toFixed(2) + " " + py.toFixed(2) + " ";
    }

    svg.innerHTML =
      '<path d="'+d+'" fill="none" stroke="rgba(59,130,246,.95)" stroke-width="2.2" stroke-linecap="round"/>' +
      '<path d="'+d+' L '+(w-pad)+' '+(h-pad)+' L '+pad+' '+(h-pad)+' Z" fill="rgba(59,130,246,.10)"/>';
  })();
</script>

