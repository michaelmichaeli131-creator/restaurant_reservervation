<% layout("_layout", it) %>

<%
// tt: ×ª×¨×’×•× ×¢× fallback ×××™×ª×™ (×× it.t ××—×–×™×¨ "(key)" ××• ××—×¨×•×–×ª ×¨×™×§×”)
function tt(k, fb){
  try{
    if (it && typeof it.t==='function'){
      const s = it.t(k);
      if(!s || s===k || s===`(${k})`) return fb;
      return s;
    }
  }catch(e){}
  return fb;
}

const role = (it.user && it.user.role) ? it.user.role : '';
const isOwner = role === 'owner';
const isStaff = role === 'staff';

// âœ… ×ª×•×× owner_staff.ts: permissions ×”× StaffPermission[] (××—×¨×•×–×•×ª)
const perms = Array.isArray(it.user?.permissions) ? it.user.permissions : [];

// permission helpers
function hasPerm(p){
  if (isOwner) return true;
  if (!isStaff) return false;
  return perms.includes(p);
}
function hasAny(list){
  if (isOwner) return true;
  if (!isStaff) return false;
  for (var i=0;i<list.length;i++){
    if (perms.includes(list[i])) return true;
  }
  return false;
}

// â€œ×§×™×¦×•×¨×™×â€ ×¡×× ×˜×™×™× ×œ×¤×™ ×”××¤×ª×—×•×ª ×©×œ×š
const canCalendar = function(){ return hasAny(['reservations.view','reservations.manage']); };
const canFloor    = function(){ return hasAny(['floor.view','floor.edit']); };
const canShifts   = function(){ return hasAny(['shifts.view','shifts.manage']); };
const canWaiter   = function(){ return hasPerm('pos.waiter'); };
const canKitchen  = function(){ return hasPerm('pos.kitchen'); };
const canHost     = function(){ return hasPerm('host.seating'); };
const canReports  = function(){ return hasPerm('reports.view'); };
const canInventory= function(){ return hasAny(['inventory.view','inventory.manage']); };
const canMenu     = function(){ return hasPerm('menu.manage'); };

// ××™×Ÿ permission ×œ×‘×¨ ×‘×ª×¦×•×¨×” ×”× ×•×›×—×™×ª ×‘-owner_staff.ts
const canBar = function(){ return isOwner; }; // Staff: ×œ× ××•×¦×’ ×¢×“ ×©×ª×•×¡×™×¤×• permission
%>

<section class="sb-owner container" aria-label="<%= isOwner ? tt('owner.dashboard.aria_section','×“×©×‘×•×¨×“ ×‘×¢×œ×™×') : tt('staff.dashboard.aria_section','×“×©×‘×•×¨×“ ××¡×¢×“×”') %>">
  <div class="card">
    <header class="owner-hd">
      <div class="owner-hd-main">
        <h1>
          <%= isOwner ? tt('owner.dashboard.title','×“×©×‘×•×¨×“ ×‘×¢×œ×™×') : tt('staff.dashboard.title','×“×©×‘×•×¨×“ ××¡×¢×“×”') %>
        </h1>
        <span class="muted">
          <%= tt('owner.dashboard.hello','×©×œ×•×') %>,
          <strong>
            <%= it.user?.firstName || it.user?.username || (isOwner ? tt('owner.dashboard.owner_fallback','×‘×¢×œ×™×') : tt('staff.dashboard.staff_fallback','×¢×•×‘×“')) %>
          </strong>
        </span>

        <% if (isStaff && (!perms || !perms.length)) { %>
          <div class="muted" style="font-size:12px;margin-top:4px">
            <%= tt('staff.dashboard.no_permissions','××™×Ÿ ×œ×š ×”×¨×©××•×ª ××•×’×“×¨×•×ª. ×¤× ×”/×™ ×œ×‘×¢×œ/×ª ×”××¡×¢×“×”.') %>
          </div>
        <% } %>
      </div>

      <div class="owner-hd-actions">
        <% if (isOwner) { %>
          <!-- × ×™×”×•×œ ×¢×•×‘×“×™× ×•×”×¨×©××•×ª (Owner ×‘×œ×‘×“) -->
          <a href="/owner/staff" class="btn sm ghost owner-staff-btn">
            <span class="icon">ğŸ‘¥</span>
            <%= tt('owner.staff.manage_title', '× ×™×”×•×œ ×¢×•×‘×“×™×') %>
          </a>
        <% } %>
      </div>
    </header>

    <div class="owner-grid">
      <!-- ×¨×©×™××ª ××¡×¢×“×•×ª -->
      <div class="panel card">
        <h2 class="card-title">
          <%= isOwner ? tt('owner.dashboard.my_restaurants','×”××¡×¢×“×•×ª ×©×œ×™') : tt('staff.dashboard.my_restaurant','×”××¡×¢×“×” ×©×œ×™') %>
        </h2>

        <% if (it.restaurants && it.restaurants.length) { %>
          <ul class="list">
            <% it.restaurants.forEach(function(r){
                 const photos = Array.isArray(r.photos) ? r.photos : [];
                 const first = photos.length ? photos[0] : null;
                 const peak = Number(r._peakOccupancyPct || 0);
                 const color = peak >= 80 ? 'red' : (peak >= 50 ? 'yellow' : 'green');
            %>
              <li class="item">
                <div class="meta">
                  <% if (first) { %>
                    <img
                      src="<%= first.dataUrl %>"
                      alt="<%= first.alt || r.name %>"
                      class="thumb"
                      onerror="this.style.visibility='hidden'"
                    />
                  <% } %>
                  <div class="meta-body">
                    <div class="title"><strong><%= r.name %></strong></div>
                    <div class="sub muted">
                      <%= r.city %> â€¢ <%= r.address %>
                    </div>
                    <div class="sub muted">
                      <%= tt('owner.dashboard.seat_duration','××©×š ×™×©×™×‘×”') %>:
                      <%= (typeof r.serviceDurationMinutes === 'number' ? r.serviceDurationMinutes : 90) %>
                      <%= tt('owner.dashboard.minutes_short','×“×§×³') %>
                    </div>

                    <!-- KPI ×™×•××™ ×§×¦×¨ -->
                    <div class="kpis" aria-label="<%= tt('owner.dashboard.today_kpis','××“×“×™ ×”×™×•×') %>">
                      <span class="kpi"><%= tt('owner.dashboard.today','×”×™×•×') %>: <%= r._today %></span>
                      <span class="kpi"><%= tt('owner.dashboard.kpi_reservations','×”×–×× ×•×ª') %>: <%= r._reservationsCount ?? 0 %></span>
                      <span class="kpi"><%= tt('owner.dashboard.kpi_people','×¡×•×¢×“×™×') %>: <%= r._peopleToday ?? 0 %></span>
                      <span class="kpi">Peak: <%= peak %>%</span>
                    </div>

                    <!-- Progress Occupancy -->
                    <div class="bar" aria-label="<%= tt('owner.dashboard.peak_aria','×ª×¤×•×¡×ª ×©×™×') %>">
                      <div class="bar-fill <%= color %>" style="width:<%= Math.max(0, Math.min(100, peak)) %>%"></div>
                    </div>
                  </div>
                </div>

                <!-- ×¤×¢×•×œ×•×ª ×›×œ×œ×™×•×ª -->
                <div class="actions primary-actions">
                  <% if (isOwner || canCalendar()) { %>
                    <a class="btn ghost" href="<%= r._calendarUrl %>" target="_self" rel="nofollow">
                      <span class="icon">ğŸ“…</span>
                      <%= tt('owner.dashboard.btn_calendar','Calendar ×™×•××™') %>
                    </a>
                  <% } %>

                  <% if (isOwner) { %>
                    <a class="btn ghost" href="/owner/restaurants/<%= r.id %>/edit"   target="_self" rel="nofollow">
                      <span class="icon">âœï¸</span>
                      <%= tt('owner.dashboard.btn_edit','×¢×¨×™×›×ª ×¤×¨×˜×™×') %>
                    </a>
                    <a class="btn ghost" href="/owner/restaurants/<%= r.id %>/hours"  target="_self" rel="nofollow">
                      <span class="icon">â°</span>
                      <%= tt('owner.dashboard.btn_hours','×©×¢×•×ª ×¤×ª×™×—×”') %>
                    </a>
                    <a class="btn ghost" href="/owner/restaurants/<%= r.id %>/photos" target="_self" rel="nofollow">
                      <span class="icon">ğŸ–¼ï¸</span>
                      <%= tt('owner.dashboard.btn_photos','×ª××•× ×•×ª') %>
                    </a>
                  <% } %>

                  <% if (isOwner || canFloor()) { %>
                    <a class="btn ghost" href="/owner/restaurants/<%= r.id %>/floor" target="_self" rel="nofollow">
                      <span class="icon">ğŸ½ï¸</span>
                      <%= tt('owner.dashboard.btn_floor','×¡×™×“×•×¨ ×©×•×œ×—× ×•×ª') %>
                    </a>
                  <% } %>

                  <% if (isOwner || canShifts()) { %>
                    <a class="btn ghost" href="/owner/<%= r.id %>/shifts" target="_self" rel="nofollow">
                      <span class="icon">ğŸ“…</span>
                      <%= tt('owner.dashboard.btn_shifts','× ×™×”×•×œ ××©××¨×•×ª') %>
                    </a>
                  <% } %>
                </div>

                <!-- ×©×•×¨×ª POS + × ×™×”×•×œ ×ª×¤×¢×•×œ×™ -->
                <div class="actions pos-actions">
                  <% if (isOwner || canMenu()) { %>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/menu">
                      <span class="icon">ğŸ§¾</span>
                      <%= tt('owner.dashboard.btn_menu', '×¢×¨×™×›×ª ×ª×¤×¨×™×˜') %>
                    </a>
                  <% } %>

                  <% if (isOwner || canWaiter()) { %>
                    <a class="btn ghost wide" href="/waiter/<%= r.id %>">
                      <span class="icon">ğŸ½ï¸</span>
                      <%= tt('owner.dashboard.btn_waiter', '××¡×š ××œ×¦×¨×™×') %>
                    </a>
                  <% } %>

                  <% if (isOwner || canKitchen()) { %>
                    <a class="btn ghost wide" href="/kitchen/<%= r.id %>">
                      <span class="icon">ğŸ§‘â€ğŸ³</span>
                      <%= tt('owner.dashboard.btn_kitchen', '××¡×š ××˜×‘×—') %>
                    </a>
                  <% } %>

                  <% if (isOwner || canHost()) { %>
                    <a class="btn ghost wide" href="/host/<%= r.id %>">
                      <span class="icon">ğŸª‘</span>
                      <%= tt('owner.dashboard.btn_host', '××¡×š ×××¨×—×ª') %>
                    </a>
                  <% } %>

                  <% if (canBar()) { %>
                    <a class="btn ghost wide" href="/bar/<%= r.id %>">
                      <span class="icon">ğŸ¸</span>
                      <%= tt('owner.dashboard.btn_bar', '××¡×š ×‘×¨') %>
                    </a>
                  <% } %>

                  <% if (isOwner || canReports()) { %>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/bills">
                      <span class="icon">ğŸ’³</span>
                      <%= tt('owner.dashboard.btn_bills', '×—×©×‘×•× ×•×ª ××—×¨×•× ×™×') %>
                    </a>

                    <a class="btn ghost wide" href="/owner/<%= r.id %>/stats">
                      <span class="icon">ğŸ“Š</span>
                      <%= tt('owner.dashboard.btn_stats', '×¡×˜×˜×™×¡×˜×™×§×•×ª ×•×“×•×—×•×ª') %>
                    </a>
                  <% } %>

                  <% if (isOwner || canInventory()) { %>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/inventory/stock">
                      <span class="icon">ğŸ“¦</span>
                      <%= tt('owner.dashboard.btn_inventory', '××œ××™ ×—×•××¨×™ ×’×œ×') %>
                    </a>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/inventory/costs">
                      <span class="icon">ğŸ’°</span>
                      <%= tt('owner.dashboard.btn_costs', '×¢×œ×•×™×•×ª ×—×•××¨×™ ×’×œ×') %>
                    </a>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/inventory/counts">
                      <span class="icon">ğŸ“‹</span>
                      <%= tt('owner.dashboard.btn_counts', '×¡×¤×™×¨×•×ª ××œ××™') %>
                    </a>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/inventory/foodcost">
                      <span class="icon">ğŸ’°</span>
                      <%= tt('owner.dashboard.btn_foodcost', '×¢×œ×•×ª ×× ×” ×•×¨×•×•×—×™×•×ª') %>
                    </a>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/inventory/suppliers">
                      <span class="icon">ğŸšš</span>
                      <%= tt('owner.dashboard.btn_suppliers', '×¡×¤×§×™×') %>
                    </a>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/inventory/purchase_orders">
                      <span class="icon">ğŸ“„</span>
                      <%= tt('owner.dashboard.btn_po', '×”×–×× ×•×ª ×¨×›×© (PO)') %>
                    </a>
                    <a class="btn ghost wide" href="/owner/<%= r.id %>/inventory/recipes">
                      <span class="icon">ğŸ“–</span>
                      <%= tt('owner.dashboard.btn_recipes', '××ª×›×•× ×™ ×× ×•×ª') %>
                    </a>
                  <% } %>
                </div>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="muted"><%= tt('owner.dashboard.no_restaurants','×¢×“×™×™×Ÿ ××™×Ÿ ×œ×š ××¡×¢×“×•×ª.') %></p>
        <% } %>
      </div>

      <!-- ×¤×ª×™×—×ª ××¡×¢×“×” ×—×“×©×” (Owner ×‘×œ×‘×“) -->
      <% if (isOwner) { %>
      <div class="panel card">
        <h2 class="card-title"><%= tt('owner.dashboard.open_new_title','×¤×ª×—/×™ ××¡×¢×“×” ×—×“×©×”') %></h2>

        <form action="/owner/restaurant/new" method="post" class="form" id="create-restaurant-form">
          <label>
            <%= tt('owner.dashboard.form.name','×©× ××¡×¢×“×”') %>
            <input name="name" required placeholder="<%= tt('owner.dashboard.form.name_ph','×œ×“×•×’××”: ×¤×¡×˜×” ×“×œ ×¡×•×œ') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.city','×¢×™×¨') %>
            <input name="city" required placeholder="<%= tt('owner.dashboard.form.city_ph','×ª×œ ××‘×™×‘') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.address','×›×ª×•×‘×ª') %>
            <input name="address" required placeholder="<%= tt('owner.dashboard.form.address_ph','××‘×Ÿ ×’×‘×™×¨×•×œ 12') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.phone','×˜×œ×¤×•×Ÿ (×œ× ×—×•×‘×”)') %>
            <input name="phone" placeholder="<%= tt('owner.dashboard.form.phone_ph','03-1234567') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.duration','××©×š ×™×©×™×‘×” (×“×§×•×ª)') %>
            <input name="serviceDurationMinutes" type="number" min="30" step="15" value="120" inputmode="numeric">
          </label>

          <div class="sep"></div>

          <label>
            <%= tt('owner.dashboard.form.photos','×ª××•× ×•×ª ×œ××¡×¢×“×” (××•×¤×¦×™×•× ×œ×™ ×‘×©×œ×‘ ×™×¦×™×¨×”)') %>
            <input id="create-files" type="file" accept="image/png,image/jpeg,image/webp" multiple>
          </label>
          <small class="muted"><%= tt('owner.dashboard.form.photos_hint','×”×§×‘×¦×™× ×™×•×¢×œ×• ××•×˜×•××˜×™×ª ×œ××¡×¢×“×” ×”×—×“×©×” ××—×¨×™ ×”×™×¦×™×¨×”.') %></small>

          <button class="btn primary sm" type="submit" style="margin-top:10px">
            <%= tt('owner.dashboard.form.submit','×©××™×¨×” ×•×™×¦×™×¨×”') %>
          </button>
        </form>

        <p class="muted" style="margin-top:8px">
          <%= tt('owner.dashboard.after_create_hint','×œ××—×¨ ×™×¦×™×¨×” × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ×©×¢×•×ª ×¤×ª×™×—×”, ×¤×¨×˜×™×, ×•×ª××•× ×•×ª ×‘××¡×š â€œ×¢×¨×™×›×ª ×¤×¨×˜×™×â€ ××• â€œ×ª××•× ×•×ªâ€.') %>
        </p>
      </div>
      <% } %>
    </div>
  </div>
</section>

<script>
  document.addEventListener('click', function (ev) {
    var target = ev.target;
    if (!target) return;
    var link = null;
    if (target.closest) link = target.closest('a[href]');
    if (!link) return;
    var href = link.getAttribute('href') || '';
    if (href.indexOf('/owner/') === 0) link.setAttribute('target', '_self');
  }, true);

  (function(){
    var input = document.getElementById('create-files');
    var form = document.getElementById('create-restaurant-form');
    if (!form) return; // ×× Staff - ××™×Ÿ ××ª ×”×˜×•×¤×¡

    function readFileAsDataURL(file) {
      return new Promise(function(resolve, reject){
        var fr = new FileReader();
        fr.onload = function(){ resolve(fr.result); };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    form.addEventListener('submit', async function(){
      try {
        var files = Array.from((input && input.files) || []);
        if (!files.length) return;
        var images = [];
        for (var i=0; i<files.length; i++) {
          var f = files[i];
          if (f.size > (1.8 * 1024 * 1024)) continue;
          var dataUrl = await readFileAsDataURL(f);
          images.push({ dataUrl: dataUrl, alt: '' });
        }
        if (images.length) {
          localStorage.setItem('pendingRestaurantPhotos', JSON.stringify(images));
        }
      } catch (e) {
        console.warn('failed to stash pending photos', e);
      }
    }, { passive: true });
  })();
</script>

<style>
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}

  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px; padding:18px; margin-bottom:18px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .panel.card{height:100%}

  .owner-hd{
    display:flex;align-items:center;gap:10px;justify-content:space-between
  }
  .owner-hd-main{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .owner-hd-actions{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .owner-staff-btn{
    font-size:12px;
    padding:6px 10px;
  }

  .card-title{ margin:0 0 10px; font-size: clamp(16px, 2.2vw, 20px) }
  .muted{ color: var(--ink-muted, #9aa3b2); }

  .owner-grid{
    display:grid;grid-template-columns:1.2fr 1fr;gap:16px;margin-top:14px
  }

  .list{list-style:none;padding:0;margin:0}
  .item{
    display:flex;align-items:flex-start;gap:14px;
    border-top:1px solid rgba(255,255,255,.06);padding:14px 0;
    flex-direction:column;
  }
  .item:first-child{border-top:none;padding-top:0}

  .meta{display:flex;gap:12px;align-items:flex-start}
  .thumb{
    width:90px;height:70px;object-fit:cover;border-radius:10px;
    border:1px solid var(--bd, #222834); background:#0f1320
  }
  .meta-body .title{font-size:16px}
  .meta-body .sub{font-size:12px}

  .kpis{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .kpi{
    font-size:12px;color:#cbd5e1;
    background: rgba(148,163,184,.12);
    border:1px solid rgba(148,163,184,.25);
    border-radius:10px;padding:4px 6px
  }

  .bar{width:100%;height:10px;background:#0e1422;border-radius:999px;overflow:hidden;border:1px solid #1f2636;margin-top:6px}
  .bar-fill{height:100%;background:linear-gradient(90deg,#10b981,#34d399)}
  .bar-fill.yellow{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
  .bar-fill.red{background:linear-gradient(90deg,#ef4444,#f87171)}

  /* ×™×™×©×•×¨ ××™×™×§×•× ×™× ××—×™×“ */
  .btn{ line-height: 1.1; }
  .btn .icon{
    width:18px;
    height:18px;
    flex: 0 0 18px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    line-height: 1;
  }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:12px; cursor:pointer; text-decoration:none;
    border:1px solid var(--bd, #23293a); background:transparent;
    color: var(--ink, #e6e8ef); font-weight:700;
    transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{
    background: var(--brand, #3b82f6); color: var(--brand-ink, #fff); border-color:transparent;
    box-shadow: 0 8px 24px rgba(59,130,246,.35);
  }
  .btn.ghost{
    background: color-mix(in srgb, var(--panel, #121622) 88%, transparent);
  }
  .btn.ghost:hover{ background: color-mix(in srgb, var(--panel, #121622) 94%, transparent); }
  .btn.sm{ padding:8px 12px; border-radius:10px }

  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
  }
  .primary-actions{ justify-content:flex-start; }
  .pos-actions{ justify-content:flex-start; }
  .pos-actions .btn.wide{ min-width:180px; }

  .form label{ display:block; font-weight:600; font-size:14px; margin-top:8px }
  .form input{
    width:100%;padding:10px 12px;margin-top:6px;
    background:#171b29;color:#e6e8ef;border:1px solid #23293a;border-radius:12px;
    font-size:14px; outline:none; transition: box-shadow .15s ease, border-color .15s ease;
  }
  .form input:focus{
    border-color: color-mix(in srgb, var(--brand, #3b82f6) 60%, #23293a);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand, #3b82f6) 20%, transparent);
  }

  .sep{height:1px;background:#23293a;margin:12px 0;border-radius:999px}

  @media (max-width:900px){
    .owner-grid{grid-template-columns:1fr}
    .pos-actions .btn.wide{
      width:100%;
      justify-content:center;
    }
    .owner-hd{
      flex-direction:column;
      align-items:flex-start;
    }
    .owner-hd-actions{
      width:100%;
      justify-content:flex-start;
    }
  }
</style>
