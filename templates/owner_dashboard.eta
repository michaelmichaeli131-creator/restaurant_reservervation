<% layout("_layout", it) %>

<%
// tt: תרגום עם fallback אמיתי (אם it.t מחזיר "(key)" או מחרוזת ריקה)
function tt(k, fb){
  try{
    if (it && typeof it.t==='function'){
      const s = it.t(k);
      if(!s || s===k || s===`(${k})`) return fb;
      return s;
    }
  }catch(e){}
  return fb;
}
%>

<section class="sb-owner container" aria-label="<%= tt('owner.dashboard.aria_section','דשבורד בעלים') %>">
  <div class="card">
    <header class="owner-hd">
      <h1><%= tt('owner.dashboard.title','דשבורד בעלים') %></h1>
      <span class="muted">
        <%= tt('owner.dashboard.hello','שלום') %>,
        <strong><%= it.user?.firstName || it.user?.username || tt('owner.dashboard.owner_fallback','בעלים') %></strong>
      </span>
    </header>

    <div class="owner-grid">
      <!-- רשימת מסעדות -->
      <div class="panel card">
        <h2 class="card-title"><%= tt('owner.dashboard.my_restaurants','המסעדות שלי') %></h2>

        <% if (it.restaurants && it.restaurants.length) { %>
          <ul class="list">
            <% it.restaurants.forEach(function(r){
                 const photos = Array.isArray(r.photos) ? r.photos : [];
                 const first = photos.length ? photos[0] : null;
                 const peak = Number(r._peakOccupancyPct || 0);
                 const color = peak >= 80 ? 'red' : (peak >= 50 ? 'yellow' : 'green');
            %>
              <li class="item">
                <div class="meta">
                  <% if (first) { %>
                    <img
                      src="<%= first.dataUrl %>"
                      alt="<%= first.alt || r.name %>"
                      class="thumb"
                      onerror="this.style.visibility='hidden'"
                    />
                  <% } %>
                  <div class="meta-body">
                    <div class="title"><strong><%= r.name %></strong></div>
                    <div class="sub muted">
                      <%= r.city %> • <%= r.address %>
                    </div>
                    <div class="sub muted">
                      <%= tt('owner.dashboard.seat_duration','משך ישיבה') %>:
                      <%= (typeof r.serviceDurationMinutes === 'number' ? r.serviceDurationMinutes : 90) %>
                      <%= tt('owner.dashboard.minutes_short','דק׳') %>
                    </div>

                    <!-- KPI יומי קצר -->
                    <div class="kpis" aria-label="<%= tt('owner.dashboard.today_kpis','מדדי היום') %>">
                      <span class="kpi"><%= tt('owner.dashboard.today','היום') %>: <%= r._today %></span>
                      <span class="kpi"><%= tt('owner.dashboard.kpi_reservations','הזמנות') %>: <%= r._reservationsCount ?? 0 %></span>
                      <span class="kpi"><%= tt('owner.dashboard.kpi_people','סועדים') %>: <%= r._peopleToday ?? 0 %></span>
                      <span class="kpi">Peak: <%= peak %>%</span>
                    </div>

                    <!-- Progress Occupancy -->
                    <div class="bar" aria-label="<%= tt('owner.dashboard.peak_aria','תפוסת שיא') %>">
                      <div class="bar-fill <%= color %>" style="width:<%= Math.max(0, Math.min(100, peak)) %>%"></div>
                    </div>
                  </div>
                </div>

                <div class="actions">
                  <a class="btn ghost" href="<%= r._calendarUrl %>" target="_self" rel="nofollow">📅 <%= tt('owner.dashboard.btn_calendar','Calendar יומי') %></a>
                  <a class="btn ghost" href="/owner/restaurants/<%= r.id %>/edit"   target="_self" rel="nofollow"><%= tt('owner.dashboard.btn_edit','עריכת פרטים') %></a>
                  <a class="btn ghost" href="/owner/restaurants/<%= r.id %>/hours"  target="_self" rel="nofollow"><%= tt('owner.dashboard.btn_hours','שעות פתיחה') %></a>
                  <a class="btn ghost" href="/owner/restaurants/<%= r.id %>/photos" target="_self" rel="nofollow"><%= tt('owner.dashboard.btn_photos','תמונות') %></a>
                </div>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="muted"><%= tt('owner.dashboard.no_restaurants','עדיין אין לך מסעדות.') %></p>
        <% } %>
      </div>

      <!-- פתיחת מסעדה חדשה -->
      <div class="panel card">
        <h2 class="card-title"><%= tt('owner.dashboard.open_new_title','פתח/י מסעדה חדשה') %></h2>

        <!-- נשאר POST קלאסי; התמונות יועמסו אוטומטית אחרי יצירה דרך localStorage -->
        <form action="/owner/restaurant/new" method="post" class="form" id="create-restaurant-form">
          <label>
            <%= tt('owner.dashboard.form.name','שם מסעדה') %>
            <input name="name" required placeholder="<%= tt('owner.dashboard.form.name_ph','לדוגמה: פסטה דל סול') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.city','עיר') %>
            <input name="city" required placeholder="<%= tt('owner.dashboard.form.city_ph','תל אביב') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.address','כתובת') %>
            <input name="address" required placeholder="<%= tt('owner.dashboard.form.address_ph','אבן גבירול 12') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.phone','טלפון (לא חובה)') %>
            <input name="phone" placeholder="<%= tt('owner.dashboard.form.phone_ph','03-1234567') %>">
          </label>

          <label>
            <%= tt('owner.dashboard.form.duration','משך ישיבה (דקות)') %>
            <input name="serviceDurationMinutes" type="number" min="30" step="15" value="120" inputmode="numeric">
          </label>

          <div class="sep"></div>

          <label>
            <%= tt('owner.dashboard.form.photos','תמונות למסעדה (אופציונלי בשלב יצירה)') %>
            <input id="create-files" type="file" accept="image/png,image/jpeg,image/webp" multiple>
          </label>
          <small class="muted"><%= tt('owner.dashboard.form.photos_hint','הקבצים יועלו אוטומטית למסעדה החדשה אחרי היצירה.') %></small>

          <button class="btn primary sm" type="submit" style="margin-top:10px">
            <%= tt('owner.dashboard.form.submit','שמירה ויצירה') %>
          </button>
        </form>

        <p class="muted" style="margin-top:8px">
          <%= tt('owner.dashboard.after_create_hint','לאחר יצירה ניתן לעדכן שעות פתיחה, פרטים, ותמונות במסך “עריכת פרטים” או “תמונות”.') %>
        </p>
      </div>
    </div>
  </div>
</section>

<script>
  // ניווט תקין בלחיצות
  document.addEventListener('click', function (ev) {
    var target = ev.target;
    if (!target) return;
    var link = null;
    if (target.closest) link = target.closest('a[href]');
    if (!link) return;
    var href = link.getAttribute('href') || '';
    if (href.indexOf('/owner/') === 0) link.setAttribute('target', '_self');
  }, true);

  // בשלב יצירת מסעדה: שומרים תמונות ב-localStorage ואז יועמסו אוטומטית בעמוד התמונות/העריכה
  (function(){
    var input = document.getElementById('create-files');
    var form = document.getElementById('create-restaurant-form');

    function readFileAsDataURL(file) {
      return new Promise(function(resolve, reject){
        var fr = new FileReader();
        fr.onload = function(){ resolve(fr.result); };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    form.addEventListener('submit', async function(){
      try {
        var files = Array.from((input && input.files) || []);
        if (!files.length) return; // אין תמונות — אין מה לשמור
        var images = [];
        for (var i=0; i<files.length; i++) {
          var f = files[i];
          if (f.size > (1.8 * 1024 * 1024)) continue; // ~1.8MB
          var dataUrl = await readFileAsDataURL(f);
          images.push({ dataUrl: dataUrl, alt: '' });
        }
        if (images.length) {
          localStorage.setItem('pendingRestaurantPhotos', JSON.stringify(images));
          // בצד השני (owner_photos / owner_restaurant_edit) נטען אוטומטית ונתחיל העלאה
        }
      } catch (e) {
        console.warn('failed to stash pending photos', e);
      }
    }, { passive: true });
  })();
</script>

<style>
  /* ===== מראה SpotBook כהה־יוקרתי, בלי לוותר על שום פיצ'ר ===== */
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}

  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px; padding:18px; margin-bottom:18px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .panel.card{height:100%}

  .owner-hd{
    display:flex;align-items:center;gap:10px;justify-content:space-between
  }
  .card-title{ margin:0 0 10px; font-size: clamp(16px, 2.2vw, 20px) }
  .muted{ color: var(--ink-muted, #9aa3b2); }

  .owner-grid{
    display:grid;grid-template-columns:1.2fr 1fr;gap:16px;margin-top:14px
  }

  /* רשימת מסעדות */
  .list{list-style:none;padding:0;margin:0}
  .item{
    display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
    border-top:1px solid rgba(255,255,255,.06);padding:14px 0
  }
  .item:first-child{border-top:none;padding-top:0}

  .meta{display:flex;gap:12px;align-items:flex-start}
  .thumb{
    width:90px;height:70px;object-fit:cover;border-radius:10px;
    border:1px solid var(--bd, #222834); background:#0f1320
  }
  .meta-body .title{font-size:16px}
  .meta-body .sub{font-size:12px}

  .kpis{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .kpi{
    font-size:12px;color:#cbd5e1;
    background: rgba(148,163,184,.12);
    border:1px solid rgba(148,163,184,.25);
    border-radius:10px;padding:4px 6px
  }

  /* Progress bar */
  .bar{width:100%;height:10px;background:#0e1422;border-radius:999px;overflow:hidden;border:1px solid #1f2636;margin-top:6px}
  .bar-fill{height:100%;background:linear-gradient(90deg,#10b981,#34d399)}
  .bar-fill.yellow{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
  .bar-fill.red{background:linear-gradient(90deg,#ef4444,#f87171)}

  /* כפתורים “חיים” */
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:12px; cursor:pointer; text-decoration:none;
    border:1px solid var(--bd, #23293a); background:transparent;
    color: var(--ink, #e6e8ef); font-weight:700;
    transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{
    background: var(--brand, #3b82f6); color: var(--brand-ink, #fff); border-color:transparent;
    box-shadow: 0 8px 24px rgba(59,130,246,.35);
  }
  .btn.ghost{
    background: color-mix(in srgb, var(--panel, #121622) 88%, transparent);
  }
  .btn.ghost:hover{ background: color-mix(in srgb, var(--panel, #121622) 94%, transparent); }
  .btn.sm{ padding:8px 12px; border-radius:10px }

  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-inline-start:auto}

  /* טפסים */
  .form label{ display:block; font-weight:600; font-size:14px; margin-top:8px }
  .form input{
    width:100%;padding:10px 12px;margin-top:6px;
    background:#171b29;color:#e6e8ef;border:1px solid #23293a;border-radius:12px;
    font-size:14px; outline:none; transition: box-shadow .15s ease, border-color .15s ease;
  }
  .form input:focus{
    border-color: color-mix(in srgb, var(--brand, #3b82f6) 60%, #23293a);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand, #3b82f6) 20%, transparent);
  }

  .sep{height:1px;background:#23293a;margin:12px 0;border-radius:999px}

  @media (max-width:900px){
    .owner-grid{grid-template-columns:1fr}
  }
</style>
