<% layout("_layout", it) %>

<% /* tt: ×ª×¨×’×•× ×¢× fallback ××ž×™×ª×™ ×’× ×›×©-it.t ×ž×—×–×™×¨ "(key)" */ %>
<% function tt(k, fb){ try{ if (it && typeof it.t==='function'){ const s = it.t(k); if(!s || s===k || s===`(${k})`) return fb; return s; } }catch(e){} return fb; } %>

<main class="sb-photos container sb-owner-page">
  <header class="page-header head">
    <div>
      <h1 class="h1"><%= tt('owner.photos.title','×ª×ž×•× ×•×ª') %> â€” <%= it.restaurant.name %></h1>
      <p class="muted"><%= it.restaurant.city %> Â· <%= it.restaurant.address %></p>
    </div>
    <a class="btn ghost sm" href="/owner"><%= tt('owner.photos.back_to_dashboard','×—×–×¨×” ×œ×“×©×‘×•×¨×“') %></a>
  </header>

  <%~ include("components/_owner_tabs", { restaurant: it.restaurant, active: "photos", t: it.t }) %>


  <% if (it.saved) { %>
    <div class="alert success" role="status">âœ“ <%= tt('owner.photos.saved_ok','× ×©×ž×¨ ×‘×”×¦×œ×—×”') %></div>
  <% } %>

  <section class="card">
    <h3 class="card-title"><%= tt('owner.photos.upload_title','×”×¢×œ××ª ×ª×ž×•× ×” (×ž×•×§×˜× ×ª ××•×˜×•×ž×˜×™×ª)') %></h3>
    <p class="muted"><%= tt('owner.photos.upload_hint','JPG/PNG/WebP â€” × × ×¡×” ×œ×›×•×•×¥ ×›×“×™ ×œ×”×ª××™× ×œ×ž×’×‘×œ×ª ×”×ž×¢×¨×›×ª (~64KB).') %></p>

    <div class="upload-row">
      <div class="dropzone" role="group" aria-label="<%= tt('owner.photos.upload_title','×”×¢×œ××ª ×ª×ž×•× ×”') %>">
        <strong><%= tt('owner.photos.choose_file','×‘×—×¨ ×ª×ž×•× ×”') %></strong>
        <div class="muted"><%= tt('owner.photos.drop_hint','×œ×—×¥ ×›×“×™ ×œ×‘×—×•×¨ ×§×•×‘×¥. ×ž×•×ž×œ×¥ ×ª×ž×•× ×” ×‘×¨×•×—×‘/×’×•×‘×” ×¢×“ ~1280px.') %></div>
        <div class="uploader">
          <input id="photo-input" class="file" type="file" accept="image/png,image/jpeg,image/webp" aria-label="<%= tt('owner.photos.input_aria','×‘×—×™×¨×ª ×§×•×‘×¥ ×ª×ž×•× ×”') %>">
          <button id="upload-btn" class="btn primary sm" type="button" aria-label="<%= tt('owner.photos.upload_btn_aria','×”×¢×œ×” ×ª×ž×•× ×”') %>"><%= tt('owner.photos.upload_btn','×”×¢×œ×”') %></button>
        </div>
        <div id="preview" class="preview" aria-live="polite"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3 class="card-title"><%= tt('owner.photos.gallery','×’×œ×¨×™×”') %></h3>
    <%
      const photos = Array.isArray(it.restaurant.photos) ? it.restaurant.photos : [];
    %>
    <% if (!photos.length) { %>
      <p class="muted"><%= tt('owner.photos.empty','××™×Ÿ ×¢×“×™×™×Ÿ ×ª×ž×•× ×•×ª.') %></p>
    <% } else { %>
      <div class="grid">
        <% photos.forEach(function(p){ %>
          <figure class="photo-card" data-id="<%= p.id %>">
            <img src="<%= p.dataUrl %>" alt="<%= p.alt || it.restaurant.name %>">
            <figcaption class="caption">
              <button class="btn danger sm delete-btn" data-id="<%= p.id %>" type="button" aria-label="<%= tt('owner.photos.delete_btn_aria','×ž×—×§ ×ª×ž×•× ×”') %>">ðŸ—‘ <%= tt('owner.photos.delete_btn','×ž×—×™×§×”') %></button>
            </figcaption>
          </figure>
        <% }) %>
      </div>
    <% } %>
  </section>
</main>

<script>
(function(){
  const rid = "<%= it.restaurant.id %>";
  const fileInput = document.getElementById('photo-input');
  const uploadBtn = document.getElementById('upload-btn');
  const preview = document.getElementById('preview');

  fileInput.addEventListener('change', () => {
    preview.innerHTML = '';
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    preview.innerHTML = '<img src="'+url+'" class="preview-img" alt="<%= tt('owner.photos.preview_alt','×ª×¦×•×’×” ×ž×§×“×™×ž×”') %>">';
  });

  async function shrinkToUnder(targetBytes, file) {
    const img = await new Promise((res, rej) => {
      const el = new Image();
      el.onload = () => res(el);
      el.onerror = rej;
      el.src = URL.createObjectURL(file);
    });

    const canvas = document.createElement('canvas');
    const ctx2d = canvas.getContext('2d');

    const maxW = 1280, maxH = 1280;
    let { width: w, height: h } = img;
    const ratio = Math.min(1, maxW / w, maxH / h);
    w = Math.floor(w * ratio);
    h = Math.floor(h * ratio);

    canvas.width = w; canvas.height = h;
    ctx2d.drawImage(img, 0, 0, w, h);

    let best = null;
    let quality = 0.85;
    for (let i=0; i<8; i++) {
      const blob = await new Promise(res => canvas.toBlob(res, 'image/webp', quality));
      if (!blob) break;
      best = blob;
      if (blob.size <= targetBytes) return blob;
      quality *= 0.8;
    }
    const fallback = await new Promise(res => canvas.toBlob(res, 'image/webp', 0.6));
    return fallback || best || file;
  }

  uploadBtn.addEventListener('click', async () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) return alert("<%= tt('owner.photos.pick_first','×‘×—×¨/×™ ×ª×ž×•× ×” ×§×•×“×') %>");

    console.log('[upload] Original file:', f.name, f.type, f.size, 'bytes');

    // R2 supports unlimited size - only compress if VERY large
    const targetBytes = 5 * 1024 * 1024; // 5 MB (reasonable limit for web)
    let blob = f;
    if (f.size > targetBytes) {
      console.log('[upload] File too large, compressing...');
      try { blob = await shrinkToUnder(targetBytes, f) || f; }
      catch(e){ console.warn("shrink failed", e); }
    }

    console.log('[upload] Sending blob:', blob.type, blob.size, 'bytes');

    const res = await fetch(`/owner/restaurants/${encodeURIComponent(rid)}/photos/upload`, {
      method: "POST",
      headers: { "Content-Type": blob.type || "image/webp" },
      body: blob
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      alert("<%= tt('owner.photos.upload_err','×©×’×™××” ×‘×”×¢×œ××”') %>: " + res.status + "\\n" + txt);
      return;
    }
    const data = await res.json();
    if (data.ok) location.reload();
    else alert("<%= tt('owner.photos.save_err','×©×’×™××” ×‘×©×ž×™×¨×”') %>");
  });

  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest?.('.delete-btn');
    if (!btn) return;
    const pid = btn.getAttribute('data-id');
    if (!pid) return;
    if (!confirm('<%= tt('owner.photos.confirm_delete','×œ×ž×—×•×§ ×ª×ž×•× ×” ×–×•?') %>')) return;

    const res = await fetch(`/owner/restaurants/${encodeURIComponent(rid)}/photos/delete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: pid }),
    });
    if (!res.ok) return alert('<%= tt('owner.photos.delete_err','×ž×—×™×§×” × ×›×©×œ×”') %>');
    const data = await res.json();
    if (data.ok) document.querySelector('.photo-card[data-id="'+pid+'"]')?.remove();
  });
})();
</script>

