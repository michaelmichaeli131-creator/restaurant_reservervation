<% layout("_layout", it) %>

<main class="container">
  <header class="page-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div>
      <h1 style="margin:0 0 6px">×ª××•× ×•×ª â€” <%= it.restaurant.name %></h1>
      <p class="muted" style="margin:0"><%= it.restaurant.city %> Â· <%= it.restaurant.address %></p>
    </div>
    <a class="btn" href="/owner">×—×–×¨×” ×œ×“×©×‘×•×¨×“</a>
  </header>

  <% if (it.saved) { %>
    <div class="alert success" role="status" style="background:#e6ffea;border:1px solid #bde5b8;border-radius:8px;padding:10px;margin-bottom:12px">
      âœ“ × ×©××¨ ×‘×”×¦×œ×—×”
    </div>
  <% } %>

  <!-- ×”×¢×œ××ª ×ª××•× ×” -->
  <section class="card" style="margin-bottom:16px">
    <h3 style="margin-top:0">×”×¢×œ××ª ×ª××•× ×”</h3>
    <p class="muted">×‘×—×¨×• ×§×•×‘×¥ JPG/PNG/WebP (×¢×“ ~2MB).</p>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="photo-input" type="file" accept="image/png,image/jpeg,image/webp">
      <button id="upload-btn" class="btn primary" type="button">×”×¢×œ×”</button>
    </div>

    <div id="preview" style="margin-top:12px"></div>
  </section>

  <!-- ×’×œ×¨×™×” -->
  <section class="card">
    <h3 style="margin-top:0">×’×œ×¨×™×”</h3>
    <% 
      const photos = Array.isArray(it.restaurant.photos) ? it.restaurant.photos : [];
    %>
    <% if (!photos.length) { %>
      <p class="muted">××™×Ÿ ×¢×“×™×™×Ÿ ×ª××•× ×•×ª.</p>
    <% } else { %>
      <div class="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px">
        <% photos.forEach(function(p){ %>
          <figure class="photo-card" data-id="<%= p.id %>" style="border:1px solid #eee;border-radius:10px;padding:8px">
            <img src="<%= p.dataUrl %>" alt="<%= p.alt || it.restaurant.name %>" style="width:100%;height:120px;object-fit:cover;border-radius:6px">
            <figcaption style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
              <button class="btn btn-danger btn-sm delete-btn" data-id="<%= p.id %>" type="button">ğŸ—‘ ××—×™×§×”</button>
            </figcaption>
          </figure>
        <% }) %>
      </div>
    <% } %>
  </section>
</main>

<script>
(function(){
  const rid = "<%= it.restaurant.id %>";
  const fileInput = document.getElementById('photo-input');
  const uploadBtn = document.getElementById('upload-btn');
  const preview = document.getElementById('preview');

  // ×ª×¦×•×’×” ××§×“×™××”
  fileInput.addEventListener('change', () => {
    preview.innerHTML = '';
    const file = fileInput.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      preview.innerHTML = '<img src="'+url+'" style="max-width:200px;border-radius:8px;border:1px solid #ccc">';
    }
  });

  // ×”×¢×œ××” ×œ×©×¨×ª (POST binary)
  uploadBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if (!file) return alert("×‘×—×¨/×™ ×ª××•× ×” ×§×•×“×");
    if (file.size > 2 * 1024 * 1024) return alert("×”×§×•×‘×¥ ×’×“×•×œ ××“×™ (××¢×œ 2MB)");

    const res = await fetch(`/owner/restaurants/${encodeURIComponent(rid)}/photos/upload`, {
      method: "POST",
      headers: { "Content-Type": file.type },
      body: file
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>"");
      alert("×©×’×™××” ×‘×”×¢×œ××”: " + res.status + "\\n" + txt);
      return;
    }

    const data = await res.json();
    if (data.ok) {
      alert("×ª××•× ×” ×”×•×¢×œ×ª×” ×‘×”×¦×œ×—×”!");
      location.reload();
    } else {
      alert("×©×’×™××” ×‘×©××™×¨×”");
    }
  });

  // ××—×™×§×ª ×ª××•× ×”
  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest?.('.delete-btn');
    if (!btn) return;
    const pid = btn.getAttribute('data-id');
    if (!pid) return;
    if (!confirm('×œ××—×•×§ ×ª××•× ×” ×–×•?')) return;

    try {
      const res = await fetch(`/owner/restaurants/${encodeURIComponent(rid)}/photos/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: pid }),
      });
      const data = await res.json();
      if (data.ok) {
        const card = document.querySelector('.photo-card[data-id="'+pid+'"]');
        card?.remove();
      }
    } catch (e) {
      console.error(e);
      alert('×©×’×™××ª ×¨×©×ª');
    }
  });
})();
</script>

<style>
.container{max-width:1000px;margin:0 auto;padding:0 16px}
.card{border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0;background:#fff}
.muted{color:#777}
.btn{display:inline-block;background:#111;color:#fff;border:none;border-radius:10px;padding:8px 12px;text-decoration:none;cursor:pointer}
.btn.primary{background:#0b6}
.btn-danger{background:#c0392b}
.btn.btn-sm{padding:6px 8px;border-radius:8px;font-size:.9rem}
img{display:block;max-width:100%}
</style>
