<% layout("_layout", it) %>

<main class="container">
  <header class="page-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div>
      <h1 style="margin:0 0 6px">תמונות — <%= it.restaurant.name %></h1>
      <p class="muted" style="margin:0"><%= it.restaurant.city %> · <%= it.restaurant.address %></p>
    </div>
    <a class="btn" href="/owner">חזרה לדשבורד</a>
  </header>

  <% if (it.saved) { %>
    <div class="alert success" role="status" style="background:#e6ffea;border:1px solid #bde5b8;border-radius:8px;padding:10px;margin-bottom:12px">
      ✓ נשמר בהצלחה
    </div>
  <% } %>

  <section class="card" style="margin-bottom:16px">
    <h3 style="margin-top:0">העלאת תמונה (מוקטנת אוטומטית)</h3>
    <p class="muted">JPG/PNG/WebP — ננסה לכווץ כדי להתאים למגבלת המערכת (~64KB).</p>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <input id="photo-input" type="file" accept="image/png,image/jpeg,image/webp">
      <button id="upload-btn" class="btn primary" type="button">העלה</button>
    </div>

    <div id="preview" style="margin-top:12px"></div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">גלריה</h3>
    <% 
      const photos = Array.isArray(it.restaurant.photos) ? it.restaurant.photos : [];
    %>
    <% if (!photos.length) { %>
      <p class="muted">אין עדיין תמונות.</p>
    <% } else { %>
      <div class="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px">
        <% photos.forEach(function(p){ %>
          <figure class="photo-card" data-id="<%= p.id %>" style="border:1px solid #eee;border-radius:10px;padding:8px">
            <img src="<%= p.dataUrl %>" alt="<%= p.alt || it.restaurant.name %>" style="width:100%;height:120px;object-fit:cover;border-radius:6px">
            <figcaption style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
              <button class="btn btn-danger btn-sm delete-btn" data-id="<%= p.id %>" type="button">🗑 מחיקה</button>
            </figcaption>
          </figure>
        <% }) %>
      </div>
    <% } %>
  </section>
</main>

<script>
(function(){
  const rid = "<%= it.restaurant.id %>";
  const fileInput = document.getElementById('photo-input');
  const uploadBtn = document.getElementById('upload-btn');
  const preview = document.getElementById('preview');

  fileInput.addEventListener('change', () => {
    preview.innerHTML = '';
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    preview.innerHTML = '<img src="'+url+'" style="max-width:220px;max-height:160px;border-radius:8px;border:1px solid #ccc">';
  });

  async function shrinkToUnder(targetBytes, file) {
    // נקטין לרוחב מקסימלי 1280px ונכווץ איכות בהדרגה עד שמגיעים ליעד
    const img = await new Promise((res, rej) => {
      const el = new Image();
      el.onload = () => res(el);
      el.onerror = rej;
      el.src = URL.createObjectURL(file);
    });

    const canvas = document.createElement('canvas');
    const ctx2d = canvas.getContext('2d');

    const maxW = 1280, maxH = 1280;
    let { width: w, height: h } = img;
    const ratio = Math.min(1, maxW / w, maxH / h);
    w = Math.floor(w * ratio);
    h = Math.floor(h * ratio);

    canvas.width = w; canvas.height = h;
    ctx2d.drawImage(img, 0, 0, w, h);

    let quality = 0.85;
    for (let i=0; i<8; i++) {
      const blob = await new Promise(res => canvas.toBlob(res, 'image/webp', quality));
      if (!blob) break;
      if (blob.size <= targetBytes) return blob;
      quality *= 0.8; // הורדת איכות מדורגת
    }
    // אם לא הצליח – נחזיר את הקטן ביותר שקיבלנו
    const fallback = await new Promise(res => canvas.toBlob(res, 'image/webp', 0.6));
    return fallback || file;
  }

  uploadBtn.addEventListener('click', async () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) return alert("בחר/י תמונה קודם");

    // ננסה לרדת מתחת ~60KB כדי להתאים ל-KV
    const targetBytes = 60 * 1024;
    let blob = f;
    if (f.size > targetBytes) {
      try { blob = await shrinkToUnder(targetBytes, f) || f; }
      catch(e){ console.warn("shrink failed", e); }
    }

    const res = await fetch(`/owner/restaurants/${encodeURIComponent(rid)}/photos/upload`, {
      method: "POST",
      headers: { "Content-Type": blob.type || "image/webp" },
      body: blob
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>"");
      alert("שגיאה בהעלאה: " + res.status + "\\n" + txt);
      return;
    }
    const data = await res.json();
    if (data.ok) location.reload();
    else alert("שגיאה בשמירה");
  });

  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest?.('.delete-btn');
    if (!btn) return;
    const pid = btn.getAttribute('data-id');
    if (!pid) return;
    if (!confirm('למחוק תמונה זו?')) return;

    const res = await fetch(`/owner/restaurants/${encodeURIComponent(rid)}/photos/delete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: pid }),
    });
    if (!res.ok) return alert('מחיקה נכשלה');
    const data = await res.json();
    if (data.ok) document.querySelector('.photo-card[data-id="'+pid+'"]')?.remove();
  });
})();
</script>

<style>
.container{max-width:1000px;margin:0 auto;padding:0 16px}
.card{border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0;background:#fff}
.muted{color:#777}
.btn{display:inline-block;background:#111;color:#fff;border:none;border-radius:10px;padding:8px 12px;text-decoration:none;cursor:pointer}
.btn.primary{background:#0b6}
.btn-danger{background:#c0392b}
.btn.btn-sm{padding:6px 8px;border-radius:8px;font-size:.9rem}
img{display:block;max-width:100%}
</style>
