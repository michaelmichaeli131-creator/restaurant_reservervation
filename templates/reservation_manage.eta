<!-- /src/templates/reservation_manage.eta -->
<!doctype html>
<%
  /* tt: ×ª×¨×’×•× ×¢× fallback ×××™×ª×™ */
  function tt(k, fb){ try{ if(it && typeof it.t==='function'){ const s=it.t(k); if(!s || s===k || s===`(${k})`) return fb; return s; } }catch(e){} return fb; }
  const lang = it.lang || 'he';
  const dir  = it.dir  || (lang === 'he' || lang === 'ar' ? 'rtl' : 'ltr');
  const token = it.token || '';
  const path  = `/r/${token}`;
  const qHe   = `?lang=he`;
  const qEn   = `?lang=en`;
  const qKa   = `?lang=ka`;
  const logo  = it.logoUrl || '/public/img/spotbook-logo.svg';
  const title = it.title || tt('manage.title','× ×™×”×•×œ ×”×–×× ×” Â· SpotBook');
  const status = (it.reservation?.status || 'new');
  const statusLabel = status==='confirmed'
    ? tt('manage.status.confirmed','×××•×©×¨')
    : status==='canceled'
      ? tt('manage.status.canceled','××‘×•×˜×œ')
      : tt('manage.status.new','×—×“×©');
%>
<html lang="<%= lang %>" dir="<%= dir %>">
<head>
  <meta charset="utf-8" />
  <title><%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Rubik + CSS ×”×¨××©×™ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/spotbook.css?v=<%= Date.now() %>"/>

  <style>
    /* ===== SpotBook Â· ×›×”×”-×™×•×§×¨×ª×™ ===== */
    :root{
      --bg:#0e1116; --ink:#e6e8ef; --ink-muted:#9aa3b2;
      --panel:#121622; --panel-2:#171b29; --bd:#23293a;
      --brand:#3b82f6; --brand-ink:#fff;
      --ok:#22c55e; --danger:#ef4444; --warn:#fbbf24;
      --radius:18px; --shadow:0 12px 36px rgba(0,0,0,.35); --max:760px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:"Rubik",system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:24px auto; padding:0 16px}
    .card{ background:var(--panel); border:1px solid var(--bd); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }

    .head{
      padding:22px 20px 14px; border-bottom:1px solid var(--bd);
      display:flex; justify-content:space-between; gap:12px; align-items:center;
    }
    .head-left{display:flex; gap:12px; align-items:center}
    .logo{height:28px; width:auto; display:block}
    h1{margin:0; font-size:clamp(20px,3.6vw,26px); letter-spacing:.2px}
    .muted{color:var(--ink-muted)}

    /* === ×œ×©×•× ×™×ª ×©×¤×” ×‘×¡×’× ×•×Ÿ "×›×“×•×¨ ×”××¨×¥" === */
    .langbar{ position:relative; display:flex; align-items:center; }
    .lang-btn{
      background:color-mix(in srgb, var(--panel-2) 92%, transparent);
      border:1px solid var(--bd);
      border-radius:50%;
      width:36px; height:36px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:18px; line-height:1; color:var(--ink);
      cursor:pointer; transition:filter .12s ease, transform .08s ease;
    }
    .lang-btn:hover{ transform:translateY(-1px); }
    .lang-menu{
      display:none; position:absolute; top:120%; inset-inline-end:0;
      background:var(--panel-2); border:1px solid var(--bd); border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.35); padding:6px 0; min-width:160px; z-index:10;
    }
    .langbar.open .lang-menu{ display:block; }
    .lang-menu a{
      display:block; padding:8px 14px; color:var(--ink); font-weight:700; text-decoration:none;
    }
    .lang-menu a:hover,
    .lang-menu a.active{
      background:var(--brand); color:var(--brand-ink);
    }

    .body{padding:18px 20px}
    .restaurant{display:flex; gap:14px; align-items:center; margin-top:8px}
    .restaurant img{ width:64px; height:64px; object-fit:cover; border-radius:12px; border:1px solid var(--bd); background:var(--panel-2); }

    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px}
    .pill{ border:1px solid var(--bd); border-radius:14px; padding:12px 14px; background: color-mix(in srgb, var(--panel-2) 90%, transparent); }
    .pill strong{display:block; font-size:12px; color:var(--ink-muted); margin-bottom:6px}
    .pill span{font-weight:800; letter-spacing:.3px}

    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}

    .btn, button{
      appearance:none; border:1px solid var(--bd); border-radius:999px; padding:10px 14px;
      font-weight:800; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:8px;
      color:var(--ink); background:transparent;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn:hover, button:hover{ transform: translateY(-1px) }
    .btn-brand{ background:var(--brand); color:var(--brand-ink); border-color:transparent; box-shadow:0 10px 28px rgba(59,130,246,.35); }
    .btn-ghost{ background: color-mix(in srgb, var(--panel-2) 90%, transparent); }
    .btn-ghost:hover{ background: color-mix(in srgb, var(--panel) 92%, transparent) }
    .btn-danger{ background: color-mix(in srgb, var(--danger) 88%, black 12%); color:#fff; border-color: transparent; box-shadow:0 10px 28px rgba(239, 68, 68, .28); }
    .btn[disabled],button[disabled]{opacity:.5; cursor:not-allowed; transform:none; filter:none}

    .hr{height:1px; background:var(--bd); margin:20px 0}
    .success{color:var(--ok); font-weight:800; margin:10px 0 0}
    .error{color:var(--danger); font-weight:800; margin:10px 0 0}

    .badge{ display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:8px 12px; font-weight:800; font-size:12px; border:1px solid var(--bd); background: color-mix(in srgb, var(--panel-2) 92%, transparent); }
    .badge.new{ border-color:#94a3b8; background:rgba(148,163,184,.18); color:#e2e8f0 }
    .badge.confirmed{ border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.14); color:#86efac }
    .badge.canceled{ border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12); color:#fecaca }

    .phone{margin-top:6px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .phone a.tel{ color:#7dd3fc; text-decoration:none; font-weight:800 }
    .copy-btn{ background: color-mix(in srgb, var(--panel-2) 90%, transparent); border:1px solid var(--bd); color:var(--ink); border-radius:12px; padding:6px 10px; font-weight:700; cursor:pointer; transition: background .12s ease, transform .08s ease; }
    .copy-btn:hover{ background: color-mix(in srgb, var(--panel) 92%, transparent); transform: translateY(-1px) }
    .copied-badge{display:none; font-size:12px; color:var(--ok); font-weight:800}
    .copied .copied-badge{display:inline}

    @media (max-width:480px){
      .head{padding:18px 16px 12px}
      .body{padding:16px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <!-- ×¦×“ ×©×××œ: ×œ×•×’×• + ×›×•×ª×¨×ª -->
        <div class="head-left">
          <img class="logo" src="<%= logo %>" alt="SpotBook" onerror="this.style.display='none'"/>
          <div>
            <h1><%= tt('manage.header.title','× ×™×”×•×œ ×”×–×× ×”') %></h1>
            <div class="muted">
              <%= tt('manage.header.resId','××¡×³ ×”×–×× ×”:') %>
              <code><%= it.reservation.id %></code>
            </div>
          </div>
        </div>

        <!-- ×¦×“ ×™××™×Ÿ: badge ×¡×˜×˜×•×¡ + ×‘×•×¨×¨ ×©×¤×” (×›×“×•×¨ ×”××¨×¥) -->
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="badge <%= status %>">
            <% if (status==='confirmed') { %>âœ“<% } else if (status==='canceled') { %>âœ—<% } else { %>â€¢<% } %>
            <span><%= statusLabel %></span>
          </div>

          <div class="langbar" aria-label="<%= tt('common.lang.switch','×©× ×” ×©×¤×”') %>">
            <button class="lang-btn" type="button" aria-haspopup="menu" aria-expanded="false" aria-label="<%= tt('common.lang.switch','×©× ×” ×©×¤×”') %>">ğŸŒ</button>
            <div class="lang-menu" role="menu">
              <a role="menuitem" href="<%= path + qHe %>" class="<%= lang==='he'?'active':'' %>">×¢×‘×¨×™×ª</a>
              <a role="menuitem" href="<%= path + qEn %>" class="<%= lang==='en'?'active':'' %>">English</a>
              <a role="menuitem" href="<%= path + qKa %>" class="<%= lang==='ka'?'active':'' %>">áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜</a>
            </div>
          </div>
        </div>
      </div>

      <div class="body">
        <!-- ×¤×¨×˜×™ ××¡×¢×“×” -->
        <div class="restaurant">
          <% if (it.restaurant && (it.restaurant.photos && it.restaurant.photos.length)) { %>
            <img src="<%= it.restaurant.photos[0] %>" alt="<%= it.restaurant.name %>" />
          <% } %>
          <div>
            <div style="font-weight:800"><%= it.restaurant?.name || tt('manage.restaurant.fallback','××¡×¢×“×”') %></div>
            <div class="muted"><%= it.restaurant?.address || "" %></div>
            <% if (it.restaurant?.phone) { const phone = String(it.restaurant.phone); %>
              <div class="phone" id="phone-block">
                <span>ğŸ“</span>
                <a class="tel" href="tel:<%= phone %>"><%= phone %></a>
                <button class="copy-btn" type="button" data-phone="<%= phone %>" onclick="copyPhone(this)"><%= tt('manage.actions.copy','×”×¢×ª×§×”') %></button>
                <span class="copied-badge" aria-live="polite"><%= tt('manage.actions.copied','×”×•×¢×ª×§ âœ“') %></span>
              </div>
            <% } %>
          </div>
        </div>

        <div class="hr"></div>

        <!-- ×¤×¨×˜×™ ×”×–×× ×” -->
        <div class="grid">
          <div class="pill">
            <strong><%= tt('manage.details.date','×ª××¨×™×š') %></strong>
            <span><%= it.reservation.date %></span>
          </div>
          <div class="pill">
            <strong><%= tt('manage.details.time','×©×¢×”') %></strong>
            <span><%= it.reservation.time %></span>
          </div>
          <div class="pill">
            <strong><%= tt('manage.details.people','××¡×³ ×¡×•×¢×“×™×') %></strong>
            <span><%= it.reservation.people %></span>
          </div>
          <div class="pill">
            <strong><%= tt('manage.details.status','×¡×˜×˜×•×¡') %></strong>
            <span><%= statusLabel %></span>
          </div>
        </div>

        <% if (it.flash?.ok) { %>
          <p class="success">âœ“ <%= it.flash.ok %></p>
        <% } %>
        <% if (it.flash?.error) { %>
          <p class="error">âœ— <%= it.flash.error %></p>
        <% } %>

        <div class="actions">
          <!-- ××™×©×•×¨ ×”×’×¢×” (××•×ª× ×”) -->
          <% if (it.allowConfirm) { %>
            <form method="post" action="<%= path %>">
              <input type="hidden" name="action" value="confirm">
              <button
                class="btn btn-brand"
                type="submit"
                name="action"
                value="confirm"
                formmethod="post"
                formaction="<%= path %>?action=confirm">
                <%= tt('manage.actions.confirm','×××©×¨/×ª ×”×’×¢×”') %>
              </button>
            </form>
          <% } %>

          <!-- ×‘×™×˜×•×œ -->
          <form method="post" action="<%= path %>" onsubmit="return <%= it.allowCancel ? `confirm('${tt('manage.confirm.cancel','×œ×‘×˜×œ ××ª ×”×”×–×× ×”?')}')` : 'false' %>;">
            <input type="hidden" name="action" value="cancel">
            <button
              class="btn btn-danger"
              type="submit"
              name="action"
              value="cancel"
              formmethod="post"
              formaction="<%= path %>?action=cancel"
              <%= it.allowCancel ? '' : 'disabled aria-disabled="true"' %>>
              <%= tt('manage.actions.cancel','×‘×™×˜×•×œ ×”×–×× ×”') %>
            </button>
          </form>

          <!-- ×¨×¢× ×•×Ÿ -->
          <a class="btn btn-ghost" href="<%= path %>"><%= tt('manage.actions.refresh','×¨×¢× ×•×Ÿ') %></a>
        </div>

        <div class="hr"></div>

        <p class="muted">
          <%= tt('manage.help.text','×¦×¨×™×š ×¢×–×¨×”? ×¤× ×• ××œ×™× ×• ×¢× ××¡×¤×¨ ×”×”×–×× ×” ×©××•×¤×™×¢ ×œ××¢×œ×”.') %>
          <% if (it.restaurant?.phone) { %>
            <%= tt('manage.help.orCall','××• ×—×™×™×’×• ××œ') %>
            <strong><a class="tel" href="tel:<%= it.restaurant.phone %>"><%= it.restaurant.phone %></a></strong>.
          <% } %>
        </p>
      </div>
    </div>
  </div>

  <script>
    // ×”×¢×ª×§×ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×œ×œ×•×— (×¤×™×¦'×¨ × ×©××¨ 1:1)
    async function copyPhone(btn){
      try{
        const v = btn.getAttribute('data-phone') || '';
        await navigator.clipboard.writeText(v);
        const wrap = btn.parentElement;
        if (wrap){
          wrap.classList.add('copied');
          setTimeout(()=>wrap.classList.remove('copied'), 1500);
        }
      }catch(e){
        // fallback: ×‘×—×™×¨×ª ×”×˜×§×¡×˜ ×‘×§×™×©×•×¨
        const tel = btn.previousElementSibling;
        if (tel && window.getSelection){
          const range = document.createRange();
          range.selectNodeContents(tel);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }

    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×ª×¤×¨×™×˜ ×”×©×¤×•×ª (×›×“×•×¨ ×”××¨×¥)
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.lang-btn');
      const bars = document.querySelectorAll('.langbar');
      if(btn){
        const bar = btn.closest('.langbar');
        const isOpen = bar.classList.contains('open');
        bars.forEach(b=>b.classList.remove('open'));
        bar.classList.toggle('open', !isOpen);
        btn.setAttribute('aria-expanded', String(!isOpen));
        e.stopPropagation();
      }else{
        bars.forEach(b=>b.classList.remove('open'));
        document.querySelectorAll('.lang-btn[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
      }
    }, {passive:true});
  </script>
</body>
</html>
