<!-- /src/templates/reservation_manage.eta -->
<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title><%= it.title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f7fb;--card:#ffffff;--ink:#0f172a;--muted:#64748b;
      --brand:#06b6d4;--brand-ink:#fff;--bd:#e2e8f0;--danger:#ef4444;--ok:#16a34a;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:760px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .head{padding:22px 20px 12px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;gap:12px;align-items:center}
    h1{margin:0;font-size:26px}
    .muted{color:var(--muted)}
    .body{padding:18px 20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .pill{border:1px dashed var(--bd);border-radius:12px;padding:10px 12px;background:#fafcff}
    .pill strong{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
    .pill span{font-weight:700;letter-spacing:.3px}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    button,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block;transition:.15s ease}
    .btn-brand{background:var(--brand);color:var(--brand-ink)}
    .btn-brand:hover{filter:brightness(1.05)}
    .btn-ghost{background:transparent;border:1px solid var(--bd);color:var(--ink)}
    .btn-ghost:hover{background:#f8fafc}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{filter:brightness(1.05)}
    .btn[disabled],button[disabled]{opacity:.55;cursor:not-allowed;filter:none}
    .hr{height:1px;background:var(--bd);margin:20px 0}
    .success{color:var(--ok);font-weight:700;margin:10px 0 0}
    .error{color:var(--danger);font-weight:700;margin:10px 0 0}
    .restaurant{display:flex;gap:14px;align-items:center;margin-top:8px}
    .restaurant img{width:60px;height:60px;object-fit:cover;border-radius:10px;border:1px solid var(--bd)}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px;border:1px solid var(--bd);background:#fff}
    .badge.new{border-color:#cbd5e1;background:#f8fafc}
    .badge.confirmed{border-color:#bbf7d0;background:#f0fdf4;color:#065f46}
    .badge.canceled{border-color:#fecaca;background:#fff1f2;color:#7f1d1d}
    /* Phone block */
    .phone{margin-top:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .phone a.tel{color:#06b6d4;text-decoration:none;font-weight:700}
    .copy-btn{background:#f1f5f9;border:1px solid var(--bd);color:#0f172a;border-radius:10px;padding:6px 10px;font-weight:600;cursor:pointer}
    .copy-btn:hover{background:#e2e8f0}
    .copied-badge{display:none;font-size:12px;color:var(--ok);font-weight:700}
    .copied .copied-badge{display:inline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div>
          <h1>ניהול הזמנה</h1>
          <div class="muted">מס׳ הזמנה: <code><%= it.reservation.id %></code></div>
        </div>
        <%
          const status = (it.reservation.status || 'new');
          const statusLabel = status==='confirmed' ? 'מאושר'
                              : status==='canceled' ? 'מבוטל'
                              : 'חדש';
        %>
        <div class="badge <%= status %>">
          <% if (status==='confirmed') { %>✓<% } else if (status==='canceled') { %>✗<% } else { %>•<% } %>
          <span><%= statusLabel %></span>
        </div>
      </div>

      <div class="body">
        <!-- פרטי מסעדה -->
        <div class="restaurant">
          <% if (it.restaurant && (it.restaurant.photos && it.restaurant.photos.length)) { %>
            <img src="<%= it.restaurant.photos[0] %>" alt="<%= it.restaurant.name %>" />
          <% } %>
          <div>
            <div style="font-weight:700"><%= it.restaurant?.name || "מסעדה" %></div>
            <div class="muted"><%= it.restaurant?.address || "" %></div>

            <!-- טלפון: לחיץ לחיוג + כפתור העתקה -->
            <% if (it.restaurant?.phone) { 
                 const phone = String(it.restaurant.phone);
            %>
              <div class="phone" id="phone-block">
                <span>📞</span>
                <a class="tel" href="tel:<%= phone %>"><%= phone %></a>
                <button class="copy-btn" type="button" data-phone="<%= phone %>" onclick="copyPhone(this)">העתקה</button>
                <span class="copied-badge" aria-live="polite">הועתק ✓</span>
              </div>
            <% } %>
          </div>
        </div>

        <div class="hr"></div>

        <!-- פרטי הזמנה -->
        <div class="grid">
          <div class="pill">
            <strong>תאריך</strong>
            <span><%= it.reservation.date %></span>
          </div>
          <div class="pill">
            <strong>שעה</strong>
            <span><%= it.reservation.time %></span>
          </div>
          <div class="pill">
            <strong>מס׳ סועדים</strong>
            <span><%= it.reservation.people %></span>
          </div>
          <div class="pill">
            <strong>סטטוס</strong>
            <span><%= statusLabel %></span>
          </div>
        </div>

        <% if (it.flash?.ok) { %>
          <p class="success">✓ <%= it.flash.ok %></p>
        <% } %>
        <% if (it.flash?.error) { %>
          <p class="error">✗ <%= it.flash.error %></p>
        <% } %>

        <div class="actions">
          <!-- אישור הגעה (מופיע רק כשהוא אפשרי) -->
          <% if (it.allowConfirm) { %>
            <form method="post" action="/r/<%= it.token %>">
              <input type="hidden" name="action" value="confirm">
              <button
                class="btn btn-brand"
                type="submit"
                name="action"
                value="confirm"
                formmethod="post"
                formaction="/r/<%= it.token %>?action=confirm"
              >מאשר/ת הגעה</button>
            </form>
          <% } %>

          <!-- ביטול (תמיד זמין עד שההזמנה כבר בוטלה) -->
          <form method="post" action="/r/<%= it.token %>" onsubmit="return <%= it.allowCancel ? 'confirm(&#39;לבטל את ההזמנה?&#39;)' : 'false' %>;">
            <input type="hidden" name="action" value="cancel">
            <button
              class="btn btn-danger"
              type="submit"
              name="action"
              value="cancel"
              formmethod="post"
              formaction="/r/<%= it.token %>?action=cancel"
              <%= it.allowCancel ? '' : 'disabled aria-disabled="true"' %>
            >
              ביטול הזמנה
            </button>
          </form>

          <!-- רענון דף -->
          <a class="btn btn-ghost" href="/r/<%= it.token %>">רענון</a>
        </div>

        <div class="hr"></div>

        <p class="muted">
          צריך עזרה? פנו אלינו עם מספר ההזמנה שמופיע למעלה.
          <% if (it.restaurant?.phone) { %>
            או חייגו אל <strong><a class="tel" href="tel:<%= it.restaurant.phone %>"><%= it.restaurant.phone %></a></strong>.
          <% } %>
        </p>
      </div>
    </div>
  </div>

  <script>
    // העתקת מספר הטלפון ללוח
    async function copyPhone(btn){
      try{
        const v = btn.getAttribute('data-phone') || '';
        await navigator.clipboard.writeText(v);
        const wrap = btn.parentElement;
        if (wrap){
          wrap.classList.add('copied');
          setTimeout(()=>wrap.classList.remove('copied'), 1500);
        }
      }catch(e){
        // fallback: בחר טקסט בקישור
        const tel = btn.previousElementSibling;
        if (tel && window.getSelection){
          const range = document.createRange();
          range.selectNodeContents(tel);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }
  </script>
</body>
</html>
