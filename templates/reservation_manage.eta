<% layout("_layout", it) %>

<section class="resv-mgr">
  <header class="hd">
    <div class="info">
      <h1 class="title">ניהול הזמנה</h1>
      <% if (it.restaurant?.name) { %>
        <div class="muted">למסעדה <strong><%= it.restaurant.name %></strong></div>
      <% } %>
    </div>
    <div class="status">
      <span class="badge <%= it.reservation?.status==='cancelled' ? 'bad':'good' %>">
        <%= it.reservation?.status==='cancelled' ? 'בוטלה' : 'פעילה' %>
      </span>
    </div>
  </header>

  <div class="grid">
    <!-- טופס עריכה -->
    <article class="card">
      <h2 class="h2">עדכון פרטי ההזמנה</h2>
      <form method="post" action="<%= (it.links && it.links.update) || '/reservations/update' %>">
        <% if (it.reservation?.id) { %><input type="hidden" name="id" value="<%= it.reservation.id %>"><% } %>
        <% if (it.restaurant?.id) { %><input type="hidden" name="rid" value="<%= it.restaurant.id %>"><% } %>

        <div class="row">
          <label>
            <span>תאריך</span>
            <input type="date" name="date" value="<%= it.reservation?.date || it.defaultDate || '' %>" required>
          </label>
          <label>
            <span>שעה</span>
            <input type="time" name="time" value="<%= it.reservation?.time || it.defaultTime || '' %>" required step="<%= it.slotStepSeconds || 900 %>">
          </label>
          <label>
            <span>מס’ סועדים</span>
            <input type="number" min="1" max="<%= it.restaurant?.capacity || 50 %>" step="1" name="size" value="<%= it.reservation?.size || it.reservation?.guests || 2 %>" required>
          </label>
        </div>

        <% if (it.presetSlots && it.presetSlots.length) { %>
          <div class="slots">
            <% it.presetSlots.forEach(s => { %>
              <button class="chip" name="time" value="<%= s %>" type="submit"><%= s %></button>
            <% }) %>
          </div>
        <% } %>

        <label class="block">
          <span>שם המזמין/ה</span>
          <input type="text" name="name" value="<%= it.reservation?.name || it.reservation?.contactName || '' %>" placeholder="שם פרטי ומשפחה">
        </label>
        <div class="row">
          <label>
            <span>טלפון</span>
            <input type="tel" dir="ltr" name="phone" value="<%= it.reservation?.phone || it.reservation?.contactPhone || '' %>">
          </label>
          <label>
            <span>אימייל</span>
            <input type="email" dir="ltr" name="email" value="<%= it.reservation?.email || '' %>">
          </label>
        </div>

        <label class="block">
          <span>הערות</span>
          <textarea name="notes" rows="3" placeholder="אלרגיות, העדפות ישיבה וכו’"><%= it.reservation?.notes || '' %></textarea>
        </label>

        <div class="actions">
          <button class="btn" type="submit">שמירה</button>
          <% if (it.links?.cancel && it.reservation?.status!=='cancelled') { %>
          <form class="inline" method="post" action="<%= it.links.cancel %>" onsubmit="return confirm('לבטל את ההזמנה?')">
            <button class="btn danger" type="submit">ביטול הזמנה</button>
          </form>
          <% } %>
          <% if (it.links?.details) { %><a class="btn secondary" href="<%= it.links.details %>">צפייה בהזמנה</a><% } %>
        </div>

        <% if (it.policy?.change) { %>
          <p class="muted small">מדיניות שינוי/ביטול: <%= it.policy.change %></p>
        <% } %>
      </form>
    </article>

    <!-- צד משלים -->
    <aside class="stack">
      <% if ((it.qr && it.qr.src) || it.reservation?.id) { %>
      <article class="card">
        <h3 class="h3">קוד הזמנה</h3>
        <div class="qr">
          <% if (it.qr?.src) { %>
            <img src="<%= it.qr.src %>" alt="QR להזמנה" width="160" height="160">
          <% } else { %>
            <img src="/qr?text=<%= encodeURIComponent(String(it.reservation.id)) %>" alt="QR להזמנה" width="160" height="160">
          <% } %>
        </div>
        <div class="muted small" dir="ltr">#<%= it.reservation?.id || '' %></div>
      </article>
      <% } %>

      <% if (it.calendar && (it.calendar.ics || it.calendar.google || it.calendar.apple)) { %>
      <article class="card">
        <h3 class="h3">הוסף ליומן</h3>
        <div class="row chips">
          <% if (it.calendar.ics) { %><a class="chip" href="<%= it.calendar.ics %>">ICS</a><% } %>
          <% if (it.calendar.google) { %><a class="chip" href="<%= it.calendar.google %>" target="_blank" rel="noopener">Google</a><% } %>
          <% if (it.calendar.apple) { %><a class="chip" href="<%= it.calendar.apple %>">Apple</a><% } %>
        </div>
      </article>
      <% } %>

      <% if (it.restaurant && (it.restaurant.phone || it.restaurant.map || it.restaurant.website)) { %>
      <article class="card">
        <h3 class="h3">יצירת קשר</h3>
        <ul class="list">
          <% if (it.restaurant.phone) { %><li><a href="tel:<%= it.restaurant.phone %>">📞 <span dir="ltr"><%= it.restaurant.phone %></span></a></li><% } %>
          <% if (it.restaurant.website) { %><li><a href="<%= it.restaurant.website %>" target="_blank" rel="noopener">🌐 אתר המסעדה</a></li><% } %>
          <% if (it.restaurant.map) { %><li><a href="<%= it.restaurant.map %>" target="_blank" rel="noopener">🗺️ מפות</a></li><% } %>
        </ul>
      </article>
      <% } %>
    </aside>
  </div>
</section>

<style>
  :root{--bd:#23293a;--panel:#12151b;--panel2:#161a21;--ink:#e6e9ef;--ink-dim:#9aa3b2}

  .resv-mgr{max-width:1100px;margin:0 auto;display:grid;gap:16px}
  .hd{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .title{margin:0}
  .muted{color:var(--ink-dim)}
  .badge{padding:5px 8px;border-radius:999px;border:1px solid #334155;font-size:12px}
  .badge.good{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
  .badge.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}

  .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg, rgba(22,26,33,.9), rgba(16,19,25,.94));border:1px solid var(--bd);border-radius:14px;padding:12px}
  .h2{margin:0 0 8px;font-size:18px}
  .h3{margin:0 0 8px;font-size:16px}

  form .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  form label{display:grid;gap:6px}
  input, textarea{
    background:var(--panel2);color:var(--ink);border:1px solid var(--bd);border-radius:10px;padding:8px 10px
  }
  textarea{resize:vertical}
  .block{margin-top:8px}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid #2a3040;background:transparent;color:var(--ink);font-weight:600;text-decoration:none}
  .btn.secondary{opacity:.9}
  .btn:hover{transform:translateY(-1px)}
  .btn.danger{border-color:rgba(239,68,68,.45);color:#fecaca}

  .slots{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3040;background:transparent;color:var(--ink);cursor:pointer}
  .chip:hover{transform:translateY(-1px)}

  .stack{display:grid;gap:12px}
  .qr{display:flex;justify-content:center;margin:6px 0}
  .list{list-style:none;margin:0;padding:0;display:grid;gap:6px}
  .list a{color:var(--ink);text-decoration:none}
  .list a:hover{text-decoration:underline}
</style>
