<% layout("_layout", it) %>

<%
  const restaurant = it.restaurant || {};
  const suppliers  = Array.isArray(it.suppliers) ? it.suppliers : [];
  const pos        = Array.isArray(it.pos) ? it.pos : [];

  function esc(s){ return String(s ?? ""); }

  // i18n helper with fallback
  function tt(k, fb){
    try{
      if (it && typeof it.t === "function"){
        const s = it.t(k);
        if (!s || s === k || s === `(${k})`) return fb;
        return s;
      }
    } catch(e){}
    return fb;
  }

  function fmtDate(ms){
    if (!ms && ms !== 0) return "";
    const d = new Date(ms);
    if (Number.isNaN(d.getTime())) return "";
    return d.toLocaleDateString("he-IL", { day:"2-digit", month:"2-digit", year:"2-digit" });
  }

  function statusLabel(st){
    if (!st) return tt('pos_list.status_draft', 'Draft');
    switch(String(st)){
      case "draft": return tt('pos_list.status_draft', 'Draft');
      case "sent": return tt('pos_list.status_sent', 'Sent');
      case "delivered": return tt('pos_list.status_delivered', 'Delivered');
      case "cancelled": return tt('pos_list.status_cancelled', 'Cancelled');
      default: return st;
    }
  }
%>

<section class="sb-owner container" aria-label="<%= tt('pos_list.aria', 'Purchase Orders') %>">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1><%= tt('pos_list.title', 'Purchase Orders') %> Â· <%= restaurant.name || tt('pos_list.restaurant_fallback', 'Restaurant') %></h1>
        <p class="muted">
          <%= tt('pos_list.subtitle', 'Create and manage purchase orders for suppliers. When an order is marked as "Delivered", ingredient inventory is automatically updated based on the order lines.') %>
        </p>
      </div>
      <div class="actions">
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/stock">ğŸ¥¬ <%= tt('pos_list.btn_stock', 'Inventory') %></a>
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/suppliers">ğŸ“¦ <%= tt('pos_list.btn_suppliers', 'Suppliers') %></a>
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/costs">ğŸ“ˆ <%= tt('pos_list.btn_costs', 'Costs') %></a>
      </div>
    </header>

    <!-- Create new order -->
    <div class="panel card" style="margin-top:14px">
      <h2 class="card-title"><%= tt('pos_list.new_order', 'New Order') %></h2>

      <form class="form row" method="post" action="/owner/<%= restaurant.id %>/inventory/purchase_orders/new">
        <label class="lbl">
          <%= tt('pos_list.lbl_supplier', 'Supplier') %> *
          <select name="supplierId" required>
            <option value=""><%= tt('pos_list.ph_select_supplier', 'Select supplier...') %></option>
            <% suppliers.forEach(function(s){ %>
              <% if (s && s.isActive !== false) { %>
                <option value="<%= esc(s.id) %>"><%= esc(s.name) %></option>
              <% } %>
            <% }) %>
          </select>
        </label>

        <label class="lbl">
          <%= tt('pos_list.lbl_expected', 'Expected Delivery') %>
          <input name="expectedAt" type="date">
        </label>

        <label class="lbl" style="min-width:260px;flex:1">
          ×”×¢×¨×•×ª ×œ×”×–×× ×”
          <input name="note" placeholder="×œ×“×•×’××”: ××©×œ×•×— ×œ×™×•× ×—××™×©×™ ×‘×‘×•×§×¨, ×œ×©×™× ×‘××§×¨×¨ ×”×××¦×¢×™">
        </label>

        <button class="btn primary sm" type="submit">â• ×¦×•×¨ ×”×–×× ×”</button>
      </form>
      <p class="muted small" style="margin-top:8px">
        ×× ×œ× ×”×•×–×Ÿ ×ª××¨×™×š ×¦×¤×™, ×”××¢×¨×›×ª ×™×›×•×œ×” ×œ×”×©×ª××© ×‘×–××Ÿ ×”××¡×¤×§×” ×”×˜×™×¤×•×¡×™ ×©×œ ×”×¡×¤×§ (leadTimeDays).
      </p>
    </div>

    <!-- ×¨×©×™××ª ×”×–×× ×•×ª -->
    <div class="panel card" style="margin-top:16px">
      <h2 class="card-title">×›×œ ×”×–×× ×•×ª ×”×¨×›×©</h2>

      <% if (!pos.length) { %>
        <p class="muted">×¢×“×™×™×Ÿ ××™×Ÿ ×”×–×× ×•×ª ×¨×›×©. ×¦×•×¨ ×”×–×× ×” ×—×“×©×” ×œ××¢×œ×”.</p>
      <% } else { %>

        <div class="table">
          <div class="tr th">
            <div>××¡×³ ×”×–×× ×”</div>
            <div>×¡×¤×§</div>
            <div>×¡×˜×˜×•×¡</div>
            <div>× ×•×¦×¨ ×‘×ª××¨×™×š</div>
            <div>×¦×¤×™ ××¡×¤×§×”</div>
            <div>×¡×•×¤×§ ×‘×ª××¨×™×š</div>
            <div></div>
          </div>

          <% pos.forEach(function(po){ %>
            <div class="tr">
              <div class="td">
                <span class="muted small">PO-</span><%= esc(po.id) %>
              </div>

              <div class="td">
                <%= esc(po.supplierNameSnapshot || po.supplierName || 'â€”') %>
              </div>

              <div class="td">
                <span class="po-status po-status-<%= esc(po.status || 'draft') %>">
                  <%= statusLabel(po.status) %>
                </span>
              </div>

              <div class="td">
                <%= fmtDate(po.createdAt) || 'â€”' %>
              </div>

              <div class="td">
                <%= fmtDate(po.expectedAt) || 'â€”' %>
              </div>

              <div class="td">
                <%= fmtDate(po.deliveredAt) || 'â€”' %>
              </div>

              <div class="td right">
                <a
                  class="btn primary sm"
                  href="/owner/<%= restaurant.id %>/inventory/purchase_orders/<%= esc(po.id) %>"
                >
                  ×¤×ª×™×—×ª ×”×–×× ×”
                </a>
              </div>
            </div>
          <% }) %>
        </div>

      <% } %>
    </div>
  </div>
</section>

<style>
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}

  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px; padding:18px; margin-bottom:18px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .panel.card{height:100%}

  .owner-hd{display:flex;align-items:flex-start;gap:12px;justify-content:space-between}
  .card-title{ margin:0 0 10px; font-size: clamp(16px, 2.2vw, 20px) }
  .muted{ color: var(--ink-muted, #9aa3b2); }
  .small{ font-size:12px; }

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:12px; cursor:pointer; text-decoration:none;
    border:1px solid var(--bd, #23293a); background:transparent;
    color: var(--ink, #e6e8ef); font-weight:700;
    transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{
    background: var(--brand, #3b82f6); color: var(--brand-ink, #fff); border-color:transparent;
    box-shadow: 0 8px 24px rgba(59,130,246,.35);
  }
  .btn.ghost{background:rgba(15,23,42,.6);}
  .btn.sm{ padding:8px 12px; border-radius:10px; font-size:13px }

  .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
  .lbl{display:block;font-weight:700;font-size:13px}
  .lbl input, .lbl select{
    width:200px; padding:10px 12px; margin-top:6px;
    background:#171b29; color:#e6e8ef; border:1px solid #23293a; border-radius:12px;
    font-size:14px; outline:none;
  }

  .table{margin-top:10px;border:1px solid rgba(148,163,184,.18);border-radius:14px;overflow:hidden}
  .tr{display:grid;grid-template-columns:.9fr 1.4fr .9fr 1.1fr 1.1fr 1.1fr 1.1fr;gap:10px;align-items:center;padding:10px 12px;border-top:1px solid rgba(255,255,255,.06)}
  .tr:first-child{border-top:none}
  .th{background:rgba(148,163,184,.08);font-weight:900;color:#dbe3f0}

  .td{min-width:0}
  .td.right{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}

  .po-status{
    display:inline-flex;align-items:center;justify-content:center;
    padding:4px 8px;border-radius:999px;font-size:11px;
    background:rgba(148,163,184,.18);
  }
  .po-status-draft{background:rgba(148,163,184,.18);}
  .po-status-sent{background:rgba(59,130,246,.25);}
  .po-status-delivered{background:rgba(34,197,94,.25);}
  .po-status-cancelled{background:rgba(248,113,113,.25);}

  @media (max-width:950px){
    .tr{grid-template-columns:1fr}
    .td.right{justify-content:flex-start}
    .lbl input, .lbl select{width:100%}
  }
</style>
