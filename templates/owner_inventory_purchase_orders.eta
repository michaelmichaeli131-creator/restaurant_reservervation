<% layout("_layout", it) %>
<%
  const restaurant = it.restaurant || {};
  const suppliers  = Array.isArray(it.suppliers) ? it.suppliers : [];
  const pos        = Array.isArray(it.pos) ? it.pos : [];

  function fmtDate(ms){
    if(!ms) return '-';
    try{ return new Date(ms).toISOString().slice(0,10); }catch(e){ return '-'; }
  }
  function esc(x){ return String(x ?? '').replaceAll('"','&quot;'); }
%>

<section class="sb-owner container" aria-label="×”×–×× ×•×ª ×¨×›×©">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1>×”×–×× ×•×ª ×¨×›×© Â· <%= restaurant.name || '××¡×¢×“×”' %></h1>
        <p class="muted">
          ××™× ×™××•× ×”×›×¨×—×™: ×™×•×¦×¨×™× PO ×œ×¡×¤×§, ××’×“×™×¨×™× ×¦×¤×™ ×”×’×¢×” (expectedAt), ××•×¡×™×¤×™× ×©×•×¨×•×ª (×—×•××¨ ×’×œ× + ×›××•×ª), ×•×‘×¡×•×£ ××¡×× ×™× "×¡×•×¤×§" â€” ×•××– × ×•×¦×¨×•×ª ×ª× ×•×¢×•×ª ××œ××™ <code>delivery</code>.
        </p>
      </div>
      <div class="actions">
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/suppliers">ğŸ­ ×¡×¤×§×™×</a>
        <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/stock">ğŸ“¦ ××œ××™</a>
      </div>
    </header>

    <div class="panel card" style="margin-top:14px">
      <h2 class="card-title">×™×¦×™×¨×ª PO ×—×“×©</h2>

      <% if (!suppliers.length) { %>
        <p class="muted">×›×“×™ ×œ×™×¦×•×¨ ×”×–×× ×”, ×§×•×“× ×”×•×¡×£ ×¡×¤×§×™×.</p>
        <a class="btn primary sm" href="/owner/<%= restaurant.id %>/inventory/suppliers">â• ×”×•×¡×£ ×¡×¤×§</a>
      <% } else { %>
        <form class="row" method="post" action="/owner/<%= restaurant.id %>/inventory/purchase_orders/new">
          <label class="lbl">
            ×¡×¤×§
            <select name="supplierId" class="in" required style="width:220px">
              <option value="">×‘×—×¨ ×¡×¤×§...</option>
              <% suppliers.forEach(function(s){ %>
                <option value="<%= s.id %>"><%= s.name %> (Lead: <%= Number(s.leadTimeDays||0) %>d)</option>
              <% }) %>
            </select>
          </label>

          <label class="lbl">
            ×¦×¤×™ ×”×’×¢×” (××•×¤×¦×™×•× ×œ×™)
            <input class="in" name="expectedAt" type="date" style="width:180px">
          </label>

          <label class="lbl" style="min-width:260px">
            ×”×¢×¨×”
            <input class="in" name="note" placeholder="××•×¤×¦×™×•× ×œ×™">
          </label>

          <button class="btn primary sm" type="submit">â• ×¦×•×¨ ×”×–×× ×”</button>
        </form>
        <p class="muted small" style="margin-top:6px">
          ×× ×œ× ×ª××œ× ×¦×¤×™ ×”×’×¢×” â€” ×”××¢×¨×›×ª ×ª×—×©×‘ ××•×˜×•××˜×™×ª: ×”×™×•× + leadTimeDays ×©×œ ×”×¡×¤×§.
        </p>
      <% } %>
    </div>

    <div class="panel card" style="margin-top:14px">
      <h2 class="card-title">×”×–×× ×•×ª ×§×™×™××•×ª</h2>

      <% if (!pos.length) { %>
        <p class="muted">××™×Ÿ ×¢×“×™×™×Ÿ ×”×–×× ×•×ª ×¨×›×©.</p>
      <% } else { %>
        <div class="table">
          <div class="tr th">
            <div>×ª××¨×™×š ×™×¦×™×¨×”</div>
            <div>×¡×¤×§</div>
            <div>×¡×˜×˜×•×¡</div>
            <div>×¦×¤×™ ×”×’×¢×”</div>
            <div>×©×•×¨×•×ª</div>
            <div></div>
          </div>

          <% pos.forEach(function(po){ %>
            <div class="tr">
              <div class="td"><%= fmtDate(po.createdAt) %></div>
              <div class="td"><strong><%= po.supplierNameSnapshot || '×¡×¤×§' %></strong></div>
              <div class="td">
                <span class="pill <%= po.status %>"><%= po.status %></span>
              </div>
              <div class="td"><%= fmtDate(po.expectedAt) %></div>
              <div class="td"><%= Array.isArray(po.lines) ? po.lines.length : 0 %></div>

              <div class="td right" style="gap:8px;display:flex;justify-content:flex-end;flex-wrap:wrap">
                <a class="btn ghost sm" href="/owner/<%= restaurant.id %>/inventory/purchase_orders/<%= po.id %>">×¤×ª×—</a>

                <% if (po.status !== 'delivered' && po.status !== 'cancelled') { %>
                  <form method="post" action="/owner/<%= restaurant.id %>/inventory/purchase_orders/<%= po.id %>/send">
                    <button class="btn ghost sm" type="submit">× ×©×œ×—</button>
                  </form>
                  <form method="post" action="/owner/<%= restaurant.id %>/inventory/purchase_orders/<%= po.id %>/delivered"
                        onsubmit="return confirm('×œ×¡××Ÿ ×›×¡×•×¤×§? ×–×” ×™×•×¡×™×£ ××œ××™ (delivery) ×œ×›×œ ×”×©×•×¨×•×ª.')">
                    <button class="btn primary sm" type="submit">×¡×•×¤×§</button>
                  </form>
                  <form method="post" action="/owner/<%= restaurant.id %>/inventory/purchase_orders/<%= po.id %>/cancel"
                        onsubmit="return confirm('×œ×‘×˜×œ ×”×–×× ×”?')">
                    <button class="btn ghost sm" type="submit">×‘×˜×œ</button>
                  </form>
                <% } %>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>
</section>

<style>
  .sb-owner.container{max-width:1100px;margin:20px auto;padding:0 16px}
  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px; padding:18px; margin-bottom:18px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .panel.card{height:100%}
  .owner-hd{display:flex;align-items:flex-start;gap:12px;justify-content:space-between}
  .card-title{ margin:0 0 10px; font-size: clamp(16px, 2.2vw, 20px) }
  .muted{ color: var(--ink-muted, #9aa3b2); }
  .small{ font-size:12px; }
  code{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.22);padding:1px 6px;border-radius:8px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:12px; cursor:pointer; text-decoration:none;
    border:1px solid var(--bd, #23293a); background:transparent;
    color: var(--ink, #e6e8ef); font-weight:700;
  }
  .btn.primary{
    background: var(--brand, #3b82f6); color: var(--brand-ink, #fff); border-color:transparent;
    box-shadow: 0 8px 24px rgba(59,130,246,.35);
  }
  .btn.ghost{background:rgba(15,23,42,.6);}
  .btn.sm{ padding:8px 12px; border-radius:10px; font-size:13px }

  .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
  .lbl{display:block;font-weight:700;font-size:13px}

  .in{
    padding:10px 12px;
    background:#171b29;color:#e6e8ef;border:1px solid #23293a;border-radius:12px;
    font-size:14px; outline:none;
  }

  .table{margin-top:10px;border:1px solid rgba(148,163,184,.18);border-radius:14px;overflow:hidden}
  .tr{display:grid;grid-template-columns:1fr 1.3fr .7fr .9fr .5fr 1.2fr;gap:10px;align-items:center;padding:10px 12px;border-top:1px solid rgba(255,255,255,.06)}
  .tr:first-child{border-top:none}
  .th{background:rgba(148,163,184,.08);font-weight:900;color:#dbe3f0}
  .td{min-width:0}
  .td.right{display:flex;justify-content:flex-end}

  .pill{
    display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;
    border:1px solid rgba(148,163,184,.25);background:rgba(148,163,184,.10);
    font-size:12px;color:#d7deea
  }
  .pill.delivered{border-color:rgba(52,211,153,.45);background:rgba(16,185,129,.10);color:#6ee7b7}
  .pill.cancelled{border-color:rgba(248,113,113,.55);background:rgba(248,113,113,.08);color:#fecaca}
  .pill.sent{border-color:rgba(59,130,246,.55);background:rgba(59,130,246,.10);color:#bfdbfe}

  @media (max-width:950px){
    .tr{grid-template-columns:1fr}
  }
</style>
