<% layout("_layout", it) %>

<%
  const restaurant  = it.restaurant || {};
  const menuItems   = Array.isArray(it.menuItems) ? it.menuItems : [];
  const recipes     = Array.isArray(it.recipes) ? it.recipes : [];
  const ingredientsArr = Array.isArray(it.ingredients) ? it.ingredients : [];

  // ××¤×” ××”×™×¨×” recipe ×œ×¤×™ itemId
  const recipeMapSrv = {};
  recipes.forEach(function(r){
    if (!r.menuItemId) return;
    recipeMapSrv[r.menuItemId] = r;
  });
%>

<section class="sb-owner container" aria-label="××ª×›×•× ×™ ×× ×•×ª ×•×—×•××¨×™ ×’×œ×">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1>××ª×›×•× ×™ ×× ×•×ª Â· <%= restaurant.name || '××¡×¢×“×”' %></h1>
        <p class="muted">
          ×›××Ÿ ××’×“×™×¨×™× ××™×œ×• ×—×•××¨×™ ×’×œ× ×•×›××•×™×•×ª ×©×™×™×›×™× ×œ×›×œ ×× ×” ×‘×ª×¤×¨×™×˜.
          ×‘×›×œ ×¤×¢× ×©×”×× ×” ××•×–×× ×ª ×‘-POS, ×”××¢×¨×›×ª ×ª×•×¨×™×“ ××•×˜×•××˜×™×ª ××ª ×”×›××•×ª ××”××œ××™.
        </p>
      </div>
    </header>

    <div class="inv-grid">
      <!-- ×¦×“ ×™××™×Ÿ: ×˜×•×¤×¡ ×¢×¨×™×›×ª ××ª×›×•×Ÿ ×œ×× ×” × ×‘×—×¨×ª -->
      <div class="panel card">
        <h2 class="card-title">×¢×¨×™×›×ª ××ª×›×•×Ÿ ×œ×× ×”</h2>

        <% if (!menuItems.length) { %>
          <p class="muted">
            ××™×Ÿ ×¢×“×™×™×Ÿ ×× ×•×ª ×‘×ª×¤×¨×™×˜, ×œ×›×Ÿ ××™×Ÿ ××” ×œ×”×’×“×™×¨ ×›××ª×›×•× ×™×.
            <br>
            <small>×¢×‘×•×¨ ×œ×“×£ "×¢×¨×™×›×ª ×ª×¤×¨×™×˜" ×•×”×•×¡×£ ×× ×•×ª ×—×“×©×•×ª.</small>
          </p>
        <% } else if (!ingredientsArr.length) { %>
          <p class="muted">
            ××™×Ÿ ×¢×“×™×™×Ÿ ×—×•××¨×™ ×’×œ× ×‘××œ××™, ×œ×›×Ÿ ××™ ××¤×©×¨ ×œ×‘× ×•×ª ××ª×›×•× ×™×.
            <br>
            <small>×¢×‘×•×¨ ×œ×“×£ "××œ××™ ×—×•××¨×™ ×’×œ×" ×•×”×•×¡×£ ×—×•××¨×™ ×’×œ×.</small>
          </p>
        <% } else { %>
          <form
            action="/owner/<%= restaurant.id %>/inventory/recipes/save"
            method="post"
            class="form"
            id="recipe-form"
          >
            <label>
              ×× ×” ×‘×ª×¤×¨×™×˜
              <select name="menuItemId" id="menuItemId" required>
                <option value="">×‘×—×¨ ×× ×”...</option>
                <% menuItems.forEach(function(mi){ %>
                  <option value="<%= mi.id %>">
                    <%= mi.name_he || mi.name_en || '×œ×œ× ×©×' %>
                  </option>
                <% }) %>
              </select>
            </label>

            <p class="muted" style="margin-top:6px">
              1. ×‘×—×¨ ×× ×” ××œ××¢×œ×”.  
              2. ×œ×›×œ ×©×•×¨×” ×œ××˜×”: ×‘×—×¨ <strong>×—×•××¨ ×’×œ×</strong> ×•×”×›× ×¡ <strong>×›××•×ª ×œ×™×—×™×“×ª ×× ×”</strong>.  
              3. × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×›××” ×¨×›×™×‘×™× ×©×ª×¨×¦×” ×‘×××¦×¢×•×ª "â• ×”×•×¡×£ ×¨×›×™×‘".
            </p>

            <!-- ×›××Ÿ ××•×¤×™×¢×•×ª ×©×•×¨×•×ª ×—×•××¨×™ ×”×’×œ× ×œ×× ×” -->
            <div class="recipe-grid" id="recipe-components">
              <!-- ×™×ª×•×•×¡×£ ×œ×¤×—×•×ª ×¨×›×™×‘ ××—×“ ×›×‘×¨×™×¨×ª ××—×“×œ ×‘-JS -->
            </div>

            <button
              type="button"
              class="btn ghost sm"
              id="btn-add-component"
              style="margin-top:8px"
            >
              â• ×”×•×¡×£ ×¨×›×™×‘ (×—×•××¨ ×’×œ× × ×•×¡×£ ×œ×× ×”)
            </button>

            <label style="margin-top:12px">
              ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)
              <input
                name="note"
                id="recipe-note"
                placeholder="×”×¢×¨×•×ª ×©×£ / ×’×¨×¡×” ××™×•×—×“×ª ×©×œ ×”×× ×”"
              >
            </label>

            <!-- JSON ×©×œ ×”×¨×›×™×‘×™× -->
            <input type="hidden" name="components" id="components-json">

            <button class="btn primary sm" type="submit" style="margin-top:10px">
              ğŸ’¾ ×©××™×¨×ª ××ª×›×•×Ÿ
            </button>
          </form>
        <% } %>
      </div>

      <!-- ×¦×“ ×©×××œ: ×¡×§×™×¨×” ×©×œ ×›×œ ×”×× ×•×ª ×¢× ×”×¤×™×¨×•×§ ×©×œ×”×Ÿ -->
      <div class="panel card">
        <h2 class="card-title">×›×œ ×”×× ×•×ª ×•×—×•××¨×™ ×”×’×œ× ×©×œ×”×Ÿ</h2>

        <% if (menuItems.length) { %>
          <div class="recipes-list">
            <% menuItems.forEach(function(mi){
                 const r    = recipeMapSrv[mi.id];
                 const rows = Array.isArray(r?.components) ? r.components : [];
            %>
              <article class="recipe-card">
                <header class="recipe-header">
                  <div>
                    <div class="recipe-title">
                      <strong><%= mi.name_he || mi.name_en || '×œ×œ× ×©×' %></strong>
                    </div>
                    <% if (mi.price) { %>
                      <div class="recipe-sub muted">
                        ××—×™×¨ ×‘×ª×¤×¨×™×˜: <%= Number(mi.price).toFixed(2) %> â‚ª
                      </div>
                    <% } %>
                  </div>
                  <% if (rows.length) { %>
                    <span class="badge ok">××ª×›×•×Ÿ ××•×’×“×¨</span>
                  <% } else { %>
                    <span class="badge bad">××™×Ÿ ××ª×›×•×Ÿ</span>
                  <% } %>
                </header>

                <% if (rows.length) { %>
                  <ul class="recipe-rows">
                    <% rows.forEach(function(row){
                         const ingId = row.ingredientId || row.id;
                         const qty   = Number(row.qty ?? row.quantity ?? 0);
                         const ing   = ingredientsArr.find(function(x){ return x.id === ingId; }) || {};
                    %>
                      <li>
                        <span class="ing-name">
                          <%= ing.name || ing.ingredientName || '×—×•××¨ ×’×œ×' %>
                        </span>
                        <span class="ing-qty">
                          <%= qty %> <%= ing.unit || '' %>
                        </span>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <p class="muted small">
                    ×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×• ×—×•××¨×™ ×’×œ× ×œ×× ×” ×–×•.
                  </p>
                <% } %>

                <% if (r && r.note) { %>
                  <p class="muted small">×”×¢×¨×•×ª: <%= r.note %></p>
                <% } %>
              </article>
            <% }) %>
          </div>
        <% } else { %>
          <p class="muted">
            ××™×Ÿ ×¢×“×™×™×Ÿ ×× ×•×ª ×‘×ª×¤×¨×™×˜, ×œ×›×Ÿ ××™×Ÿ ××” ×œ×”×’×“×™×¨ ×›××ª×›×•× ×™×.
          </p>
        <% } %>
      </div>
    </div>
  </div>
</section>

<script>
  (function(){
    // × ×ª×•× ×™× ××”×©×¨×ª (×©×™××•×© ×™×©×™×¨ ×‘-it ×›×“×™ ×œ×•×•×“× ×©×ª××™×“ ×™×© ×¢×¨×š)
    var ingredients  = <%- JSON.stringify(Array.isArray(ingredientsArr) ? ingredientsArr : []) %>;
    var recipeMap    = <%- JSON.stringify(recipeMapSrv || {}) %>;

    var container    = document.getElementById('recipe-components');
    var btnAdd       = document.getElementById('btn-add-component');
    var form         = document.getElementById('recipe-form');
    var hiddenJson   = document.getElementById('components-json');
    var selectItem   = document.getElementById('menuItemId');
    var noteInput    = document.getElementById('recipe-note');

    console.log("[Recipes view] init", {
      hasContainer: !!container,
      hasBtnAdd: !!btnAdd,
      hasForm: !!form,
      hasHiddenJson: !!hiddenJson,
      hasSelectItem: !!selectItem,
      ingredientsCount: ingredients.length
    });

    if (!container || !btnAdd || !form || !hiddenJson || !selectItem) {
      console.warn("[Recipes view] missing DOM element(s)", {
        container: !!container,
        btnAdd: !!btnAdd,
        form: !!form,
        hiddenJson: !!hiddenJson,
        selectItem: !!selectItem
      });
      return;
    }

    function buildIngredientOptions(selectedId) {
      var html = '<option value="">×—×•××¨ ×’×œ×...</option>';
      html += ingredients.map(function(ing){
        var sel = (selectedId && selectedId === ing.id) ? ' selected' : '';
        return '<option value="'+ing.id+'"'+sel+'>'+ing.name+' ('+(ing.unit || 'unit')+')</option>';
      }).join('');
      return html;
    }

    function renderRow(value) {
      var wrap = document.createElement('div');
      wrap.className = 'recipe-row';

      var sel = document.createElement('select');
      sel.className = 'recipe-ingredient';
      sel.required = true;
      sel.innerHTML = buildIngredientOptions(value && value.ingredientId);

      var inputQty = document.createElement('input');
      inputQty.type = 'number';
      inputQty.min = '0';
      inputQty.step = '0.001';
      inputQty.required = true;
      inputQty.placeholder = '×›××•×ª ×œ×™×—×™×“×” ××—×ª';
      inputQty.className = 'recipe-qty';
      if (value && typeof value.qty === 'number') {
        inputQty.value = value.qty;
      }

      var btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.className = 'btn ghost sm';
      btnDel.textContent = 'âœ•';

      btnDel.addEventListener('click', function(){
        wrap.remove();
      });

      wrap.appendChild(sel);
      wrap.appendChild(inputQty);
      wrap.appendChild(btnDel);

      container.appendChild(wrap);
    }

    function clearRows() {
      while (container.firstChild) container.removeChild(container.firstChild);
    }

    // ×˜×¢×™× ×ª ××ª×›×•×Ÿ ×§×™×™× ×›×©×‘×•×—×¨×™× ×× ×”
    selectItem.addEventListener('change', function(){
      var id = selectItem.value;
      clearRows();

      var recipe = recipeMap[id];
      if (recipe && Array.isArray(recipe.components) && recipe.components.length) {
        recipe.components.forEach(function(c){
          renderRow({ ingredientId: c.ingredientId, qty: c.qty });
        });
        if (noteInput && recipe.note) {
          noteInput.value = recipe.note;
        } else if (noteInput) {
          noteInput.value = '';
        }
      } else {
        // ××™×Ÿ ××ª×›×•×Ÿ â€“ × ×ª×—×™×œ ××©×•×¨×” ×¨×™×§×”
        renderRow(null);
        if (noteInput) noteInput.value = '';
      }
    });

    // ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×¨×›×™×‘
    btnAdd.addEventListener('click', function(){
      renderRow(null);
    });

    // ×‘×¨×™×¨×ª ××—×“×œ: ×× ×™×© ×× ×•×ª â€“ × ×¦×™×’ ×œ×¤×—×•×ª ×©×•×¨×” ××—×ª ×¨×™×§×”,
    // ×›×“×™ ×©×™×”×™×” ×‘×¨×•×¨ ×©××¤×©×¨ ×œ×‘×—×•×¨ ×—×•××¨ ×’×œ×
    if (container.children.length === 0) {
      renderRow(null);
    }

    // ×œ×¤× ×™ ×©×œ×™×—×” â€“ × ×¨×›×™×‘ JSON ×©×œ ×›×œ ×”×¨×›×™×‘×™×
    form.addEventListener('submit', function(){
      var rows = container.querySelectorAll('.recipe-row');
      var comps = [];
      rows.forEach(function(row){
        var s = row.querySelector('.recipe-ingredient');
        var q = row.querySelector('.recipe-qty');
        if (!s || !q) return;
        var id = s.value;
        var qty = parseFloat(q.value || '0');
        if (!id || !(qty > 0)) return;
        comps.push({ ingredientId: id, qty: qty });
      });
      hiddenJson.value = JSON.stringify(comps);
    });
  })();
</script>

<style>
  .inv-grid{
    display:grid;
    grid-template-columns:1.1fr 1.4fr;
    gap:16px;
    margin-top:14px;
  }

  .recipe-grid{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:8px;
  }
  .recipe-row{
    display:grid;
    grid-template-columns:1.5fr 1fr auto;
    gap:8px;
    align-items:center;
  }

  .recipes-list{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:8px;
    max-height:520px;
    overflow:auto;
    padding-right:4px;
  }

  .recipe-card{
    background:rgba(15,23,42,.85);
    border-radius:14px;
    border:1px solid rgba(148,163,184,.2);
    padding:10px 12px;
  }

  .recipe-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
  }

  .recipe-title{
    font-size:14px;
  }
  .recipe-sub{
    font-size:12px;
    margin-top:2px;
  }

  .recipe-rows{
    list-style:none;
    margin:8px 0 0;
    padding:0;
    font-size:13px;
  }
  .recipe-rows li{
    display:flex;
    justify-content:space-between;
    padding:3px 0;
    border-bottom:1px dashed rgba(148,163,184,.25);
  }
  .recipe-rows li:last-child{
    border-bottom:none;
  }
  .ing-name{
    font-weight:500;
  }
  .ing-qty{
    color:#9ca3af;
  }

  .small{
    font-size:12px;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid transparent;
  }
  .badge.ok{
    border-color:rgba(52,211,153,.5);
    color:#6ee7b7;
    background:rgba(16,185,129,.08);
  }
  .badge.bad{
    border-color:rgba(248,113,113,.6);
    color:#fecaca;
    background:rgba(248,113,113,.08);
  }

  .form select,
  .form input{
    width:100%;
    padding:10px 12px;
    margin-top:6px;
    background:#171b29;
    color:#e6e8ef;
    border:1px solid #23293a;
    border-radius:12px;
    font-size:14px;
    outline:none;
  }
  .form select:focus,
  .form input:focus{
    border-color: color-mix(in srgb, var(--brand, #3b82f6) 60%, #23293a);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand, #3b82f6) 20%, transparent);
  }

  @media (max-width:900px){
    .inv-grid{
      grid-template-columns:1fr;
    }
  }
</style>
