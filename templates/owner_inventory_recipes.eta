<% layout("_layout", it) %>

<%
  // i18n helper with fallback
  function tt(k, fb){
    try{
      if (it && typeof it.t === "function"){
        const s = it.t(k);
        if (!s || s === k || s === `(${k})`) return fb;
        return s;
      }
    } catch(e){}
    return fb;
  }

  const restaurant  = it.restaurant || {};
  const menuItems   = Array.isArray(it.menuItems) ? it.menuItems : [];
  const recipes     = Array.isArray(it.recipes) ? it.recipes : [];
  const ingredients = Array.isArray(it.ingredients) ? it.ingredients : [];

  // quick map: recipe by itemId - used for display on the right panel only
  const recipeMapSrv = {};
  recipes.forEach(function(r){
    if (!r.menuItemId) return;
    recipeMapSrv[r.menuItemId] = r;
  });
%>

<section class="sb-owner container" aria-label="<%= tt('recipes.aria', 'Dish Recipes & Ingredients') %>">
  <div class="card">
    <header class="owner-hd">
      <div>
        <h1><%= tt('recipes.title', 'Dish Recipes') %> Â· <%= restaurant.name || '××¡×¢×“×”' %></h1>
        <p class="muted">
          <%= tt('recipes.subtitle', 'Here you define which ingredients and quantities belong to each menu dish. Every time a dish is ordered via POS, the system will automatically deduct the quantity from inventory.') %>
        </p>
      </div>
    </header>

    <div class="inv-grid">
      <!-- Left panel: recipe editing form for selected dish -->
      <div class="panel card">
        <h2 class="card-title"><%= tt('recipes.edit_title', 'Edit Dish Recipe') %></h2>

        <% if (!menuItems.length) { %>
          <p class="muted">
            <%= tt('recipes.no_menu_items', 'There are no menu items yet, so there is nothing to define as recipes.') %>
            <br>
            <small><%= tt('recipes.no_menu_items_hint', 'Go to the "Edit Menu" page and add new dishes.') %></small>
          </p>
        <% } else if (!ingredients.length) { %>
          <p class="muted">
            <%= tt('recipes.no_ingredients', 'There are no ingredients in inventory yet, so recipes cannot be created.') %>
            <br>
            <small><%= tt('recipes.no_ingredients_hint', 'Go to the "Ingredient Inventory" page and add ingredients.') %></small>
          </p>
        <% } else { %>
          <form
            action="/owner/<%= restaurant.id %>/inventory/recipes/save"
            method="post"
            class="form"
            id="recipe-form"
          >
            <label>
              <%= tt('recipes.menu_item_label', 'Menu Item') %>
              <select name="menuItemId" id="menuItemId" required>
                <option value=""><%= tt('recipes.select_dish', 'Select a dish...') %></option>
                <% menuItems.forEach(function(mi){ %>
                  <option value="<%= mi.id %>">
                    <%= mi.name_he || mi.name_en || tt('recipes.no_name', 'No name') %>
                  </option>
                <% }) %>
              </select>
            </label>

            <p class="muted" style="margin-top:6px">
              <%= tt('recipes.instructions', '1. Select a dish above. 2. For each row below: select an ingredient and enter the quantity per serving. 3. You can add as many components as you like with "â• Add component".') %>
            </p>

            <!-- ×›××Ÿ ××•×¤×™×¢×•×ª ×©×•×¨×•×ª ×—×•××¨×™ ×”×’×œ× ×œ×× ×” -->
            <div class="recipe-grid" id="recipe-components">
              <!-- ×™×ª×•×•×¡×£ ×œ×¤×—×•×ª ×¨×›×™×‘ ××—×“ ×›×‘×¨×™×¨×ª ××—×“×œ ×‘-JS -->
            </div>

            <button
              type="button"
              class="btn ghost sm"
              id="btn-add-component"
              style="margin-top:8px"
            >
              â• ×”×•×¡×£ ×¨×›×™×‘ (×—×•××¨ ×’×œ× × ×•×¡×£ ×œ×× ×”)
            </button>

            <label style="margin-top:12px">
              ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)
              <input
                name="note"
                id="recipe-note"
                placeholder="×”×¢×¨×•×ª ×©×£ / ×’×¨×¡×” ××™×•×—×“×ª ×©×œ ×”×× ×”"
              >
            </label>

            <!-- JSON ×©×œ ×”×¨×›×™×‘×™× -->
            <input type="hidden" name="components" id="components-json">

            <button class="btn primary sm" type="submit" style="margin-top:10px">
              ğŸ’¾ ×©××™×¨×ª ××ª×›×•×Ÿ
            </button>
          </form>

          <!-- template ×—×‘×•×™ ×©×œ options ×œ×—×•××¨×™ ×’×œ×, ×œ×©×™××•×© ×‘-JS -->
          <select id="ingredient-options-template" style="display:none">
            <option value="">×—×•××¨ ×’×œ×...</option>
            <% ingredients.forEach(function(ing){ %>
              <option value="<%= ing.id %>">
                <%= ing.name || ing.ingredientName || '×—×•××¨ ×’×œ×' %> (<%= ing.unit || 'unit' %>)
              </option>
            <% }) %>
          </select>
        <% } %>
      </div>

      <!-- ×¦×“ ×©×××œ: ×¡×§×™×¨×” ×©×œ ×›×œ ×”×× ×•×ª ×¢× ×”×¤×™×¨×•×§ ×©×œ×”×Ÿ -->
      <div class="panel card">
        <h2 class="card-title">×›×œ ×”×× ×•×ª ×•×—×•××¨×™ ×”×’×œ× ×©×œ×”×Ÿ</h2>

        <% if (menuItems.length) { %>
          <div class="recipes-list">
            <% menuItems.forEach(function(mi){
                 const r    = recipeMapSrv[mi.id];
                 const rows = Array.isArray(r?.components) ? r.components : [];
            %>
              <article class="recipe-card" data-menu-item-id="<%= mi.id %>">
                <header class="recipe-header">
                  <div>
                    <div class="recipe-title">
                      <strong><%= mi.name_he || mi.name_en || '×œ×œ× ×©×' %></strong>
                    </div>
                    <% if (mi.price) { %>
                      <div class="recipe-sub muted">
                        ××—×™×¨ ×‘×ª×¤×¨×™×˜: <%= Number(mi.price).toFixed(2) %> â‚ª
                      </div>
                    <% } %>
                  </div>
                  <% if (rows.length) { %>
                    <span class="badge ok">××ª×›×•×Ÿ ××•×’×“×¨</span>
                  <% } else { %>
                    <span class="badge bad">××™×Ÿ ××ª×›×•×Ÿ</span>
                  <% } %>
                </header>

                <% if (rows.length) { %>
                  <ul class="recipe-rows">
                    <% rows.forEach(function(row){
                         const ingId = row.ingredientId || row.id;
                         const qty   = Number(row.qty ?? row.quantity ?? 0);
                         const ing   = ingredients.find(function(x){ return x.id === ingId; }) || {};
                    %>
                      <li
                        data-ingredient-id="<%= ingId %>"
                        data-qty="<%= qty %>"
                      >
                        <span class="ing-name">
                          <%= ing.name || ing.ingredientName || '×—×•××¨ ×’×œ×' %>
                        </span>
                        <span class="ing-qty">
                          <%= qty %> <%= ing.unit || '' %>
                        </span>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <p class="muted small">
                    ×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×• ×—×•××¨×™ ×’×œ× ×œ×× ×” ×–×•.
                  </p>
                <% } %>

                <% if (r && r.note) { %>
                  <p
                    class="muted small"
                    data-recipe-note="<%= r.note %>"
                  >
                    ×”×¢×¨×•×ª: <%= r.note %>
                  </p>
                <% } %>
              </article>
            <% }) %>
          </div>
        <% } else { %>
          <p class="muted">
            ××™×Ÿ ×¢×“×™×™×Ÿ ×× ×•×ª ×‘×ª×¤×¨×™×˜, ×œ×›×Ÿ ××™×Ÿ ××” ×œ×”×’×“×™×¨ ×›××ª×›×•× ×™×.
          </p>
        <% } %>
      </div>
    </div>
  </div>
</section>

<script>
  (function(){
    var container    = document.getElementById('recipe-components');
    var btnAdd       = document.getElementById('btn-add-component');
    var form         = document.getElementById('recipe-form');
    var hiddenJson   = document.getElementById('components-json');
    var selectItem   = document.getElementById('menuItemId');
    var noteInput    = document.getElementById('recipe-note');
    var tplSelect    = document.getElementById('ingredient-options-template');

    if (!container || !btnAdd || !form || !hiddenJson || !selectItem || !tplSelect) {
      console.warn("[Recipes view] missing DOM element(s)", {
        container: !!container,
        btnAdd: !!btnAdd,
        form: !!form,
        hiddenJson: !!hiddenJson,
        selectItem: !!selectItem,
        tplSelect: !!tplSelect
      });
      return;
    }

    function createIngredientSelect(selectedId) {
      var sel = document.createElement('select');
      sel.className = 'recipe-ingredient';
      sel.required = true;
      sel.innerHTML = tplSelect.innerHTML;
      if (selectedId) {
        sel.value = selectedId;
      }
      return sel;
    }

    function renderRow(value) {
      var wrap = document.createElement('div');
      wrap.className = 'recipe-row';

      var sel = createIngredientSelect(value && value.ingredientId);

      var inputQty = document.createElement('input');
      inputQty.type = 'number';
      inputQty.min = '0';
      inputQty.step = '0.001';
      inputQty.required = true;
      inputQty.placeholder = '×›××•×ª ×œ×™×—×™×“×” ××—×ª';
      inputQty.className = 'recipe-qty';
      if (value && typeof value.qty === 'number') {
        inputQty.value = value.qty;
      }

      var btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.className = 'btn ghost sm';
      btnDel.textContent = 'âœ•';

      btnDel.addEventListener('click', function(){
        wrap.remove();
      });

      wrap.appendChild(sel);
      wrap.appendChild(inputQty);
      wrap.appendChild(btnDel);

      container.appendChild(wrap);
    }

    function clearRows() {
      while (container.firstChild) container.removeChild(container.firstChild);
    }

    function loadRecipeFromDOM(menuItemId) {
      clearRows();

      var article = document.querySelector('[data-menu-item-id="'+menuItemId+'"]');
      if (!article) {
        renderRow(null);
        if (noteInput) noteInput.value = '';
        return;
      }

      var lis = article.querySelectorAll('li[data-ingredient-id]');
      if (!lis.length) {
        renderRow(null);
      } else {
        lis.forEach(function(li){
          var ingId = li.getAttribute('data-ingredient-id');
          var qty   = parseFloat(li.getAttribute('data-qty') || '0');
          if (!ingId || !(qty > 0)) return;
          renderRow({ ingredientId: ingId, qty: qty });
        });
      }

      if (noteInput) {
        var noteEl = article.querySelector('[data-recipe-note]');
        noteInput.value = noteEl ? (noteEl.getAttribute('data-recipe-note') || '') : '';
      }
    }

    selectItem.addEventListener('change', function(){
      var id = selectItem.value;
      if (!id) {
        clearRows();
        renderRow(null);
        if (noteInput) noteInput.value = '';
        return;
      }
      loadRecipeFromDOM(id);
    });

    btnAdd.addEventListener('click', function(){
      renderRow(null);
    });

    // ×‘×¨×™×¨×ª ××—×“×œ: ×× ×™×© ×× ×•×ª â€“ × ×¦×™×’ ×œ×¤×—×•×ª ×©×•×¨×” ××—×ª ×¨×™×§×”
    if (container.children.length === 0) {
      renderRow(null);
    }

    form.addEventListener('submit', function(){
      var rows = container.querySelectorAll('.recipe-row');
      var comps = [];
      rows.forEach(function(row){
        var s = row.querySelector('.recipe-ingredient');
        var q = row.querySelector('.recipe-qty');
        if (!s || !q) return;
        var id = s.value;
        var qty = parseFloat(q.value || '0');
        if (!id || !(qty > 0)) return;
        comps.push({ ingredientId: id, qty: qty });
      });
      hiddenJson.value = JSON.stringify(comps);
    });
  })();
</script>

<style>
  .inv-grid{
    display:grid;
    grid-template-columns:1.1fr 1.4fr;
    gap:16px;
    margin-top:14px;
  }

  .recipe-grid{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:8px;
  }
  .recipe-row{
    display:grid;
    grid-template-columns:1.5fr 1fr auto;
    gap:8px;
    align-items:center;
  }

  .recipes-list{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:8px;
    max-height:520px;
    overflow:auto;
    padding-right:4px;
  }

  .recipe-card{
    background:rgba(15,23,42,.85);
    border-radius:14px;
    border:1px solid rgba(148,163,184,.2);
    padding:10px 12px;
  }

  .recipe-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
  }

  .recipe-title{
    font-size:14px;
  }
  .recipe-sub{
    font-size:12px;
    margin-top:2px;
  }

  .recipe-rows{
    list-style:none;
    margin:8px 0 0;
    padding:0;
    font-size:13px;
  }
  .recipe-rows li{
    display:flex;
    justify-content:space-between;
    padding:3px 0;
    border-bottom:1px dashed rgba(148,163,184,.25);
  }
  .recipe-rows li:last-child{
    border-bottom:none;
  }
  .ing-name{
    font-weight:500;
  }
  .ing-qty{
    color:#9ca3af;
  }

  .small{
    font-size:12px;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid transparent;
  }
  .badge.ok{
    border-color:rgba(52,211,153,.5);
    color:#6ee7b7;
    background:rgba(16,185,129,.08);
  }
  .badge.bad{
    border-color:rgba(248,113,113,.6);
    color:#fecaca;
    background:rgba(248,113,113,.08);
  }

  .form select,
  .form input{
    width:100%;
    padding:10px 12px;
    margin-top:6px;
    background:#171b29;
    color:#e6e8ef;
    border:1px solid #23293a;
    border-radius:12px;
    font-size:14px;
    outline:none;
  }
  .form select:focus,
  .form input:focus{
    border-color: color-mix(in srgb, var(--brand, #3b82f6) 60%, #23293a);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand, #3b82f6) 20%, transparent);
  }

  @media (max-width:900px){
    .inv-grid{
      grid-template-columns:1fr;
    }
  }
</style>
