<% layout("_layout", it) %>

<div class="wrap">
  <div class="card">
    <h1>×”××©××¨×•×ª ×©×œ×™</h1>
    <div class="muted">
      <%= it.restaurant?.name || '' %>
    </div>

    <div class="controls">
      <button class="btn" id="prevWeek">â—€ ×©×‘×•×¢ ×§×•×“×</button>
      <div id="weekLabel" class="weekLabel"></div>
      <button class="btn" id="nextWeek">×©×‘×•×¢ ×”×‘× â–¶</button>
    </div>

    <div id="msg" class="muted" style="margin-top:8px"></div>

    <!-- Availability / Preferences -->
    <div class="card" id="availCard" style="margin-top:14px">
      <div class="avail-hd">
        <h2 style="margin:0">ğŸ—“ï¸ ×”×¢×“×¤×•×ª ×–××™× ×•×ª</h2>
        <button class="btn primary" id="saveAvail" type="button">×©××™×¨×”</button>
      </div>
      <div class="muted" style="margin-top:6px">
        ×¡××Ÿ ×™××™× ×©×‘×”× × ×•×— ×œ×š ×œ×¢×‘×•×“ ×•×‘×—×¨ ×”×¢×“×¤×” (×‘×•×§×¨/×¦×”×¨×™×™×/×¢×¨×‘/×œ×™×œ×”). ×”×× ×”×œ ×™×¨××” ×–××ª ×‘×”××œ×¦×•×ª.
      </div>

      <div id="availabilityMsg" class="muted" style="margin-top:8px"></div>
      <div id="availabilityGrid" class="avail-grid" style="margin-top:10px"></div>
    </div>

    <div id="days" class="days"></div>
  </div>
</div>

<script>
  const msg = document.getElementById('msg');
  const daysEl = document.getElementById('days');
  const weekLabel = document.getElementById('weekLabel');
  const prevBtn = document.getElementById('prevWeek');
  const nextBtn = document.getElementById('nextWeek');
  const saveAvailBtn = document.getElementById('saveAvail');

  const availabilityGrid = document.getElementById('availabilityGrid');
  const availabilityMsg = document.getElementById('availabilityMsg');

  // ---- helpers ----
  function pad(n){ return String(n).padStart(2,'0'); }
  function iso(d){
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    return `${y}-${m}-${day}`;
  }
  function addDays(isoDate, days){
    const d = new Date(isoDate + 'T00:00:00');
    d.setDate(d.getDate()+days);
    return iso(d);
  }
  function startOfWeek(date){
    // Sunday start
    const d = new Date(date + 'T00:00:00');
    const dow = d.getDay(); // 0..6
    d.setDate(d.getDate()-dow);
    return iso(d);
  }

  // ---- availability UI ----
  const DOWS = [
    { id: 0, name: '×¨××©×•×Ÿ' },
    { id: 1, name: '×©× ×™' },
    { id: 2, name: '×©×œ×™×©×™' },
    { id: 3, name: '×¨×‘×™×¢×™' },
    { id: 4, name: '×—××™×©×™' },
    { id: 5, name: '×©×™×©×™' },
    { id: 6, name: '×©×‘×ª' },
  ];

  const SHIFT_OPTS = [
    { v: '', t: '×œ×œ× ×”×¢×“×¤×”' },
    { v: 'morning', t: '×‘×•×§×¨' },
    { v: 'afternoon', t: '×¦×”×¨×™×™×' },
    { v: 'evening', t: '×¢×¨×‘' },
    { v: 'night', t: '×œ×™×œ×”' },
  ];

  function el(tag, attrs, children){
    const e = document.createElement(tag);
    if (attrs) for (const k in attrs) {
      if (k === 'class') e.className = attrs[k];
      else if (k === 'text') e.textContent = attrs[k];
      else e.setAttribute(k, attrs[k]);
    }
    if (children) children.forEach(c => e.appendChild(c));
    return e;
  }

  function buildAvailabilityRow(dow, state){
    const row = el('div', { class: 'avail-row' });

    const cb = el('input', { type:'checkbox' });
    cb.checked = !!state.available;

    const name = el('span', { class:'avail-name', text: DOWS.find(x=>x.id===dow)?.name || String(dow) });

    const select = el('select', { class:'avail-select' });
    SHIFT_OPTS.forEach(o=>{
      const opt = el('option', { value:o.v });
      opt.textContent = o.t;
      select.appendChild(opt);
    });
    select.value = (state.preferredShift || '').toLowerCase();
    select.disabled = !cb.checked;

    cb.addEventListener('change', ()=>{
      select.disabled = !cb.checked;
      if (!cb.checked) select.value = '';
    });

    row.appendChild(el('label', { class:'avail-day' }, [cb, name]));
    row.appendChild(select);

    row._getPayload = () => ({
      dayOfWeek: dow,
      available: cb.checked,
      preferredShift: select.value || null
    });

    return row;
  }

  async function loadAvailability(){
    try{
      availabilityMsg.textContent = '×˜×•×¢×Ÿ...';
      const r = await fetch('/api/staff/availability');
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j || !j.ok) throw new Error(j?.error || 'failed');

      const byDow = new Map();
      (j.days || []).forEach(x => byDow.set(Number(x.dayOfWeek), x));

      availabilityGrid.innerHTML = '';
      for (const d of DOWS){
        const st = byDow.get(d.id) || { available: false, preferredShift: '' };
        const row = buildAvailabilityRow(d.id, st);
        availabilityGrid.appendChild(row);
      }
      availabilityMsg.textContent = '';
    }catch(e){
      availabilityMsg.textContent = '×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ×–××™× ×•×ª. × ×¡×” ×œ×¨×¢× ×Ÿ.';
      console.warn(e);
    }
  }

  async function saveAvailability(){
    try{
      availabilityMsg.textContent = '×©×•××¨...';

      const rows = Array.from(availabilityGrid.querySelectorAll('.avail-row'));
      const days = rows.map(r => r._getPayload());

      const r = await fetch('/api/staff/availability', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ days })
      });
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j || !j.ok) throw new Error(j?.error || 'failed');

      availabilityMsg.textContent = '× ×©××¨ âœ…';
      setTimeout(()=>{ if (availabilityMsg.textContent === '× ×©××¨ âœ…') availabilityMsg.textContent=''; }, 2000);
    }catch(e){
      availabilityMsg.textContent = '×©××™×¨×” × ×›×©×œ×”. × ×¡×” ×©×•×‘.';
      console.warn(e);
    }
  }

  // ---- shifts page ----
  let weekStart = startOfWeek(iso(new Date()));
  function setWeekLabel(){
    const end = addDays(weekStart, 6);
    weekLabel.textContent = `${weekStart} â†’ ${end}`;
  }

  async function load(){
    setWeekLabel();
    msg.textContent = '×˜×•×¢×Ÿ...';
    daysEl.innerHTML = '';

    const from = weekStart;
    const to = addDays(weekStart, 6);

    try{
      const res = await fetch(`/api/staff/shifts?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      const data = await res.json().catch(()=>null);
      if (!res.ok || !data || !data.ok) throw new Error(data?.error || 'failed');

      const byDate = new Map();
      for (let i=0;i<7;i++){
        const d = addDays(from, i);
        byDate.set(d, []);
      }
      (data.shifts || []).forEach(s => {
        const d = String(s.date || '');
        if (!byDate.has(d)) byDate.set(d, []);
        byDate.get(d).push(s);
      });

      for (const [d, shifts] of byDate.entries()){
        const box = document.createElement('div');
        box.className = 'day';
        const h = document.createElement('div');
        h.className = 'dayHd';
        h.textContent = d;
        box.appendChild(h);

        if (!shifts.length){
          const em = document.createElement('div');
          em.className = 'muted';
          em.textContent = '××™×Ÿ ××©××¨×•×ª';
          box.appendChild(em);
        } else {
          shifts.forEach(s=>{
            const item = document.createElement('div');
            item.className = 'shift';
            const name = s.templateName ? ` â€¢ ${s.templateName}` : '';
            item.innerHTML = `<div class="shiftLine"><strong>${s.startTime}â€“${s.endTime}</strong>${name}</div>` +
              `<div class="muted tiny">${(s.role || '')}${s.note ? ' â€¢ ' + s.note : ''}</div>`;
            box.appendChild(item);
          });
        }

        daysEl.appendChild(box);
      }

      msg.textContent = '';
    }catch(e){
      msg.textContent = '×©×’×™××” ×‘×˜×¢×™× ×”';
      console.warn(e);
    }
  }

  prevBtn.addEventListener('click', ()=>{ weekStart = addDays(weekStart, -7); load(); });
  nextBtn.addEventListener('click', ()=>{ weekStart = addDays(weekStart, 7); load(); });

  // Availability init
  if (saveAvailBtn) saveAvailBtn.addEventListener('click', saveAvailability);
  loadAvailability();

  load();
</script>

<style>
  .wrap{max-width:980px;margin:18px auto;padding:0 14px}
  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px; padding:18px; margin-bottom:18px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  h1{margin:0 0 6px}
  .muted{color:var(--ink-muted,#9aa3b2)}
  .tiny{font-size:12px}

  .controls{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:14px}
  .weekLabel{font-weight:700}

  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:8px 12px; border-radius:12px; cursor:pointer; text-decoration:none;
    border:1px solid var(--bd, #23293a); background:transparent;
    color: var(--ink, #e6e8ef); font-weight:700;
    transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{
    background: var(--brand, #3b82f6); color: var(--brand-ink, #fff); border-color:transparent;
    box-shadow: 0 8px 24px rgba(59,130,246,.35);
  }

  .days{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:14px}
  .day{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;background:rgba(0,0,0,.12)}
  .dayHd{font-weight:800;margin-bottom:6px}

  .shift{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px;margin-top:8px;background:rgba(255,255,255,.04)}
  .shiftLine{font-size:14px}

  /* Availability UI */
  .avail-hd{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .avail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .avail-row{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px;padding:10px;background:rgba(255,255,255,.04);
  }
  .avail-day{display:flex;align-items:center;gap:10px}
  .avail-name{font-weight:800}
  .avail-select{
    min-width:150px;
    padding:8px 10px;
    background:#171b29;color:#e6e8ef;border:1px solid #23293a;border-radius:12px;
    outline:none;
  }
  .avail-select:disabled{opacity:.55}

  @media (max-width:920px){
    .days{grid-template-columns:repeat(2,1fr)}
    .avail-grid{grid-template-columns:1fr}
  }
</style>
