<% layout("_layout", it) %>

<% /* tt: ×ª×¨×’×•× ×¢× fallback ×××™×ª×™ ×’× ×›×©-it.t ××—×–×™×¨ "(key)" */ %>
<% function tt(k, fb){ try{ if (it && typeof it.t==='function'){ const s = it.t(k); if(!s || s===k || s===`(${k})`) return fb; return s; } }catch(e){} return fb; } %>

<main class="sb-owner-edit container">
  <header class="page-header head">
    <div>
      <h1 class="h1"><%= tt('owner.edit.title','×¢×¨×™×›×ª ×¤×¨×˜×™ ×”××¡×¢×“×”') %> â€” <%= it.restaurant.name %></h1>
      <p class="muted"><%= it.restaurant.city %> Â· <%= it.restaurant.address %></p>
    </div>
    <a class="btn ghost sm" href="/owner"><%= tt('owner.common.back_to_dashboard','×—×–×¨×” ×œ×“×©×‘×•×¨×“') %></a>
  </header>

  <% if (it.saved) { %>
    <div class="alert success" role="status">âœ“ <%= tt('owner.edit.saved_ok','×”×¤×¨×˜×™× × ×©××¨×•') %></div>
  <% } %>

  <section class="card">
    <!-- ×©××™×¨×” ×‘-GET ×œ-/edit/save ×›×“×™ ×œ×¢×§×•×£ ×§×¨×™××ª ×’×•×£ -->
    <form action="/owner/restaurants/<%= it.restaurant.id %>/edit/save" method="get" class="form-grid" novalidate>
      <div class="form-row">
        <label for="name"><%= tt('owner.edit.fields.name','×©×') %></label>
        <input id="name" name="name" value="<%= it.restaurant.name %>" required />
      </div>
      <div class="form-row">
        <label for="city"><%= tt('owner.edit.fields.city','×¢×™×¨') %></label>
        <input id="city" name="city" value="<%= it.restaurant.city %>" required />
      </div>
      <div class="form-row">
        <label for="address"><%= tt('owner.edit.fields.address','×›×ª×•×‘×ª') %></label>
        <input id="address" name="address" value="<%= it.restaurant.address %>" required />
      </div>
      <div class="form-row">
        <label for="phone"><%= tt('owner.edit.fields.phone','×˜×œ×¤×•×Ÿ') %></label>
        <input id="phone" name="phone" value="<%= it.restaurant.phone || "" %>" />
      </div>
      <div class="form-row full">
        <label for="description"><%= tt('owner.edit.fields.description','×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)') %></label>
        <textarea id="description" name="description" rows="4"><%= it.restaurant.description || "" %></textarea>
      </div>

      <div class="form-row full">
        <label for="categories"><%= tt('owner.edit.fields.categories','×¡×•×’×™ ××˜×‘×—') %></label>
        <select id="categories" name="categories" multiple size="6" style="background:#171b29; color:#e6e8ef; border:1px solid #23293a; border-radius:12px; padding:10px 12px;">
          <option value="italian" <%= (it.restaurant.kitchenCategories || []).includes('italian') ? 'selected' : '' %>>ğŸ Italian</option>
          <option value="asian" <%= (it.restaurant.kitchenCategories || []).includes('asian') ? 'selected' : '' %>>ğŸœ Asian</option>
          <option value="japanese" <%= (it.restaurant.kitchenCategories || []).includes('japanese') ? 'selected' : '' %>>ğŸ£ Japanese</option>
          <option value="chinese" <%= (it.restaurant.kitchenCategories || []).includes('chinese') ? 'selected' : '' %>>ğŸ¥¡ Chinese</option>
          <option value="indian" <%= (it.restaurant.kitchenCategories || []).includes('indian') ? 'selected' : '' %>>ğŸ› Indian</option>
          <option value="mediterranean" <%= (it.restaurant.kitchenCategories || []).includes('mediterranean') ? 'selected' : '' %>>ğŸ«’ Mediterranean</option>
          <option value="american" <%= (it.restaurant.kitchenCategories || []).includes('american') ? 'selected' : '' %>>ğŸ” American</option>
          <option value="mexican" <%= (it.restaurant.kitchenCategories || []).includes('mexican') ? 'selected' : '' %>>ğŸŒ® Mexican</option>
          <option value="french" <%= (it.restaurant.kitchenCategories || []).includes('french') ? 'selected' : '' %>>ğŸ¥ French</option>
          <option value="steakhouse" <%= (it.restaurant.kitchenCategories || []).includes('steakhouse') ? 'selected' : '' %>>ğŸ¥© Steakhouse</option>
          <option value="seafood" <%= (it.restaurant.kitchenCategories || []).includes('seafood') ? 'selected' : '' %>>ğŸ¦ Seafood</option>
          <option value="vegetarian" <%= (it.restaurant.kitchenCategories || []).includes('vegetarian') ? 'selected' : '' %>>ğŸ¥— Vegetarian</option>
          <option value="vegan" <%= (it.restaurant.kitchenCategories || []).includes('vegan') ? 'selected' : '' %>>ğŸŒ± Vegan</option>
          <option value="cafe" <%= (it.restaurant.kitchenCategories || []).includes('cafe') ? 'selected' : '' %>>â˜• Cafe</option>
          <option value="bakery" <%= (it.restaurant.kitchenCategories || []).includes('bakery') ? 'selected' : '' %>>ğŸ¥– Bakery</option>
          <option value="fast_food" <%= (it.restaurant.kitchenCategories || []).includes('fast_food') ? 'selected' : '' %>>ğŸŸ Fast Food</option>
          <option value="other" <%= (it.restaurant.kitchenCategories || []).includes('other') ? 'selected' : '' %>>ğŸ½ï¸ Other</option>
        </select>
        <small class="muted" style="margin-top: 4px;"><%= tt('owner.edit.fields.categories_hint','×”×—×–×§ Ctrl/Cmd ×œ×‘×—×™×¨×ª ××¡×¤×¨ ×§×˜×’×•×¨×™×•×ª') %></small>
      </div>

      <div class="form-actions full">
        <button class="btn primary sm" type="submit"><%= tt('owner.edit.actions.save','×©××•×¨') %></button>
        <a class="btn ghost sm" href="/owner/restaurants/<%= it.restaurant.id %>/hours"><%= tt('owner.edit.actions.hours','×©×¢×•×ª ×¤×ª×™×—×”') %></a>
      </div>
    </form>
  </section>

  <!-- × ×™×”×•×œ ×ª××•× ×•×ª ×™×©×™×¨×•×ª ××ª×•×š ××¡×š ×”×¢×¨×™×›×” -->
  <section class="card">
    <h3 class="card-title"><%= tt('owner.edit.photos.title','×ª××•× ×•×ª ×”××¡×¢×“×”') %></h3>
    <p class="muted"><%= tt('owner.edit.photos.hint','×”×¢×œ××ª JPG/PNG/WebP (×¢×“ ~1.8MB ×œ×§×•×‘×¥).') %></p>

    <div class="uploader">
      <input id="file-input" type="file" accept="image/png,image/jpeg,image/webp" multiple aria-label="<%= tt('owner.edit.photos.input_aria','×‘×—×™×¨×ª ×§×‘×¦×™ ×ª××•× ×”') %>">
      <button id="upload-btn" class="btn primary sm" type="button"><%= tt('owner.edit.photos.upload_btn','×”×¢×œ×”') %></button>
    </div>

    <div id="preview" class="grid preview-grid" aria-live="polite"></div>

    <hr class="sep"/>

    <h4 class="card-subtitle"><%= tt('owner.edit.photos.gallery','×’×œ×¨×™×”') %></h4>
    <%
      const photos = Array.isArray(it.restaurant.photos) ? it.restaurant.photos : [];
    %>
    <% if (!photos.length) { %>
      <p class="muted"><%= tt('owner.edit.photos.empty','××™×Ÿ ×¢×“×™×™×Ÿ ×ª××•× ×•×ª.') %></p>
    <% } else { %>
      <div class="grid gallery-grid">
        <% photos.forEach(function(p){ %>
          <figure class="photo-card" data-id="<%= p.id %>">
            <img src="<%= p.dataUrl %>" alt="<%= p.alt || it.restaurant.name %>">
            <figcaption class="caption">
              <input class="alt-edit" value="<%= p.alt || '' %>" placeholder="<%= tt('owner.edit.photos.alt_placeholder','×›×™×ª×•×‘') %>" />
              <button class="btn danger sm delete-btn" data-id="<%= p.id %>" type="button"><%= tt('owner.edit.photos.delete_btn','××—×™×§×”') %></button>
            </figcaption>
          </figure>
        <% }) %>
      </div>
    <% } %>
  </section>
</main>

<script>
(function(){
  var rid = "<%= it.restaurant.id %>";
  var fileInput = document.getElementById('file-input');
  var uploadBtn = document.getElementById('upload-btn');
  var preview = document.getElementById('preview');

  function readFileAsDataURL(file) {
    return new Promise(function(resolve, reject){
      var fr = new FileReader();
      fr.onload = function(){ resolve(fr.result); };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  fileInput.addEventListener('change', async function(){
    preview.innerHTML = '';
    var files = Array.from(fileInput.files || []);
    for (var i=0; i<files.length; i++) {
      var f = files[i];
      var url = URL.createObjectURL(f);
      var card = document.createElement('div');
      card.className = 'preview-card';
      card.innerHTML =
        '<img class="preview-img" src="'+url+'" alt="<%= tt('owner.edit.photos.preview_alt','×ª×¦×•×’×” ××§×“×™××”') %>">' +
        '<input class="alt" placeholder="<%= tt('owner.edit.photos.alt_placeholder','×›×™×ª×•×‘ ×œ×ª××•× ×”') %>">';
      preview.appendChild(card);
    }
  });

  uploadBtn.addEventListener('click', async function(){
    var files = Array.from(fileInput.files || []);
    if (!files.length) { alert('<%= tt('owner.edit.photos.no_files','×œ× × ×‘×—×¨×• ×§×‘×¦×™×') %>'); return; }

    var images = [];
    var cards = Array.from(preview.children);
    for (var i=0; i<files.length; i++) {
      var f = files[i];
      if (f.size > (1.8 * 1024 * 1024)) { continue; } // ~1.8MB
      var dataUrl = await readFileAsDataURL(f);
      var alt = cards[i]?.querySelector('.alt')?.value || '';
      images.push({ dataUrl: dataUrl, alt: alt });
    }
    if (!images.length) { alert('<%= tt('owner.edit.photos.too_big_or_bad','×”×§×‘×¦×™× ×’×“×•×œ×™× ××“×™ ××• ×œ× ×ª×§×™× ×™×') %>'); return; }

    try {
      var res = await fetch('/owner/restaurants/'+encodeURIComponent(rid)+'/photos/upload', {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept":"application/json" },
        body: JSON.stringify({ images: images }),
      });
      if (!res.ok) {
        var txt = await res.text().catch(function(){ return ""; });
        alert('<%= tt('owner.edit.photos.upload_failed','×”×¢×œ××” × ×›×©×œ×”') %>: ' + res.status + '\n' + txt);
        return;
      }
      var data = await res.json();
      if (data.ok) { location.reload(); }
      else { alert('<%= tt('owner.edit.photos.upload_failed','×”×¢×œ××” × ×›×©×œ×”') %>'); }
    } catch (e) {
      console.error(e);
      alert('<%= tt('owner.edit.photos.net_err','×©×’×™××ª ×¨×©×ª') %>');
    }
  });

  // ××—×™×§×ª ×ª××•× ×”
  document.addEventListener('click', async function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('.delete-btn') : null;
    if (!btn) return;
    var pid = btn.getAttribute('data-id');
    if (!pid) return;
    if (!confirm('<%= tt('owner.edit.photos.confirm_delete','×œ××—×•×§ ×ª××•× ×” ×–×•?') %>')) return;

    try {
      var res = await fetch('/owner/restaurants/'+encodeURIComponent(rid)+'/photos/delete', {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept":"application/json" },
        body: JSON.stringify({ id: pid }),
      });
      if (!res.ok) { alert('<%= tt('owner.edit.photos.delete_failed','××—×™×§×” × ×›×©×œ×”') %>'); return; }
      var data = await res.json();
      if (data.ok) {
        var card = document.querySelector('.photo-card[data-id="'+pid+'"]');
        if (card) card.remove();
      }
    } catch (e) {
      console.error(e);
      alert('<%= tt('owner.edit.photos.net_err','×©×’×™××ª ×¨×©×ª') %>');
    }
  });
})();
</script>

<style>
  /* ===== ×ª×•×× SpotBook (×›×”×” ×™×•×§×¨×ª×™) â€“ ×œ×œ× ×©×™× ×•×™ ×¤×™×¦'×¨×™× ===== */
  .sb-owner-edit.container{ max-width: 1000px; margin: 24px auto; padding: 0 16px }
  .head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 10px }
  .h1{ margin:0 0 6px }
  .muted{ color: var(--ink-muted, #9aa3b2) }

  .alert.success{
    background: color-mix(in srgb, #16a34a 12%, transparent);
    border:1px solid color-mix(in srgb, #16a34a 45%, transparent);
    color:#c5f2d3; border-radius:12px; padding:10px 12px; margin: 12px 0 14px;
  }

  .card{
    background: var(--panel, #121622);
    border:1px solid var(--bd, #222834);
    border-radius:18px; padding:18px; margin:12px 0 18px;
    color: var(--ink, #e6e8ef);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .card-title{ margin:0 0 6px; font-size: clamp(16px, 2.2vw, 20px) }
  .card-subtitle{ margin:0 0 8px }

  /* ×˜×¤×¡×™× */
  .form-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px }
  .form-row{ display:flex; flex-direction:column; gap:6px }
  .form-row.full{ grid-column: 1 / -1 }
  .form-row label{ font-weight:600 }
  .form-row input, .form-row textarea{
    background:#171b29; color:#e6e8ef; border:1px solid #23293a;
    border-radius:12px; padding:10px 12px; font-size:15px; outline:none;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .form-row input:focus, .form-row textarea:focus{
    border-color: color-mix(in srgb, var(--brand, #3b82f6) 60%, #23293a);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand, #3b82f6) 22%, transparent);
  }
  .form-actions{ display:flex; gap:10px; flex-wrap:wrap }
  .form-actions.full{ grid-column: 1 / -1 }

  /* ×”×¢×œ××” + ×ª×¦×•×’×” ××§×“×™××” */
  .uploader{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px }
  #file-input{
    background:#171b29; color:#e6e8ef; border:1px solid #23293a; border-radius:12px;
    padding:8px 10px; font-size:14px;
  }
  .sep{ margin:16px 0; border:none; border-top:1px solid #23293a }

  .preview-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:10px; margin-top:12px }
  .preview-card{
    border:1px solid #23293a; border-radius:12px; padding:8px;
    background: color-mix(in srgb, #171b29 92%, transparent);
  }
  .preview-img{ width:100%; height:120px; object-fit:cover; border-radius:10px; border:1px solid #23293a; margin-bottom:6px }
  .preview-card .alt{
    width:100%; padding:8px 10px; border:1px solid #23293a; border-radius:10px; background:#0f1422; color:#e6e8ef;
  }

  /* ×’×œ×¨×™×” ×§×™×™××ª */
  .gallery-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:12px }
  .photo-card{
    border:1px solid #23293a; border-radius:12px; padding:8px;
    background: color-mix(in srgb, #171b29 92%, transparent);
  }
  .photo-card img{
    width:100%; height:120px; object-fit:cover; border-radius:10px; border:1px solid #23293a
  }
  .caption{ display:flex; gap:8px; align-items:center; margin-top:6px }
  .alt-edit{
    flex:1; min-width:0; padding:8px 10px; border:1px solid #23293a; border-radius:10px;
    background:#0f1422; color:#e6e8ef;
  }

  /* ×›×¤×ª×•×¨×™× â€œ×—×™×™×â€ */
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:12px; cursor:pointer; text-decoration:none;
    border:1px solid var(--bd, #23293a); background:transparent;
    color: var(--ink, #e6e8ef); font-weight:700;
    transition: transform .08s ease, filter .12s ease, box-shadow .12s.ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn.primary{
    background: var(--brand, #3b82f6); color: var(--brand-ink, #fff); border-color:transparent;
    box-shadow: 0 8px 24px rgba(59,130,246,.35);
  }
  .btn.ghost{
    background: color-mix(in srgb, var(--panel, #121622) 88%, transparent);
  }
  .btn.ghost:hover{ background: color-mix(in srgb, var(--panel, #121622) 94%, transparent); }
  .btn.danger{ background:#ef4444; color:#fff; border-color:transparent; }
  .btn.sm{ padding:8px 12px; border-radius:10px; font-size:.95rem }

  @media (max-width:760px){
    .form-grid{ grid-template-columns: 1fr }
  }
</style>
