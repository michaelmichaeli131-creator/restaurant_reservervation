<% layout("_layout", it) %>

<%
  function tt(k, fb){
    try{
      if (it && typeof it.t==='function'){
        const s = it.t(k);
        if(!s || s===k || s===`(${k})`) return fb;
        return s;
      }
    }catch(e){}
    return fb;
  }

  const r   = it.restaurant;
  const rid = it.rid;
  const tbl = it.table;
  const items = it.orderItems || [];
  const totals = it.totals || { itemsCount: 0, subtotal: 0 };
%>

<main class="container pos-waiter-page" dir="rtl">
  <header class="page-header waiter-header">
    <div class="title-block">
      <h1><%= tt('pos.waiter.table_label', 'Table') %> <%= tbl %> â€” <%= r.name %></h1>
      <p class="muted"><%= r.city %> â€¢ <%= r.address %></p>
    </div>

    <div
      id="bill-summary"
      class="bill-summary"
      data-rid="<%= rid %>"
      data-table="<%= tbl %>"
    >
      <span id="bill-items"><%= totals.itemsCount %> <%= tt('pos.waiter.items_count', '×¤×¨×™×˜×™×') %></span>
      <span>â€¢</span>
      <span id="bill-total"><%= totals.subtotal.toFixed(2) %> â‚ª</span>
    </div>

    <div class="header-actions">
      <a class="btn ghost" href="/waiter/<%= rid %>"><%= tt('pos.waiter.btn_back_lobby', 'Back to Waiter Screen') %></a>
    </div>
  </header>

  <section class="waiter-layout">
    <!-- ×ª×¤×¨×™×˜ -->
    <aside class="panel card menu-panel" aria-label="<%= tt('pos.menu.title', 'Menu') %>">
      <h2 class="card-title"><%= tt('pos.menu.title', 'Menu') %></h2>
      <p class="muted" style="font-size:12px">
        <%= tt('pos.menu.help_text', 'Select dishes from the menu to add to the table order.') %>
      </p>
      <div id="menu-root" data-rid="<%= rid %>">
        <p class="muted"><%= tt('pos.menu.loading', 'Loading menu...') %></p>
      </div>
    </aside>

    <!-- ×”×–×ž× ×” -->
    <section class="panel card order-panel" aria-label="<%= tt('pos.order.title', 'Table Order') %>">
      <h2 class="card-title"><%= tt('pos.order.title', 'Table Order') %> <%= tbl %></h2>

      <table class="order-table">
        <thead>
          <tr>
            <th><%= tt('pos.order.tbl.dish', 'Dish') %></th>
            <th><%= tt('pos.order.tbl.quantity', 'Quantity') %></th>
            <th><%= tt('pos.order.tbl.destination', 'Destination') %></th>
            <th><%= tt('pos.order.tbl.status', 'Status') %></th>
            <th><%= tt('pos.order.tbl.total', 'Total') %></th>
            <th><%= tt('pos.order.tbl.actions', 'Actions') %></th>
          </tr>
        </thead>
        <tbody id="order-items">
          <% if (items.length) { %>
            <% items.forEach(function(row){ %>
              <tr
                class="order-row status-<%= row.status %>"
                data-order-id="<%= row.orderId %>"
                data-item-id="<%= row.id %>"
                data-qty="<%= row.quantity %>"
                data-price="<%= row.unitPrice %>"
              >
                <td class="col-name">
                  <div class="name-main"><%= row.name %></div>
                  <div class="name-sub muted">
                    <%= tt('pos.waiter.created_at', 'Created at') %> <%= new Date(row.createdAt).toLocaleTimeString(it.lang === 'he' ? 'he-IL' : 'en-US',{hour:'2-digit',minute:'2-digit'}) %>
                  </div>
                </td>
                <td class="col-qty">x<%= row.quantity %></td>
                <td class="col-dest">
                  <%= row.destination === 'bar' ? tt('owner.menu.dest_bar', 'Bar') : tt('owner.menu.dest_kitchen', 'Kitchen') %>
                </td>
                <td class="col-status">
                  <% if (row.status === 'received') { %><%= tt('pos.status.received', 'Received') %>
                  <% } else if (row.status === 'in_progress') { %><%= tt('pos.status.in_progress', 'In Progress') %>
                  <% } else if (row.status === 'ready') { %><%= tt('pos.status.ready', 'Ready') %>
                  <% } else if (row.status === 'served') { %><%= tt('pos.status.served', 'Served') %>
                  <% } else if (row.status === 'cancelled') { %><%= tt('pos.status.cancelled', 'Cancelled') %>
                  <% } else { %><%= row.status %><% } %>
                </td>
                <td class="col-total">
                  <%= (row.unitPrice * row.quantity).toFixed(2) %> â‚ª
                </td>
                <td class="col-actions">
                  <% if (row.status === 'cancelled') { %>
                    <span class="muted"><%= tt('pos.status.cancelled', 'Cancelled') %></span>
                  <% } else if (row.status === 'served') { %>
                    <span class="muted"><%= tt('pos.status.served', 'Served') %></span>
                  <% } else { %>
                    <button type="button" class="btn ghost btn-cancel-item">
                      ðŸ—‘ <%= tt('common.btn_cancel', 'Cancel') %>
                    </button>
                    <% if (row.status === 'ready' || row.status === 'in_progress') { %>
                      <button type="button" class="btn ghost btn-mark-served" style="margin-inline-start:4px;">
                        âœ… <%= tt('pos.waiter.btn_mark_served', 'Mark as Served') %>
                      </button>
                    <% } %>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr class="no-items-row">
              <td colspan="6">
                <p class="muted" style="margin:6px 0">
                  <%= tt('pos.waiter.no_items', 'No items in the order yet. Select dishes from the menu.') %>
                </p>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>

      <div class="bill-actions">
        <button type="button" id="btn-close-order" class="btn primary">
          <%= tt('pos.waiter.btn_close_order', 'Close Table / Issue Bill') %>
        </button>
      </div>
    </section>
  </section>
</main>

<script src="/public/js/pos_waiter.js?v=<%= it.BUILD_TAG || '' %>"></script>

<!-- ×ª×¤×¨×™×˜ ××™× ×˜×¨××§×˜×™×‘×™ + ×”×•×¡×¤×ª ×ž× ×•×ª -->
<script>
  (function(){
    const root = document.getElementById("menu-root");
    if (!root) return;
    const rid = root.dataset.rid;
    const table = <%= Number(tbl) %>;
    if (!rid || !table) return;

    async function loadMenu(){
      try{
        const res = await fetch(`/api/pos/menu/${encodeURIComponent(rid)}`);
        if(!res.ok) throw new Error("menu fetch failed");
        const items = await res.json();
        renderMenu(items);
      }catch(e){
        root.innerHTML = '<p class="muted"><%= tt('pos.error.load_menu', 'Error loading the menu.') %></p>';
        console.error(e);
      }
    }

    function renderMenu(items){
      if(!Array.isArray(items) || !items.length){
        root.innerHTML = '<p class="muted"><%= tt('pos.menu.empty', 'No dishes in menu currently.') %></p>';
        return;
      }
      const byCat = new Map();
      for (const it of items){
        const cid = it.categoryId || "__no_cat__";
        if (!byCat.has(cid)) byCat.set(cid, []);
        byCat.get(cid).push(it);
      }

      const frag = document.createElement("div");
      byCat.forEach((list, cid) => {
        const section = document.createElement("section");
        section.className = "menu-section";
        const title = document.createElement("h3");
        title.className = "menu-section-title";
        title.textContent = cid === "__no_cat__" ? "<%= tt('pos.menu.no_category', 'Uncategorized') %>" : (list[0].categoryName || "<%= tt('pos.menu.category', 'Category') %>");
        section.appendChild(title);

        const grid = document.createElement("div");
        grid.className = "menu-grid";
        list.forEach((m) => {
          if (m.outOfStock || m.isActive === false) return;
          const card = document.createElement("button");
          card.type = "button";
          card.className = "menu-item-card";
          card.dataset.menuItemId = m.id;
          card.dataset.price = m.price;
          card.dataset.dest = m.destination;
          card.innerHTML = `
            <div class="menu-item-name">${m.name_en || m.name_he || '<%= tt("pos.menu.dish", "Dish") %>'}</div>
            <div class="menu-item-desc muted">${m.desc_en || m.desc_he || ''}</div>
            <div class="menu-item-footer">
              <span class="price">${Number(m.price || 0).toFixed(2)} â‚ª</span>
              <span class="dest">${m.destination === 'bar' ? '<%= tt('owner.menu.dest_bar', 'Bar') %>' : '<%= tt('owner.menu.dest_kitchen', 'Kitchen') %>'}</span>
            </div>
          `;
          grid.appendChild(card);
        });

        section.appendChild(grid);
        frag.appendChild(section);
      });

      root.innerHTML = "";
      root.appendChild(frag);
    }

    async function addItem(card){
      const menuItemId = card.dataset.menuItemId;
      if (!menuItemId) return;

      try{
        const res = await fetch("/api/pos/order-item/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            restaurantId: rid,
            table,
            menuItemId,
            quantity: 1,
          }),
        });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.ok) return;

        const item = data.item;
        const tbody = document.getElementById("order-items");
        if (!tbody) return;

        const emptyRow = tbody.querySelector(".no-items-row");
        if (emptyRow) emptyRow.remove();

        const tr = document.createElement("tr");
        tr.className = `order-row status-${item.status}`;
        tr.dataset.orderId = item.orderId;
        tr.dataset.itemId = item.id;
        tr.dataset.qty = item.quantity;
        tr.dataset.price = item.unitPrice;

        const createdAt = new Date(item.createdAt);
        const timeStr = createdAt.toLocaleTimeString('he-IL',{
          hour:'2-digit',minute:'2-digit'
        });

        tr.innerHTML = `
          <td class="col-name">
            <div class="name-main">${item.name}</div>
            <div class="name-sub muted">
              <%= tt('pos.waiter.created_at', 'Created at') %> ${timeStr}
            </div>
          </td>
          <td class="col-qty">x${item.quantity}</td>
          <td class="col-dest">
            ${item.destination === 'bar' ? '<%= tt('owner.menu.dest_bar', 'Bar') %>' : '<%= tt('owner.menu.dest_kitchen', 'Kitchen') %>'}
          </td>
          <td class="col-status"><%= tt('pos.status.received', 'Received') %></td>
          <td class="col-total">
            ${(item.unitPrice * item.quantity).toFixed(2)} â‚ª
          </td>
          <td class="col-actions">
            <button type="button" class="btn ghost btn-cancel-item">
              ðŸ—‘ <%= tt('common.btn_cancel', '×‘×™×˜×•×œ') %>
            </button>
            <button type="button" class="btn ghost btn-mark-served" style="margin-inline-start:4px;">
              âœ… <%= tt('pos.waiter.btn_mark_served', '×¡×ž×Ÿ ×”×•×’×©') %>
            </button>
          </td>
        `;
        tbody.appendChild(tr);

        if (window.sbRecalcBill) {
          window.sbRecalcBill();
        }
      }catch(e){
        console.error("addItem failed", e);
      }
    }

    root.addEventListener("click", function(ev){
      const card = ev.target.closest(".menu-item-card");
      if (!card) return;
      addItem(card);
    });

    loadMenu();
  })();
</script>

<!-- WS: ×¢×“×›×•× ×™× ×ž×”×ž×˜×‘×—/×‘×¨ ×œ×ž×œ×¦×¨ -->
<script>
  (function(){
    const rid = "<%= rid %>";
    const table = <%= Number(tbl) %>;
    const proto = (location.protocol === "https:") ? "wss:" : "ws:";
    const wsUrl = proto + "//" + location.host + "/ws/pos";

    let ws;
    try{
      ws = new WebSocket(wsUrl);
    }catch(e){
      console.warn("WS not available", e);
      return;
    }

    ws.addEventListener("open", () => {
      ws.send(JSON.stringify({
        type: "join",
        role: "waiter",
        restaurantId: rid,
        table
      }));
    });

    ws.addEventListener("message", (ev) => {
      try{
        const msg = JSON.parse(ev.data);
        if (msg.type === "order_updated" &&
            msg.restaurantId === rid &&
            msg.table === table) {
          window.location.reload();
        }
        if (msg.type === "order_closed" &&
            msg.restaurantId === rid &&
            msg.table === table) {
          window.location.href = `/waiter/${encodeURIComponent(rid)}`;
        }
      }catch(e){
        console.warn("bad WS message", e);
      }
    });
  })();
</script>

<style>
  .pos-waiter-page .waiter-header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:16px;
  }
  .pos-waiter-page .title-block h1{
    margin:0;
    font-size:clamp(18px,2.6vw,24px);
  }
  .pos-waiter-page .bill-summary{
    display:flex;
    gap:6px;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.5);
    font-size:14px;
  }
  .waiter-header .header-actions{
    display:flex;
    align-items:center;
  }

  .waiter-layout{
    display:grid;
    grid-template-columns:1.1fr 1.4fr;
    gap:16px;
  }

  .panel.card{
    background: var(--panel,#111827);
    border:1px solid var(--bd,#1f2937);
    border-radius:18px;
    padding:14px 16px;
    box-shadow:0 14px 40px rgba(0,0,0,.45);
  }
  .card-title{
    margin:0 0 8px;
    font-size:clamp(16px,2.2vw,20px);
  }

  .order-table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
    font-size:14px;
  }
  .order-table th,
  .order-table td{
    border-bottom:1px solid rgba(255,255,255,.06);
    padding:6px 4px;
    text-align:right;
  }
  .order-table th{
    font-weight:600;
    color:var(--ink-muted,#9ca3af);
  }

  .bill-actions{
    margin-top:10px;
    display:flex;
    justify-content:flex-start;
  }

  .menu-section{
    margin-bottom:12px;
  }
  .menu-section-title{
    font-size:14px;
    margin:0 0 6px;
    color:var(--ink-muted,#9ca3af);
  }
  .menu-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    gap:8px;
  }
  .menu-item-card{
    border-radius:12px;
    border:1px solid rgba(31,41,55,1);
    background:rgba(15,23,42,0.9);
    padding:8px;
    cursor:pointer;
    text-align:right;
  }
  .menu-item-card:hover{
    border-color:rgba(59,130,246,0.7);
  }
  .menu-item-name{
    font-size:14px;
    font-weight:600;
    margin-bottom:4px;
  }
  .menu-item-desc{
    font-size:12px;
    min-height:16px;
  }
  .menu-item-footer{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:4px;
    font-size:12px;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:8px 12px;
    border-radius:12px;
    border:1px solid var(--bd,#1f2937);
    background:transparent;
    color:var(--ink,#e5e7eb);
    cursor:pointer;
    text-decoration:none;
  }
  .btn.primary{
    background:#3b82f6;
    border-color:#2563eb;
    color:#fff;
  }
  .btn.ghost{
    background:rgba(15,23,42,0.7);
  }

  @media (max-width:900px){
    .waiter-layout{
      grid-template-columns:1fr;
    }
  }
</style>
