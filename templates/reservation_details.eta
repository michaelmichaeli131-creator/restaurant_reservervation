<% layout("_layout", it) %>

<section class="resv">
  <header class="resv-hd">
    <div class="brand">
      <% if (it.restaurant && it.restaurant.cover) { %>
        <div class="cover" style="background-image:url('<%= it.restaurant.cover %>')"></div>
      <% } %>
      <div class="meta">
        <h1 class="title"><%= (it.restaurant && it.restaurant.name) || 'הזמנה' %></h1>
        <% if (it.restaurant && (it.restaurant.city || it.restaurant.address)) { %>
          <div class="sub muted">
            <%= [it.restaurant.city, it.restaurant.address].filter(Boolean).join(" · ") %>
          </div>
        <% } %>
      </div>
      <div class="status">
        <span class="badge <%= it.reservation && it.reservation.status === 'cancelled' ? 'bad' : 'good' %>">
          <%= it.reservation && it.reservation.status === 'cancelled' ? 'בוטלה' : 'מאושרת' %>
        </span>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- פרטי הזמנה -->
    <article class="card">
      <h2 class="h2">פרטי ההזמנה</h2>
      <dl class="dl">
        <% if (it.reservation && (it.reservation.date || it.reservation.time || it.reservation.slot)) { %>
          <div class="row">
            <dt>תאריך ושעה</dt>
            <dd>
              <%= it.reservation.date || '' %>
              <%~ (it.reservation.time ? ' · ' + it.reservation.time : '') %>
              <%~ (it.reservation.slot ? ' · שולחן לשעה ' + it.reservation.slot + ' ד׳' : '') %>
            </dd>
          </div>
        <% } %>

        <% if (it.reservation && (it.reservation.size || it.reservation.guests)) { %>
          <div class="row">
            <dt>כמות סועדים</dt>
            <dd><%= it.reservation.size || it.reservation.guests %></dd>
          </div>
        <% } %>

        <% if (it.reservation && (it.reservation.name || it.reservation.contactName)) { %>
          <div class="row">
            <dt>שם המזמין/ה</dt>
            <dd><%= it.reservation.name || it.reservation.contactName %></dd>
          </div>
        <% } %>

        <% if (it.reservation && (it.reservation.phone || it.reservation.contactPhone)) { %>
          <div class="row">
            <dt>טלפון</dt>
            <dd dir="ltr"><%= it.reservation.phone || it.reservation.contactPhone %></dd>
          </div>
        <% } %>

        <% if (it.reservation && it.reservation.email) { %>
          <div class="row">
            <dt>אימייל</dt>
            <dd dir="ltr"><%= it.reservation.email %></dd>
          </div>
        <% } %>

        <% if (it.reservation && it.reservation.notes) { %>
          <div class="row">
            <dt>הערות</dt>
            <dd class="pre"><%= it.reservation.notes %></dd>
          </div>
        <% } %>
      </dl>

      <div class="actions">
        <% if (!it.reservation || it.reservation.status !== 'cancelled') { %>
          <% if (it.links && it.links.edit) { %><a class="btn" href="<%= it.links.edit %>">עריכת הזמנה</a><% } %>
          <% if (it.links && it.links.cancel) { %>
            <form class="inline" method="post" action="<%= it.links.cancel %>" onsubmit="return confirm('לבטל את ההזמנה?')">
              <button class="btn danger" type="submit">ביטול הזמנה</button>
            </form>
          <% } %>
        <% } else { %>
          <% if (it.links && it.links.rebook) { %><a class="btn" href="<%= it.links.rebook %>">הזמנה חדשה</a><% } %>
        <% } %>
      </div>
    </article>

    <!-- כרטיסים משלימים -->
    <aside class="stack">
      <!-- כרטיס QR / קבלה -->
      <% if ((it.qr && it.qr.src) || (it.reservation && it.reservation.id)) { %>
      <article class="card">
        <h3 class="h3">קוד הזמנה</h3>
        <div class="qr">
          <% if (it.qr && it.qr.src) { %>
            <img src="<%= it.qr.src %>" alt="QR להזמנה" width="160" height="160" />
          <% } else { %>
            <img src="/qr?text=<%= encodeURIComponent(String(it.reservation.id)) %>" alt="QR להזמנה" width="160" height="160" />
          <% } %>
        </div>
        <div class="muted small" dir="ltr">#<%= (it.reservation && it.reservation.id) || '' %></div>
      </article>
      <% } %>

      <!-- הוסף ליומן -->
      <% if (it.calendar && (it.calendar.ics || it.calendar.google || it.calendar.apple)) { %>
      <article class="card">
        <h3 class="h3">הוסף ליומן</h3>
        <div class="row chips">
          <% if (it.calendar.ics) { %><a class="chip" href="<%= it.calendar.ics %>">ICS</a><% } %>
          <% if (it.calendar.google) { %><a class="chip" href="<%= it.calendar.google %>" target="_blank" rel="noopener">Google</a><% } %>
          <% if (it.calendar.apple) { %><a class="chip" href="<%= it.calendar.apple %>">Apple</a><% } %>
        </div>
      </article>
      <% } %>

      <!-- יצירת קשר / ניווט -->
      <% if (it.restaurant && (it.restaurant.phone || it.restaurant.map || it.restaurant.website)) { %>
      <article class="card">
        <h3 class="h3">יצירת קשר</h3>
        <ul class="list">
          <% if (it.restaurant.phone) { %><li><a href="tel:<%= it.restaurant.phone %>">📞 <span dir="ltr"><%= it.restaurant.phone %></span></a></li><% } %>
          <% if (it.restaurant.website) { %><li><a href="<%= it.restaurant.website %>" target="_blank" rel="noopener">🌐 אתר המסעדה</a></li><% } %>
          <% if (it.restaurant.map) { %><li><a href="<%= it.restaurant.map %>" target="_blank" rel="noopener">🗺️ נווט עם מפות</a></li><% } %>
        </ul>
      </article>
      <% } %>
    </aside>
  </div>

  <!-- גלריית תמונות (אם קיימת) -->
  <% if (it.restaurant && it.restaurant.photos && it.restaurant.photos.length) { %>
    <section class="photos">
      <h2 class="h2">מהמקום</h2>
      <div class="gallery">
        <% it.restaurant.photos.forEach(src => { %>
          <img class="ph" src="<%= src %>" alt="">
        <% }) %>
      </div>
    </section>
  <% } %>
</section>

<style>
  :root{--bd:#222834;--panel:#12151b;--panel2:#161a21;--ink:#e6e9ef;--ink-dim:#98a2b3;--ok:#22c55e;--bad:#ef4444}

  .resv{max-width:1100px;margin:0 auto;display:grid;gap:14px}
  .resv-hd .brand{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
  .cover{inline-size:72px; block-size:72px; border-radius:14px; border:1px solid var(--bd); background:#0b0f17 center/cover no-repeat}
  .title{margin:0}
  .muted{color:var(--ink-dim)}
  .status{display:flex;align-items:center}
  .badge{padding:5px 8px;border-radius:999px;border:1px solid #334155;font-size:12px}
  .badge.good{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
  .badge.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}

  .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg, rgba(22,26,33,.9), rgba(16,19,25,.94));border:1px solid var(--bd);border-radius:14px;padding:12px}
  .h2{margin:0 0 8px;font-size:18px}
  .h3{margin:0 0 8px;font-size:16px}

  .dl{display:grid;gap:8px;margin:0}
  .dl .row{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:start}
  .dl dt{color:var(--ink-dim);font-size:12px}
  .dl dd{margin:0}
  .pre{white-space:pre-wrap}

  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid #2a3040;background:transparent;color:var(--ink);font-weight:600;text-decoration:none}
  .btn:hover{transform:translateY(-1px)}
  .btn.danger{border-color:rgba(239,68,68,.45);color:#fecaca}

  .stack{display:grid;gap:12px}
  .qr{display:flex;justify-content:center;margin:6px 0}

  .list{list-style:none;margin:0;padding:0;display:grid;gap:6px}
  .list a{color:var(--ink);text-decoration:none}
  .list a:hover{text-decoration:underline}

  .chips{gap:6px}
  .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3040;text-decoration:none;color:var(--ink)}
  .chip:hover{transform:translateY(-1px)}

  .photos{display:grid;gap:8px}
  .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .ph{width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:12px;border:1px solid var(--bd);background:#0b0f17}
  @media (max-width:720px){.gallery{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:520px){.gallery{grid-template-columns:1fr}}
</style>
