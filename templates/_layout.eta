<!doctype html>
<html lang="<%= it.lang || 'he' %>" dir="<%= it.dir || 'rtl' %>">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="color-scheme" content="dark light">
  <title><%= it.title ? it.title + ' 路 SpotBook' : 'SpotBook' %></title>

  <% if (!it.admin) { %>
    <link rel="stylesheet" href="/static/styles.css?v=<%= it.BUILD_TAG || '' %>"/>
  <% } %>

  <!-- External fonts intentionally not loaded to keep CSP strict (style-src 'self').
       spotbook.css uses a system font stack fallback. -->
  <link rel="stylesheet" href="/public/css/spotbook.css?v=<%= it.BUILD_TAG || Date.now() %>"/>
  <link rel="stylesheet" href="/public/css/sb-ui.css?v=<%= it.BUILD_TAG || Date.now() %>"/>
  <link rel="stylesheet" href="/public/css/sb-floorboard.css?v=<%= it.BUILD_TAG || Date.now() %>"/>

  <%~ it.head || '' %>

  <style>
    /* ===== Language switch (minimal clean) ===== */
    .lang-switch { position: relative; display:inline-block; margin-inline-start:12px; }
    .lang-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      cursor:pointer;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.25);
      transition: background .15s ease, transform .15s ease;
    }
    .lang-btn:hover { background:rgba(255,255,255,.1); transform:translateY(-1px); }
    .lang-btn::before{ content:""; font-size:18px; line-height:1; }

    .lang-menu {
      position:absolute; top:110%; inset-inline-end:0;
      background: rgba(15,23,42,.85);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:4px;
      box-shadow:0 6px 20px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      z-index:60; min-width:90px;
      opacity:0; transform:translateY(-5px) scale(.97);
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
    }
    .lang-menu.open { opacity:1; transform:translateY(0) scale(1); pointer-events:auto; }

    .lang-item {
      display:block; text-align:center;
      color:#e2e8f0; padding:6px 0;
      border-radius:6px;
      text-decoration:none; font-weight:600;
      font-variant: all-small-caps;
      font-family:"Rubik",sans-serif;
      transition:background .15s ease;
    }
    .lang-item:hover { background:rgba(255,255,255,.08); }
    .lang-item.active { background:rgba(255,255,255,.12); }

    html[dir="rtl"] .lang-menu { inset-inline-start:0; inset-inline-end:auto; }

    /* ===== Admin small bottom-right ===== */
    .sb-footer { position: relative; }
    .admin-bottom-right {
      position:absolute; right:16px; bottom:34px;
      font-size:.85rem; opacity:.8;
    }
    .admin-bottom-right a {
      color:var(--muted,#94a3b8); text-decoration:none;
      padding:4px 8px; border-radius:10px;
      border:1px solid transparent;
      transition:all .15s ease;
    }
    .admin-bottom-right a:hover {
      color:var(--brand-ink,#fff);
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.1);
      opacity:1;
    }
  </style>
</head>

<body class="sb-body<%= it.admin ? ' admin' : '' %>" data-theme="<%= it.admin ? 'dark' : 'auto' %>">
  <header class="sb-header">
    <div class="sb-container sb-header-row">
      <a class="brand" href="/" aria-label="SpotBook">
        <img class="brand-logo" src="/public/img/logo-spotbook.png" alt="SpotBook Logo"/>
      </a>

      <% if (it.user) { %>
      <div class="user-mobile">
        <%= it.t ? it.t('nav.signedin') : '专/转' %>:
        <strong><%= [it.user.firstName, it.user.lastName].filter(Boolean).join(" ") %></strong>
      </div>
      <% } %>

      <nav class="sb-actions" aria-label="Main actions">
        <% if (it.user) { %>
          <a class="btn primary btn-manage" href="/owner"><%= it.t ? it.t('nav.manage') : ' 住注' %></a>
          <a class="btn ghost btn-logout" href="/auth/logout"><%= it.t ? it.t('nav.logout') : '转转拽' %></a>
        <% } else { %>
          <a class="btn ghost" href="/auth/login"><%= it.t ? it.t('nav.login') : '转专' %></a>
          <a class="btn" style="border-color:transparent;background:var(--brand);color:var(--brand-ink)" href="/auth/register"><%= it.t ? it.t('nav.register') : '专砖' %></a>
        <% } %>

        <!-- Language switch -->
        <div class="lang-switch">
          <button class="lang-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="langMenu" title="<%= it.t ? it.t('nav.language') : '专 砖驻' %>"></button>
          <div class="lang-menu" id="langMenu" role="menu">
            <a class="lang-item <%= (it.lang==='en'?'active':'') %>" href="/lang/en" role="menuitem">EN</a>
            <a class="lang-item <%= (it.lang==='ka'?'active':'') %>" href="/lang/ka" role="menuitem">GE</a>
            <a class="lang-item <%= (it.lang==='he'?'active':'') %>" href="/lang/he" role="menuitem">HE</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="sb-container">
    <%~ it.body %>
  </main>

  <footer class="sb-footer">
    <div class="admin-bottom-right">
      <a href="/admin/login"><%= it.t ? (it.t('nav.admin') || 'Admin') : 'Admin' %></a>
    </div>
    <p>漏 <%= new Date().getFullYear() %> SpotBook 路 <%= it.t ? (it.t('footer.rights') || ' 转 砖专转') : ' 转 砖专转' %></p>
  </footer>

  <script src="/static/app.js?v=<%= it.BUILD_TAG || '' %>" defer></script>
  <script>
  (function(){
    function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    ready(function(){
      const btn  = document.querySelector('.lang-btn');
      const menu = document.getElementById('langMenu');
      if(!btn || !menu) return;

      function openMenu(){ menu.classList.add('open');  btn.setAttribute('aria-expanded','true'); }
      function closeMenu(){ menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      function toggleMenu(e){ e?.stopPropagation(); menu.classList.contains('open') ? closeMenu() : openMenu(); }

      btn.addEventListener('click', toggleMenu);
      btn.addEventListener('touchstart', toggleMenu, { passive: true });

      document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==btn) closeMenu(); });
      document.addEventListener('touchstart', (e)=>{ if(!menu.contains(e.target) && e.target!==btn) closeMenu(); }, { passive: true });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
    });
  })();
  </script>

  <% if (it.scripts) { it.scripts.forEach(function(src){ %>
    <script src="<%= src %>" type="module"></script>
  <% }) } %>
</body>
</html>
