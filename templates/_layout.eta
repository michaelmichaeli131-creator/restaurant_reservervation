<!doctype html>
<html lang="<%= it.lang || 'he' %>" dir="<%= it.dir || 'rtl' %>">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="color-scheme" content="dark light">
  <title><%= it.title ? it.title + ' · SpotBook' : 'SpotBook' %></title>

  <% if (!it.admin) { %>
    <link rel="stylesheet" href="/static/styles.css?v=<%= it.BUILD_TAG || '' %>"/>
  <% } %>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/spotbook.css?v=<%= it.BUILD_TAG || Date.now() %>"/>

  <%~ it.head || '' %>

  <style>
    /* ===== Language button & menu (dark, blended) ===== */
    .lang-switch { position: relative; display:inline-block; margin-inline-start:12px; }
    .lang-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:999px;
      border:1px solid var(--bd,#2a2f3a);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 2px 10px rgba(0,0,0,.18) inset, 0 1px 0 rgba(255,255,255,.05);
      cursor:pointer; font-size:0;
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .lang-btn:hover { transform: translateY(-1px); }
    .lang-btn::before{ content: "🌐"; font-size:18px; line-height:1; opacity:.9; }

    .lang-menu {
      position:absolute; top:120%; inset-inline-end:0;
      min-width: 160px; padding:6px;
      border:1px solid var(--bd,#2a2f3a);
      border-radius:12px;
      background: rgba(15,23,42,.70); /* כהה, עם שקיפות קלה */
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      z-index:60;
    }
    .lang-menu[hidden]{ display:none; }

    .lang-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border-radius:9px; color:#e5edf7;
      text-decoration:none; border:1px solid transparent; font-weight:600;
      letter-spacing:.2px;
      transition: background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .lang-item:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.10); }
    .lang-item .code{ font-variant: all-small-caps; }
    .lang-item .flag{ font-size:16px; margin-inline-start:8px; }

    html[dir="rtl"] .lang-menu{ inset-inline-start:0; inset-inline-end:auto; }

    /* ===== Admin קטן בתחתית ימין ===== */
    .sb-footer { position: relative; }
    .admin-bottom-right {
      position: absolute; right: 16px; bottom: 34px;
      font-size:.85rem; opacity:.8;
    }
    .admin-bottom-right a{
      color:var(--muted,#94a3b8); text-decoration:none;
      padding:4px 8px; border-radius:10px; border:1px solid transparent;
      transition: color .15s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .admin-bottom-right a:hover{
      color:var(--brand-ink,#fff);
      background:rgba(255,255,255,.06);
      border-color:var(--bd,#2a2f3a);
      opacity:1;
    }
  </style>
</head>

<body class="sb-body<%= it.admin ? ' admin' : '' %>" data-theme="<%= it.admin ? 'dark' : 'auto' %>">
  <header class="sb-header">
    <div class="sb-container sb-header-row">
      <!-- לוגו -->
      <a class="brand" href="/" aria-label="SpotBook">
        <img class="brand-logo" src="/public/img/logo-spotbook.png" alt="SpotBook Logo"/>
      </a>

      <% if (it.user) { %>
      <div class="user-mobile">
        מחובר/ת:
        <strong><%= [it.user.firstName, it.user.lastName].filter(Boolean).join(" ") %></strong>
      </div>
      <% } %>

      <!-- פעולות (העיצוב הישן נשמר) -->
      <nav class="sb-actions" aria-label="Main actions">
        <% if (it.user) { %>
          <a class="btn primary btn-manage" href="/owner">נהל מסעדה</a>
          <a class="btn ghost btn-logout" href="/auth/logout">התנתקות</a>
        <% } else { %>
          <a class="btn ghost" href="/auth/login">התחברות</a>
          <a class="btn" style="border-color:transparent;background:var(--brand);color:var(--brand-ink)" href="/auth/register">הרשמה</a>
        <% } %>

        <!-- כפתור שפה עגול במקום Admin -->
        <div class="lang-switch">
          <button class="lang-btn" type="button" aria-haspopup="true" aria-expanded="false" title="בחר שפה"></button>
          <div class="lang-menu" hidden>
            <!-- קוד ואז דגל: EN 🇺🇸, HE 🇮🇱, GE 🇬🇪 -->
            <a class="lang-item" href="/lang/en"><span class="code">EN</span><span class="flag">🇺🇸</span></a>
            <a class="lang-item" href="/lang/he"><span class="code">HE</span><span class="flag">🇮🇱</span></a>
            <a class="lang-item" href="/lang/ka"><span class="code">GE</span><span class="flag">🇬🇪</span></a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="sb-container">
    <%~ it.body %>
  </main>

  <footer class="sb-footer">
    <!-- Admin קטן, בצד ימין למטה, לא בולט -->
    <div class="admin-bottom-right">
      <a href="/admin/login">Admin</a>
    </div>
    <p>© <%= new Date().getFullYear() %> SpotBook · כל הזכויות שמורות</p>
  </footer>

  <script src="/static/app.js?v=<%= it.BUILD_TAG || '' %>" defer></script>
  <script>
    (function(){
      const btn = document.querySelector('.lang-btn');
      const menu = document.querySelector('.lang-menu');
      if(!btn || !menu) return;

      btn.addEventListener('click', ()=>{
        const open = !menu.hasAttribute('hidden');
        if(open) menu.setAttribute('hidden',''); else menu.removeAttribute('hidden');
        btn.setAttribute('aria-expanded', String(!open));
      });

      document.addEventListener('click', (e)=>{
        if (!menu.contains(e.target) && e.target !== btn) menu.setAttribute('hidden','');
      });
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') menu.setAttribute('hidden','');
      });
    })();
  </script>

  <% if (it.scripts) { it.scripts.forEach(function(src){ %>
    <script src="<%= src %>" type="module"></script>
  <% }) } %>
</body>
</html>
