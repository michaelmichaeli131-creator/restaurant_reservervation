var bt=Object.defineProperty;var xt=(p,C,N)=>C in p?bt(p,C,{enumerable:!0,configurable:!0,writable:!0,value:N}):p[C]=N;var Ve=(p,C,N)=>xt(p,typeof C!="symbol"?C+"":C,N);import{r as h,t as d,j as e,g as vt,i as jt,c as yt,R as wt}from"./floor-index.js";function Nt({restaurantId:p}){const[C,N]=h.useState([]),[s,D]=h.useState(null),[J,W]=h.useState([]),[R,q]=h.useState(null),[T,$]=h.useState(null),[G,K]=h.useState(null),z=h.useMemo(()=>!s||!T?null:s.tables.find(t=>t.id===T)??null,[s,T]),P=h.useMemo(()=>!s||!G?null:(s.objects??[]).find(t=>t.id===G)??null,[s,G]),[g,ae]=h.useState(null),[Z,ne]=h.useState(1),[be,te]=h.useState(!1),[ke,Se]=h.useState(""),[Me,Fe]=h.useState(!1),[de,oe]=h.useState(null),[x,he]=h.useState(null),[xe,re]=h.useState(null),[V,v]=h.useState(60),X=vt(),A=h.useMemo(()=>({parquet_blue:{label:d("floor.themes.parquet_blue","Blue parquet"),bg:"url(/floor_assets/floor_parquet_blue.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{label:d("floor.themes.parquet_brown","Brown parquet"),bg:"url(/floor_assets/floor_parquet_brown.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{label:d("floor.themes.slate_dark","Dark slate"),bg:"url(/floor_assets/floor_slate_dark.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{label:d("floor.themes.navy_carpet","Deep navy"),bg:"url(/floor_assets/floor_navy_carpet.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{label:d("floor.themes.teal_terrazzo","Muted teal"),bg:"url(/floor_assets/floor_teal_terrazzo.svg)",size:"240px 240px",repeat:"repeat",pos:"center"}}),[X]),F=t=>!t||t.startsWith("#")?"parquet_blue":t in A?t:"parquet_blue",[I,ie]=h.useState("parquet_blue"),[Q,n]=h.useState(!1);h.useEffect(()=>{s&&ie(F(s.floorColor))},[s==null?void 0:s.id]);const[o,S]=h.useState(!1),[_,E]=h.useState(1),[U,O]=h.useState({x:0,y:0}),[ue,ye]=h.useState(!1),[H,fe]=h.useState(!1),ee=h.useRef(null),le=h.useRef(null),ve=h.useRef(null),Y="/floor_assets/",we=t=>Math.max(1,Number(t)||1)*V,_e=(t,a)=>{const r=String(t||"square").toLowerCase(),i=Number(a||0);return r==="booth"?i>=6?{spanX:6,spanY:2}:{spanX:2,spanY:2}:r==="round"?i>=9?{spanX:3,spanY:3}:{spanX:2,spanY:2}:i<=2?{spanX:2,spanY:1}:i<=4?{spanX:2,spanY:2}:{spanX:2,spanY:2}},De=(t,a,r)=>{const i=String(r||"").toLowerCase();return i==="large_booth.svg"||i==="round_table_10.svg"?.88:i==="round_table4.svg"||i==="square_table2.svg"?1.06:1},Te=(t,a=1)=>{const r=Number(t);return Number.isFinite(r)?Math.max(.5,Math.min(1.6,r)):a},pe=t=>{const a=Number(t);return Number.isFinite(a)?(Math.round(a/45)*45%360+360)%360:0},st=t=>String(t||"").toLowerCase()==="bar"?1.8:1,ge=(t,a)=>{const r=String(t||"rect").toLowerCase(),i=Number(a||0);if(r==="round")return i>=9?`${Y}round_table_10.svg`:`${Y}round_table4.svg`;if(r==="booth")return i>=6?`${Y}large_booth.svg`:`${Y}booth4.svg`;const c=[2,4,6,8,10].reduce((f,u)=>Math.abs(u-i)<Math.abs(f-i)?u:f,4);return`${Y}square_table${c}.svg`},Ce=(t,a,r,i)=>{const l=String(i||"").toLowerCase(),c={bar:"bar.svg",chair:"chair.svg",plant:"plant.svg",door:"door.svg",floor_brown:"floor_brown.svg",corner_partitaion:"corner_partitaion.svg",cyclic:"cyclic_partition.svg",cyclic_partition:"cyclic_partition.svg",horizintal_partitaion:"horizintal_partitaion.svg",vertical_partition:"vertical_partition.svg"};return c[l]?`${Y}${c[l]}`:t==="door"?`${Y}door.svg`:t==="bar"?`${Y}bar.svg`:t==="plant"?`${Y}plant.svg`:(a||1)===1&&(r||1)===1?`${Y}corner_partitaion.svg`:(a||1)>(r||1)?`${Y}horizintal_partitaion.svg`:`${Y}vertical_partition.svg`},Ie=t=>{const a=Number(t.gridRows||0),r=Number(t.gridCols||0),i=Math.max(0,a*r),l=Array.isArray(t.gridMask)?t.gridMask.slice(0,i):[];for(;l.length<i;)l.push(1);return{...t,gridMask:l,floorColor:t.floorColor||"parquet_blue"}},Ee=(t,a,r,i)=>{if(!(s!=null&&s.gridMask))return!0;const l=s.gridCols;for(let c=a;c<a+i;c++)for(let f=t;f<t+r;f++){if(f<0||c<0||f>=l||c>=s.gridRows)return!1;const u=c*l+f;if(s.gridMask[u]!==1)return!1}return!0};h.useEffect(()=>{p&&(fetch(`/api/floor-layouts/${p}`).then(t=>t.ok?t.json():[]).then(t=>{N(t);const a=t.find(l=>l.isActive);D(a?Ie(a):t[0]?Ie(t[0]):null);const r=t.flatMap(l=>l.tables),i=Math.max(...r.map(l=>l.tableNumber),0);ne(i+1)}).catch(t=>console.error("Failed to load layouts:",t)),fetch(`/api/floor-sections/${p}`).then(t=>t.ok?t.json():[]).then(t=>{W(t),t.length>0&&q(t[0])}).catch(t=>console.error("Failed to load sections:",t)))},[p]),h.useEffect(()=>{const t=r=>{r.code==="Space"&&fe(!0)},a=r=>{r.code==="Space"&&(fe(!1),ye(!1))};return window.addEventListener("keydown",t),window.addEventListener("keyup",a),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",a)}},[]);const Re=async()=>{if(!ke.trim()){alert(d("floor.error.enter_name","Please enter a layout name"));return}try{const t=await fetch(`/api/floor-layouts/${p}`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:ke,gridRows:8,gridCols:12,gridMask:Array.from({length:96},()=>1),tables:[],objects:[],isActive:C.length===0})});if(t.ok){const a=await t.json();N([...C,a]),D(a),Se(""),te(!1);try{const r=await fetch(`/api/floor-layouts/${p}/${a.id}/activate`,{method:"POST",credentials:"include"});if(r.ok)N(i=>i.map(l=>({...l,isActive:l.id===a.id})));else{const i=await r.text().catch(()=>"");console.error("[FloorEditor] auto-activate after create failed",{status:r.status,statusText:r.statusText,body:i})}}catch(r){console.error("[FloorEditor] auto-activate after create threw",r)}}else{const a=await t.json().catch(()=>null),r=(a==null?void 0:a.error)||d("floor.error.server","Server error: {status} {statusText}").replace("{status}",String(t.status)).replace("{statusText}",t.statusText);alert(d("floor.error.create","Error creating layout: {error}").replace("{error}",r))}}catch(t){console.error("Create layout failed:",t),alert(d("floor.error.create","Error creating layout: {error}").replace("{error}",t instanceof Error?t.message:String(t)))}},at=async t=>{if(confirm(d("floor.confirm.delete_layout","Are you sure you want to delete this layout?")))try{const a=await fetch(`/api/floor-layouts/${p}/${t}`,{method:"DELETE",credentials:"include"});if(a.ok){const r=C.filter(i=>i.id!==t);N(r),(s==null?void 0:s.id)===t&&D(r[0]||null)}else{const r=await a.json();alert(r.error||d("floor.error.delete","Delete failed"))}}catch(a){console.error("Delete failed:",a),alert(d("floor.error.delete_general","Error deleting layout"))}},nt=async t=>{const a=prompt(d("floor.prompt.duplicate_name","Enter name for duplicated layout:"));if(a)try{const r=await fetch(`/api/floor-layouts/${p}/${t}/duplicate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:a})});if(r.ok){const i=await r.json();N([...C,i]),D(i)}else alert(d("floor.error.duplicate","Error duplicating layout"))}catch(r){console.error("Duplicate failed:",r),alert(d("floor.error.duplicate","Error duplicating layout"))}},ot=async t=>{try{(await fetch(`/api/floor-layouts/${p}/${t}/activate`,{method:"POST",credentials:"include"})).ok&&N(C.map(r=>({...r,isActive:r.id===t})))}catch(a){console.error("Set active failed:",a)}},Ke=(t,a,r)=>Math.max(a,Math.min(r,t)),Oe=(t,a,r,i)=>s?{x:Ke(t,0,Math.max(0,s.gridCols-r)),y:Ke(a,0,Math.max(0,s.gridRows-i))}:{x:t,y:a},rt=(t,a,r,i)=>{if(!s)return{x:t,y:a};const c=(s.objects??[]).filter(b=>b.type==="wall"||b.type==="divider");if(!c.length)return{x:t,y:a};const f={x:t,y:a},u=[],y=(b,j)=>{const m=Oe(b,j,r,i),k=Math.abs(m.x-f.x)+Math.abs(m.y-f.y);u.push({...m,score:k})};return c.forEach(b=>{const j=b.gridX,m=b.gridY,k=b.gridX+(b.spanX||1),L=b.gridY+(b.spanY||1);t+r>j&&t<k&&(y(t,m-i),y(t,L)),a+i>m&&a<L&&(y(j-r,a),y(k,a))}),u.length?(u.sort((b,j)=>b.score-j.score),u[0].score<=1?{x:u[0].x,y:u[0].y}:{x:t,y:a}):{x:t,y:a}},Ae=t=>Math.max(.35,Math.min(2.5,t)),it=t=>{const a=Number(t.gridCols||0),r=Number(t.gridRows||0);let i=0,l=0,c=Math.max(0,a-1),f=Math.max(0,r-1);const u=t.gridMask;if(Array.isArray(u)&&a>0&&r>0){const b=a*r,j=u.slice(0,b);for(;j.length<b;)j.push(1);let m=!0;for(let k=0;k<b;k++)if((j[k]??1)!==1){m=!1;break}if(!m){let k=!1,L=1/0,M=1/0,B=-1/0,Ne=-1/0;for(let ce=0;ce<b;ce++){if((j[ce]??1)!==1)continue;const w=ce%a,me=Math.floor(ce/a);k=!0,w<L&&(L=w),me<M&&(M=me),w>B&&(B=w),me>Ne&&(Ne=me)}k&&(i=L,l=M,c=B,f=Ne)}}const y=(b,j,m,k)=>{const L=Math.max(1,Number(m)||1),M=Math.max(1,Number(k)||1);i=Math.min(i,b),l=Math.min(l,j),c=Math.max(c,b+L-1),f=Math.max(f,j+M-1)};for(const b of t.tables||[])y(Number(b.gridX)||0,Number(b.gridY)||0,b.spanX??1,b.spanY??1);for(const b of t.objects||[])y(Number(b.gridX)||0,Number(b.gridY)||0,b.spanX??1,b.spanY??1);return i=Math.max(0,Math.min(a-1,i)),l=Math.max(0,Math.min(r-1,l)),c=Math.max(0,Math.min(a-1,c)),f=Math.max(0,Math.min(r-1,f)),{minX:i,minY:l,maxX:c,maxY:f}},ze=()=>{const t=ee.current;if(!t||!s)return;t.scrollLeft=0,t.scrollTop=0;const a=V,r=it(s),i=(r.maxX-r.minX+1)*a,l=(r.maxY-r.minY+1)*a,c=window.getComputedStyle(t),f=parseFloat(c.paddingLeft||"0")||0,u=parseFloat(c.paddingRight||"0")||0,y=parseFloat(c.paddingTop||"0")||0,b=parseFloat(c.paddingBottom||"0")||0,j=le.current,m=j?window.getComputedStyle(j):null,k=m&&parseFloat(m.marginLeft||"0")||0,L=m&&parseFloat(m.marginTop||"0")||0,M=12,B=Math.max(1,t.clientWidth-f-u-M*2),Ne=Math.max(1,t.clientHeight-y-b-M*2),ce=Ae(Math.min(B/i,Ne/l,1.2));E(ce);const w=Math.round(f+M+(B-i*ce)/2-r.minX*a*ce-k),me=Math.round(y+M+(Ne-l*ce)/2-r.minY*a*ce-L);O({x:w,y:me})};h.useEffect(()=>{if(!s)return;const t=requestAnimationFrame(()=>ze());return()=>cancelAnimationFrame(t)},[s==null?void 0:s.id,s==null?void 0:s.gridCols,s==null?void 0:s.gridRows,V]),h.useEffect(()=>{const t=ee.current;if(!t||!s)return;const a=new ResizeObserver(()=>{requestAnimationFrame(()=>ze())});return a.observe(t),()=>a.disconnect()},[s==null?void 0:s.id,V]);const Be=(t,a,r)=>{if(!ee.current)return;const i=ee.current.getBoundingClientRect(),l=a-i.left,c=r-i.top;O(f=>{const y=t/_,b=Math.round(l-(l-f.x)*y),j=Math.round(c-(c-f.y)*y);return{x:b,y:j}}),E(t)},lt=t=>{if(!(t.ctrlKey||t.metaKey))return;t.preventDefault();const a=t.deltaY,r=Ae(_*(a>0?.9:1.1));Be(r,t.clientX,t.clientY)},ct=t=>{const a=t.button===1,r=H&&t.button===0;if(!a&&!r)return;t.preventDefault(),ye(!0);const i={x:t.clientX,y:t.clientY},l={...U},c=u=>{const y=u.clientX-i.x,b=u.clientY-i.y;O({x:l.x+y,y:l.y+b})},f=()=>{ye(!1),window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",f)};window.addEventListener("mousemove",c),window.addEventListener("mouseup",f)},dt=(t,a,r,i,l)=>{if(!s)return{x:t,y:a,guides:{v:[],h:[]}};const c=[];for(const w of s.tables)(l==null?void 0:l.kind)==="table"&&(l!=null&&l.id)&&w.id===l.id||c.push({left:w.gridX,top:w.gridY,right:w.gridX+(w.spanX||1),bottom:w.gridY+(w.spanY||1),cx2:w.gridX*2+(w.spanX||1),cy2:w.gridY*2+(w.spanY||1)});for(const w of s.objects??[])(l==null?void 0:l.kind)==="object"&&(l!=null&&l.id)&&w.id===l.id||c.push({left:w.gridX,top:w.gridY,right:w.gridX+(w.spanX||1),bottom:w.gridY+(w.spanY||1),cx2:w.gridX*2+(w.spanX||1),cy2:w.gridY*2+(w.spanY||1)});const f=t,u=a,y=t+r,b=a+i,j=t*2+r,m=a*2+i,k=1;let L=null,M=null;const B={v:[],h:[]},Ne=(w,me)=>{Math.abs(w)>k||(L===null||Math.abs(w)<Math.abs(L))&&(L=w,B.v=[me])},ce=(w,me)=>{Math.abs(w)>k||(M===null||Math.abs(w)<Math.abs(M))&&(M=w,B.h=[me])};for(const w of c){Ne(w.left-f,w.left),Ne(w.right-y,w.right);const me=w.cx2-j;me%2===0&&Ne(me/2,w.cx2/2),ce(w.top-u,w.top),ce(w.bottom-b,w.bottom);const He=w.cy2-m;He%2===0&&ce(He/2,w.cy2/2)}return{x:L!==null?t+L:t,y:M!==null?a+M:a,guides:B}},ut=(t,a,r,i,l,c,f,u)=>{const y=Oe(t,a,r,i);if(f)return{x:y.x,y:y.y,guides:{v:[],h:[]}};const j=l==="table"&&String(c).toLowerCase()==="booth"||l==="object"&&(c==="bar"||c==="door")?rt(y.x,y.y,r,i):y,m=dt(j.x,j.y,r,i,u),k=Oe(m.x,m.y,r,i);return{x:k.x,y:k.y,guides:m.guides}},Ye=(t,a,r,i,l,c,f,u)=>ut(t,a,r,i,l,c,f,u),qe=(t,a)=>{if(!s)return null;const r=le.current;if(!r)return null;const i=r.getBoundingClientRect(),l=s.gridCols*V,c=s.gridRows*V,f=i.width/Math.max(1,l),u=i.height/Math.max(1,c),b=getComputedStyle(r).direction==="rtl"?(i.right-t)/f:(t-i.left)/f,j=(a-i.top)/u,m=Math.floor(b/V),k=Math.floor(j/V);return Number.isNaN(m)||Number.isNaN(k)||m<0||k<0||m>=s.gridCols||k>=s.gridRows?null:{x:m,y:k}},se=(t,a,r,i,l)=>{s&&(t.preventDefault(),t.stopPropagation(),$(null),K(null),$(null),K(null),$(null),he({kind:a,mode:"new",spanX:r,spanY:i,payload:l}),re(null))},Ue=(t,a,r,i,l)=>{s&&(t.preventDefault(),t.stopPropagation(),he({kind:a,mode:"existing",spanX:i,spanY:l,tableId:a==="table"?r:void 0,objectId:a==="object"?r:void 0}),re(null))};h.useEffect(()=>{if(!x||!s)return;const t=i=>{var j,m;const l=qe(i.clientX,i.clientY);if(!l){re(null);return}const c=l.x-Math.floor(x.spanX/2),f=l.y-Math.floor(x.spanY/2),u=i.shiftKey,y=x.mode==="existing"?{kind:x.kind,id:x.kind==="table"?x.tableId:x.objectId}:void 0,b=Ye(c,f,x.spanX,x.spanY,x.kind,((j=x.payload)==null?void 0:j.shape)??((m=x.payload)==null?void 0:m.objectType),u,y);if(!Ee(b.x,b.y,x.spanX,x.spanY)){re(null);return}re({x:b.x,y:b.y}),oe({x:b.x,y:b.y})},a=()=>{var c,f,u,y,b,j,m;if(!xe){he(null),re(null),oe(null);return}const i=xe.x,l=xe.y;if(x.mode==="existing")x.kind==="table"&&x.tableId?Xe(x.tableId,{gridX:i,gridY:l}):x.kind==="object"&&x.objectId&&$e(x.objectId,{gridX:i,gridY:l});else if(x.kind==="table"){const k=Number(((c=x.payload)==null?void 0:c.seats)??2),L=((f=x.payload)==null?void 0:f.shape)??"square",M={id:`T${Date.now()}`,name:`T${Z}`,tableNumber:Z,gridX:i,gridY:l,spanX:x.spanX,spanY:x.spanY,seats:k,shape:L,scale:1,rotationDeg:0,assetFile:(u=x.payload)==null?void 0:u.assetFile,kind:"table",sectionId:R==null?void 0:R.id};ne(B=>B+1),D({...s,tables:[...s.tables,M]})}else{const k={id:`O${Date.now()}`,type:((y=x.payload)==null?void 0:y.objectType)??"visual",gridX:i,gridY:l,spanX:x.spanX,spanY:x.spanY,label:(b=x.payload)==null?void 0:b.objectLabel,assetFile:(j=x.payload)==null?void 0:j.assetFile,kind:((m=x.payload)==null?void 0:m.objectKind)??"object",scale:1,rotationDeg:0};D({...s,objects:[...s.objects??[],k]})}he(null),re(null),oe(null)},r=i=>{i.key==="Escape"&&(he(null),re(null),oe(null))};return window.addEventListener("mousemove",t),window.addEventListener("mouseup",a,{once:!0}),window.addEventListener("keydown",r),()=>{window.removeEventListener("mousemove",t),window.removeEventListener("keydown",r)}},[x,s,V,xe,Z,R==null?void 0:R.id]);const pt=t=>{if(t.preventDefault(),!g||!s)return;const a=qe(t.clientX,t.clientY);if(!a)return;const r=a.x,i=a.y,l=!!t.shiftKey;if(g.kind==="table"&&g.mode==="new"&&g.shape){const c=Number(g.seats??(g.shape==="booth"?4:2)),f=g.spanX&&g.spanY?{spanX:g.spanX,spanY:g.spanY}:_e(g.shape,c),u=Ye(r,i,f.spanX,f.spanY,"table",g.shape,l);if(!Ee(u.x,u.y,f.spanX,f.spanY)){alert(d("floor.error.placement_outside","Cannot place item outside the restaurant shape"));return}const y={id:`T${Date.now()}`,name:`Table ${Z}`,tableNumber:Z,gridX:u.x,gridY:u.y,spanX:f.spanX,spanY:f.spanY,seats:c,shape:g.shape,assetFile:g.assetFile,kind:"table",sectionId:R==null?void 0:R.id,scale:1,rotationDeg:0};D({...s,tables:[...s.tables,y]}),ne(Z+1),K(null),$(null),$(y.id),K(null),$(null)}else if(g.kind==="table"&&g.mode==="existing"&&g.tableId){const c=s.tables.find(u=>u.id===g.tableId);if(!c)return;const f=Ye(r,i,c.spanX||1,c.spanY||1,"table",c.shape,l,{kind:"table",id:c.id});if(!Ee(f.x,f.y,c.spanX||1,c.spanY||1)){alert(d("floor.error.move_outside","Cannot move item outside the restaurant shape"));return}D({...s,tables:s.tables.map(u=>u.id===g.tableId?{...u,gridX:f.x,gridY:f.y}:u)})}else if(g.kind==="object"&&g.mode==="new"&&g.objectType){const c=s.objects??[],u={wall:{spanX:4,spanY:1,rotation:0,label:"wall_h"},divider:{spanX:2,spanY:1,rotation:0,label:"partition"},door:{spanX:1,spanY:1,rotation:0,label:"Door"},bar:{spanX:5,spanY:1,rotation:0,label:"Bar"},plant:{spanX:1,spanY:1,rotation:0,label:""}}[String(g.objectType)]??{spanX:1,spanY:1},y={spanX:Math.max(1,Number(g.spanX??u.spanX)||1),spanY:Math.max(1,Number(g.spanY??u.spanY)||1)},b=Ye(r,i,y.spanX,y.spanY,"object",g.objectType,l);if(!Ee(b.x,b.y,y.spanX,y.spanY)){alert(d("floor.error.placement_outside","Cannot place item outside the restaurant shape"));return}const j={id:`O${Date.now()}`,type:g.objectType,gridX:b.x,gridY:b.y,spanX:y.spanX,spanY:y.spanY,rotation:g.rotation??u.rotation,label:g.objectLabel??u.label,assetFile:g.assetFile,kind:g.objectKind??"object",scale:1,rotationDeg:0};D({...s,objects:[...c,j]}),$(null),K(null),$(null),K(j.id),$(null)}else if(g.kind==="object"&&g.mode==="existing"&&g.objectId){const c=s.objects??[],f=c.find(y=>y.id===g.objectId);if(!f)return;const u=Ye(r,i,f.spanX||1,f.spanY||1,"object",f.type,l,{kind:"object",id:f.id});if(!Ee(u.x,u.y,f.spanX||1,f.spanY||1)){alert(d("floor.error.move_outside","Cannot move item outside the restaurant shape"));return}D({...s,objects:c.map(y=>y.id===g.objectId?{...y,gridX:u.x,gridY:u.y}:y)})}ae(null),oe(null)},mt=t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const a=qe(t.clientX,t.clientY);a&&oe(a)},ht=t=>{s&&(D({...s,tables:s.tables.filter(a=>a.id!==t)}),$(null),K(null),$(null))},ft=t=>{if(!s)return;const a=s.objects??[];D({...s,objects:a.filter(r=>r.id!==t)}),K(null),$(null)},$e=(t,a)=>{if(!s)return;const i=(s.objects??[]).map(l=>l.id===t?{...l,...a}:l);D({...s,objects:i})},Xe=(t,a)=>{if(!s)return;const r=s.tables.map(i=>i.id===t?{...i,...a}:i);D({...s,tables:r})},gt=async()=>{if(s)try{const t=await fetch(`/api/floor-layouts/${p}/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(s)});if(t.ok){let a=!1,r=null;try{const l=await fetch(`/api/floor-layouts/${p}/${s.id}/activate`,{method:"POST",credentials:"include"});if(a=l.ok,!l.ok){const c=await l.text().catch(()=>"");r=c||`${l.status} ${l.statusText}`,console.error("[FloorEditor] activate failed",{status:l.status,statusText:l.statusText,body:c})}}catch(l){r=l instanceof Error?l.message:String(l),console.error("[FloorEditor] activate threw",l)}N(C.map(l=>({...l,isActive:l.id===s.id})));const i=a?d("floor.success.save_and_activate","Layout saved and activated âœ…"):d("floor.success.save_but_activate_failed","Layout saved âœ… but activation failed: {error}").replace("{error}",r||"unknown");alert("âœ… "+i)}else{const a=await t.json();alert("âŒ "+d("floor.error.save","Error saving: {error}").replace("{error}",a.error||"Unknown error"))}}catch(t){console.error("Save failed:",t),alert("âŒ "+d("floor.error.save","Error saving: {error}").replace("{error}",t instanceof Error?t.message:String(t)))}};return s?e.jsxs("div",{className:"floor-editor",children:[e.jsxs("div",{className:"layout-tabs-bar",children:[e.jsx("div",{className:"layout-tabs",children:C.map(t=>e.jsxs("button",{className:`layout-tab ${s.id===t.id?"active":""} ${t.isActive?"is-active":""}`,onClick:()=>D(Ie(t)),title:t.isActive?d("floor.toolbar.active_hint","Active layout (shown in live view)"):"",children:[t.name,t.isActive&&e.jsx("span",{className:"active-badge",children:"â˜…"})]},t.id))}),e.jsxs("div",{className:"layout-actions",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>te(!0),title:d("floor.btn_new_layout","New Layout"),children:"âž•"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>nt(s.id),title:d("floor.btn_duplicate","Duplicate"),children:"ðŸ“‹"}),!s.isActive&&e.jsx("button",{className:"btn-icon-small",onClick:()=>ot(s.id),title:d("floor.btn_set_active","Set as Active"),children:"â­"}),C.length>1&&e.jsx("button",{className:"btn-icon-small btn-danger",onClick:()=>at(s.id),title:d("floor.btn_delete","Delete"),children:"ðŸ—‘ï¸"})]})]}),e.jsxs("div",{className:"editor-content",children:[e.jsxs("div",{className:"editor-sidebar",children:[J.length>0&&e.jsxs("div",{className:"sections-tabs",children:[e.jsx("h3",{children:d("floor.sections.title","Sections")}),e.jsx("div",{className:"tabs",children:J.map(t=>e.jsx("button",{className:`tab ${(R==null?void 0:R.id)===t.id?"active":""}`,onClick:()=>q(t),children:t.name},t.id))}),e.jsxs("label",{className:"fe-toggle",children:[e.jsx("input",{type:"checkbox",checked:Me,onChange:t=>Fe(t.target.checked)}),e.jsx("span",{children:d("floor.sections.show_only_active","Show only active section")})]})]}),e.jsxs("h2",{children:["ðŸ§© ",d("floor.assets.title","Assets")]}),e.jsx("h3",{className:"fe-subtitle",children:d("floor.assets.seating","Seating")}),e.jsxs("div",{className:"palette",children:[e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",5,2,{shape:"rect",seats:5,assetFile:"bar.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:`${Y}bar.svg`,alt:""})}),e.jsx("span",{children:"bar.svg â€¢ 5 (5Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",2,2,{shape:"booth",seats:4,assetFile:"booth4.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("booth",4),alt:""})}),e.jsx("span",{children:"booth4.svg â€¢ 4 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",6,2,{shape:"booth",seats:6,assetFile:"large_booth.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("booth",6),alt:""})}),e.jsx("span",{children:"large_booth.svg â€¢ 6 (6Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",1,1,{objectType:"chair",objectLabel:"chair",assetFile:"chair.svg",objectKind:"object"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:`${Y}chair.svg`,alt:""})}),e.jsx("span",{children:"chair.svg â€¢ 1 (1Ã—1)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",1,1,{objectType:"plant",objectLabel:"plant",assetFile:"plant.svg",objectKind:"object"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:`${Y}plant.svg`,alt:""})}),e.jsx("span",{children:"plant.svg â€¢ 1 (1Ã—1)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",2,2,{shape:"round",seats:4,assetFile:"round_table4.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("round",4),alt:""})}),e.jsx("span",{children:"round_table4.svg â€¢ 4 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",3,3,{shape:"round",seats:10,assetFile:"round_table_10.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("round",10),alt:""})}),e.jsx("span",{children:"round_table_10.svg â€¢ 10 (3Ã—3)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",2,1,{shape:"square",seats:2,assetFile:"square_table2.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("square",2),alt:""})}),e.jsx("span",{children:"square_table2.svg â€¢ 2 (2Ã—1)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",2,2,{shape:"square",seats:4,assetFile:"square_table4.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("square",4),alt:""})}),e.jsx("span",{children:"square_table4.svg â€¢ 4 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",2,2,{shape:"square",seats:6,assetFile:"square_table6.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("square",6),alt:""})}),e.jsx("span",{children:"square_table6.svg â€¢ 6 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",2,2,{shape:"square",seats:8,assetFile:"square_table8.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("square",8),alt:""})}),e.jsx("span",{children:"square_table8.svg â€¢ 8 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"table",2,2,{shape:"square",seats:10,assetFile:"square_table10.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ge("square",10),alt:""})}),e.jsx("span",{children:"square_table10.svg â€¢ 10 (2Ã—2)"})]})]}),e.jsx("h3",{className:"fe-subtitle",style:{marginTop:14},children:d("floor.assets.visual_only","Visual only")}),e.jsxs("div",{className:"palette",children:[e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",1,1,{objectType:"visual",objectLabel:"corner_partitaion",assetFile:"corner_partitaion.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:Ce("divider",1,1,"corner_partitaion"),alt:""})}),e.jsx("span",{children:"corner_partitaion.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",2,2,{objectType:"visual",objectLabel:"cyclic_partition",assetFile:"cyclic_partition.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:Ce("divider",2,2,"cyclic_partition"),alt:""})}),e.jsx("span",{children:"cyclic_partition.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",1,1,{objectType:"door",objectLabel:"door",assetFile:"door.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:Ce("door",1,1,"door"),alt:""})}),e.jsx("span",{children:"door.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",1,1,{objectType:"visual",objectLabel:"floor_brown",assetFile:"floor_brown.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:Ce("divider",1,1,"floor_brown"),alt:""})}),e.jsx("span",{children:"floor_brown.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",4,1,{objectType:"visual",objectLabel:"horizintal_partitaion",assetFile:"horizintal_partitaion.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:Ce("divider",4,1,"horizintal_partitaion"),alt:""})}),e.jsx("span",{children:"horizintal_partitaion.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>se(t,"object",1,4,{objectType:"visual",objectLabel:"vertical_partition",assetFile:"vertical_partition.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:Ce("divider",1,4,"vertical_partition"),alt:""})}),e.jsx("span",{children:"vertical_partition.svg"})]})]}),e.jsxs("div",{className:"properties-panel",children:[e.jsx("h3",{children:d("floor.map.title","Map")}),e.jsxs("label",{children:[d("floor.map.cell_size","Cell size: {size}px").replace("{size}",String(V)),e.jsx("input",{type:"range",min:"40",max:"110",value:V,onChange:t=>v(Number(t.target.value))})]}),e.jsxs("label",{children:[d("floor.map.floor_label","Floor:"),e.jsx("select",{value:I,onChange:t=>{const a=F(String(t.target.value||"parquet_blue"));ie(a),s&&D({...s,floorColor:a})},children:Object.keys(A).map(t=>e.jsx("option",{value:t,children:A[t].label},t))})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8},children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{n(t=>!t),$(null),K(null),$(null),K(null),$(null)},children:Q?`âœ… ${d("floor.shape.done","Done shape")}`:`âœï¸ ${d("floor.shape.edit","Edit shape")}`}),e.jsxs("button",{className:"btn-icon-small",onClick:()=>{if(!s)return;const t=s.gridRows*s.gridCols;D({...s,gridMask:Array.from({length:t},()=>1)})},title:d("floor.shape.reset_title","Reset shape"),children:["â†º ",d("floor.shape.reset","Reset")]}),e.jsxs("button",{className:"btn-icon-small",onClick:()=>{s!=null&&s.gridMask&&D({...s,gridMask:s.gridMask.map(t=>t===1?0:1)})},title:d("floor.shape.invert_title","Invert shape"),children:["â‡„ ",d("floor.shape.invert","Invert")]})]}),Q&&e.jsx("div",{className:"fe-hint",style:{marginTop:8},children:d("floor.shape.paint_hint","Paint the restaurant shape: click/drag cells to enable/disable.")})]}),z&&e.jsxs("div",{className:"properties-panel",children:[e.jsx("h3",{children:d("floor.properties.selected_table","Selected: {name}").replace("{name}",z.name)}),e.jsxs("label",{children:[d("floor.properties.name","Name:"),e.jsx("input",{type:"text",value:z.name,onChange:t=>Xe(z.id,{name:t.target.value})})]}),e.jsxs("label",{children:[d("floor.properties.seats","Seats:"),e.jsx("input",{type:"number",min:"1",max:"12",value:z.seats,onChange:t=>{const a=Math.max(1,Number(t.target.value)||1);Xe(z.id,{seats:a})}})]}),e.jsxs("label",{children:[d("floor.properties.size","Size:"),e.jsx("input",{type:"range",min:"0.6",max:"1.4",step:"0.05",className:"range-ltr",value:z.scale??1,onChange:t=>Xe(z.id,{scale:Number(t.target.value)})}),e.jsxs("span",{style:{marginInlineStart:8},children:[Math.round((z.scale??1)*100),"%"]})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{opacity:.85},children:d("floor.properties.rotate","Rotate:")}),e.jsx("button",{className:"btn-icon-small",onClick:()=>Xe(z.id,{rotationDeg:pe((z.rotationDeg??0)-45)}),title:"Rotate -45Â°",children:"â†º"}),e.jsxs("span",{style:{minWidth:54,textAlign:"center",opacity:.9},children:[pe(z.rotationDeg??0),"Â°"]}),e.jsx("button",{className:"btn-icon-small",onClick:()=>Xe(z.id,{rotationDeg:pe((z.rotationDeg??0)+45)}),title:"Rotate +45Â°",children:"â†»"})]}),e.jsxs("button",{className:"btn-danger",onClick:()=>ht(z.id),children:["ðŸ—‘ï¸ ",d("common.btn_delete","Delete")]})]}),P&&e.jsxs("div",{className:"properties-panel",children:[e.jsx("h3",{children:d("floor.properties.selected_object","Selected: {type}").replace("{type}",P.type)}),e.jsxs("label",{children:[d("floor.properties.name","Name:"),e.jsx("input",{type:"text",value:P.label??"",onChange:t=>$e(P.id,{label:t.target.value})})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8},children:[e.jsxs("label",{style:{flex:1},children:["W:",e.jsx("input",{type:"number",min:"1",max:"12",value:P.spanX,onChange:t=>$e(P.id,{spanX:Math.max(1,Number(t.target.value)||1)})})]}),e.jsxs("label",{style:{flex:1},children:["H:",e.jsx("input",{type:"number",min:"1",max:"12",value:P.spanY,onChange:t=>$e(P.id,{spanY:Math.max(1,Number(t.target.value)||1)})})]})]}),e.jsxs("label",{children:[d("floor.properties.size","Size:"),e.jsx("input",{type:"range",min:"0.6",max:"1.4",step:"0.05",className:"range-ltr",value:P.scale??1,onChange:t=>$e(P.id,{scale:Number(t.target.value)})}),e.jsxs("span",{style:{marginInlineStart:8},children:[Math.round((P.scale??1)*100),"%"]})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{opacity:.85},children:d("floor.properties.rotate","Rotate:")}),e.jsx("button",{className:"btn-icon-small",onClick:()=>$e(P.id,{rotationDeg:pe((P.rotationDeg??P.rotation??0)-45)}),title:"Rotate -45Â°",children:"â†º"}),e.jsxs("span",{style:{minWidth:54,textAlign:"center",opacity:.9},children:[pe(P.rotationDeg??P.rotation??0),"Â°"]}),e.jsx("button",{className:"btn-icon-small",onClick:()=>$e(P.id,{rotationDeg:pe((P.rotationDeg??P.rotation??0)+45)}),title:"Rotate +45Â°",children:"â†»"})]}),e.jsxs("button",{className:"btn-danger",onClick:()=>ft(P.id),children:["ðŸ—‘ï¸ ",d("common.btn_delete","Delete")]})]}),e.jsxs("button",{className:"btn-save",onClick:gt,children:["ðŸ’¾ ",d("floor.btn_save_layout","Save Layout")]})]}),e.jsxs("div",{className:`editor-canvas ${ue?"is-panning":""}`,ref:ee,onWheel:lt,onMouseDown:ct,children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t,a;return Be(Ae(_*1.1),(((t=ee.current)==null?void 0:t.getBoundingClientRect().left)||0)+40,(((a=ee.current)==null?void 0:a.getBoundingClientRect().top)||0)+40)},title:d("floor.toolbar.zoom_in","Zoom in"),children:"ï¼‹"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t,a;return Be(Ae(_*.9),(((t=ee.current)==null?void 0:t.getBoundingClientRect().left)||0)+40,(((a=ee.current)==null?void 0:a.getBoundingClientRect().top)||0)+40)},title:d("floor.toolbar.zoom_out","Zoom out"),children:"ï¼"}),e.jsx("button",{className:"btn-icon-small",onClick:ze,title:d("floor.toolbar.fit_screen","Fit to screen"),children:"â¤¢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(_*100),"%"]}),e.jsx("div",{className:"fe-hint",children:H?d("floor.hints.pan_drag","Pan: drag"):d("floor.hints.controls","Tip: hold Space to pan, Ctrl+wheel to zoom")})]}),(()=>{const t=A[I];return e.jsxs("div",{className:"fe-grid",ref:le,style:{direction:"ltr",gridTemplateColumns:`repeat(${s.gridCols}, ${V}px)`,gridTemplateRows:`repeat(${s.gridRows}, ${V}px)`,transform:`translate(${U.x}px, ${U.y}px) scale(${_})`,transformOrigin:"0 0","--cell":`${V}px`,"--floor-bg":t.bg,"--floor-bg-size":t.size,"--floor-bg-repeat":t.repeat,"--floor-bg-position":t.pos},onDragOver:Q?void 0:mt,onDrop:Q?void 0:pt,onDragLeave:()=>oe(null),children:[(()=>{if(!de||!g||!s)return null;const a=V,r=10,i=()=>{if(g.kind==="table"){if(g.mode==="new"){const m=String(g.shape||"square"),k=Number(g.seats??(m==="booth"?4:2)),L=g.spanX&&g.spanY?{spanX:g.spanX,spanY:g.spanY}:_e(m,k);return{spanX:L.spanX,spanY:L.spanY,subtype:m}}const j=s.tables.find(m=>m.id===g.tableId);if(j)return{spanX:j.spanX||1,spanY:j.spanY||1,subtype:j.shape}}if(g.kind==="object"){if(g.mode==="new"){const m={spanX:Math.max(1,Number(g.spanX??1)||1),spanY:Math.max(1,Number(g.spanY??1)||1)};return{spanX:m.spanX,spanY:m.spanY,subtype:g.objectType}}const j=(s.objects??[]).find(m=>m.id===g.objectId);if(j)return{spanX:j.spanX||1,spanY:j.spanY||1,subtype:j.type}}return{spanX:1,spanY:1,subtype:""}},{spanX:l,spanY:c,subtype:f}=i(),u=Ye(de.x,de.y,l,c,g.kind,String(f),!1,g.mode==="existing"?{kind:g.kind,id:g.kind==="table"?g.tableId:g.objectId}:void 0),y=r+u.x*a,b=r+u.y*a;return e.jsxs(e.Fragment,{children:[u.guides.v.map((j,m)=>e.jsx("div",{className:"fe-guide-line v",style:{left:r+j*a}},`pv-v-${m}`)),u.guides.h.map((j,m)=>e.jsx("div",{className:"fe-guide-line h",style:{top:r+j*a}},`pv-h-${m}`)),e.jsx("div",{className:"fe-drop-preview",style:{left:y,top:b,width:l*a,height:c*a}})]})})(),x&&xe&&(()=>{var f,u,y,b,j,m,k,L;const a=V,r=10,i=r+xe.x*a,l=r+xe.y*a;let c="";if(x.mode==="existing"){if(x.kind==="table"&&x.tableId){const M=s.tables.find(B=>B.id===x.tableId);M&&(c=M.assetFile?`${Y}${M.assetFile}`:ge(M.shape,M.seats))}if(x.kind==="object"&&x.objectId){const M=(s.objects??[]).find(B=>B.id===x.objectId);M&&(c=M.assetFile?`${Y}${M.assetFile}`:Ce(M.type,M.spanX,M.spanY,M.label))}}else if(x.kind==="table"){const M=String(((f=x.payload)==null?void 0:f.shape)??"square"),B=Number(((u=x.payload)==null?void 0:u.seats)??2);c=(y=x.payload)!=null&&y.assetFile?`${Y}${(b=x.payload)==null?void 0:b.assetFile}`:ge(M,B)}else{const M=((j=x.payload)==null?void 0:j.objectType)??"visual";c=(m=x.payload)!=null&&m.assetFile?`${Y}${(k=x.payload)==null?void 0:k.assetFile}`:Ce(M,x.spanX,x.spanY,(L=x.payload)==null?void 0:L.objectLabel)}return e.jsx("div",{className:"fe-drop-preview",style:{left:i,top:l,width:x.spanX*a,height:x.spanY*a,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none"},children:c&&e.jsx("img",{src:c,alt:"",style:{width:"100%",height:"100%",objectFit:"contain",display:"block",opacity:.75}})})})(),Array.from({length:s.gridRows*s.gridCols}).map((a,r)=>{var j;const i=Math.floor(r/s.gridCols),l=r%s.gridCols,c=s.tables.find(m=>Me&&R&&String(m.sectionId||"")!==String(R.id)?!1:l>=m.gridX&&l<m.gridX+m.spanX&&i>=m.gridY&&i<m.gridY+m.spanY),u=(s.objects??[]).find(m=>l>=m.gridX&&l<m.gridX+m.spanX&&i>=m.gridY&&i<m.gridY+m.spanY),y=c&&c.gridX===l&&c.gridY===i,b=u&&u.gridX===l&&u.gridY===i;return e.jsxs("div",{className:`fe-grid-cell ${(()=>{var L;const m=i*s.gridCols+l;return(((L=s.gridMask)==null?void 0:L[m])??1)===1?"active":"inactive"})()}`,onMouseDown:m=>{if(!Q||!s)return;m.preventDefault(),S(!0);const k=i*s.gridCols+l,L=s.gridRows*s.gridCols,M=(s.gridMask??Array.from({length:L},()=>1)).slice(),B=M[k]===1?0:1;ve.current=B,M[k]=B,D({...s,gridMask:M})},onMouseEnter:m=>{if(!Q||!o||!s)return;m.preventDefault();const k=ve.current;if(k==null)return;const L=i*s.gridCols+l,M=s.gridRows*s.gridCols,B=(s.gridMask??Array.from({length:M},()=>1)).slice();B[L]!==k&&(B[L]=k,D({...s,gridMask:B}))},children:[b&&u&&e.jsxs("div",{className:`floor-object type-${u.type} ${(P==null?void 0:P.id)===u.id?"selected":""}`,onMouseDown:m=>Ue(m,"object",u.id,u.spanX||1,u.spanY||1),onClick:()=>{$(null),K(null),$(null),K(u.id),$(null)},style:{width:`${we(u.spanX)}px`,height:`${we(u.spanY)}px`,transform:`rotate(${pe(u.rotationDeg??u.rotation??0)}deg)`},children:[e.jsx("img",{className:`fe-asset fe-asset--${(u.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${Te(u.scale,st(u.type))})`},src:u.assetFile?`${Y}${u.assetFile}`:Ce(u.type,u.spanX,u.spanY,u.label),alt:""}),u.label&&e.jsx("div",{className:"obj-label",children:u.label})]}),y&&e.jsxs("div",{className:`table ${c.shape} ${(z==null?void 0:z.id)===c.id?"selected":""} ${!Me&&R&&String(c.sectionId||"")&&String(c.sectionId||"")!==String(R.id)?"dimmed":""}`,onMouseDown:m=>Ue(m,"table",c.id,c.spanX||1,c.spanY||1),onClick:()=>{K(null),$(null),$(c.id),K(null),$(null)},style:{width:`${we(c.spanX)}px`,height:`${we(c.spanY)}px`},children:[e.jsx("div",{className:"fe-table-visual","data-asset":c.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(c.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${pe(c.rotationDeg??0)}deg) scale(${Te(c.scale,De(c.shape,c.seats,c.assetFile))})`},src:c.assetFile?`${Y}${c.assetFile}`:ge(c.shape,c.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:c.name}),e.jsxs("div",{className:"table-seats",children:[c.seats," ",d("floor.properties.seats_unit","seats")]}),c.sectionId&&J.length>0&&e.jsx("div",{className:"table-section",children:((j=J.find(m=>String(m.id)===String(c.sectionId)))==null?void 0:j.name)||d("floor.properties.section","Section")})]})]})]},r)})]})})()]})]}),be&&e.jsx("div",{className:"modal-overlay",onClick:()=>te(!1),children:e.jsxs("div",{className:"modal-content",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:d("floor.modal.create_title","Create New Layout")}),e.jsx("input",{type:"text",placeholder:d("floor.modal.placeholder_name","Layout name (e.g., Main Floor, Patio)"),value:ke,onChange:t=>Se(t.target.value),onKeyDown:t=>t.key==="Enter"&&Re(),autoFocus:!0}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{onClick:Re,className:"btn-primary",children:d("floor.btn_create","Create")}),e.jsx("button",{onClick:()=>te(!1),className:"btn-secondary",children:d("common.btn_cancel","Cancel")})]})]})})]}):e.jsxs("div",{className:"floor-editor-empty",children:[e.jsx("h2",{children:d("floor.empty_state","No floor layouts found. Please create a floor layout first.")}),e.jsx("p",{children:d("floor.empty_hint","Create your first floor layout to get started.")}),e.jsxs("button",{className:"btn-primary",onClick:()=>te(!0),children:["âž• ",d("floor.btn_create_new","Create New Layout")]}),be&&e.jsx("div",{className:"modal-overlay",onClick:()=>te(!1),children:e.jsxs("div",{className:"modal-content",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:d("floor.modal.create_title","Create New Layout")}),e.jsx("input",{type:"text",placeholder:d("floor.modal.placeholder_name","Layout name (e.g., Main Floor, Patio)"),value:ke,onChange:t=>Se(t.target.value),onKeyDown:t=>t.key==="Enter"&&Re(),autoFocus:!0}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{onClick:Re,className:"btn-primary",children:d("common.btn_add","Create")}),e.jsx("button",{onClick:()=>te(!1),className:"btn-secondary",children:d("common.btn_cancel","Cancel")})]})]})})]})}const tt=h.createContext(null);function St(){const p=h.useContext(tt);if(!p)throw new Error("useToast must be used within <ToastProvider>");return p}let Ct=0;function kt({children:p}){const[C,N]=h.useState([]),[s,D]=h.useState(null),J=h.useCallback((T,$="info")=>{const G=++Ct;N(K=>[...K,{id:G,message:T,type:$}]),setTimeout(()=>N(K=>K.filter(z=>z.id!==G)),4e3)},[]),W=h.useCallback(T=>new Promise($=>{D({message:T,resolve:$})}),[]),R=T=>{s==null||s.resolve(T),D(null)};h.useEffect(()=>{if(!s)return;const T=$=>{$.key==="Escape"&&R(!1)};return document.addEventListener("keydown",T),()=>document.removeEventListener("keydown",T)},[s]);const q={success:"#00b894",error:"#d63031",warning:"#fdcb6e",info:"#6c5ce7"};return e.jsxs(tt.Provider,{value:{toast:J,confirmDialog:W},children:[p,e.jsx("div",{style:{position:"fixed",top:"1rem",left:"50%",transform:"translateX(-50%)",zIndex:99999,display:"flex",flexDirection:"column",gap:"0.5rem",pointerEvents:"none"},children:C.map(T=>e.jsx("div",{role:"alert","aria-live":"assertive",style:{padding:"0.75rem 1.5rem",background:"#1a1d2e",color:"#e6e8ef",borderRadius:"8px",borderLeft:`4px solid ${q[T.type]}`,boxShadow:"0 4px 12px rgba(0,0,0,0.4)",fontSize:"0.9rem",pointerEvents:"auto",animation:"toast-in 0.3s ease"},children:T.message},T.id))}),s&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":"Confirmation",style:{position:"fixed",inset:0,zIndex:99998,background:"rgba(0,0,0,0.6)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{background:"#1a1d2e",color:"#e6e8ef",padding:"1.5rem 2rem",borderRadius:"12px",maxWidth:"400px",width:"90%",boxShadow:"0 8px 32px rgba(0,0,0,0.5)"},children:[e.jsx("p",{style:{marginBottom:"1.5rem",lineHeight:1.5},children:s.message}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem",justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>R(!1),style:{padding:"0.5rem 1.25rem",background:"#2d3148",color:"#e6e8ef",border:"none",borderRadius:"8px",cursor:"pointer"},children:"Cancel"}),e.jsx("button",{onClick:()=>R(!0),autoFocus:!0,style:{padding:"0.5rem 1.25rem",background:"#d63031",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer"},children:"Confirm"})]})]})}),e.jsx("style",{children:`
        @keyframes toast-in {
          from { opacity: 0; transform: translateY(-10px); }
          to   { opacity: 1; transform: translateY(0); }
        }
      `})]})}const Le={waiter:"#FF6B6B",chef:"#4ECDC4",manager:"#FFE66D",busser:"#95E1D3",host:"#C7B3E5",bartender:"#F38181"},Mt={scheduled:"#E8F5E9",checked_in:"#C8E6C9",checked_out:"#BDBDBD",called_out:"#FFE0B2",cancelled:"#FFCDD2"},_t=p=>{const C=new Date(p),N=C.getDay(),s=C.getDate()-N+(N===0?-6:1);return new Date(C.setDate(s))},We=p=>{const C=_t(p),N=[];for(let s=0;s<7;s++){const D=new Date(C);D.setDate(D.getDate()+s),N.push(D)}return N},je=p=>p.toISOString().split("T")[0],Je=p=>p.toLocaleDateString("en-US",{month:"short",day:"numeric"}),Ge=p=>p.toLocaleDateString("en-US",{month:"long",year:"numeric"});function Dt({restaurantId:p}){const{toast:C}=St(),[N,s]=h.useState([]),[D,J]=h.useState([]),[W,R]=h.useState(new Date().toISOString().split("T")[0]),[q,T]=h.useState("day"),[$,G]=h.useState(!1),[K,z]=h.useState(!1),[P,g]=h.useState(!1),[ae,Z]=h.useState({firstName:"",lastName:"",email:"",role:"waiter",userId:""}),[ne,be]=h.useState({staffId:"",startTime:"09:00",endTime:"17:00"});h.useEffect(()=>{te()},[W,q,p]);const te=async()=>{G(!0);try{const v=await fetch(`/api/restaurants/${p}/staff`);v.ok&&s(await v.json());let X=W,A=W;if(q==="week"){const I=We(new Date(W));X=je(I[0]),A=je(I[6])}else if(q==="month"){const I=new Date(W);X=je(new Date(I.getFullYear(),I.getMonth(),1)),A=je(new Date(I.getFullYear(),I.getMonth()+1,0))}const F=await fetch(`/api/restaurants/${p}/shifts?startDate=${X}&endDate=${A}`);F.ok&&J(await F.json())}catch(v){console.error("Failed to load data:",v)}finally{G(!1)}},ke=async()=>{if(!ae.firstName||!ae.lastName||!ae.email){C("Please fill in required fields","warning");return}try{(await fetch(`/api/restaurants/${p}/staff`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)})).ok&&(Z({firstName:"",lastName:"",email:"",role:"waiter",userId:""}),z(!1),te())}catch(v){console.error("Failed to add staff:",v)}},Se=async()=>{if(!ne.staffId){C("Please select a staff member","warning");return}try{(await fetch(`/api/restaurants/${p}/shifts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({staffId:ne.staffId,date:W,startTime:ne.startTime,endTime:ne.endTime})})).ok&&(be({staffId:"",startTime:"09:00",endTime:"17:00"}),g(!1),te())}catch(v){console.error("Failed to add shift:",v)}},Me=async v=>{try{await fetch(`/api/restaurants/${p}/shifts/${v}/check-in`,{method:"POST"}),te()}catch(X){console.error("Failed to check in:",X)}},Fe=async v=>{try{await fetch(`/api/restaurants/${p}/shifts/${v}/check-out`,{method:"POST"}),te()}catch(X){console.error("Failed to check out:",X)}},de=async v=>{try{await fetch(`/api/restaurants/${p}/shifts/${v}`,{method:"DELETE"}),te()}catch(X){console.error("Failed to cancel shift:",X)}},oe=v=>{const X=new Date(W);q==="week"?X.setDate(X.getDate()+v*7):q==="month"?X.setMonth(X.getMonth()+v):X.setDate(X.getDate()+v),R(je(X))},x=()=>{const v=new Date(W),X=D.filter(n=>n.date===W),A=new Map;X.forEach(n=>{A.has(n.staffId)||A.set(n.staffId,[]),A.get(n.staffId).push(n)});const F=n=>{const[o,S]=n.split(":").map(Number);return o*60+S},I=9*60,Q=23*60-I;return e.jsxs("div",{className:"shift-board day-view",children:[e.jsx("div",{className:"day-view-header",children:e.jsx("h2",{children:v.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"})})}),e.jsxs("div",{className:"day-timeline",children:[e.jsx("div",{className:"time-slots",children:Array.from({length:15},(n,o)=>e.jsxs("div",{className:"time-slot",children:[9+o,":00"]},o))}),e.jsx("div",{className:"staff-rows",children:N.map(n=>e.jsxs("div",{className:"staff-row",children:[e.jsxs("div",{className:"staff-name",style:{borderLeftColor:Le[n.role]||"#999"},children:[e.jsxs("span",{children:[n.firstName," ",n.lastName]}),e.jsx("small",{children:n.role})]}),e.jsx("div",{className:"timeline-row",children:(A.get(n.id)||[]).map(o=>{const S=F(o.startTime),_=F(o.endTime),E=(S-I)/Q*100,U=(_-S)/Q*100;return e.jsxs("div",{className:"shift-bar",style:{left:`${E}%`,width:`${U}%`,backgroundColor:Le[o.staffRole]||"#999",opacity:Mt[o.status]?1:.6},title:`${o.startTime}-${o.endTime} (${o.status})`,children:[e.jsxs("span",{className:"shift-time",children:[o.startTime,"-",o.endTime]}),e.jsxs("div",{className:"shift-actions",children:[o.status==="scheduled"&&e.jsx("button",{onClick:()=>Me(o.id),className:"btn-checkin",children:"Check In"}),o.status==="checked_in"&&e.jsx("button",{onClick:()=>Fe(o.id),className:"btn-checkout",children:"Check Out"}),e.jsx("button",{onClick:()=>de(o.id),className:"btn-cancel",children:"Cancel"})]})]},o.id)})})]},n.id))})]})]})},he=()=>{const v=We(new Date(W)),X=D.filter(F=>{const I=new Date(F.date);return I>=v[0]&&I<=v[6]}),A=new Map;return N.forEach(F=>{A.set(F.id,new Map),v.forEach(I=>{const ie=je(I);A.get(F.id).set(ie,[])})}),X.forEach(F=>{const I=A.get(F.staffId);if(I){const ie=I.get(F.date)||[];ie.push(F),I.set(F.date,ie)}}),e.jsxs("div",{className:"shift-board week-view",children:[e.jsx("div",{className:"week-header",children:e.jsxs("h2",{children:[je(v[0])," to ",je(v[6])]})}),e.jsxs("div",{className:"week-table",children:[e.jsxs("div",{className:"week-row header-row",children:[e.jsx("div",{className:"staff-cell",children:"Staff"}),v.map(F=>e.jsxs("div",{className:"day-cell",children:[e.jsx("div",{children:F.toLocaleDateString("en-US",{weekday:"short"})}),e.jsx("div",{className:"date-num",children:Je(F)})]},je(F)))]}),N.map(F=>e.jsxs("div",{className:"week-row",children:[e.jsx("div",{className:"staff-cell",children:e.jsxs("div",{className:"staff-info",style:{borderLeftColor:Le[F.role]||"#999"},children:[e.jsxs("span",{className:"staff-name",children:[F.firstName," ",F.lastName]}),e.jsx("span",{className:"staff-role",children:F.role})]})}),v.map(I=>{var n;const ie=je(I),Q=((n=A.get(F.id))==null?void 0:n.get(ie))||[];return e.jsx("div",{className:"day-cell",children:Q.map(o=>e.jsx("div",{className:"week-shift",style:{backgroundColor:Le[o.staffRole]||"#999"},title:`${o.startTime}-${o.endTime}`,children:e.jsxs("small",{children:[o.startTime,"-",o.endTime]})},o.id))},ie)})]},F.id))]})]})},xe=()=>{const v=new Date(W),X=v.getFullYear(),A=v.getMonth(),F=new Date(X,A,1),I=new Date(X,A+1,0),ie=new Date(X,A,0).getDate(),Q=[];for(let o=F.getDay()-1;o>=0;o--)Q.push(new Date(X,A-1,ie-o));for(let o=1;o<=I.getDate();o++)Q.push(new Date(X,A,o));const n=42-Q.length;for(let o=1;o<=n;o++)Q.push(new Date(X,A+1,o));return e.jsxs("div",{className:"shift-board month-view",children:[e.jsx("div",{className:"month-header",children:e.jsx("h2",{children:Ge(v)})}),e.jsxs("div",{className:"month-calendar",children:[["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(o=>e.jsx("div",{className:"day-header",children:o},o)),Q.map((o,S)=>{const _=o?je(o):"",E=o?D.filter(O=>O.date===_):[],U=o&&o.getMonth()===A;return e.jsxs("div",{className:`month-day ${U?"current":"other"}`,children:[e.jsx("div",{className:"day-number",children:o==null?void 0:o.getDate()}),e.jsx("div",{className:"shift-count",children:E.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"count-badge",children:[E.length," shifts"]}),e.jsx("div",{className:"shift-dots",children:N.map(O=>E.some(ye=>ye.staffId===O.id)?e.jsx("span",{className:"dot",style:{backgroundColor:Le[O.role]||"#999"},title:O.firstName},O.id):null)})]})})]},S)})]})]})},re=new Date(W),V=q==="week"?`Week of ${Je(We(re)[0])}`:q==="month"?Ge(re):re.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});return e.jsxs("div",{className:"shift-board-container",children:[e.jsxs("div",{className:"board-header",children:[e.jsxs("div",{className:"view-controls",children:[e.jsx("button",{className:`view-btn ${q==="day"?"active":""}`,onClick:()=>T("day"),children:"Day"}),e.jsx("button",{className:`view-btn ${q==="week"?"active":""}`,onClick:()=>T("week"),children:"Week"}),e.jsx("button",{className:`view-btn ${q==="month"?"active":""}`,onClick:()=>T("month"),children:"Month"})]}),e.jsxs("div",{className:"date-controls",children:[e.jsx("button",{onClick:()=>oe(-1),children:"â† Prev"}),e.jsx("div",{className:"current-date",children:V}),e.jsx("button",{onClick:()=>oe(1),children:"Next â†’"}),e.jsx("input",{type:"date",value:W,onChange:v=>R(v.target.value)})]}),e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-primary",onClick:()=>z(!K),children:"+ Add Staff"}),e.jsx("button",{className:"btn-primary",onClick:()=>g(!P),children:"+ Add Shift"})]})]}),K&&e.jsxs("div",{className:"form-panel",children:[e.jsx("h3",{children:"Add Staff Member"}),e.jsx("input",{type:"text",placeholder:"First Name",value:ae.firstName,onChange:v=>Z({...ae,firstName:v.target.value})}),e.jsx("input",{type:"text",placeholder:"Last Name",value:ae.lastName,onChange:v=>Z({...ae,lastName:v.target.value})}),e.jsx("input",{type:"email",placeholder:"Email",value:ae.email,onChange:v=>Z({...ae,email:v.target.value})}),e.jsxs("select",{value:ae.role,onChange:v=>Z({...ae,role:v.target.value}),children:[e.jsx("option",{value:"waiter",children:"Waiter"}),e.jsx("option",{value:"chef",children:"Chef"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"busser",children:"Busser"}),e.jsx("option",{value:"host",children:"Host"}),e.jsx("option",{value:"bartender",children:"Bartender"})]}),e.jsx("button",{onClick:ke,className:"btn-primary",children:"Save Staff"}),e.jsx("button",{onClick:()=>z(!1),className:"btn-secondary",children:"Cancel"})]}),P&&e.jsxs("div",{className:"form-panel",children:[e.jsx("h3",{children:"Create Shift"}),e.jsxs("select",{value:ne.staffId,onChange:v=>be({...ne,staffId:v.target.value}),children:[e.jsx("option",{value:"",children:"Select Staff Member"}),N.map(v=>e.jsxs("option",{value:v.id,children:[v.firstName," ",v.lastName]},v.id))]}),e.jsx("input",{type:"time",value:ne.startTime,onChange:v=>be({...ne,startTime:v.target.value})}),e.jsx("input",{type:"time",value:ne.endTime,onChange:v=>be({...ne,endTime:v.target.value})}),e.jsx("button",{onClick:Se,className:"btn-primary",children:"Create Shift"}),e.jsx("button",{onClick:()=>g(!1),className:"btn-secondary",children:"Cancel"})]}),$?e.jsx("p",{children:"Loading..."}):e.jsxs(e.Fragment,{children:[q==="day"&&e.jsx(x,{}),q==="week"&&e.jsx(he,{}),q==="month"&&e.jsx(xe,{})]})]})}const Tt={empty:"Empty",occupied:"Occupied",reserved:"Reserved",dirty:"Dirty"};function $t({table:p,restaurantId:C,isOpen:N,onClose:s,onStatusChange:D}){const[J,W]=h.useState(!1);if(!N)return null;const R=async q=>{W(!0);try{const T=await fetch(`/api/tables/${C}/${p.tableId}/status`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:q})});if(T.ok)D(p.tableId,q),s();else{const $=await T.text();console.error("Status update failed:",T.status,T.statusText,$);let G=`Status ${T.status}`;try{G=JSON.parse($).error||G}catch{G=T.statusText||G}alert(`âŒ Failed to update table status: ${G}`)}}catch(T){console.error("Failed to update table status:",T),alert(`âŒ Error updating table status: ${T instanceof Error?T.message:String(T)}`)}finally{W(!1)}};return e.jsx("div",{className:"modal-overlay",onClick:s,children:e.jsxs("div",{className:"modal-content",onClick:q=>q.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Table ",p.tableNumber]}),e.jsx("button",{className:"modal-close",onClick:s,children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"table-info-section",children:[e.jsx("h3",{children:"Current Status"}),e.jsx("div",{className:"status-badge",style:{color:Ft(p.status)},children:Tt[p.status]})]}),p.status==="occupied"&&e.jsxs("div",{className:"order-info-section",children:[e.jsx("h3",{children:"Order Details"}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Guests:"}),e.jsx("span",{className:"value",children:p.guestCount||"â€”"})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Items Pending:"}),e.jsx("span",{className:"value",children:p.itemsPending||0})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Items Ready:"}),e.jsx("span",{className:"value",children:p.itemsReady||0})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Total:"}),e.jsxs("span",{className:"value",children:["â‚ª",(p.orderTotal||0).toFixed(0)]})]})]}),e.jsxs("div",{className:"actions-section",children:[e.jsx("h3",{children:"Actions"}),e.jsxs("div",{className:"actions",children:[p.status!=="dirty"&&e.jsx("button",{className:"action-btn btn-mark-dirty",onClick:()=>R("dirty"),disabled:J,children:"ðŸ§¹ Mark Dirty"}),p.status!=="reserved"&&e.jsx("button",{className:"action-btn btn-reserve",onClick:()=>R("reserved"),disabled:J,children:"ðŸ“… Reserve"}),p.status!=="empty"&&e.jsx("button",{className:"action-btn btn-empty",onClick:()=>R("empty"),disabled:J,children:"âœ” Clear Table"}),p.status==="occupied"&&e.jsx("button",{className:"action-btn btn-view-order",onClick:()=>{window.location.href=`/waiter/${C}/${p.tableNumber}`},disabled:J,children:"ðŸ“‹ View Order"})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn-close",onClick:s,children:"Close"})})]})})}function Ft(p){switch(p){case"empty":return"#4CAF50";case"occupied":return"#FF6B6B";case"reserved":return"#FFC107";case"dirty":return"#9C27B0";default:return"#333"}}const Pe={empty:"#4CAF50",occupied:"#FF6B6B",reserved:"#FFC107",dirty:"#9C27B0"},Yt={empty:d("floor.status.empty","Empty"),occupied:d("floor.status.occupied","Occupied"),reserved:d("floor.status.reserved","Reserved"),dirty:d("floor.status.dirty","Dirty")},Ze="/floor_assets/",Qe=(p,C=1)=>{const N=Number(p);return Number.isFinite(N)?Math.max(.5,Math.min(1.6,N)):C},et=p=>{const C=Number(p);return Number.isFinite(C)?Math.round(C/45)*45:0};function Xt({restaurantId:p}){const[C,N]=h.useState([]),[s,D]=h.useState(null),[J,W]=h.useState(new Map),[R,q]=h.useState(!0),[T,$]=h.useState(!0),[G,K]=h.useState(5e3),[z,P]=h.useState(null),[g,ae]=h.useState(!1),[Z,ne]=h.useState(1),[be,te]=h.useState({x:0,y:0}),[ke,Se]=h.useState(!1),[Me,Fe]=h.useState(!1),de=h.useRef(null),oe=72;h.useEffect(()=>{const n=S=>{S.code==="Space"&&Fe(!0)},o=S=>{S.code==="Space"&&(Fe(!1),Se(!1))};return window.addEventListener("keydown",n),window.addEventListener("keyup",o),()=>{window.removeEventListener("keydown",n),window.removeEventListener("keyup",o)}},[]),h.useEffect(()=>{(async()=>{try{const o=await fetch(`/api/floor-layouts/${p}`);if(o.ok){const S=await o.json();N(S);const _=S.find(E=>E.isActive)||S[0];_&&await x(_.id)}}catch(o){console.error("Failed to load layouts:",o)}finally{q(!1)}})()},[p]);const x=async n=>{try{const o=await fetch(`/api/floor-layouts/${p}/${n}`);if(o.ok){const S=await o.json();if(D(S),S.tableStatuses){const _=new Map;S.tableStatuses.forEach(E=>_.set(E.tableId,E)),W(_)}requestAnimationFrame(()=>re(S))}}catch(o){console.error("Failed to load layout:",o)}};h.useEffect(()=>{if(!T||!s)return;const n=setInterval(async()=>{try{const o=await fetch(`/api/floor-layouts/${p}/${s.id}`);if(o.ok){const S=await o.json();if(S.tableStatuses){const _=new Map;S.tableStatuses.forEach(E=>_.set(E.tableId,E)),W(_)}}}catch(o){console.error("Failed to refresh table statuses:",o)}},G);return()=>clearInterval(n)},[p,T,G,s]);const he=n=>Math.max(.4,Math.min(2.5,n)),xe=n=>{const o=Number(n.gridCols||0),S=Number(n.gridRows||0);let _=0,E=0,U=Math.max(0,o-1),O=Math.max(0,S-1);const ue=n.gridMask;if(Array.isArray(ue)&&o>0&&S>0){const H=o*S,fe=ue.slice(0,H);for(;fe.length<H;)fe.push(1);let ee=!0;for(let le=0;le<H;le++)if((fe[le]??1)!==1){ee=!1;break}if(!ee){let le=!1,ve=1/0,Y=1/0,we=-1/0,_e=-1/0;for(let De=0;De<H;De++){if((fe[De]??1)!==1)continue;const Te=De%o,pe=Math.floor(De/o);le=!0,Te<ve&&(ve=Te),pe<Y&&(Y=pe),Te>we&&(we=Te),pe>_e&&(_e=pe)}le&&(_=ve,E=Y,U=we,O=_e)}}const ye=(H,fe,ee,le)=>{const ve=Math.max(1,Number(ee)||1),Y=Math.max(1,Number(le)||1);_=Math.min(_,H),E=Math.min(E,fe),U=Math.max(U,H+ve-1),O=Math.max(O,fe+Y-1)};for(const H of n.tables||[])ye(Number(H.gridX)||0,Number(H.gridY)||0,H.spanX??1,H.spanY??1);for(const H of n.objects||[])ye(Number(H.gridX)||0,Number(H.gridY)||0,H.spanX??1,H.spanY??1);return _=Math.max(0,Math.min(o-1,_)),E=Math.max(0,Math.min(S-1,E)),U=Math.max(0,Math.min(o-1,U)),O=Math.max(0,Math.min(S-1,O)),{minX:_,minY:E,maxX:U,maxY:O}},re=n=>{const o=n??s,S=de.current;if(!S||!o)return;S.scrollLeft=0,S.scrollTop=0;const _=xe(o),E=(_.maxX-_.minX+1)*oe,U=(_.maxY-_.minY+1)*oe,O=window.getComputedStyle(S),ue=parseFloat(O.paddingLeft||"0")||0,ye=parseFloat(O.paddingRight||"0")||0,H=parseFloat(O.paddingTop||"0")||0,fe=parseFloat(O.paddingBottom||"0")||0,ee=12,le=Math.max(1,S.clientWidth-ue-ye-ee*2),ve=Math.max(1,S.clientHeight-H-fe-ee*2),Y=he(Math.min(le/E,ve/U,1.2));ne(Y);const we=Math.round(ue+ee+(le-E*Y)/2-_.minX*oe*Y),_e=Math.round(H+ee+(ve-U*Y)/2-_.minY*oe*Y);te({x:we,y:_e})},V=(n,o,S)=>{if(!de.current)return;const _=de.current.getBoundingClientRect(),E=o-_.left,U=S-_.top;te(O=>{const ue=n/Z;return{x:Math.round(E-(E-O.x)*ue),y:Math.round(U-(U-O.y)*ue)}}),ne(n)},v=n=>{if(!(n.ctrlKey||n.metaKey))return;n.preventDefault();const o=he(Z*(n.deltaY>0?.9:1.1));V(o,n.clientX,n.clientY)},X=n=>{const o=n.button===1,S=Me&&n.button===0;if(!o&&!S)return;n.preventDefault(),Se(!0);const _={x:n.clientX,y:n.clientY},E={...be},U=ue=>{te({x:E.x+(ue.clientX-_.x),y:E.y+(ue.clientY-_.y)})},O=()=>{Se(!1),window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",O)};window.addEventListener("mousemove",U),window.addEventListener("mouseup",O)},A=n=>J.get(n)||{tableId:n,tableNumber:0,status:"empty"},F=n=>{P(n),ae(!0)},I=(n,o)=>{const S={...A(n),status:o};W(_=>new Map(_).set(n,S))},ie=n=>{if(!n)return"";const o=Math.floor((Date.now()-n)/1e3/60);return o<1?"Just now":o<60?`${o}m`:`${Math.floor(o/60)}h ${o%60}m`},Q=n=>n==null?"":`â‚ª${n.toFixed(0)}`;return R?e.jsx("div",{className:"live-view-loading",children:d("floor.loading","Loading floor layouts...")}):s?e.jsxs("div",{className:"restaurant-live-view",children:[e.jsxs("div",{className:"live-view-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("h1",{children:"ðŸ”´ Live Floor View"}),C.length>1&&e.jsx("div",{className:"layout-selector",children:e.jsx("select",{value:s.id,onChange:n=>x(n.target.value),children:C.map(n=>e.jsxs("option",{value:n.id,children:[n.name," ",n.isActive?"(Active)":""]},n.id))})})]}),e.jsxs("div",{className:"control-panel",children:[e.jsxs("label",{className:"auto-refresh-label",children:[e.jsx("input",{type:"checkbox",checked:T,onChange:n=>$(n.target.checked)}),d("live.auto_refresh","Auto-refresh")]}),e.jsxs("select",{value:G,onChange:n=>K(Number(n.target.value)),disabled:!T,className:"refresh-interval-select",children:[e.jsx("option",{value:3e3,children:"3s"}),e.jsx("option",{value:5e3,children:"5s"}),e.jsx("option",{value:1e4,children:"10s"}),e.jsx("option",{value:15e3,children:"15s"})]}),e.jsxs("button",{className:"refresh-btn",onClick:()=>s&&x(s.id),children:["ðŸ”„ ",d("common.btn_refresh","Refresh")]})]})]}),e.jsxs("div",{className:`live-view-container ${ke?"is-panning":""}`,ref:de,onWheel:v,onMouseDown:X,children:[e.jsxs("div",{className:"fe-canvas-controls live",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n,o;return V(he(Z*1.1),(((n=de.current)==null?void 0:n.getBoundingClientRect().left)||0)+40,(((o=de.current)==null?void 0:o.getBoundingClientRect().top)||0)+40)},title:"Zoom in",children:"ï¼‹"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n,o;return V(he(Z*.9),(((n=de.current)==null?void 0:n.getBoundingClientRect().left)||0)+40,(((o=de.current)==null?void 0:o.getBoundingClientRect().top)||0)+40)},title:"Zoom out",children:"ï¼"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>re(),title:"Fit to screen",children:"â¤¢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(Z*100),"%"]}),e.jsx("div",{className:"fe-hint",children:Me?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsxs("div",{className:"floor-grid",style:{gridTemplateColumns:`repeat(${s.gridCols}, ${oe}px)`,gridTemplateRows:`repeat(${s.gridRows}, ${oe}px)`,transform:`translate(${be.x}px, ${be.y}px) scale(${Z})`,transformOrigin:"0 0"},"data-floor-theme":String(s.floorColor||""),children:[(s.objects??[]).map(n=>e.jsxs("div",{className:`floor-object-live type-${n.type}`,style:{gridColumn:`${n.gridX+1} / span ${n.spanX}`,gridRow:`${n.gridY+1} / span ${n.spanY}`,transform:`rotate(${et(n.rotationDeg??n.rotation??0)}deg)`},title:n.label||n.type,children:[n.assetFile?e.jsx("img",{className:"live-asset",src:`${Ze}${n.assetFile}`,alt:"",style:{transform:`scale(${Qe(n.scale,1)})`,width:"100%",height:"100%",objectFit:"contain",display:"block"}}):e.jsx("span",{className:"obj-icon",children:n.type==="wall"?"ðŸ§±":n.type==="door"?"ðŸšª":n.type==="bar"?"ðŸ¸":n.type==="plant"?"ðŸª´":"âž–"}),n.label?e.jsx("span",{className:"obj-label",children:n.label}):null]},n.id)),s.tables.map(n=>{const o=A(n.id),S=ie(o.occupiedSince);return e.jsxs("div",{className:`table-card table-${n.shape} status-${o.status}`,style:{gridColumn:`${n.gridX+1} / span ${n.spanX}`,gridRow:`${n.gridY+1} / span ${n.spanY}`,borderColor:Pe[o.status]},onClick:()=>F(o),children:[e.jsx("div",{className:"table-number",children:n.tableNumber||o.tableNumber}),n.assetFile?e.jsx("img",{className:"live-asset",src:`${Ze}${n.assetFile}`,alt:"",style:{width:"100%",height:"100%",objectFit:"contain",display:"block",transform:`rotate(${et(n.rotationDeg??0)}deg) scale(${Qe(n.scale,1)})`}}):null,o.status==="occupied"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"table-info",children:[e.jsxs("span",{className:"guests",children:["ðŸ‘¥ ",o.guestCount||"-"]}),e.jsx("span",{className:"seated",children:S})]}),e.jsxs("div",{className:"order-summary",children:[o.itemsPending?e.jsxs("span",{className:"pending",children:["â³ ",o.itemsPending]}):null,o.itemsReady?e.jsxs("span",{className:"ready",children:["âœ… ",o.itemsReady]}):null,o.orderTotal?e.jsx("span",{className:"total",children:Q(o.orderTotal)}):null]})]}),o.status==="reserved"&&e.jsx("div",{className:"table-info",children:e.jsx("span",{children:d("floor.status.reserved","Reserved")})}),o.status==="dirty"&&e.jsx("div",{className:"table-info",children:e.jsxs("span",{children:["ðŸ§¹ ",d("floor.status_text.dirty","Needs cleaning")]})}),o.status==="empty"&&e.jsx("div",{className:"table-info",children:e.jsx("span",{children:d("floor.status_text.available","Available")})})]},n.id)})]})]}),e.jsxs("div",{className:"live-view-footer",children:[e.jsxs("div",{className:"status-legend",children:[e.jsx("h3",{children:d("live.status_legend","Status Legend")}),e.jsx("div",{className:"legend-items",children:Object.entries(Pe).map(([n,o])=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-color",style:{backgroundColor:o,opacity:n==="empty"?.6:1}}),e.jsx("span",{children:Yt[n]})]},n))})]}),e.jsxs("div",{className:"stats-panel",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.total_tables","Total Tables:")}),e.jsx("span",{className:"value",children:s.tables.length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.occupied","Occupied:")}),e.jsx("span",{className:"value",style:{color:Pe.occupied},children:Array.from(J.values()).filter(n=>n.status==="occupied").length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.empty","Empty:")}),e.jsx("span",{className:"value",style:{color:Pe.empty},children:Array.from(J.values()).filter(n=>n.status==="empty").length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.occupancy","Occupancy:")}),e.jsxs("span",{className:"value",children:[s.tables.length>0?Math.round(Array.from(J.values()).filter(n=>n.status==="occupied").length/s.tables.length*100):0,"%"]})]})]})]}),z&&e.jsx($t,{table:z,restaurantId:p,isOpen:g,onClose:()=>ae(!1),onStatusChange:I})]}):e.jsx("div",{className:"live-view-error",children:e.jsx("p",{children:d("floor.empty_state","No floor layouts found. Please create a floor layout first.")})})}function Et(){const[p,C]=h.useState("edit"),N=window.__APP_CONFIG__||{},s=new URLSearchParams(window.location.search),D=N.restaurantId||s.get("restaurantId")||"";return(N.page||s.get("page")||"floor")==="shifts"?e.jsx("div",{className:"app shifts-app",children:e.jsx(Dt,{restaurantId:D})}):e.jsxs("div",{className:"app",children:[e.jsxs("header",{className:"app-header",children:[e.jsx("h1",{children:"Floor Plan Manager"}),e.jsxs("nav",{className:"mode-switch","aria-label":"View mode",children:[e.jsx("button",{className:p==="edit"?"active":"",onClick:()=>C("edit"),"aria-pressed":p==="edit","aria-label":"Switch to edit layout mode",children:"Edit Layout"}),e.jsx("button",{className:p==="live"?"active":"",onClick:()=>C("live"),"aria-pressed":p==="live","aria-label":"Switch to live view mode",children:"Live View"})]})]}),e.jsx("main",{className:"app-main",children:p==="edit"?e.jsx(Nt,{restaurantId:D}):e.jsx(Xt,{restaurantId:D})})]})}class Lt extends h.Component{constructor(N){super(N);Ve(this,"handleRetry",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(N){return{hasError:!0,error:N}}componentDidCatch(N,s){console.error("[ErrorBoundary] caught:",N,s.componentStack)}render(){var N;return this.state.hasError?this.props.fallback?this.props.fallback:e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"#e6e8ef",background:"#1a1d2e",borderRadius:"12px",margin:"2rem"},children:[e.jsx("h2",{children:"Something went wrong"}),e.jsx("p",{style:{color:"#9aa3b2",marginBottom:"1rem"},children:((N=this.state.error)==null?void 0:N.message)||"An unexpected error occurred"}),e.jsx("button",{onClick:this.handleRetry,style:{padding:"0.5rem 1.5rem",background:"#6c5ce7",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.95rem"},children:"Try Again"})]}):this.props.children}}function Rt(){var C;if((C=window.__APP_CONFIG__)!=null&&C.lang)return window.__APP_CONFIG__.lang;const p=document.cookie.match(/(?:^|; )lang=([^;]*)/);return p?p[1]:"en"}jt(Rt()).then(()=>{yt.createRoot(document.getElementById("root")).render(e.jsx(wt.StrictMode,{children:e.jsx(Lt,{children:e.jsx(kt,{children:e.jsx(Et,{})})})}))});
