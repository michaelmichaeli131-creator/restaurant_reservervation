var gt=Object.defineProperty;var vt=(m,S,w)=>S in m?gt(m,S,{enumerable:!0,configurable:!0,writable:!0,value:w}):m[S]=w;var He=(m,S,w)=>vt(m,typeof S!="symbol"?S+"":S,w);import{r as h,t as d,j as e,g as bt,i as xt,c as jt,R as yt}from"./floor-index.js";function wt({restaurantId:m}){const[S,w]=h.useState([]),[s,k]=h.useState(null),[V,z]=h.useState([]),[L,I]=h.useState(null),[_,$]=h.useState(null),[H,B]=h.useState(null),P=h.useMemo(()=>!s||!_?null:s.tables.find(t=>t.id===_)??null,[s,_]),X=h.useMemo(()=>!s||!H?null:(s.objects??[]).find(t=>t.id===H)??null,[s,H]),[g,Q]=h.useState(null),[W,ee]=h.useState(1),[de,J]=h.useState(!1),[fe,me]=h.useState(""),[ge,ye]=h.useState(!1),[ae,oe]=h.useState(null),[v,ue]=h.useState(null),[ie,ne]=h.useState(null),[K,x]=h.useState(60),T=bt(),R=h.useMemo(()=>({parquet_blue:{label:d("floor.themes.parquet_blue","Blue parquet"),bg:"url(/floor_assets/floor_parquet_blue.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{label:d("floor.themes.parquet_brown","Brown parquet"),bg:"url(/floor_assets/floor_parquet_brown.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{label:d("floor.themes.slate_dark","Dark slate"),bg:"url(/floor_assets/floor_slate_dark.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{label:d("floor.themes.navy_carpet","Deep navy"),bg:"url(/floor_assets/floor_navy_carpet.svg)",size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{label:d("floor.themes.teal_terrazzo","Muted teal"),bg:"url(/floor_assets/floor_teal_terrazzo.svg)",size:"240px 240px",repeat:"repeat",pos:"center"}}),[T]),F=t=>!t||t.startsWith("#")?"parquet_blue":t in R?t:"parquet_blue",[A,re]=h.useState("parquet_blue"),[r,p]=h.useState(!1);h.useEffect(()=>{s&&re(F(s.floorColor))},[s==null?void 0:s.id]);const[c,E]=h.useState(!1),[Y,te]=h.useState(1),[se,G]=h.useState({x:0,y:0}),[Se,ve]=h.useState(!1),[Ie,ze]=h.useState(!1),Ye=h.useRef(Y);h.useEffect(()=>{Ye.current=Y},[Y]);const le=h.useRef(null),Me=h.useRef(null),Be=h.useRef(null),U="/floor_assets/",$e=t=>Math.max(1,Number(t)||1)*K,qe=(t,a)=>{const n=String(t||"square").toLowerCase(),o=Number(a||0);return n==="booth"?o>=6?{spanX:6,spanY:2}:{spanX:2,spanY:2}:n==="round"?o>=9?{spanX:3,spanY:3}:{spanX:2,spanY:2}:o<=2?{spanX:2,spanY:1}:o<=4?{spanX:2,spanY:2}:{spanX:2,spanY:2}},st=(t,a,n)=>{const o=String(n||"").toLowerCase();return o==="large_booth.svg"||o==="round_table_10.svg"?.88:o==="round_table4.svg"||o==="square_table2.svg"?1.06:1},Ke=(t,a=1)=>{const n=Number(t);return Number.isFinite(n)?Math.max(.5,Math.min(1.6,n)):a},be=t=>{const a=Number(t);return Number.isFinite(a)?(Math.round(a/45)*45%360+360)%360:0},at=t=>String(t||"").toLowerCase()==="bar"?1.8:1,ce=(t,a)=>{const n=String(t||"rect").toLowerCase(),o=Number(a||0);if(n==="round")return o>=9?`${U}round_table_10.svg`:`${U}round_table4.svg`;if(n==="booth")return o>=6?`${U}large_booth.svg`:`${U}booth4.svg`;const l=[2,4,6,8,10].reduce((b,u)=>Math.abs(u-o)<Math.abs(b-o)?u:b,4);return`${U}square_table${l}.svg`},he=(t,a,n,o)=>{const i=String(o||"").toLowerCase(),l={bar:"bar.svg",chair:"chair.svg",plant:"plant.svg",door:"door.svg",floor_brown:"floor_brown.svg",corner_partitaion:"corner_partitaion.svg",cyclic:"cyclic_partition.svg",cyclic_partition:"cyclic_partition.svg",horizintal_partitaion:"horizintal_partitaion.svg",vertical_partition:"vertical_partition.svg"};return l[i]?`${U}${l[i]}`:t==="door"?`${U}door.svg`:t==="bar"?`${U}bar.svg`:t==="plant"?`${U}plant.svg`:(a||1)===1&&(n||1)===1?`${U}corner_partitaion.svg`:(a||1)>(n||1)?`${U}horizintal_partitaion.svg`:`${U}vertical_partition.svg`},Le=t=>{const a=Number(t.gridRows||0),n=Number(t.gridCols||0),o=Math.max(0,a*n),i=Array.isArray(t.gridMask)?t.gridMask.slice(0,o):[];for(;i.length<o;)i.push(1);return{...t,gridMask:i,floorColor:t.floorColor||"parquet_blue"}},ke=(t,a,n,o)=>{if(!(s!=null&&s.gridMask))return!0;const i=s.gridCols;for(let l=a;l<a+o;l++)for(let b=t;b<t+n;b++){if(b<0||l<0||b>=i||l>=s.gridRows)return!1;const u=l*i+b;if(s.gridMask[u]!==1)return!1}return!0};h.useEffect(()=>{m&&(fetch(`/api/floor-layouts/${m}`).then(t=>t.ok?t.json():[]).then(t=>{w(t);const a=t.find(i=>i.isActive);k(a?Le(a):t[0]?Le(t[0]):null);const n=t.flatMap(i=>i.tables),o=Math.max(...n.map(i=>i.tableNumber),0);ee(o+1)}).catch(t=>console.error("Failed to load layouts:",t)),fetch(`/api/floor-sections/${m}`).then(t=>t.ok?t.json():[]).then(t=>{z(t),t.length>0&&I(t[0])}).catch(t=>console.error("Failed to load sections:",t)))},[m]),h.useEffect(()=>{const t=n=>{n.code==="Space"&&ze(!0)},a=n=>{n.code==="Space"&&(ze(!1),ve(!1))};return window.addEventListener("keydown",t),window.addEventListener("keyup",a),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",a)}},[]);const Te=async()=>{if(!fe.trim()){alert(d("floor.error.enter_name","Please enter a layout name"));return}try{const t=await fetch(`/api/floor-layouts/${m}`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:fe,gridRows:8,gridCols:12,gridMask:Array.from({length:96},()=>1),tables:[],objects:[],isActive:S.length===0})});if(t.ok){const a=await t.json();w([...S,a]),k(a),me(""),J(!1);try{const n=await fetch(`/api/floor-layouts/${m}/${a.id}/activate`,{method:"POST",credentials:"include"});if(n.ok)w(o=>o.map(i=>({...i,isActive:i.id===a.id})));else{const o=await n.text().catch(()=>"");console.error("[FloorEditor] auto-activate after create failed",{status:n.status,statusText:n.statusText,body:o})}}catch(n){console.error("[FloorEditor] auto-activate after create threw",n)}}else{const a=await t.json().catch(()=>null),n=(a==null?void 0:a.error)||d("floor.error.server","Server error: {status} {statusText}").replace("{status}",String(t.status)).replace("{statusText}",t.statusText);alert(d("floor.error.create","Error creating layout: {error}").replace("{error}",n))}}catch(t){console.error("Create layout failed:",t),alert(d("floor.error.create","Error creating layout: {error}").replace("{error}",t instanceof Error?t.message:String(t)))}},nt=async t=>{if(confirm(d("floor.confirm.delete_layout","Are you sure you want to delete this layout?")))try{const a=await fetch(`/api/floor-layouts/${m}/${t}`,{method:"DELETE",credentials:"include"});if(a.ok){const n=S.filter(o=>o.id!==t);w(n),(s==null?void 0:s.id)===t&&k(n[0]||null)}else{const n=await a.json();alert(n.error||d("floor.error.delete","Delete failed"))}}catch(a){console.error("Delete failed:",a),alert(d("floor.error.delete_general","Error deleting layout"))}},rt=async t=>{const a=prompt(d("floor.prompt.duplicate_name","Enter name for duplicated layout:"));if(a)try{const n=await fetch(`/api/floor-layouts/${m}/${t}/duplicate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:a})});if(n.ok){const o=await n.json();w([...S,o]),k(o)}else alert(d("floor.error.duplicate","Error duplicating layout"))}catch(n){console.error("Duplicate failed:",n),alert(d("floor.error.duplicate","Error duplicating layout"))}},ot=async t=>{try{(await fetch(`/api/floor-layouts/${m}/${t}/activate`,{method:"POST",credentials:"include"})).ok&&w(S.map(n=>({...n,isActive:n.id===t})))}catch(a){console.error("Set active failed:",a)}},Ue=(t,a,n)=>Math.max(a,Math.min(n,t)),Xe=(t,a,n,o)=>s?{x:Ue(t,0,Math.max(0,s.gridCols-n)),y:Ue(a,0,Math.max(0,s.gridRows-o))}:{x:t,y:a},it=(t,a,n,o)=>{if(!s)return{x:t,y:a};const l=(s.objects??[]).filter(y=>y.type==="wall"||y.type==="divider");if(!l.length)return{x:t,y:a};const b={x:t,y:a},u=[],N=(y,j)=>{const f=Xe(y,j,n,o),D=Math.abs(f.x-b.x)+Math.abs(f.y-b.y);u.push({...f,score:D})};return l.forEach(y=>{const j=y.gridX,f=y.gridY,D=y.gridX+(y.spanX||1),O=y.gridY+(y.spanY||1);t+n>j&&t<D&&(N(t,f-o),N(t,O)),a+o>f&&a<O&&(N(j-n,a),N(D,a))}),u.length?(u.sort((y,j)=>y.score-j.score),u[0].score<=1?{x:u[0].x,y:u[0].y}:{x:t,y:a}):{x:t,y:a}},Fe=t=>Math.max(.35,Math.min(2.5,t)),Re=()=>{if(!le.current||!Me.current||!s)return;const t=le.current,a=Me.current,n=getComputedStyle(t),o=parseFloat(n.paddingLeft||"0")||0,i=parseFloat(n.paddingRight||"0")||0,l=parseFloat(n.paddingTop||"0")||0,b=parseFloat(n.paddingBottom||"0")||0,u=getComputedStyle(a),N=parseFloat(u.marginLeft||"0")||0,y=parseFloat(u.marginTop||"0")||0,j=12,f=Math.max(1,t.clientWidth-o-i-j*2),D=Math.max(1,t.clientHeight-l-b-j*2),O=K,M=s.gridCols*O,q=s.gridRows*O,je=Fe(Math.min(f/M,D/q,1.2));te(je);const _e=Math.round(o+j+(f-M*je)/2-N),C=Math.round(l+j+(D-q*je)/2-y);G({x:_e,y:C}),t.scrollLeft=0,t.scrollTop=0},Ae=(t,a,n,o=Ye.current)=>{if(!le.current)return;const i=le.current.getBoundingClientRect(),l=a-i.left,b=n-i.top;G(u=>{const y=t/(o||1),j=Math.round(l-(l-u.x)*y),f=Math.round(b-(b-u.y)*y);return{x:j,y:f}}),te(t)};h.useEffect(()=>{const t=le.current;if(!t)return;const a=n=>{if(!(n.ctrlKey||n.metaKey))return;n.preventDefault(),n.stopPropagation();const o=Ye.current||1,i=Fe(o*(n.deltaY>0?.9:1.1));Ae(i,n.clientX,n.clientY,o)};return t.addEventListener("wheel",a,{passive:!1}),()=>t.removeEventListener("wheel",a)},[]),h.useEffect(()=>{s&&requestAnimationFrame(Re)},[s==null?void 0:s.id,s==null?void 0:s.gridCols,s==null?void 0:s.gridRows,K]),h.useEffect(()=>{if(!le.current||!s)return;let t=0;const a=new ResizeObserver(()=>{cancelAnimationFrame(t),t=requestAnimationFrame(Re)});return a.observe(le.current),()=>{cancelAnimationFrame(t),a.disconnect()}},[s==null?void 0:s.id]);const lt=t=>{const a=t.button===1,n=Ie&&t.button===0;if(!a&&!n)return;t.preventDefault(),ve(!0);const o={x:t.clientX,y:t.clientY},i={...se},l=u=>{const N=u.clientX-o.x,y=u.clientY-o.y;G({x:i.x+N,y:i.y+y})},b=()=>{ve(!1),window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",b)};window.addEventListener("mousemove",l),window.addEventListener("mouseup",b)},ct=(t,a,n,o,i)=>{if(!s)return{x:t,y:a,guides:{v:[],h:[]}};const l=[];for(const C of s.tables)(i==null?void 0:i.kind)==="table"&&(i!=null&&i.id)&&C.id===i.id||l.push({left:C.gridX,top:C.gridY,right:C.gridX+(C.spanX||1),bottom:C.gridY+(C.spanY||1),cx2:C.gridX*2+(C.spanX||1),cy2:C.gridY*2+(C.spanY||1)});for(const C of s.objects??[])(i==null?void 0:i.kind)==="object"&&(i!=null&&i.id)&&C.id===i.id||l.push({left:C.gridX,top:C.gridY,right:C.gridX+(C.spanX||1),bottom:C.gridY+(C.spanY||1),cx2:C.gridX*2+(C.spanX||1),cy2:C.gridY*2+(C.spanY||1)});const b=t,u=a,N=t+n,y=a+o,j=t*2+n,f=a*2+o,D=1;let O=null,M=null;const q={v:[],h:[]},je=(C,Ce)=>{Math.abs(C)>D||(O===null||Math.abs(C)<Math.abs(O))&&(O=C,q.v=[Ce])},_e=(C,Ce)=>{Math.abs(C)>D||(M===null||Math.abs(C)<Math.abs(M))&&(M=C,q.h=[Ce])};for(const C of l){je(C.left-b,C.left),je(C.right-N,C.right);const Ce=C.cx2-j;Ce%2===0&&je(Ce/2,C.cx2/2),_e(C.top-u,C.top),_e(C.bottom-y,C.bottom);const Ve=C.cy2-f;Ve%2===0&&_e(Ve/2,C.cy2/2)}return{x:O!==null?t+O:t,y:M!==null?a+M:a,guides:q}},dt=(t,a,n,o,i,l,b,u)=>{const N=Xe(t,a,n,o);if(b)return{x:N.x,y:N.y,guides:{v:[],h:[]}};const j=i==="table"&&String(l).toLowerCase()==="booth"||i==="object"&&(l==="bar"||l==="door")?it(N.x,N.y,n,o):N,f=ct(j.x,j.y,n,o,u),D=Xe(f.x,f.y,n,o);return{x:D.x,y:D.y,guides:f.guides}},we=(t,a,n,o,i,l,b,u)=>dt(t,a,n,o,i,l,b,u),Pe=(t,a)=>{if(!s)return null;const n=Me.current;if(!n)return null;const o=n.getBoundingClientRect(),i=s.gridCols*K,l=s.gridRows*K,b=o.width/Math.max(1,i),u=o.height/Math.max(1,l),y=getComputedStyle(n).direction==="rtl"?(o.right-t)/b:(t-o.left)/b,j=(a-o.top)/u,f=Math.floor(y/K),D=Math.floor(j/K);return Number.isNaN(f)||Number.isNaN(D)||f<0||D<0||f>=s.gridCols||D>=s.gridRows?null:{x:f,y:D}},Z=(t,a,n,o,i)=>{s&&(t.preventDefault(),t.stopPropagation(),$(null),B(null),$(null),B(null),$(null),ue({kind:a,mode:"new",spanX:n,spanY:o,payload:i}),ne(null))},We=(t,a,n,o,i)=>{s&&(t.preventDefault(),t.stopPropagation(),ue({kind:a,mode:"existing",spanX:o,spanY:i,tableId:a==="table"?n:void 0,objectId:a==="object"?n:void 0}),ne(null))};h.useEffect(()=>{if(!v||!s)return;const t=o=>{var j,f;const i=Pe(o.clientX,o.clientY);if(!i){ne(null);return}const l=i.x-Math.floor(v.spanX/2),b=i.y-Math.floor(v.spanY/2),u=o.shiftKey,N=v.mode==="existing"?{kind:v.kind,id:v.kind==="table"?v.tableId:v.objectId}:void 0,y=we(l,b,v.spanX,v.spanY,v.kind,((j=v.payload)==null?void 0:j.shape)??((f=v.payload)==null?void 0:f.objectType),u,N);if(!ke(y.x,y.y,v.spanX,v.spanY)){ne(null);return}ne({x:y.x,y:y.y}),oe({x:y.x,y:y.y})},a=()=>{var l,b,u,N,y,j,f;if(!ie){ue(null),ne(null),oe(null);return}const o=ie.x,i=ie.y;if(v.mode==="existing")v.kind==="table"&&v.tableId?Ne(v.tableId,{gridX:o,gridY:i}):v.kind==="object"&&v.objectId&&xe(v.objectId,{gridX:o,gridY:i});else if(v.kind==="table"){const D=Number(((l=v.payload)==null?void 0:l.seats)??2),O=((b=v.payload)==null?void 0:b.shape)??"square",M={id:`T${Date.now()}`,name:`T${W}`,tableNumber:W,gridX:o,gridY:i,spanX:v.spanX,spanY:v.spanY,seats:D,shape:O,scale:1,rotationDeg:0,assetFile:(u=v.payload)==null?void 0:u.assetFile,kind:"table",sectionId:L==null?void 0:L.id};ee(q=>q+1),k({...s,tables:[...s.tables,M]})}else{const D={id:`O${Date.now()}`,type:((N=v.payload)==null?void 0:N.objectType)??"visual",gridX:o,gridY:i,spanX:v.spanX,spanY:v.spanY,label:(y=v.payload)==null?void 0:y.objectLabel,assetFile:(j=v.payload)==null?void 0:j.assetFile,kind:((f=v.payload)==null?void 0:f.objectKind)??"object",scale:1,rotationDeg:0};k({...s,objects:[...s.objects??[],D]})}ue(null),ne(null),oe(null)},n=o=>{o.key==="Escape"&&(ue(null),ne(null),oe(null))};return window.addEventListener("mousemove",t),window.addEventListener("mouseup",a,{once:!0}),window.addEventListener("keydown",n),()=>{window.removeEventListener("mousemove",t),window.removeEventListener("keydown",n)}},[v,s,K,ie,W,L==null?void 0:L.id]);const ut=t=>{if(t.preventDefault(),!g||!s)return;const a=Pe(t.clientX,t.clientY);if(!a)return;const n=a.x,o=a.y,i=!!t.shiftKey;if(g.kind==="table"&&g.mode==="new"&&g.shape){const l=Number(g.seats??(g.shape==="booth"?4:2)),b=g.spanX&&g.spanY?{spanX:g.spanX,spanY:g.spanY}:qe(g.shape,l),u=we(n,o,b.spanX,b.spanY,"table",g.shape,i);if(!ke(u.x,u.y,b.spanX,b.spanY)){alert(d("floor.error.placement_outside","Cannot place item outside the restaurant shape"));return}const N={id:`T${Date.now()}`,name:`Table ${W}`,tableNumber:W,gridX:u.x,gridY:u.y,spanX:b.spanX,spanY:b.spanY,seats:l,shape:g.shape,assetFile:g.assetFile,kind:"table",sectionId:L==null?void 0:L.id,scale:1,rotationDeg:0};k({...s,tables:[...s.tables,N]}),ee(W+1),B(null),$(null),$(N.id),B(null),$(null)}else if(g.kind==="table"&&g.mode==="existing"&&g.tableId){const l=s.tables.find(u=>u.id===g.tableId);if(!l)return;const b=we(n,o,l.spanX||1,l.spanY||1,"table",l.shape,i,{kind:"table",id:l.id});if(!ke(b.x,b.y,l.spanX||1,l.spanY||1)){alert(d("floor.error.move_outside","Cannot move item outside the restaurant shape"));return}k({...s,tables:s.tables.map(u=>u.id===g.tableId?{...u,gridX:b.x,gridY:b.y}:u)})}else if(g.kind==="object"&&g.mode==="new"&&g.objectType){const l=s.objects??[],u={wall:{spanX:4,spanY:1,rotation:0,label:"wall_h"},divider:{spanX:2,spanY:1,rotation:0,label:"partition"},door:{spanX:1,spanY:1,rotation:0,label:"Door"},bar:{spanX:5,spanY:1,rotation:0,label:"Bar"},plant:{spanX:1,spanY:1,rotation:0,label:""}}[String(g.objectType)]??{spanX:1,spanY:1},N={spanX:Math.max(1,Number(g.spanX??u.spanX)||1),spanY:Math.max(1,Number(g.spanY??u.spanY)||1)},y=we(n,o,N.spanX,N.spanY,"object",g.objectType,i);if(!ke(y.x,y.y,N.spanX,N.spanY)){alert(d("floor.error.placement_outside","Cannot place item outside the restaurant shape"));return}const j={id:`O${Date.now()}`,type:g.objectType,gridX:y.x,gridY:y.y,spanX:N.spanX,spanY:N.spanY,rotation:g.rotation??u.rotation,label:g.objectLabel??u.label,assetFile:g.assetFile,kind:g.objectKind??"object",scale:1,rotationDeg:0};k({...s,objects:[...l,j]}),$(null),B(null),$(null),B(j.id),$(null)}else if(g.kind==="object"&&g.mode==="existing"&&g.objectId){const l=s.objects??[],b=l.find(N=>N.id===g.objectId);if(!b)return;const u=we(n,o,b.spanX||1,b.spanY||1,"object",b.type,i,{kind:"object",id:b.id});if(!ke(u.x,u.y,b.spanX||1,b.spanY||1)){alert(d("floor.error.move_outside","Cannot move item outside the restaurant shape"));return}k({...s,objects:l.map(N=>N.id===g.objectId?{...N,gridX:u.x,gridY:u.y}:N)})}Q(null),oe(null)},pt=t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";const a=Pe(t.clientX,t.clientY);a&&oe(a)},mt=t=>{s&&(k({...s,tables:s.tables.filter(a=>a.id!==t)}),$(null),B(null),$(null))},ht=t=>{if(!s)return;const a=s.objects??[];k({...s,objects:a.filter(n=>n.id!==t)}),B(null),$(null)},xe=(t,a)=>{if(!s)return;const o=(s.objects??[]).map(i=>i.id===t?{...i,...a}:i);k({...s,objects:o})},Ne=(t,a)=>{if(!s)return;const n=s.tables.map(o=>o.id===t?{...o,...a}:o);k({...s,tables:n})},ft=async()=>{if(s)try{const t=await fetch(`/api/floor-layouts/${m}/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(s)});if(t.ok){let a=!1,n=null;try{const i=await fetch(`/api/floor-layouts/${m}/${s.id}/activate`,{method:"POST",credentials:"include"});if(a=i.ok,!i.ok){const l=await i.text().catch(()=>"");n=l||`${i.status} ${i.statusText}`,console.error("[FloorEditor] activate failed",{status:i.status,statusText:i.statusText,body:l})}}catch(i){n=i instanceof Error?i.message:String(i),console.error("[FloorEditor] activate threw",i)}w(S.map(i=>({...i,isActive:i.id===s.id})));const o=a?d("floor.success.save_and_activate","Layout saved and activated âœ…"):d("floor.success.save_but_activate_failed","Layout saved âœ… but activation failed: {error}").replace("{error}",n||"unknown");alert("âœ… "+o)}else{const a=await t.json();alert("âŒ "+d("floor.error.save","Error saving: {error}").replace("{error}",a.error||"Unknown error"))}}catch(t){console.error("Save failed:",t),alert("âŒ "+d("floor.error.save","Error saving: {error}").replace("{error}",t instanceof Error?t.message:String(t)))}};return s?e.jsxs("div",{className:"floor-editor",children:[e.jsxs("div",{className:"layout-tabs-bar",children:[e.jsx("div",{className:"layout-tabs",children:S.map(t=>e.jsxs("button",{className:`layout-tab ${s.id===t.id?"active":""} ${t.isActive?"is-active":""}`,onClick:()=>k(Le(t)),title:t.isActive?d("floor.toolbar.active_hint","Active layout (shown in live view)"):"",children:[t.name,t.isActive&&e.jsx("span",{className:"active-badge",children:"â˜…"})]},t.id))}),e.jsxs("div",{className:"layout-actions",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>J(!0),title:d("floor.btn_new_layout","New Layout"),children:"âž•"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>rt(s.id),title:d("floor.btn_duplicate","Duplicate"),children:"ðŸ“‹"}),!s.isActive&&e.jsx("button",{className:"btn-icon-small",onClick:()=>ot(s.id),title:d("floor.btn_set_active","Set as Active"),children:"â­"}),S.length>1&&e.jsx("button",{className:"btn-icon-small btn-danger",onClick:()=>nt(s.id),title:d("floor.btn_delete","Delete"),children:"ðŸ—‘ï¸"})]})]}),e.jsxs("div",{className:"editor-content",children:[e.jsxs("div",{className:"editor-sidebar",children:[V.length>0&&e.jsxs("div",{className:"sections-tabs",children:[e.jsx("h3",{children:d("floor.sections.title","Sections")}),e.jsx("div",{className:"tabs",children:V.map(t=>e.jsx("button",{className:`tab ${(L==null?void 0:L.id)===t.id?"active":""}`,onClick:()=>I(t),children:t.name},t.id))}),e.jsxs("label",{className:"fe-toggle",children:[e.jsx("input",{type:"checkbox",checked:ge,onChange:t=>ye(t.target.checked)}),e.jsx("span",{children:d("floor.sections.show_only_active","Show only active section")})]})]}),e.jsxs("h2",{children:["ðŸ§© ",d("floor.assets.title","Assets")]}),e.jsx("h3",{className:"fe-subtitle",children:d("floor.assets.seating","Seating")}),e.jsxs("div",{className:"palette",children:[e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",5,2,{shape:"rect",seats:5,assetFile:"bar.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:`${U}bar.svg`,alt:""})}),e.jsx("span",{children:"bar.svg â€¢ 5 (5Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",2,2,{shape:"booth",seats:4,assetFile:"booth4.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("booth",4),alt:""})}),e.jsx("span",{children:"booth4.svg â€¢ 4 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",6,2,{shape:"booth",seats:6,assetFile:"large_booth.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("booth",6),alt:""})}),e.jsx("span",{children:"large_booth.svg â€¢ 6 (6Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",1,1,{objectType:"chair",objectLabel:"chair",assetFile:"chair.svg",objectKind:"object"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:`${U}chair.svg`,alt:""})}),e.jsx("span",{children:"chair.svg â€¢ 1 (1Ã—1)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",1,1,{objectType:"plant",objectLabel:"plant",assetFile:"plant.svg",objectKind:"object"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:`${U}plant.svg`,alt:""})}),e.jsx("span",{children:"plant.svg â€¢ 1 (1Ã—1)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",2,2,{shape:"round",seats:4,assetFile:"round_table4.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("round",4),alt:""})}),e.jsx("span",{children:"round_table4.svg â€¢ 4 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",3,3,{shape:"round",seats:10,assetFile:"round_table_10.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("round",10),alt:""})}),e.jsx("span",{children:"round_table_10.svg â€¢ 10 (3Ã—3)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",2,1,{shape:"square",seats:2,assetFile:"square_table2.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("square",2),alt:""})}),e.jsx("span",{children:"square_table2.svg â€¢ 2 (2Ã—1)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",2,2,{shape:"square",seats:4,assetFile:"square_table4.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("square",4),alt:""})}),e.jsx("span",{children:"square_table4.svg â€¢ 4 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",2,2,{shape:"square",seats:6,assetFile:"square_table6.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("square",6),alt:""})}),e.jsx("span",{children:"square_table6.svg â€¢ 6 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",2,2,{shape:"square",seats:8,assetFile:"square_table8.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("square",8),alt:""})}),e.jsx("span",{children:"square_table8.svg â€¢ 8 (2Ã—2)"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"table",2,2,{shape:"square",seats:10,assetFile:"square_table10.svg"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:ce("square",10),alt:""})}),e.jsx("span",{children:"square_table10.svg â€¢ 10 (2Ã—2)"})]})]}),e.jsx("h3",{className:"fe-subtitle",style:{marginTop:14},children:d("floor.assets.visual_only","Visual only")}),e.jsxs("div",{className:"palette",children:[e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",1,1,{objectType:"visual",objectLabel:"corner_partitaion",assetFile:"corner_partitaion.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:he("divider",1,1,"corner_partitaion"),alt:""})}),e.jsx("span",{children:"corner_partitaion.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",2,2,{objectType:"visual",objectLabel:"cyclic_partition",assetFile:"cyclic_partition.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:he("divider",2,2,"cyclic_partition"),alt:""})}),e.jsx("span",{children:"cyclic_partition.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",1,1,{objectType:"door",objectLabel:"door",assetFile:"door.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:he("door",1,1,"door"),alt:""})}),e.jsx("span",{children:"door.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",1,1,{objectType:"visual",objectLabel:"floor_brown",assetFile:"floor_brown.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:he("divider",1,1,"floor_brown"),alt:""})}),e.jsx("span",{children:"floor_brown.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",4,1,{objectType:"visual",objectLabel:"horizintal_partitaion",assetFile:"horizintal_partitaion.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:he("divider",4,1,"horizintal_partitaion"),alt:""})}),e.jsx("span",{children:"horizintal_partitaion.svg"})]}),e.jsxs("div",{className:"palette-item",onMouseDown:t=>Z(t,"object",1,4,{objectType:"visual",objectLabel:"vertical_partition",assetFile:"vertical_partition.svg",objectKind:"visualOnly"}),children:[e.jsx("div",{className:"preview",children:e.jsx("img",{className:"preview-img",src:he("divider",1,4,"vertical_partition"),alt:""})}),e.jsx("span",{children:"vertical_partition.svg"})]})]}),e.jsxs("div",{className:"properties-panel",children:[e.jsx("h3",{children:d("floor.map.title","Map")}),e.jsxs("label",{children:[d("floor.map.cell_size","Cell size: {size}px").replace("{size}",String(K)),e.jsx("input",{type:"range",min:"40",max:"110",value:K,onChange:t=>x(Number(t.target.value))})]}),e.jsxs("label",{children:[d("floor.map.floor_label","Floor:"),e.jsx("select",{value:A,onChange:t=>{const a=F(String(t.target.value||"parquet_blue"));re(a),s&&k({...s,floorColor:a})},children:Object.keys(R).map(t=>e.jsx("option",{value:t,children:R[t].label},t))})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8},children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{p(t=>!t),$(null),B(null),$(null),B(null),$(null)},children:r?`âœ… ${d("floor.shape.done","Done shape")}`:`âœï¸ ${d("floor.shape.edit","Edit shape")}`}),e.jsxs("button",{className:"btn-icon-small",onClick:()=>{if(!s)return;const t=s.gridRows*s.gridCols;k({...s,gridMask:Array.from({length:t},()=>1)})},title:d("floor.shape.reset_title","Reset shape"),children:["â†º ",d("floor.shape.reset","Reset")]}),e.jsxs("button",{className:"btn-icon-small",onClick:()=>{s!=null&&s.gridMask&&k({...s,gridMask:s.gridMask.map(t=>t===1?0:1)})},title:d("floor.shape.invert_title","Invert shape"),children:["â‡„ ",d("floor.shape.invert","Invert")]})]}),r&&e.jsx("div",{className:"fe-hint",style:{marginTop:8},children:d("floor.shape.paint_hint","Paint the restaurant shape: click/drag cells to enable/disable.")})]}),P&&e.jsxs("div",{className:"properties-panel",children:[e.jsx("h3",{children:d("floor.properties.selected_table","Selected: {name}").replace("{name}",P.name)}),e.jsxs("label",{children:[d("floor.properties.name","Name:"),e.jsx("input",{type:"text",value:P.name,onChange:t=>Ne(P.id,{name:t.target.value})})]}),e.jsxs("label",{children:[d("floor.properties.seats","Seats:"),e.jsx("input",{type:"number",min:"1",max:"12",value:P.seats,onChange:t=>{const a=Math.max(1,Number(t.target.value)||1);Ne(P.id,{seats:a})}})]}),e.jsxs("label",{children:[d("floor.properties.size","Size:"),e.jsx("input",{type:"range",min:"0.6",max:"1.4",step:"0.05",className:"range-ltr",value:P.scale??1,onChange:t=>Ne(P.id,{scale:Number(t.target.value)})}),e.jsxs("span",{style:{marginInlineStart:8},children:[Math.round((P.scale??1)*100),"%"]})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{opacity:.85},children:d("floor.properties.rotate","Rotate:")}),e.jsx("button",{className:"btn-icon-small",onClick:()=>Ne(P.id,{rotationDeg:be((P.rotationDeg??0)-45)}),title:"Rotate -45Â°",children:"â†º"}),e.jsxs("span",{style:{minWidth:54,textAlign:"center",opacity:.9},children:[be(P.rotationDeg??0),"Â°"]}),e.jsx("button",{className:"btn-icon-small",onClick:()=>Ne(P.id,{rotationDeg:be((P.rotationDeg??0)+45)}),title:"Rotate +45Â°",children:"â†»"})]}),e.jsxs("button",{className:"btn-danger",onClick:()=>mt(P.id),children:["ðŸ—‘ï¸ ",d("common.btn_delete","Delete")]})]}),X&&e.jsxs("div",{className:"properties-panel",children:[e.jsx("h3",{children:d("floor.properties.selected_object","Selected: {type}").replace("{type}",X.type)}),e.jsxs("label",{children:[d("floor.properties.name","Name:"),e.jsx("input",{type:"text",value:X.label??"",onChange:t=>xe(X.id,{label:t.target.value})})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8},children:[e.jsxs("label",{style:{flex:1},children:["W:",e.jsx("input",{type:"number",min:"1",max:"12",value:X.spanX,onChange:t=>xe(X.id,{spanX:Math.max(1,Number(t.target.value)||1)})})]}),e.jsxs("label",{style:{flex:1},children:["H:",e.jsx("input",{type:"number",min:"1",max:"12",value:X.spanY,onChange:t=>xe(X.id,{spanY:Math.max(1,Number(t.target.value)||1)})})]})]}),e.jsxs("label",{children:[d("floor.properties.size","Size:"),e.jsx("input",{type:"range",min:"0.6",max:"1.4",step:"0.05",className:"range-ltr",value:X.scale??1,onChange:t=>xe(X.id,{scale:Number(t.target.value)})}),e.jsxs("span",{style:{marginInlineStart:8},children:[Math.round((X.scale??1)*100),"%"]})]}),e.jsxs("div",{className:"row",style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{opacity:.85},children:d("floor.properties.rotate","Rotate:")}),e.jsx("button",{className:"btn-icon-small",onClick:()=>xe(X.id,{rotationDeg:be((X.rotationDeg??X.rotation??0)-45)}),title:"Rotate -45Â°",children:"â†º"}),e.jsxs("span",{style:{minWidth:54,textAlign:"center",opacity:.9},children:[be(X.rotationDeg??X.rotation??0),"Â°"]}),e.jsx("button",{className:"btn-icon-small",onClick:()=>xe(X.id,{rotationDeg:be((X.rotationDeg??X.rotation??0)+45)}),title:"Rotate +45Â°",children:"â†»"})]}),e.jsxs("button",{className:"btn-danger",onClick:()=>ht(X.id),children:["ðŸ—‘ï¸ ",d("common.btn_delete","Delete")]})]}),e.jsxs("button",{className:"btn-save",onClick:ft,children:["ðŸ’¾ ",d("floor.btn_save_layout","Save Layout")]})]}),e.jsxs("div",{className:`editor-canvas ${Se?"is-panning":""}`,ref:le,onMouseDown:lt,children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t,a;return Ae(Fe(Y*1.1),(((t=le.current)==null?void 0:t.getBoundingClientRect().left)||0)+40,(((a=le.current)==null?void 0:a.getBoundingClientRect().top)||0)+40)},title:d("floor.toolbar.zoom_in","Zoom in"),children:"ï¼‹"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t,a;return Ae(Fe(Y*.9),(((t=le.current)==null?void 0:t.getBoundingClientRect().left)||0)+40,(((a=le.current)==null?void 0:a.getBoundingClientRect().top)||0)+40)},title:d("floor.toolbar.zoom_out","Zoom out"),children:"ï¼"}),e.jsx("button",{className:"btn-icon-small",onClick:Re,title:d("floor.toolbar.fit_screen","Fit to screen"),children:"â¤¢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(Y*100),"%"]}),e.jsx("div",{className:"fe-hint",children:Ie?d("floor.hints.pan_drag","Pan: drag"):d("floor.hints.controls","Tip: hold Space to pan, Ctrl+wheel to zoom")})]}),(()=>{const t=R[A];return e.jsxs("div",{className:"fe-grid",ref:Me,style:{direction:"ltr",gridTemplateColumns:`repeat(${s.gridCols}, ${K}px)`,gridTemplateRows:`repeat(${s.gridRows}, ${K}px)`,transform:`translate(${se.x}px, ${se.y}px) scale(${Y})`,transformOrigin:"0 0","--cell":`${K}px`,"--floor-bg":t.bg,"--floor-bg-size":t.size,"--floor-bg-repeat":t.repeat,"--floor-bg-position":t.pos},onDragOver:r?void 0:pt,onDrop:r?void 0:ut,onDragLeave:()=>oe(null),children:[(()=>{if(!ae||!g||!s)return null;const a=K,n=10,o=()=>{if(g.kind==="table"){if(g.mode==="new"){const f=String(g.shape||"square"),D=Number(g.seats??(f==="booth"?4:2)),O=g.spanX&&g.spanY?{spanX:g.spanX,spanY:g.spanY}:qe(f,D);return{spanX:O.spanX,spanY:O.spanY,subtype:f}}const j=s.tables.find(f=>f.id===g.tableId);if(j)return{spanX:j.spanX||1,spanY:j.spanY||1,subtype:j.shape}}if(g.kind==="object"){if(g.mode==="new"){const f={spanX:Math.max(1,Number(g.spanX??1)||1),spanY:Math.max(1,Number(g.spanY??1)||1)};return{spanX:f.spanX,spanY:f.spanY,subtype:g.objectType}}const j=(s.objects??[]).find(f=>f.id===g.objectId);if(j)return{spanX:j.spanX||1,spanY:j.spanY||1,subtype:j.type}}return{spanX:1,spanY:1,subtype:""}},{spanX:i,spanY:l,subtype:b}=o(),u=we(ae.x,ae.y,i,l,g.kind,String(b),!1,g.mode==="existing"?{kind:g.kind,id:g.kind==="table"?g.tableId:g.objectId}:void 0),N=n+u.x*a,y=n+u.y*a;return e.jsxs(e.Fragment,{children:[u.guides.v.map((j,f)=>e.jsx("div",{className:"fe-guide-line v",style:{left:n+j*a}},`pv-v-${f}`)),u.guides.h.map((j,f)=>e.jsx("div",{className:"fe-guide-line h",style:{top:n+j*a}},`pv-h-${f}`)),e.jsx("div",{className:"fe-drop-preview",style:{left:N,top:y,width:i*a,height:l*a}})]})})(),v&&ie&&(()=>{var b,u,N,y,j,f,D,O;const a=K,n=10,o=n+ie.x*a,i=n+ie.y*a;let l="";if(v.mode==="existing"){if(v.kind==="table"&&v.tableId){const M=s.tables.find(q=>q.id===v.tableId);M&&(l=M.assetFile?`${U}${M.assetFile}`:ce(M.shape,M.seats))}if(v.kind==="object"&&v.objectId){const M=(s.objects??[]).find(q=>q.id===v.objectId);M&&(l=M.assetFile?`${U}${M.assetFile}`:he(M.type,M.spanX,M.spanY,M.label))}}else if(v.kind==="table"){const M=String(((b=v.payload)==null?void 0:b.shape)??"square"),q=Number(((u=v.payload)==null?void 0:u.seats)??2);l=(N=v.payload)!=null&&N.assetFile?`${U}${(y=v.payload)==null?void 0:y.assetFile}`:ce(M,q)}else{const M=((j=v.payload)==null?void 0:j.objectType)??"visual";l=(f=v.payload)!=null&&f.assetFile?`${U}${(D=v.payload)==null?void 0:D.assetFile}`:he(M,v.spanX,v.spanY,(O=v.payload)==null?void 0:O.objectLabel)}return e.jsx("div",{className:"fe-drop-preview",style:{left:o,top:i,width:v.spanX*a,height:v.spanY*a,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none"},children:l&&e.jsx("img",{src:l,alt:"",style:{width:"100%",height:"100%",objectFit:"contain",display:"block",opacity:.75}})})})(),Array.from({length:s.gridRows*s.gridCols}).map((a,n)=>{var j;const o=Math.floor(n/s.gridCols),i=n%s.gridCols,l=s.tables.find(f=>ge&&L&&String(f.sectionId||"")!==String(L.id)?!1:i>=f.gridX&&i<f.gridX+f.spanX&&o>=f.gridY&&o<f.gridY+f.spanY),u=(s.objects??[]).find(f=>i>=f.gridX&&i<f.gridX+f.spanX&&o>=f.gridY&&o<f.gridY+f.spanY),N=l&&l.gridX===i&&l.gridY===o,y=u&&u.gridX===i&&u.gridY===o;return e.jsxs("div",{className:`fe-grid-cell ${(()=>{var O;const f=o*s.gridCols+i;return(((O=s.gridMask)==null?void 0:O[f])??1)===1?"active":"inactive"})()}`,onMouseDown:f=>{if(!r||!s)return;f.preventDefault(),E(!0);const D=o*s.gridCols+i,O=s.gridRows*s.gridCols,M=(s.gridMask??Array.from({length:O},()=>1)).slice(),q=M[D]===1?0:1;Be.current=q,M[D]=q,k({...s,gridMask:M})},onMouseEnter:f=>{if(!r||!c||!s)return;f.preventDefault();const D=Be.current;if(D==null)return;const O=o*s.gridCols+i,M=s.gridRows*s.gridCols,q=(s.gridMask??Array.from({length:M},()=>1)).slice();q[O]!==D&&(q[O]=D,k({...s,gridMask:q}))},children:[y&&u&&e.jsxs("div",{className:`floor-object type-${u.type} ${(X==null?void 0:X.id)===u.id?"selected":""}`,onMouseDown:f=>We(f,"object",u.id,u.spanX||1,u.spanY||1),onClick:()=>{$(null),B(null),$(null),B(u.id),$(null)},style:{width:`${$e(u.spanX)}px`,height:`${$e(u.spanY)}px`,transform:`rotate(${be(u.rotationDeg??u.rotation??0)}deg)`},children:[e.jsx("img",{className:`fe-asset fe-asset--${(u.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${Ke(u.scale,at(u.type))})`},src:u.assetFile?`${U}${u.assetFile}`:he(u.type,u.spanX,u.spanY,u.label),alt:""}),u.label&&e.jsx("div",{className:"obj-label",children:u.label})]}),N&&e.jsxs("div",{className:`table ${l.shape} ${(P==null?void 0:P.id)===l.id?"selected":""} ${!ge&&L&&String(l.sectionId||"")&&String(l.sectionId||"")!==String(L.id)?"dimmed":""}`,onMouseDown:f=>We(f,"table",l.id,l.spanX||1,l.spanY||1),onClick:()=>{B(null),$(null),$(l.id),B(null),$(null)},style:{width:`${$e(l.spanX)}px`,height:`${$e(l.spanY)}px`},children:[e.jsx("div",{className:"fe-table-visual","data-asset":l.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(l.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${be(l.rotationDeg??0)}deg) scale(${Ke(l.scale,st(l.shape,l.seats,l.assetFile))})`},src:l.assetFile?`${U}${l.assetFile}`:ce(l.shape,l.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:l.name}),e.jsxs("div",{className:"table-seats",children:[l.seats," ",d("floor.properties.seats_unit","seats")]}),l.sectionId&&V.length>0&&e.jsx("div",{className:"table-section",children:((j=V.find(f=>String(f.id)===String(l.sectionId)))==null?void 0:j.name)||d("floor.properties.section","Section")})]})]})]},n)})]})})()]})]}),de&&e.jsx("div",{className:"modal-overlay",onClick:()=>J(!1),children:e.jsxs("div",{className:"modal-content",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:d("floor.modal.create_title","Create New Layout")}),e.jsx("input",{type:"text",placeholder:d("floor.modal.placeholder_name","Layout name (e.g., Main Floor, Patio)"),value:fe,onChange:t=>me(t.target.value),onKeyDown:t=>t.key==="Enter"&&Te(),autoFocus:!0}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{onClick:Te,className:"btn-primary",children:d("floor.btn_create","Create")}),e.jsx("button",{onClick:()=>J(!1),className:"btn-secondary",children:d("common.btn_cancel","Cancel")})]})]})})]}):e.jsxs("div",{className:"floor-editor-empty",children:[e.jsx("h2",{children:d("floor.empty_state","No floor layouts found. Please create a floor layout first.")}),e.jsx("p",{children:d("floor.empty_hint","Create your first floor layout to get started.")}),e.jsxs("button",{className:"btn-primary",onClick:()=>J(!0),children:["âž• ",d("floor.btn_create_new","Create New Layout")]}),de&&e.jsx("div",{className:"modal-overlay",onClick:()=>J(!1),children:e.jsxs("div",{className:"modal-content",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:d("floor.modal.create_title","Create New Layout")}),e.jsx("input",{type:"text",placeholder:d("floor.modal.placeholder_name","Layout name (e.g., Main Floor, Patio)"),value:fe,onChange:t=>me(t.target.value),onKeyDown:t=>t.key==="Enter"&&Te(),autoFocus:!0}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{onClick:Te,className:"btn-primary",children:d("common.btn_add","Create")}),e.jsx("button",{onClick:()=>J(!1),className:"btn-secondary",children:d("common.btn_cancel","Cancel")})]})]})})]})}const tt=h.createContext(null);function Nt(){const m=h.useContext(tt);if(!m)throw new Error("useToast must be used within <ToastProvider>");return m}let Ct=0;function St({children:m}){const[S,w]=h.useState([]),[s,k]=h.useState(null),V=h.useCallback((_,$="info")=>{const H=++Ct;w(B=>[...B,{id:H,message:_,type:$}]),setTimeout(()=>w(B=>B.filter(P=>P.id!==H)),4e3)},[]),z=h.useCallback(_=>new Promise($=>{k({message:_,resolve:$})}),[]),L=_=>{s==null||s.resolve(_),k(null)};h.useEffect(()=>{if(!s)return;const _=$=>{$.key==="Escape"&&L(!1)};return document.addEventListener("keydown",_),()=>document.removeEventListener("keydown",_)},[s]);const I={success:"#00b894",error:"#d63031",warning:"#fdcb6e",info:"#6c5ce7"};return e.jsxs(tt.Provider,{value:{toast:V,confirmDialog:z},children:[m,e.jsx("div",{style:{position:"fixed",top:"1rem",left:"50%",transform:"translateX(-50%)",zIndex:99999,display:"flex",flexDirection:"column",gap:"0.5rem",pointerEvents:"none"},children:S.map(_=>e.jsx("div",{role:"alert","aria-live":"assertive",style:{padding:"0.75rem 1.5rem",background:"#1a1d2e",color:"#e6e8ef",borderRadius:"8px",borderLeft:`4px solid ${I[_.type]}`,boxShadow:"0 4px 12px rgba(0,0,0,0.4)",fontSize:"0.9rem",pointerEvents:"auto",animation:"toast-in 0.3s ease"},children:_.message},_.id))}),s&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":"Confirmation",style:{position:"fixed",inset:0,zIndex:99998,background:"rgba(0,0,0,0.6)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{background:"#1a1d2e",color:"#e6e8ef",padding:"1.5rem 2rem",borderRadius:"12px",maxWidth:"400px",width:"90%",boxShadow:"0 8px 32px rgba(0,0,0,0.5)"},children:[e.jsx("p",{style:{marginBottom:"1.5rem",lineHeight:1.5},children:s.message}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem",justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>L(!1),style:{padding:"0.5rem 1.25rem",background:"#2d3148",color:"#e6e8ef",border:"none",borderRadius:"8px",cursor:"pointer"},children:"Cancel"}),e.jsx("button",{onClick:()=>L(!0),autoFocus:!0,style:{padding:"0.5rem 1.25rem",background:"#d63031",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer"},children:"Confirm"})]})]})}),e.jsx("style",{children:`
        @keyframes toast-in {
          from { opacity: 0; transform: translateY(-10px); }
          to   { opacity: 1; transform: translateY(0); }
        }
      `})]})}const De={waiter:"#FF6B6B",chef:"#4ECDC4",manager:"#FFE66D",busser:"#95E1D3",host:"#C7B3E5",bartender:"#F38181"},kt={scheduled:"#E8F5E9",checked_in:"#C8E6C9",checked_out:"#BDBDBD",called_out:"#FFE0B2",cancelled:"#FFCDD2"},_t=m=>{const S=new Date(m),w=S.getDay(),s=S.getDate()-w+(w===0?-6:1);return new Date(S.setDate(s))},Oe=m=>{const S=_t(m),w=[];for(let s=0;s<7;s++){const k=new Date(S);k.setDate(k.getDate()+s),w.push(k)}return w},pe=m=>m.toISOString().split("T")[0],Je=m=>m.toLocaleDateString("en-US",{month:"short",day:"numeric"}),Ge=m=>m.toLocaleDateString("en-US",{month:"long",year:"numeric"});function Dt({restaurantId:m}){const{toast:S}=Nt(),[w,s]=h.useState([]),[k,V]=h.useState([]),[z,L]=h.useState(new Date().toISOString().split("T")[0]),[I,_]=h.useState("day"),[$,H]=h.useState(!1),[B,P]=h.useState(!1),[X,g]=h.useState(!1),[Q,W]=h.useState({firstName:"",lastName:"",email:"",role:"waiter",userId:""}),[ee,de]=h.useState({staffId:"",startTime:"09:00",endTime:"17:00"});h.useEffect(()=>{J()},[z,I,m]);const J=async()=>{H(!0);try{const x=await fetch(`/api/restaurants/${m}/staff`);x.ok&&s(await x.json());let T=z,R=z;if(I==="week"){const A=Oe(new Date(z));T=pe(A[0]),R=pe(A[6])}else if(I==="month"){const A=new Date(z);T=pe(new Date(A.getFullYear(),A.getMonth(),1)),R=pe(new Date(A.getFullYear(),A.getMonth()+1,0))}const F=await fetch(`/api/restaurants/${m}/shifts?startDate=${T}&endDate=${R}`);F.ok&&V(await F.json())}catch(x){console.error("Failed to load data:",x)}finally{H(!1)}},fe=async()=>{if(!Q.firstName||!Q.lastName||!Q.email){S("Please fill in required fields","warning");return}try{(await fetch(`/api/restaurants/${m}/staff`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q)})).ok&&(W({firstName:"",lastName:"",email:"",role:"waiter",userId:""}),P(!1),J())}catch(x){console.error("Failed to add staff:",x)}},me=async()=>{if(!ee.staffId){S("Please select a staff member","warning");return}try{(await fetch(`/api/restaurants/${m}/shifts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({staffId:ee.staffId,date:z,startTime:ee.startTime,endTime:ee.endTime})})).ok&&(de({staffId:"",startTime:"09:00",endTime:"17:00"}),g(!1),J())}catch(x){console.error("Failed to add shift:",x)}},ge=async x=>{try{await fetch(`/api/restaurants/${m}/shifts/${x}/check-in`,{method:"POST"}),J()}catch(T){console.error("Failed to check in:",T)}},ye=async x=>{try{await fetch(`/api/restaurants/${m}/shifts/${x}/check-out`,{method:"POST"}),J()}catch(T){console.error("Failed to check out:",T)}},ae=async x=>{try{await fetch(`/api/restaurants/${m}/shifts/${x}`,{method:"DELETE"}),J()}catch(T){console.error("Failed to cancel shift:",T)}},oe=x=>{const T=new Date(z);I==="week"?T.setDate(T.getDate()+x*7):I==="month"?T.setMonth(T.getMonth()+x):T.setDate(T.getDate()+x),L(pe(T))},v=()=>{const x=new Date(z),T=k.filter(p=>p.date===z),R=new Map;T.forEach(p=>{R.has(p.staffId)||R.set(p.staffId,[]),R.get(p.staffId).push(p)});const F=p=>{const[c,E]=p.split(":").map(Number);return c*60+E},A=9*60,r=23*60-A;return e.jsxs("div",{className:"shift-board day-view",children:[e.jsx("div",{className:"day-view-header",children:e.jsx("h2",{children:x.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"})})}),e.jsxs("div",{className:"day-timeline",children:[e.jsx("div",{className:"time-slots",children:Array.from({length:15},(p,c)=>e.jsxs("div",{className:"time-slot",children:[9+c,":00"]},c))}),e.jsx("div",{className:"staff-rows",children:w.map(p=>e.jsxs("div",{className:"staff-row",children:[e.jsxs("div",{className:"staff-name",style:{borderLeftColor:De[p.role]||"#999"},children:[e.jsxs("span",{children:[p.firstName," ",p.lastName]}),e.jsx("small",{children:p.role})]}),e.jsx("div",{className:"timeline-row",children:(R.get(p.id)||[]).map(c=>{const E=F(c.startTime),Y=F(c.endTime),te=(E-A)/r*100,se=(Y-E)/r*100;return e.jsxs("div",{className:"shift-bar",style:{left:`${te}%`,width:`${se}%`,backgroundColor:De[c.staffRole]||"#999",opacity:kt[c.status]?1:.6},title:`${c.startTime}-${c.endTime} (${c.status})`,children:[e.jsxs("span",{className:"shift-time",children:[c.startTime,"-",c.endTime]}),e.jsxs("div",{className:"shift-actions",children:[c.status==="scheduled"&&e.jsx("button",{onClick:()=>ge(c.id),className:"btn-checkin",children:"Check In"}),c.status==="checked_in"&&e.jsx("button",{onClick:()=>ye(c.id),className:"btn-checkout",children:"Check Out"}),e.jsx("button",{onClick:()=>ae(c.id),className:"btn-cancel",children:"Cancel"})]})]},c.id)})})]},p.id))})]})]})},ue=()=>{const x=Oe(new Date(z)),T=k.filter(F=>{const A=new Date(F.date);return A>=x[0]&&A<=x[6]}),R=new Map;return w.forEach(F=>{R.set(F.id,new Map),x.forEach(A=>{const re=pe(A);R.get(F.id).set(re,[])})}),T.forEach(F=>{const A=R.get(F.staffId);if(A){const re=A.get(F.date)||[];re.push(F),A.set(F.date,re)}}),e.jsxs("div",{className:"shift-board week-view",children:[e.jsx("div",{className:"week-header",children:e.jsxs("h2",{children:[pe(x[0])," to ",pe(x[6])]})}),e.jsxs("div",{className:"week-table",children:[e.jsxs("div",{className:"week-row header-row",children:[e.jsx("div",{className:"staff-cell",children:"Staff"}),x.map(F=>e.jsxs("div",{className:"day-cell",children:[e.jsx("div",{children:F.toLocaleDateString("en-US",{weekday:"short"})}),e.jsx("div",{className:"date-num",children:Je(F)})]},pe(F)))]}),w.map(F=>e.jsxs("div",{className:"week-row",children:[e.jsx("div",{className:"staff-cell",children:e.jsxs("div",{className:"staff-info",style:{borderLeftColor:De[F.role]||"#999"},children:[e.jsxs("span",{className:"staff-name",children:[F.firstName," ",F.lastName]}),e.jsx("span",{className:"staff-role",children:F.role})]})}),x.map(A=>{var p;const re=pe(A),r=((p=R.get(F.id))==null?void 0:p.get(re))||[];return e.jsx("div",{className:"day-cell",children:r.map(c=>e.jsx("div",{className:"week-shift",style:{backgroundColor:De[c.staffRole]||"#999"},title:`${c.startTime}-${c.endTime}`,children:e.jsxs("small",{children:[c.startTime,"-",c.endTime]})},c.id))},re)})]},F.id))]})]})},ie=()=>{const x=new Date(z),T=x.getFullYear(),R=x.getMonth(),F=new Date(T,R,1),A=new Date(T,R+1,0),re=new Date(T,R,0).getDate(),r=[];for(let c=F.getDay()-1;c>=0;c--)r.push(new Date(T,R-1,re-c));for(let c=1;c<=A.getDate();c++)r.push(new Date(T,R,c));const p=42-r.length;for(let c=1;c<=p;c++)r.push(new Date(T,R+1,c));return e.jsxs("div",{className:"shift-board month-view",children:[e.jsx("div",{className:"month-header",children:e.jsx("h2",{children:Ge(x)})}),e.jsxs("div",{className:"month-calendar",children:[["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(c=>e.jsx("div",{className:"day-header",children:c},c)),r.map((c,E)=>{const Y=c?pe(c):"",te=c?k.filter(G=>G.date===Y):[],se=c&&c.getMonth()===R;return e.jsxs("div",{className:`month-day ${se?"current":"other"}`,children:[e.jsx("div",{className:"day-number",children:c==null?void 0:c.getDate()}),e.jsx("div",{className:"shift-count",children:te.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"count-badge",children:[te.length," shifts"]}),e.jsx("div",{className:"shift-dots",children:w.map(G=>te.some(ve=>ve.staffId===G.id)?e.jsx("span",{className:"dot",style:{backgroundColor:De[G.role]||"#999"},title:G.firstName},G.id):null)})]})})]},E)})]})]})},ne=new Date(z),K=I==="week"?`Week of ${Je(Oe(ne)[0])}`:I==="month"?Ge(ne):ne.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});return e.jsxs("div",{className:"shift-board-container",children:[e.jsxs("div",{className:"board-header",children:[e.jsxs("div",{className:"view-controls",children:[e.jsx("button",{className:`view-btn ${I==="day"?"active":""}`,onClick:()=>_("day"),children:"Day"}),e.jsx("button",{className:`view-btn ${I==="week"?"active":""}`,onClick:()=>_("week"),children:"Week"}),e.jsx("button",{className:`view-btn ${I==="month"?"active":""}`,onClick:()=>_("month"),children:"Month"})]}),e.jsxs("div",{className:"date-controls",children:[e.jsx("button",{onClick:()=>oe(-1),children:"â† Prev"}),e.jsx("div",{className:"current-date",children:K}),e.jsx("button",{onClick:()=>oe(1),children:"Next â†’"}),e.jsx("input",{type:"date",value:z,onChange:x=>L(x.target.value)})]}),e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-primary",onClick:()=>P(!B),children:"+ Add Staff"}),e.jsx("button",{className:"btn-primary",onClick:()=>g(!X),children:"+ Add Shift"})]})]}),B&&e.jsxs("div",{className:"form-panel",children:[e.jsx("h3",{children:"Add Staff Member"}),e.jsx("input",{type:"text",placeholder:"First Name",value:Q.firstName,onChange:x=>W({...Q,firstName:x.target.value})}),e.jsx("input",{type:"text",placeholder:"Last Name",value:Q.lastName,onChange:x=>W({...Q,lastName:x.target.value})}),e.jsx("input",{type:"email",placeholder:"Email",value:Q.email,onChange:x=>W({...Q,email:x.target.value})}),e.jsxs("select",{value:Q.role,onChange:x=>W({...Q,role:x.target.value}),children:[e.jsx("option",{value:"waiter",children:"Waiter"}),e.jsx("option",{value:"chef",children:"Chef"}),e.jsx("option",{value:"manager",children:"Manager"}),e.jsx("option",{value:"busser",children:"Busser"}),e.jsx("option",{value:"host",children:"Host"}),e.jsx("option",{value:"bartender",children:"Bartender"})]}),e.jsx("button",{onClick:fe,className:"btn-primary",children:"Save Staff"}),e.jsx("button",{onClick:()=>P(!1),className:"btn-secondary",children:"Cancel"})]}),X&&e.jsxs("div",{className:"form-panel",children:[e.jsx("h3",{children:"Create Shift"}),e.jsxs("select",{value:ee.staffId,onChange:x=>de({...ee,staffId:x.target.value}),children:[e.jsx("option",{value:"",children:"Select Staff Member"}),w.map(x=>e.jsxs("option",{value:x.id,children:[x.firstName," ",x.lastName]},x.id))]}),e.jsx("input",{type:"time",value:ee.startTime,onChange:x=>de({...ee,startTime:x.target.value})}),e.jsx("input",{type:"time",value:ee.endTime,onChange:x=>de({...ee,endTime:x.target.value})}),e.jsx("button",{onClick:me,className:"btn-primary",children:"Create Shift"}),e.jsx("button",{onClick:()=>g(!1),className:"btn-secondary",children:"Cancel"})]}),$?e.jsx("p",{children:"Loading..."}):e.jsxs(e.Fragment,{children:[I==="day"&&e.jsx(v,{}),I==="week"&&e.jsx(ue,{}),I==="month"&&e.jsx(ie,{})]})]})}const Mt={empty:"Empty",occupied:"Occupied",reserved:"Reserved",dirty:"Dirty"};function $t({table:m,restaurantId:S,isOpen:w,onClose:s,onStatusChange:k}){const[V,z]=h.useState(!1);if(!w)return null;const L=async I=>{z(!0);try{const _=await fetch(`/api/tables/${S}/${m.tableId}/status?status=${encodeURIComponent(I)}`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:I})});if(_.ok)k(m.tableId,I),s();else{const $=await _.text();console.error("Status update failed:",_.status,_.statusText,$);let H=`Status ${_.status}`;try{H=JSON.parse($).error||H}catch{H=_.statusText||H}alert(`âŒ Failed to update table status: ${H}`)}}catch(_){console.error("Failed to update table status:",_),alert(`âŒ Error updating table status: ${_ instanceof Error?_.message:String(_)}`)}finally{z(!1)}};return e.jsx("div",{className:"modal-overlay",onClick:s,children:e.jsxs("div",{className:"modal-content",onClick:I=>I.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Table ",m.tableNumber]}),e.jsx("button",{className:"modal-close",onClick:s,children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"table-info-section",children:[e.jsx("h3",{children:"Current Status"}),e.jsx("div",{className:"status-badge",style:{color:Tt(m.status)},children:Mt[m.status]})]}),m.status==="occupied"&&e.jsxs("div",{className:"order-info-section",children:[e.jsx("h3",{children:"Order Details"}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Guests:"}),e.jsx("span",{className:"value",children:m.guestCount||"â€”"})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Items Pending:"}),e.jsx("span",{className:"value",children:m.itemsPending||0})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Items Ready:"}),e.jsx("span",{className:"value",children:m.itemsReady||0})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Total:"}),e.jsxs("span",{className:"value",children:[d("common.currency","â‚ª"),(m.orderTotal||0).toFixed(0)]})]})]}),e.jsxs("div",{className:"actions-section",children:[e.jsx("h3",{children:"Actions"}),e.jsxs("div",{className:"actions",children:[m.status!=="dirty"&&e.jsx("button",{className:"action-btn btn-mark-dirty",onClick:()=>L("dirty"),disabled:V,children:"ðŸ§¹ Mark Dirty"}),m.status!=="reserved"&&e.jsx("button",{className:"action-btn btn-reserve",onClick:()=>L("reserved"),disabled:V,children:"ðŸ“… Reserve"}),m.status!=="empty"&&e.jsx("button",{className:"action-btn btn-empty",onClick:()=>L("empty"),disabled:V,children:"âœ” Clear Table"}),m.status==="occupied"&&e.jsx("button",{className:"action-btn btn-view-order",onClick:()=>{window.location.href=`/waiter/${S}/${m.tableNumber}`},disabled:V,children:"ðŸ“‹ View Order"})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn-close",onClick:s,children:"Close"})})]})})}function Tt(m){switch(m){case"empty":return"#4CAF50";case"occupied":return"#FF6B6B";case"reserved":return"#FFC107";case"dirty":return"#9C27B0";default:return"#333"}}const Ee={empty:"#4CAF50",occupied:"#FF6B6B",reserved:"#FFC107",dirty:"#9C27B0"},Ft={empty:d("floor.status.empty","Empty"),occupied:d("floor.status.occupied","Occupied"),reserved:d("floor.status.reserved","Reserved"),dirty:d("floor.status.dirty","Dirty")},Ze="/floor_assets/",Qe=(m,S=1)=>{const w=Number(m);return Number.isFinite(w)?Math.max(.5,Math.min(1.6,w)):S},et=m=>{const S=Number(m);return Number.isFinite(S)?Math.round(S/45)*45:0};function Et({restaurantId:m}){const[S,w]=h.useState([]),[s,k]=h.useState(null),[V,z]=h.useState(new Map),[L,I]=h.useState(!0),[_,$]=h.useState(!0),[H,B]=h.useState(5e3),[P,X]=h.useState(null),[g,Q]=h.useState(!1),[W,ee]=h.useState(1),[de,J]=h.useState({x:0,y:0}),[fe,me]=h.useState(!1),[ge,ye]=h.useState(!1),ae=h.useRef(null),oe=h.useRef(W);h.useEffect(()=>{oe.current=W},[W]);const v=72;h.useEffect(()=>{const r=c=>{c.code==="Space"&&ye(!0)},p=c=>{c.code==="Space"&&(ye(!1),me(!1))};return window.addEventListener("keydown",r),window.addEventListener("keyup",p),()=>{window.removeEventListener("keydown",r),window.removeEventListener("keyup",p)}},[]),h.useEffect(()=>{(async()=>{try{const p=await fetch(`/api/floor-layouts/${m}`);if(p.ok){const c=await p.json();w(c);const E=c.find(Y=>Y.isActive)||c[0];E&&await ue(E.id)}}catch(p){console.error("Failed to load layouts:",p)}finally{I(!1)}})()},[m]);const ue=async r=>{try{const p=await fetch(`/api/floor-layouts/${m}/${r}`);if(p.ok){const c=await p.json();if(k(c),c.tableStatuses){const E=new Map;c.tableStatuses.forEach(Y=>E.set(Y.tableId,Y)),z(E)}requestAnimationFrame(()=>ne(c))}}catch(p){console.error("Failed to load layout:",p)}};h.useEffect(()=>{if(!_||!s)return;const r=setInterval(async()=>{try{const p=await fetch(`/api/floor-layouts/${m}/${s.id}`);if(p.ok){const c=await p.json();if(c.tableStatuses){const E=new Map;c.tableStatuses.forEach(Y=>E.set(Y.tableId,Y)),z(E)}}}catch(p){console.error("Failed to refresh table statuses:",p)}},H);return()=>clearInterval(r)},[m,_,H,s]);const ie=r=>Math.max(.4,Math.min(2.5,r)),ne=r=>{const p=r??s;if(!ae.current||!p)return;const c=ae.current.getBoundingClientRect(),E=p.gridCols*v,Y=p.gridRows*v,te=24,se=ie(Math.min((c.width-te*2)/E,(c.height-te*2)/Y,1.2));ee(se);const G=Math.round((c.width-E*se)/2),Se=Math.round((c.height-Y*se)/2);J({x:G,y:Se})},K=(r,p,c,E=oe.current)=>{if(!ae.current)return;const Y=ae.current.getBoundingClientRect(),te=p-Y.left,se=c-Y.top;J(G=>{const ve=r/(E||1);return{x:Math.round(te-(te-G.x)*ve),y:Math.round(se-(se-G.y)*ve)}}),ee(r)};h.useEffect(()=>{const r=ae.current;if(!r)return;const p=c=>{if(!(c.ctrlKey||c.metaKey))return;c.preventDefault(),c.stopPropagation();const E=oe.current||1,Y=ie(E*(c.deltaY>0?.9:1.1));K(Y,c.clientX,c.clientY,E)};return r.addEventListener("wheel",p,{passive:!1}),()=>r.removeEventListener("wheel",p)},[]);const x=r=>{const p=r.button===1,c=ge&&r.button===0;if(!p&&!c)return;r.preventDefault(),me(!0);const E={x:r.clientX,y:r.clientY},Y={...de},te=G=>{J({x:Y.x+(G.clientX-E.x),y:Y.y+(G.clientY-E.y)})},se=()=>{me(!1),window.removeEventListener("mousemove",te),window.removeEventListener("mouseup",se)};window.addEventListener("mousemove",te),window.addEventListener("mouseup",se)},T=r=>V.get(r)||{tableId:r,tableNumber:0,status:"empty"},R=r=>{X(r),Q(!0)},F=(r,p)=>{const c={...T(r),status:p};z(E=>new Map(E).set(r,c))},A=r=>{if(!r)return"";const p=Math.floor((Date.now()-r)/1e3/60);return p<1?"Just now":p<60?`${p}m`:`${Math.floor(p/60)}h ${p%60}m`},re=r=>r==null?"":`${d("common.currency","â‚ª")}${r.toFixed(0)}`;return L?e.jsx("div",{className:"live-view-loading",children:d("floor.loading","Loading floor layouts...")}):s?e.jsxs("div",{className:"restaurant-live-view",children:[e.jsxs("div",{className:"live-view-header",children:[e.jsxs("div",{className:"header-left",children:[e.jsx("h1",{children:"ðŸ”´ Live Floor View"}),S.length>1&&e.jsx("div",{className:"layout-selector",children:e.jsx("select",{value:s.id,onChange:r=>ue(r.target.value),children:S.map(r=>e.jsxs("option",{value:r.id,children:[r.name," ",r.isActive?"(Active)":""]},r.id))})})]}),e.jsxs("div",{className:"control-panel",children:[e.jsxs("label",{className:"auto-refresh-label",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:r=>$(r.target.checked)}),d("live.auto_refresh","Auto-refresh")]}),e.jsxs("select",{value:H,onChange:r=>B(Number(r.target.value)),disabled:!_,className:"refresh-interval-select",children:[e.jsx("option",{value:3e3,children:"3s"}),e.jsx("option",{value:5e3,children:"5s"}),e.jsx("option",{value:1e4,children:"10s"}),e.jsx("option",{value:15e3,children:"15s"})]}),e.jsxs("button",{className:"refresh-btn",onClick:()=>s&&ue(s.id),children:["ðŸ”„ ",d("common.btn_refresh","Refresh")]})]})]}),e.jsxs("div",{className:`live-view-container ${fe?"is-panning":""}`,ref:ae,onMouseDown:x,children:[e.jsxs("div",{className:"fe-canvas-controls live",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var r,p;return K(ie(W*1.1),(((r=ae.current)==null?void 0:r.getBoundingClientRect().left)||0)+40,(((p=ae.current)==null?void 0:p.getBoundingClientRect().top)||0)+40)},title:"Zoom in",children:"ï¼‹"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var r,p;return K(ie(W*.9),(((r=ae.current)==null?void 0:r.getBoundingClientRect().left)||0)+40,(((p=ae.current)==null?void 0:p.getBoundingClientRect().top)||0)+40)},title:"Zoom out",children:"ï¼"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>ne(),title:"Fit to screen",children:"â¤¢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(W*100),"%"]}),e.jsx("div",{className:"fe-hint",children:ge?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsxs("div",{className:"floor-grid",style:{gridTemplateColumns:`repeat(${s.gridCols}, ${v}px)`,gridTemplateRows:`repeat(${s.gridRows}, ${v}px)`,transform:`translate(${de.x}px, ${de.y}px) scale(${W})`,transformOrigin:"0 0"},"data-floor-theme":String(s.floorColor||""),children:[(s.objects??[]).map(r=>e.jsxs("div",{className:`floor-object-live type-${r.type}`,style:{gridColumn:`${r.gridX+1} / span ${r.spanX}`,gridRow:`${r.gridY+1} / span ${r.spanY}`,transform:`rotate(${et(r.rotationDeg??r.rotation??0)}deg)`},title:r.label||r.type,children:[r.assetFile?e.jsx("img",{className:"live-asset",src:`${Ze}${r.assetFile}`,alt:"",style:{transform:`scale(${Qe(r.scale,1)})`,width:"100%",height:"100%",objectFit:"contain",display:"block"}}):e.jsx("span",{className:"obj-icon",children:r.type==="wall"?"ðŸ§±":r.type==="door"?"ðŸšª":r.type==="bar"?"ðŸ¸":r.type==="plant"?"ðŸª´":"âž–"}),r.label?e.jsx("span",{className:"obj-label",children:r.label}):null]},r.id)),s.tables.map(r=>{const p=T(r.id),c=A(p.occupiedSince);return e.jsxs("div",{className:`table-card table-${r.shape} status-${p.status}`,style:{gridColumn:`${r.gridX+1} / span ${r.spanX}`,gridRow:`${r.gridY+1} / span ${r.spanY}`,borderColor:Ee[p.status]},onClick:()=>R(p),children:[e.jsx("div",{className:"table-number",children:r.tableNumber||p.tableNumber}),r.assetFile?e.jsx("img",{className:"live-asset",src:`${Ze}${r.assetFile}`,alt:"",style:{width:"100%",height:"100%",objectFit:"contain",display:"block",transform:`rotate(${et(r.rotationDeg??0)}deg) scale(${Qe(r.scale,1)})`}}):null,p.status==="occupied"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"table-info",children:[e.jsxs("span",{className:"guests",children:["ðŸ‘¥ ",p.guestCount||"-"]}),e.jsx("span",{className:"seated",children:c})]}),e.jsxs("div",{className:"order-summary",children:[p.itemsPending?e.jsxs("span",{className:"pending",children:["â³ ",p.itemsPending]}):null,p.itemsReady?e.jsxs("span",{className:"ready",children:["âœ… ",p.itemsReady]}):null,p.orderTotal?e.jsx("span",{className:"total",children:re(p.orderTotal)}):null]})]}),p.status==="reserved"&&e.jsx("div",{className:"table-info",children:e.jsx("span",{children:d("floor.status.reserved","Reserved")})}),p.status==="dirty"&&e.jsx("div",{className:"table-info",children:e.jsxs("span",{children:["ðŸ§¹ ",d("floor.status_text.dirty","Needs cleaning")]})}),p.status==="empty"&&e.jsx("div",{className:"table-info",children:e.jsx("span",{children:d("floor.status_text.available","Available")})})]},r.id)})]})]}),e.jsxs("div",{className:"live-view-footer",children:[e.jsxs("div",{className:"status-legend",children:[e.jsx("h3",{children:d("live.status_legend","Status Legend")}),e.jsx("div",{className:"legend-items",children:Object.entries(Ee).map(([r,p])=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-color",style:{backgroundColor:p,opacity:r==="empty"?.6:1}}),e.jsx("span",{children:Ft[r]})]},r))})]}),e.jsxs("div",{className:"stats-panel",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.total_tables","Total Tables:")}),e.jsx("span",{className:"value",children:s.tables.length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.occupied","Occupied:")}),e.jsx("span",{className:"value",style:{color:Ee.occupied},children:Array.from(V.values()).filter(r=>r.status==="occupied").length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.empty","Empty:")}),e.jsx("span",{className:"value",style:{color:Ee.empty},children:Array.from(V.values()).filter(r=>r.status==="empty").length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"label",children:d("live.stats.occupancy","Occupancy:")}),e.jsxs("span",{className:"value",children:[s.tables.length>0?Math.round(Array.from(V.values()).filter(r=>r.status==="occupied").length/s.tables.length*100):0,"%"]})]})]})]}),P&&e.jsx($t,{table:P,restaurantId:m,isOpen:g,onClose:()=>Q(!1),onStatusChange:F})]}):e.jsx("div",{className:"live-view-error",children:e.jsx("p",{children:d("floor.empty_state","No floor layouts found. Please create a floor layout first.")})})}function Yt(){const[m,S]=h.useState("edit"),w=window.__APP_CONFIG__||{},s=new URLSearchParams(window.location.search),k=w.restaurantId||s.get("restaurantId")||"";return(w.page||s.get("page")||"floor")==="shifts"?e.jsx("div",{className:"app shifts-app",children:e.jsx(Dt,{restaurantId:k})}):e.jsxs("div",{className:"app",children:[e.jsxs("header",{className:"app-header",children:[e.jsx("h1",{children:"Floor Plan Manager"}),e.jsxs("nav",{className:"mode-switch","aria-label":"View mode",children:[e.jsx("button",{className:m==="edit"?"active":"",onClick:()=>S("edit"),"aria-pressed":m==="edit","aria-label":"Switch to edit layout mode",children:"Edit Layout"}),e.jsx("button",{className:m==="live"?"active":"",onClick:()=>S("live"),"aria-pressed":m==="live","aria-label":"Switch to live view mode",children:"Live View"})]})]}),e.jsx("main",{className:"app-main",children:m==="edit"?e.jsx(wt,{restaurantId:k}):e.jsx(Et,{restaurantId:k})})]})}class Lt extends h.Component{constructor(w){super(w);He(this,"handleRetry",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(w){return{hasError:!0,error:w}}componentDidCatch(w,s){console.error("[ErrorBoundary] caught:",w,s.componentStack)}render(){var w;return this.state.hasError?this.props.fallback?this.props.fallback:e.jsxs("div",{style:{padding:"2rem",textAlign:"center",color:"#e6e8ef",background:"#1a1d2e",borderRadius:"12px",margin:"2rem"},children:[e.jsx("h2",{children:"Something went wrong"}),e.jsx("p",{style:{color:"#9aa3b2",marginBottom:"1rem"},children:((w=this.state.error)==null?void 0:w.message)||"An unexpected error occurred"}),e.jsx("button",{onClick:this.handleRetry,style:{padding:"0.5rem 1.5rem",background:"#6c5ce7",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.95rem"},children:"Try Again"})]}):this.props.children}}function Xt(){var S;if((S=window.__APP_CONFIG__)!=null&&S.lang)return window.__APP_CONFIG__.lang;const m=document.cookie.match(/(?:^|; )lang=([^;]*)/);return m?m[1]:"en"}xt(Xt()).then(()=>{jt.createRoot(document.getElementById("root")).render(e.jsx(yt.StrictMode,{children:e.jsx(Lt,{children:e.jsx(St,{children:e.jsx(Yt,{})})})}))});
