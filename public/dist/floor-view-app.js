import{r as p,j as e,R as x,c as oe}from"./floor-index.js";const m="/floor_assets/",J=(r,a=1)=>{const d=Number(r);return Number.isFinite(d)?Math.max(.5,Math.min(1.6,d)):a},Q=r=>{const a=Number(r);return Number.isFinite(a)?Math.round(a/45)*45:0},le=r=>{if(!r||r.startsWith("#"))return"parquet_blue";const a=r;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function ce(r){return{parquet_blue:{bg:`url(${m}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${m}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${m}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${m}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${m}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[r]}function ue(r,a){const d=String(r||"square").toLowerCase(),f=Number(a||0);return d==="round"?`${m}${f>=9?"round_table_10.svg":"round_table4.svg"}`:d==="booth"?`${m}${f>=6?"large_booth.svg":"booth4.svg"}`:d==="rect"?`${m}${f>=10?"square_table10.svg":f>=6?"square_table6.svg":f>=4?"square_table4.svg":"square_table2.svg"}`:`${m}${f>=10?"square_table10.svg":f>=6?"square_table6.svg":f>=4?"square_table4.svg":"square_table2.svg"}`}function de(r,a){const d=String(r||"").toLowerCase();return d==="door"?`${m}door.svg`:d==="wall"?`${m}wall.svg`:d==="divider"?`${m}divider.svg`:d==="chair"?`${m}chair.svg`:d==="bar"?`${m}bar.svg`:d==="plant"?`${m}plant.svg`:a?`${m}${a}.svg`:`${m}divider.svg`}function ve({layout:r,mode:a,onTableClick:d,selectedTableId:f}){const B=a==="edit",g=p.useRef(null),T=p.useRef(null),[C,Z]=p.useState(1),[S,F]=p.useState({x:0,y:0}),[q,y]=p.useState(!1),[H,N]=p.useState(!1),j=p.useRef(C);p.useEffect(()=>{j.current=C},[C]);const v=p.useRef(null),c=60,A=p.useMemo(()=>le(r.floorColor),[r==null?void 0:r.id]),I=p.useMemo(()=>ce(A),[A]);p.useEffect(()=>{const s=n=>{n.code==="Space"&&y(!0)},t=n=>{n.code==="Space"&&(y(!1),N(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",t)}},[]);const z=s=>Math.max(.4,Math.min(2.5,s)),E=()=>{if(!g.current||!T.current)return;const s=g.current,t=T.current,n=getComputedStyle(t),b=(parseFloat(n.marginLeft)||0)+(parseFloat(n.marginRight)||0),i=(parseFloat(n.marginTop)||0)+(parseFloat(n.marginBottom)||0),w=t.offsetWidth+b,o=t.offsetHeight+i;if(!w||!o)return;const $=getComputedStyle(s),M=parseFloat($.paddingLeft||"0")||0,P=parseFloat($.paddingRight||"0")||0,L=parseFloat($.paddingTop||"0")||0,Y=parseFloat($.paddingBottom||"0")||0,l=24,_=Math.max(1,s.clientWidth-M-P-l*2),X=Math.max(1,s.clientHeight-L-Y-l*2),R=z(Math.min(_/w,X/o,1.2));Z(R);const W=Math.round(M+l+(_-w*R)/2),G=Math.round(L+l+(X-o*R)/2);F({x:W,y:G})};p.useEffect(()=>{requestAnimationFrame(E)},[r==null?void 0:r.id]),p.useEffect(()=>{if(!g.current)return;let s=0;const t=new ResizeObserver(()=>{cancelAnimationFrame(s),s=requestAnimationFrame(E)});return t.observe(g.current),()=>{cancelAnimationFrame(s),t.disconnect()}},[r==null?void 0:r.id]);const u=(s,t,n)=>{if(!g.current)return;const b=g.current.getBoundingClientRect(),i=t-b.left,w=n-b.top;F(o=>{const $=s/(j.current||1);return{x:Math.round(i-(i-o.x)*$),y:Math.round(w-(w-o.y)*$)}}),Z(s)};p.useEffect(()=>{const s=g.current;if(!s)return;const t=n=>{if(!!!(n.ctrlKey||n.metaKey)||(n.preventDefault(),!B))return;const i=n.deltaY>0?.9:1.1,w=z((j.current||1)*i);u(w,n.clientX,n.clientY)};return s.addEventListener("wheel",t,{passive:!1}),()=>s.removeEventListener("wheel",t)},[B]);const k=s=>{const t=s.target;if(a==="view"){if(s.button!==0||t!=null&&t.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),v.current={moved:!1};const M={x:s.clientX,y:s.clientY},P={...S};let L=!1;const Y=_=>{const X=_.clientX-M.x,R=_.clientY-M.y,W=Math.abs(X)+Math.abs(R);!L&&W>4&&(L=!0,v.current&&(v.current.moved=!0),N(!0)),L&&F({x:P.x+X,y:P.y+R})},l=()=>{L&&N(!1),window.removeEventListener("mousemove",Y),window.removeEventListener("mouseup",l),v.current&&!v.current.moved&&(v.current=null)};window.addEventListener("mousemove",Y),window.addEventListener("mouseup",l);return}const n=s.button===1,b=q&&s.button===0;if(!n&&!b)return;s.preventDefault(),N(!0);const i={x:s.clientX,y:s.clientY},w={...S},o=M=>{F({x:w.x+(M.clientX-i.x),y:w.y+(M.clientY-i.y)})},$=()=>{N(!1),window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",$)};window.addEventListener("mousemove",o),window.addEventListener("mouseup",$)},h=p.useRef(null),K=s=>{if(a!=="view"||s.touches.length!==1)return;const t=s.touches[0],n=s.target;n!=null&&n.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),N(!0),h.current={startX:t.clientX,startY:t.clientY,panX:S.x,panY:S.y,active:!0})},U=s=>{if(a!=="view")return;const t=h.current;if(!t||!t.active||s.touches.length!==1)return;const n=s.touches[0];s.preventDefault(),F({x:t.panX+(n.clientX-t.startX),y:t.panY+(n.clientY-t.startY)})},re=()=>{a==="view"&&(h.current=null,N(!1))},O=s=>Math.max(1,Number(s)||1)*c,V=s=>{const t=(s||"").toLowerCase();return t.includes("occup")||t==="busy"||t==="taken"?"occupied":t.includes("reserv")||t.includes("book")?"reserved":t.includes("dirty")||t.includes("need")||t.includes("clean")?"dirty":"empty"},ne=p.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=t&&t.tableId?String(t.tableId):"";n&&s.set(n,{status:V(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),ae=p.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=Number(t&&(t.tableNumber??0));!Number.isFinite(n)||n<=0||s.set(n,{status:V(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),ie=s=>{const t=s.id?ne.get(String(s.id)):void 0;if(t)return t;const n=Number(s.tableNumber??0);if(Number.isFinite(n)&&n>0){const b=ae.get(n);if(b)return b}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${H?"is-panning":""}`,ref:g,onMouseDown:k,onTouchStart:K,onTouchMove:U,onTouchEnd:re,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[B?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=g.current)==null?void 0:t.getBoundingClientRect();u(z(C*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=g.current)==null?void 0:t.getBoundingClientRect();u(z(C*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"})]}):null,e.jsx("button",{className:"btn-icon-small",onClick:E,title:"Center",children:"⤢"}),B?e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(C*100),"%"]}):null,e.jsx("div",{className:"fe-hint",children:a==="view"?"Drag to pan":q?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:T,onClickCapture:s=>{var t;a==="view"&&(t=v.current)!=null&&t.moved&&(s.preventDefault(),s.stopPropagation(),v.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${r.gridCols}, ${c}px)`,gridTemplateRows:`repeat(${r.gridRows}, ${c}px)`,transform:`translate(${S.x}px, ${S.y}px) scale(${C})`,transformOrigin:"0 0","--cell":`${c}px`,"--floor-bg":I.bg,"--floor-bg-size":I.size,"--floor-bg-repeat":I.repeat,"--floor-bg-position":I.pos},children:Array.from({length:r.gridRows*r.gridCols}).map((s,t)=>{var Y;const n=Math.floor(t/r.gridCols),b=t%r.gridCols,i=r.tables.find(l=>b>=l.gridX&&b<l.gridX+(l.spanX||1)&&n>=l.gridY&&n<l.gridY+(l.spanY||1)),o=(r.objects??[]).find(l=>b>=l.gridX&&b<l.gridX+(l.spanX||1)&&n>=l.gridY&&n<l.gridY+(l.spanY||1)),$=!!i&&i.gridX===b&&i.gridY===n,M=!!o&&o.gridX===b&&o.gridY===n,P=n*r.gridCols+b,L=(((Y=r.gridMask)==null?void 0:Y[P])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${L?"active":"inactive"}`,children:[M&&o&&e.jsxs("div",{className:`floor-object type-${o.type}`,style:{width:`${O(o.spanX)}px`,height:`${O(o.spanY)}px`,transform:`rotate(${Q(o.rotationDeg??o.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(o.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${J(o.scale,1)})`},src:o.assetFile?`${m}${o.assetFile}`:de(o.type,o.label),alt:""}),o.label&&e.jsx("div",{className:"obj-label",children:o.label})]}),$&&i&&(()=>{const l=ie(i),_=String(l.status||"empty"),X=f&&String(f)===String(i.id),R=a==="view",W=_==="occupied"?"תפוס":_==="reserved"?"שמור":_==="dirty"?"מלוכלך":"פנוי",G=l.guestCount!=null&&l.guestCount!==""?` · ${l.guestCount}`:"";return e.jsxs("div",{className:`table ${String(i.shape||"square")} ${X?"selected":""}`,onClick:()=>d==null?void 0:d(i.id),style:{position:"absolute",top:0,left:0,width:`${O(i.spanX)}px`,height:`${O(i.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":i.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(i.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${Q(i.rotationDeg??i.rotation??0)}deg) scale(${J(i.scale,1)})`},src:i.assetFile?`${m}${i.assetFile}`:ue(i.shape,i.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:i.name||(i.tableNumber!=null?`Table ${i.tableNumber}`:"Table")}),i.seats!=null&&e.jsxs("div",{className:"table-seats",children:[i.seats," seats"]})]}),R&&e.jsxs("div",{className:`sbv-status-pill is-${_}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[W,G]})]})]})})()]},t)})})]})}function me(r){const a=(r||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function be(r){switch(r){case"occupied":return"תפוס";case"reserved":return"שמור";case"dirty":return"מלוכלך";default:return"פנוי"}}function pe({restaurantId:r,mountMode:a="page"}){const[d,f]=x.useState([]),[B,g]=x.useState(null),[T,C]=x.useState(null),[Z,S]=x.useState(!0),[F,q]=x.useState(null),[y,H]=x.useState(null),N=x.useCallback(async()=>{try{const u=await fetch(`/api/floor-layouts/${r}/active`,{headers:{"Content-Type":"application/json"}});if(!u.ok)throw new Error(`HTTP ${u.status}`);const k=await u.json(),h=k&&k.id?k:(k==null?void 0:k.activeLayout)??null;if(!h){f([]),g(null),C(null),q("אין מפת מסעדה פעילה"),S(!1);return}f([h]),g(h.id),C(K=>K??h.id),q(null),S(!1),y&&((h.tables||[]).some(U=>String(U.id)===String(y))||H(null))}catch(u){q(`שגיאה בטעינת המפה: ${(u==null?void 0:u.message)??"unknown"}`),S(!1)}},[r,y]);x.useEffect(()=>{N();const u=setInterval(N,5e3);return()=>clearInterval(u)},[N]);const j=x.useMemo(()=>T?d.find(u=>u.id===T)??null:null,[d,T]),v=x.useMemo(()=>!j||!y?null:(j.tables||[]).find(u=>String(u.id)===String(y))??null,[j,y]),c=x.useMemo(()=>{if(!j||!v)return null;const u=j.tableStatuses;if(!Array.isArray(u))return null;const k=u.find(h=>String(h.tableId)===String(v.id));return k||(u.find(h=>h.tableNumber===v.number)??null)},[j,v]),A=x.useMemo(()=>me(c==null?void 0:c.status),[c]),I=u=>{H(u)},z=()=>H(null),E=`floor-editor sb-floor-view ${a==="lobby"?"is-embed":""}`;return Z?e.jsx("div",{className:E,children:e.jsx("div",{className:"sbv-loading",children:"טוען מפת מסעדה…"})}):F||!j?e.jsx("div",{className:E,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:"לא ניתן לטעון את מפת המסעדה"}),e.jsx("div",{className:"sbv-error-sub",children:F??"קרתה שגיאה בטעינת המפה"}),e.jsx("button",{className:"sbv-retry",onClick:N,children:"נסה שוב"})]})}):e.jsxs("div",{className:E,children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:"עדכון סידור שולחנות"}),e.jsx("div",{className:"sbv-topbar-sub",children:"גרור כדי להזיז • ⤢ למרכז למסך"})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," פנוי"]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," תפוס"]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," שמור"]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," מלוכלך"]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(ve,{layout:j,selectedTableId:y,onTableClick:I,mode:"view"})}),y&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:z}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-close",onClick:z,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:["שולחן ",(v==null?void 0:v.number)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${A}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:"סטטוס שולחן"}),e.jsx("span",{className:"sbv-status-value",children:be(A)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שם המזמין"}),e.jsx("div",{className:"sbv-kv-val",children:(c==null?void 0:c.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-kv-val",children:(c==null?void 0:c.guestCount)!=null?String(c.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-kv-val",children:(c==null?void 0:c.reservationTime)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-kv-val",children:(c==null?void 0:c.itemsCount)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-kv-val",children:(c==null?void 0:c.subtotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:A==="occupied"&&(v!=null&&v.number)?e.jsx("a",{className:"sbv-primary-btn",href:`/waiter/${r}/${v.number}`,children:"פתח הזמנה"}):e.jsx("button",{className:"sbv-secondary-btn",onClick:z,children:"סגור"})})]})]})]})}const D=document.getElementById("sb-floor-root");if(!D)throw new Error("Missing #sb-floor-root");const ee=D.getAttribute("data-rid")||D.getAttribute("data-restaurant-id")||"",se=D.getAttribute("data-click-mode")||D.getAttribute("data-mode")||"page",te=se==="lobby"?"lobby":"page";console.info("[FloorView] mount",{rid:ee,mountMode:te,clickMode:se});oe.createRoot(D).render(e.jsx(x.StrictMode,{children:e.jsx(pe,{restaurantId:ee,mountMode:te})}));
