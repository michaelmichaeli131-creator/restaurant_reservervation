import{r as x,j as e,R as h,t as u,c as ce}from"./floor-index.js";const p="/floor_assets/",ne=(r,n=1)=>{const b=Number(r);return Number.isFinite(b)?Math.max(.5,Math.min(1.6,b)):n},ae=r=>{const n=Number(r);return Number.isFinite(n)?Math.round(n/45)*45:0},ue=r=>{if(!r||r.startsWith("#"))return"parquet_blue";const n=r;return n==="parquet_blue"||n==="parquet_brown"||n==="slate_dark"||n==="navy_carpet"||n==="teal_terrazzo"?n:"parquet_blue"};function de(r){return{parquet_blue:{bg:`url(${p}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${p}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${p}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${p}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${p}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[r]}function ve(r,n){const b=String(r||"square").toLowerCase(),N=Number(n||0);return b==="round"?`${p}${N>=9?"round_table_10.svg":"round_table4.svg"}`:b==="booth"?`${p}${N>=6?"large_booth.svg":"booth4.svg"}`:b==="rect"?`${p}${N>=10?"square_table10.svg":N>=6?"square_table6.svg":N>=4?"square_table4.svg":"square_table2.svg"}`:`${p}${N>=10?"square_table10.svg":N>=6?"square_table6.svg":N>=4?"square_table4.svg":"square_table2.svg"}`}function be(r,n){const b=String(r||"").toLowerCase();return b==="door"?`${p}door.svg`:b==="wall"?`${p}wall.svg`:b==="divider"?`${p}divider.svg`:b==="chair"?`${p}chair.svg`:b==="bar"?`${p}bar.svg`:b==="plant"?`${p}plant.svg`:n?`${p}${n}.svg`:`${p}divider.svg`}function me({layout:r,mode:n,onTableClick:b,selectedTableId:N}){const k=x.useRef(null),B=x.useRef(null),[M,Z]=x.useState(1),[A,z]=x.useState({x:0,y:0}),[G,O]=x.useState(!1),[y,_]=x.useState(!1),$=x.useRef(null),H=60,L=x.useMemo(()=>ue(r.floorColor),[r==null?void 0:r.id]),q=x.useMemo(()=>de(L),[L]);x.useEffect(()=>{const t=a=>{a.code==="Space"&&O(!0)},s=a=>{a.code==="Space"&&(O(!1),_(!1))};return window.addEventListener("keydown",t),window.addEventListener("keyup",s),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",s)}},[]);const F=t=>Math.max(n==="view"?.01:.4,Math.min(2.5,t)),g=()=>{if(!k.current||!B.current)return;const t=k.current,s=B.current,a=getComputedStyle(s),f=(parseFloat(a.marginLeft)||0)+(parseFloat(a.marginRight)||0),i=(parseFloat(a.marginTop)||0)+(parseFloat(a.marginBottom)||0),R=s.offsetWidth+f,l=s.offsetHeight+i;if(!R||!l)return;const w=getComputedStyle(t);let C=parseFloat(w.paddingLeft||"0")||0,I=parseFloat(w.paddingRight||"0")||0,T=parseFloat(w.paddingTop||"0")||0,X=parseFloat(w.paddingBottom||"0")||0;n==="view"&&(C=0,I=0,T=0,X=0);const c=n==="view"?0:24,S=Math.max(1,t.clientWidth-C-I-c*2),P=Math.max(1,t.clientHeight-T-X-c*2),K=n==="view"?1:1.2,D=F(Math.min(S/R,P/l,K));Z(D);const se=Math.round(C+c+(S-R*D)/2),le=Math.round(T+c+(P-l*D)/2);z({x:se,y:le})};x.useEffect(()=>{requestAnimationFrame(g)},[r==null?void 0:r.id]),x.useEffect(()=>{if(!k.current)return;let t=0;const s=new ResizeObserver(()=>{cancelAnimationFrame(t),t=requestAnimationFrame(g)});return s.observe(k.current),()=>{cancelAnimationFrame(t),s.disconnect()}},[r==null?void 0:r.id]);const V=(t,s,a)=>{if(!k.current)return;const f=k.current.getBoundingClientRect(),i=s-f.left,R=a-f.top;z(l=>{const w=t/M;return{x:Math.round(i-(i-l.x)*w),y:Math.round(R-(R-l.y)*w)}}),Z(t)},d=t=>{if(!(t.ctrlKey||t.metaKey))return;t.preventDefault();const s=F(M*(t.deltaY>0?.9:1.1));V(s,t.clientX,t.clientY)},v=t=>{const s=t.target;if(n==="view"){if(t.button!==0||s!=null&&s.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;t.preventDefault(),$.current={moved:!1};const C={x:t.clientX,y:t.clientY},I={...A};let T=!1;const X=S=>{const P=S.clientX-C.x,K=S.clientY-C.y,D=Math.abs(P)+Math.abs(K);!T&&D>4&&(T=!0,$.current&&($.current.moved=!0),_(!0)),T&&z({x:I.x+P,y:I.y+K})},c=()=>{T&&_(!1),window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",c),$.current&&!$.current.moved&&($.current=null)};window.addEventListener("mousemove",X),window.addEventListener("mouseup",c);return}const a=t.button===1,f=G&&t.button===0;if(!a&&!f)return;t.preventDefault(),_(!0);const i={x:t.clientX,y:t.clientY},R={...A},l=C=>{z({x:R.x+(C.clientX-i.x),y:R.y+(C.clientY-i.y)})},w=()=>{_(!1),window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",w)};window.addEventListener("mousemove",l),window.addEventListener("mouseup",w)},Y=x.useRef(null),ee=t=>{if(n!=="view"||t.touches.length!==1)return;const s=t.touches[0],a=t.target;a!=null&&a.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(t.preventDefault(),_(!0),Y.current={startX:s.clientX,startY:s.clientY,panX:A.x,panY:A.y,active:!0})},Q=t=>{if(n!=="view")return;const s=Y.current;if(!s||!s.active||t.touches.length!==1)return;const a=t.touches[0];t.preventDefault(),z({x:s.panX+(a.clientX-s.startX),y:s.panY+(a.clientY-s.startY)})},te=()=>{n==="view"&&(Y.current=null,_(!1))},E=t=>Math.max(1,Number(t)||1)*H,o=t=>{const s=(t||"").toLowerCase();return s.includes("occup")||s==="busy"||s==="taken"?"occupied":s.includes("reserv")||s.includes("book")?"reserved":s.includes("dirty")||s.includes("need")||s.includes("clean")?"dirty":"empty"},m=x.useMemo(()=>{const t=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(s=>{const a=s&&s.tableId?String(s.tableId):"";a&&t.set(a,{status:o(String(s.status||"empty")),guestName:s.guestName??null,guestCount:s.guestCount??null,orderId:s.orderId??null})}),t},[r]),j=x.useMemo(()=>{const t=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(s=>{const a=Number(s&&(s.tableNumber??0));!Number.isFinite(a)||a<=0||t.set(a,{status:o(String(s.status||"empty")),guestName:s.guestName??null,guestCount:s.guestCount??null,orderId:s.orderId??null})}),t},[r]),W=t=>{const s=t.id?m.get(String(t.id)):void 0;if(s)return s;const a=Number(t.tableNumber??0);if(Number.isFinite(a)&&a>0){const f=j.get(a);if(f)return f}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${y?"is-panning":""}`,ref:k,onWheel:d,onMouseDown:v,onTouchStart:ee,onTouchMove:Q,onTouchEnd:te,style:{position:"relative",direction:"ltr"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var s;const t=(s=k.current)==null?void 0:s.getBoundingClientRect();V(F(M*1.1),((t==null?void 0:t.left)||0)+40,((t==null?void 0:t.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var s;const t=(s=k.current)==null?void 0:s.getBoundingClientRect();V(F(M*.9),((t==null?void 0:t.left)||0)+40,((t==null?void 0:t.top)||0)+40)},title:"Zoom out",children:"－"}),e.jsx("button",{className:"btn-icon-small",onClick:g,title:"Fit to screen",children:"⤢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(M*100),"%"]}),e.jsx("div",{className:"fe-hint",children:G?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:B,onClickCapture:t=>{var s;n==="view"&&(s=$.current)!=null&&s.moved&&(t.preventDefault(),t.stopPropagation(),$.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${r.gridCols}, ${H}px)`,gridTemplateRows:`repeat(${r.gridRows}, ${H}px)`,transform:`translate(${A.x}px, ${A.y}px) scale(${M})`,transformOrigin:"0 0","--cell":`${H}px`,"--floor-bg":q.bg,"--floor-bg-size":q.size,"--floor-bg-repeat":q.repeat,"--floor-bg-position":q.pos},children:Array.from({length:r.gridRows*r.gridCols}).map((t,s)=>{var X;const a=Math.floor(s/r.gridCols),f=s%r.gridCols,i=r.tables.find(c=>f>=c.gridX&&f<c.gridX+(c.spanX||1)&&a>=c.gridY&&a<c.gridY+(c.spanY||1)),l=(r.objects??[]).find(c=>f>=c.gridX&&f<c.gridX+(c.spanX||1)&&a>=c.gridY&&a<c.gridY+(c.spanY||1)),w=!!i&&i.gridX===f&&i.gridY===a,C=!!l&&l.gridX===f&&l.gridY===a,I=a*r.gridCols+f,T=(((X=r.gridMask)==null?void 0:X[I])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${T?"active":"inactive"}`,children:[C&&l&&e.jsxs("div",{className:`floor-object type-${l.type}`,style:{width:`${E(l.spanX)}px`,height:`${E(l.spanY)}px`,transform:`rotate(${ae(l.rotationDeg??l.rotation??0)}deg)`,cursor:n==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(l.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${ne(l.scale,1)})`},src:l.assetFile?`${p}${l.assetFile}`:be(l.type,l.label),alt:""}),l.label&&e.jsx("div",{className:"obj-label",children:l.label})]}),w&&i&&(()=>{const c=W(i),S=String(c.status||"empty"),P=N&&String(N)===String(i.id),K=n==="view",D=S==="occupied"?"תפוס":S==="reserved"?"שמור":S==="dirty"?"מלוכלך":"פנוי",se=c.guestCount!=null&&c.guestCount!==""?` · ${c.guestCount}`:"";return e.jsxs("div",{className:`table floor-table status-${S} ${String(i.shape||"square")} ${P?"is-selected":""}`,onClick:()=>b==null?void 0:b(i.id),style:{position:"absolute",top:0,left:0,width:`${E(i.spanX)}px`,height:`${E(i.spanY)}px`,cursor:n==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":i.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(i.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${ae(i.rotationDeg??i.rotation??0)}deg) scale(${ne(i.scale,1)})`},src:i.assetFile?`${p}${i.assetFile}`:ve(i.shape,i.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:i.name||(i.tableNumber!=null?`Table ${i.tableNumber}`:"Table")}),i.seats!=null&&e.jsxs("div",{className:"table-seats",children:[i.seats," seats"]})]}),K&&e.jsxs("div",{className:`sbv-status-pill is-${S}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[D,se]})]})]})})()]},s)})})]})}function pe(r){const n=(r||"").toLowerCase();return n==="occupied"||n==="busy"||n==="taken"?"occupied":n==="reserved"||n==="booked"?"reserved":n==="dirty"||n==="needs_cleaning"?"dirty":"empty"}function J(r){return u(`floor.status.${r}`,r)}function fe({restaurantId:r,mountMode:n="page"}){const[b,N]=h.useState([]),[k,B]=h.useState(null),[M,Z]=h.useState(null),[A,z]=h.useState(!0),[G,O]=h.useState(null),[y,_]=h.useState(null),[$,H]=h.useState([]),[L,q]=h.useState(null);h.useEffect(()=>{(async()=>{try{const o=await fetch(`/api/floor-sections/${r}`);if(!o.ok)return;const m=await o.json(),j=Array.isArray(m)?m:(m==null?void 0:m.sections)??[];j.sort((W,t)=>(W.displayOrder??0)-(t.displayOrder??0)),H(j)}catch{}})()},[r]);const F=h.useCallback(async()=>{try{const o=await fetch(`/api/floor-layouts/${r}/active`,{headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`HTTP ${o.status}`);const m=await o.json(),j=m&&m.id?m:(m==null?void 0:m.activeLayout)??null;if(!j){N([]),B(null),Z(null),O(u("host.no_floor_plan","No active floor plan")),z(!1);return}N([j]),B(j.id),Z(W=>W??j.id),O(null),z(!1),y&&((j.tables||[]).some(t=>String(t.id)===String(y))||_(null))}catch(o){O(u("host.err_load_map","Error loading floor map")+`: ${(o==null?void 0:o.message)??"unknown"}`),z(!1)}},[r,y]);h.useEffect(()=>{F();const o=setInterval(F,5e3);return()=>clearInterval(o)},[F]);const g=h.useMemo(()=>M?b.find(o=>o.id===M)??null:null,[b,M]),V=h.useMemo(()=>g?L?{...g,tables:(g.tables||[]).filter(o=>o.sectionId===L)}:g:null,[g,L]),d=h.useMemo(()=>!g||!y?null:(g.tables||[]).find(o=>String(o.id)===String(y))??null,[g,y]),v=h.useMemo(()=>{if(!g||!d)return null;const o=g.tableStatuses;if(!Array.isArray(o))return null;const m=o.find(j=>String(j.tableId)===String(d.id));return m||(o.find(j=>j.tableNumber===d.number)??null)},[g,d]),Y=h.useMemo(()=>pe(v==null?void 0:v.status),[v]),ee=o=>{_(o)},Q=()=>_(null),te=async()=>{const o=(d==null?void 0:d.number)??(d==null?void 0:d.tableNumber);if(o)try{await fetch("/api/host/table/clean",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({restaurantId:r,table:o})}),await F()}catch(m){console.error("Failed to mark table clean:",m)}},E=`floor-editor sb-floor-view ${n==="lobby"?"is-embed":""}`;return A?e.jsx("div",{className:E,children:e.jsx("div",{className:"sbv-loading",children:u("floor.loading","Loading floor plan...")})}):G||!g?e.jsx("div",{className:E,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:u("host.err_load_map","Cannot load floor map")}),e.jsx("div",{className:"sbv-error-sub",children:G??u("host.err_load_map","Error loading floor map")}),e.jsx("button",{className:"sbv-retry",onClick:F,children:u("common.btn_refresh","Retry")})]})}):e.jsx("div",{className:E,children:e.jsxs("div",{className:"sbv-shell",children:[e.jsxs("div",{className:"sbv-left",children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:u("host.floor_map_title","Restaurant Map (Live)")}),e.jsx("div",{className:"sbv-topbar-sub",children:u("floor.hints.controls","Drag to pan, Ctrl+wheel to zoom")})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," ",J("empty")]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," ",J("occupied")]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," ",J("reserved")]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," ",J("dirty")]})]}),$.length>1&&e.jsxs("div",{className:"sbv-section-tabs",role:"tablist","aria-label":u("floor.sections.title","Sections"),children:[e.jsx("button",{className:`sbv-section-tab ${L===null?"is-active":""}`,onClick:()=>q(null),role:"tab","aria-selected":L===null,children:u("common.all","All")}),$.map(o=>e.jsx("button",{className:`sbv-section-tab ${L===o.id?"is-active":""}`,onClick:()=>q(o.id),role:"tab","aria-selected":L===o.id,children:o.name},o.id))]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(me,{layout:V,selectedTableId:y,onTableClick:ee,mode:"view"})})]}),e.jsx("aside",{className:`sbv-right ${n==="lobby"&&y?"open":""}`,"aria-label":u("host.table_details","Table details"),children:y?e.jsxs("div",{className:"sbv-right-panel",role:"dialog","aria-modal":"false",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:u("host.table_details","Table Details")}),e.jsx("button",{className:"sbv-close",onClick:Q,"aria-label":u("common.btn_close","Close"),children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:[u("host.table_label","Table")," ",(d==null?void 0:d.number)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${Y}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:u("host.table_status_label","Table Status")}),e.jsx("span",{className:"sbv-status-value",children:J(Y)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:u("host.guest_name","Guest Name")}),e.jsx("div",{className:"sbv-kv-val",children:(v==null?void 0:v.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:u("host.num_guests","Guests")}),e.jsx("div",{className:"sbv-kv-val",children:(v==null?void 0:v.guestCount)!=null?String(v.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:u("host.reservation_time","Reservation Time")}),e.jsx("div",{className:"sbv-kv-val",children:(v==null?void 0:v.reservationTime)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:u("pos.waiter.items_label","Items")}),e.jsx("div",{className:"sbv-kv-val",children:(v==null?void 0:v.itemsCount)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:u("pos.waiter.subtotal","Subtotal")}),e.jsx("div",{className:"sbv-kv-val",children:(v==null?void 0:v.subtotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:Y==="dirty"&&(d!=null&&d.number)?e.jsx("button",{className:"sbv-success-btn",onClick:te,children:u("floor.btn_mark_clean","Mark as Clean")}):Y==="occupied"&&(d!=null&&d.number)?e.jsx("a",{className:"sbv-primary-btn",href:`/waiter/${r}/${d.number}`,children:u("pos.waiter.btn_open_order","Open Order")}):e.jsx("button",{className:"sbv-secondary-btn",onClick:Q,children:u("common.btn_close","Close")})})]}):e.jsxs("div",{className:"sbv-right-empty",children:[e.jsx("div",{className:"sbv-right-empty-title",children:u("host.table_details","Table Details")}),e.jsx("div",{className:"sbv-right-empty-sub",children:u("host.floor_map_help","Select a table on the map to view details.")})]})})]})})}const U=document.getElementById("sb-floor-root");if(!U)throw new Error("Missing #sb-floor-root");const oe=U.getAttribute("data-rid")||U.getAttribute("data-restaurant-id")||"",re=U.getAttribute("data-click-mode")||U.getAttribute("data-mode")||"page",ie=re==="lobby"||re==="host"?"lobby":"page";console.info("[FloorView] mount",{rid:oe,mountMode:ie,clickMode:re});ce.createRoot(U).render(e.jsx(h.StrictMode,{children:e.jsx(fe,{restaurantId:oe,mountMode:ie})}));
