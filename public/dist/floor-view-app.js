import{r as N,j as e,R as p,a as ue,c as de}from"./floor-index.js";const g="/floor_assets/",ae=(t,a=1)=>{const v=Number(t);return Number.isFinite(v)?Math.max(.5,Math.min(1.6,v)):a},oe=t=>{const a=Number(t);return Number.isFinite(a)?Math.round(a/45)*45:0},ve=t=>{if(!t||t.startsWith("#"))return"parquet_blue";const a=t;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function be(t){return{parquet_blue:{bg:`url(${g}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${g}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${g}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${g}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${g}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[t]}function me(t,a){const v=String(t||"square").toLowerCase(),h=Number(a||0);return v==="round"?`${g}${h>=9?"round_table_10.svg":"round_table4.svg"}`:v==="booth"?`${g}${h>=6?"large_booth.svg":"booth4.svg"}`:v==="rect"?`${g}${h>=10?"square_table10.svg":h>=6?"square_table6.svg":h>=4?"square_table4.svg":"square_table2.svg"}`:`${g}${h>=10?"square_table10.svg":h>=6?"square_table6.svg":h>=4?"square_table4.svg":"square_table2.svg"}`}function fe(t,a){const v=String(t||"").toLowerCase();return v==="door"?`${g}door.svg`:v==="wall"?`${g}wall.svg`:v==="divider"?`${g}divider.svg`:v==="chair"?`${g}chair.svg`:v==="bar"?`${g}bar.svg`:v==="plant"?`${g}plant.svg`:a?`${g}${a}.svg`:`${g}divider.svg`}function pe({layout:t,mode:a,onTableClick:v,selectedTableId:h,selectedTableIds:P}){const _=a==="edit",x=N.useRef(null),H=N.useRef(null),[F,O]=N.useState(1),[R,E]=N.useState({x:0,y:0}),[j,X]=N.useState(!1),[W,L]=N.useState(!1),y=N.useRef(F);N.useEffect(()=>{y.current=F},[F]);const f=N.useRef(null),S=60,i=N.useMemo(()=>ve(t.floorColor),[t==null?void 0:t.id]),I=N.useMemo(()=>be(i),[i]);N.useEffect(()=>{const s=o=>{o.code==="Space"&&X(!0)},n=o=>{o.code==="Space"&&(X(!1),L(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",n)}},[]);const $=s=>Math.max(.4,Math.min(2.5,s)),q=()=>{if(!x.current||!H.current)return;const s=x.current,n=H.current,o=getComputedStyle(n),w=(parseFloat(o.marginLeft)||0)+(parseFloat(o.marginRight)||0),c=(parseFloat(o.marginTop)||0)+(parseFloat(o.marginBottom)||0),C=n.offsetWidth+w,u=n.offsetHeight+c;if(!C||!u)return;const k=getComputedStyle(s),M=parseFloat(k.paddingLeft||"0")||0,U=parseFloat(k.paddingRight||"0")||0,z=parseFloat(k.paddingTop||"0")||0,D=parseFloat(k.paddingBottom||"0")||0,d=24,T=Math.max(1,s.clientWidth-M-U-d*2),B=Math.max(1,s.clientHeight-z-D-d*2),Y=$(Math.min(T/C,B/u,1.2));O(Y);const Q=Math.round(M+d+(T-C*Y)/2),ne=Math.round(z+d+(B-u*Y)/2);E({x:Q,y:ne})};N.useEffect(()=>{requestAnimationFrame(q)},[t==null?void 0:t.id]),N.useEffect(()=>{if(!x.current)return;let s=0;const n=new ResizeObserver(()=>{cancelAnimationFrame(s),s=requestAnimationFrame(q)});return n.observe(x.current),()=>{cancelAnimationFrame(s),n.disconnect()}},[t==null?void 0:t.id]);const V=(s,n,o)=>{if(!x.current)return;const w=x.current.getBoundingClientRect(),c=n-w.left,C=o-w.top;E(u=>{const k=s/(y.current||1);return{x:Math.round(c-(c-u.x)*k),y:Math.round(C-(C-u.y)*k)}}),O(s)};N.useEffect(()=>{const s=x.current;if(!s)return;const n=o=>{if(!!!(o.ctrlKey||o.metaKey)||(o.preventDefault(),!_))return;const c=o.deltaY>0?.9:1.1,C=$((y.current||1)*c);V(C,o.clientX,o.clientY)};return s.addEventListener("wheel",n,{passive:!1}),()=>s.removeEventListener("wheel",n)},[_]);const ee=s=>{const n=s.target;if(a==="view"){if(s.button!==0||n!=null&&n.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),f.current={moved:!1};const M={x:s.clientX,y:s.clientY},U={...R};let z=!1;const D=T=>{const B=T.clientX-M.x,Y=T.clientY-M.y,Q=Math.abs(B)+Math.abs(Y);!z&&Q>4&&(z=!0,f.current&&(f.current.moved=!0),L(!0)),z&&E({x:U.x+B,y:U.y+Y})},d=()=>{z&&L(!1),window.removeEventListener("mousemove",D),window.removeEventListener("mouseup",d),f.current&&!f.current.moved&&(f.current=null)};window.addEventListener("mousemove",D),window.addEventListener("mouseup",d);return}const o=s.button===1,w=j&&s.button===0;if(!o&&!w)return;s.preventDefault(),L(!0);const c={x:s.clientX,y:s.clientY},C={...R},u=M=>{E({x:C.x+(M.clientX-c.x),y:C.y+(M.clientY-c.y)})},k=()=>{L(!1),window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",k)};window.addEventListener("mousemove",u),window.addEventListener("mouseup",k)},Z=N.useRef(null),J=s=>{if(a!=="view"||s.touches.length!==1)return;const n=s.touches[0],o=s.target;o!=null&&o.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),L(!0),Z.current={startX:n.clientX,startY:n.clientY,panX:R.x,panY:R.y,active:!0})},r=s=>{if(a!=="view")return;const n=Z.current;if(!n||!n.active||s.touches.length!==1)return;const o=s.touches[0];s.preventDefault(),E({x:n.panX+(o.clientX-n.startX),y:n.panY+(o.clientY-n.startY)})},b=()=>{a==="view"&&(Z.current=null,L(!1))},l=s=>Math.max(1,Number(s)||1)*S,m=s=>{const n=(s||"").toLowerCase();return n.includes("occup")||n==="busy"||n==="taken"?"occupied":n.includes("reserv")||n.includes("book")?"reserved":n.includes("dirty")||n.includes("need")?"dirty":"empty"},A=N.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(n=>{const o=n&&n.tableId?String(n.tableId):"";o&&s.set(o,{status:m(String(n.status||"empty")),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[t]),K=N.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(n=>{const o=Number(n&&(n.tableNumber??0));!Number.isFinite(o)||o<=0||s.set(o,{status:m(String(n.status||"empty")),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[t]),se=s=>{const n=s.id?A.get(String(s.id)):void 0;if(n)return n;const o=Number(s.tableNumber??0);if(Number.isFinite(o)&&o>0){const w=K.get(o);if(w)return w}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${W?"is-panning":""}`,ref:x,onMouseDown:ee,onTouchStart:J,onTouchMove:r,onTouchEnd:b,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[_?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=x.current)==null?void 0:n.getBoundingClientRect();V($(F*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=x.current)==null?void 0:n.getBoundingClientRect();V($(F*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"})]}):null,e.jsx("button",{className:"btn-icon-small",onClick:q,title:"Center",children:"⤢"}),_?e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(F*100),"%"]}):null,e.jsx("div",{className:"fe-hint",children:a==="view"?"Drag to pan":j?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:H,onClickCapture:s=>{var n;a==="view"&&(n=f.current)!=null&&n.moved&&(s.preventDefault(),s.stopPropagation(),f.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${t.gridCols}, ${S}px)`,gridTemplateRows:`repeat(${t.gridRows}, ${S}px)`,transform:`translate(${R.x}px, ${R.y}px) scale(${F})`,transformOrigin:"0 0","--cell":`${S}px`,"--floor-bg":I.bg,"--floor-bg-size":I.size,"--floor-bg-repeat":I.repeat,"--floor-bg-position":I.pos},children:Array.from({length:t.gridRows*t.gridCols}).map((s,n)=>{var D;const o=Math.floor(n/t.gridCols),w=n%t.gridCols,c=t.tables.find(d=>w>=d.gridX&&w<d.gridX+(d.spanX||1)&&o>=d.gridY&&o<d.gridY+(d.spanY||1)),u=(t.objects??[]).find(d=>w>=d.gridX&&w<d.gridX+(d.spanX||1)&&o>=d.gridY&&o<d.gridY+(d.spanY||1)),k=!!c&&c.gridX===w&&c.gridY===o,M=!!u&&u.gridX===w&&u.gridY===o,U=o*t.gridCols+w,z=(((D=t.gridMask)==null?void 0:D[U])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${z?"active":"inactive"}`,children:[M&&u&&e.jsxs("div",{className:`floor-object type-${u.type}`,style:{width:`${l(u.spanX)}px`,height:`${l(u.spanY)}px`,transform:`rotate(${oe(u.rotationDeg??u.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(u.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${ae(u.scale,1)})`},src:u.assetFile?`${g}${u.assetFile}`:fe(u.type,u.label),alt:""}),u.label&&e.jsx("div",{className:"obj-label",children:u.label})]}),k&&c&&(()=>{const d=se(c),T=String(d.status||"empty"),B=h&&String(h)===String(c.id)||Array.isArray(P)&&P.some(ce=>String(ce)===String(c.id)),Y=a==="view",Q=T==="occupied"?"תפוס":T==="reserved"?"שמור":T==="dirty"?"מלוכלך":"פנוי",ne=d.guestCount!=null&&d.guestCount!==""?` · ${d.guestCount}`:"";return e.jsxs("div",{className:`table ${String(c.shape||"square")} ${B?"selected":""}`,onClick:()=>v==null?void 0:v(c.id),style:{position:"absolute",top:0,left:0,width:`${l(c.spanX)}px`,height:`${l(c.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":c.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(c.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${oe(c.rotationDeg??c.rotation??0)}deg) scale(${ae(c.scale,1)})`},src:c.assetFile?`${g}${c.assetFile}`:me(c.shape,c.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:c.name||(c.tableNumber!=null?`Table ${c.tableNumber}`:"Table")}),c.seats!=null&&e.jsxs("div",{className:"table-seats",children:[c.seats," seats"]})]}),Y&&e.jsxs("div",{className:`sbv-status-pill is-${T}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[Q,ne]})]})]})})()]},n)})})]})}function ge(t){const a=(t||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function te(t){const a=[t==null?void 0:t.tableNumber,t==null?void 0:t.number,t==null?void 0:t.table_number,t==null?void 0:t.tableNum,t==null?void 0:t.table,t==null?void 0:t.name,t==null?void 0:t.label];for(const v of a){if(v==null)continue;const h=String(v).trim();if(!h)continue;const P=Number(h);if(Number.isFinite(P)&&P>0)return P;const _=h.match(/(\d{1,4})/);if(_){const x=Number(_[1]);if(Number.isFinite(x)&&x>0)return x}}return null}function he(t){switch(t){case"occupied":return"תפוס";case"reserved":return"שמור";case"dirty":return"מלוכלך";default:return"פנוי"}}function xe({restaurantId:t,mountMode:a="page"}){const[v,h]=p.useState([]),[P,_]=p.useState(null),[x,H]=p.useState(null),[F,O]=p.useState(!0),[R,E]=p.useState(null),[j,X]=p.useState(null),[W,L]=p.useState([]),y=p.useCallback(async()=>{try{const r=await fetch(`/api/floor-layouts/${t}/active`,{headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const b=await r.json(),l=b&&b.id?b:(b==null?void 0:b.activeLayout)??null;if(!l){h([]),_(null),H(null),E("אין מפת מסעדה פעילה"),O(!1);return}h([l]),_(l.id),H(m=>m??l.id),E(null),O(!1),j&&((l.tables||[]).some(A=>String(A.id)===String(j))||X(null))}catch(r){E(`שגיאה בטעינת המפה: ${(r==null?void 0:r.message)??"unknown"}`),O(!1)}},[t,j]);p.useEffect(()=>{y();const r=setInterval(y,5e3);return()=>clearInterval(r)},[y]),p.useEffect(()=>{const r=()=>y();return window.addEventListener("sb-floor-refresh",r),()=>window.removeEventListener("sb-floor-refresh",r)},[y]);const f=p.useMemo(()=>x?v.find(r=>r.id===x)??null:null,[v,x]),S=p.useMemo(()=>!f||!j?null:(f.tables||[]).find(r=>String(r.id)===String(j))??null,[f,j]),i=p.useMemo(()=>{if(!f||!S)return null;const r=f.tableStatuses;if(!Array.isArray(r))return null;const b=r.find(l=>String(l.tableId)===String(S.id));return b||(r.find(l=>l.tableNumber===te(S))??null)},[f,S]),I=p.useMemo(()=>ge(i==null?void 0:i.status),[i]),$=a==="host",q=a==="lobby",V=r=>{if($){L(b=>{const l=new Set(b);return l.has(r)?l.delete(r):l.add(r),Array.from(l)});return}X(r)},ee=()=>X(null);p.useEffect(()=>{if(!$)return;const r=f;if(!r)return;const b=new Map;(r.tables||[]).forEach(m=>b.set(String(m.id),m));const l=W.map(m=>b.get(String(m))).filter(Boolean).map(m=>te(m)??0).filter(m=>Number.isFinite(m)&&m>0);window.dispatchEvent(new CustomEvent("sb-floor-selection",{detail:{tableIds:W,tableNumbers:l}}))},[$,f,W]),p.useEffect(()=>{if(!$)return;const r=()=>L([]);return window.addEventListener("sb-floor-clear-selection",r),()=>window.removeEventListener("sb-floor-clear-selection",r)},[$]),p.useEffect(()=>{if(a!=="lobby")return;const r=b=>{var se;const l=b,m=Number((se=l==null?void 0:l.detail)==null?void 0:se.tableNumber);if(!Number.isFinite(m)||m<=0)return;const A=activeLayout==null?void 0:activeLayout.tables;if(!Array.isArray(A))return;const K=A.find(s=>Number(s==null?void 0:s.tableNumber)===m);K!=null&&K.id&&(X(String(K.id)),L([]))};return window.addEventListener("sb-floor-select-table-number",r),()=>window.removeEventListener("sb-floor-select-table-number",r)},[a,activeLayout]);const Z=p.useCallback(async(r,b)=>{try{const l=await fetch(`/api/tables/${t}/${r}/status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:b})});if(!l.ok)throw new Error(`HTTP ${l.status}`);await y()}catch(l){console.warn("Failed to update table status",l);try{const m=l!=null&&l.message?String(l.message):"unknown";alert("שגיאה בעדכון סטטוס שולחן: "+m)}catch{}}},[t,y]),J=`floor-editor sb-floor-view ${a==="lobby"||a==="host"?"is-embed":""}`;return F?e.jsx("div",{className:J,children:e.jsx("div",{className:"sbv-loading",children:"טוען מפת מסעדה…"})}):R||!f?e.jsx("div",{className:J,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:"לא ניתן לטעון את מפת המסעדה"}),e.jsx("div",{className:"sbv-error-sub",children:R??"קרתה שגיאה בטעינת המפה"}),e.jsx("button",{className:"sbv-retry",onClick:y,children:"נסה שוב"})]})}):e.jsxs("div",{className:J,children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:"עדכון סידור שולחנות"}),e.jsx("div",{className:"sbv-topbar-sub",children:"גרור כדי להזיז • ⤢ למרכז למסך"})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," פנוי"]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," תפוס"]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," שמור"]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," מלוכלך"]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(pe,{layout:f,selectedTableId:j,selectedTableIds:$?W:null,onTableClick:V,mode:"view"})}),j&&!$?ue.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:ee}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-close",onClick:ee,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:["שולחן ",te(S)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${I}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:"סטטוס שולחן"}),e.jsx("span",{className:"sbv-status-value",children:he(I)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שם המזמין"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-kv-val",children:(()=>{const r=(i==null?void 0:i.guestCount)??(i==null?void 0:i.people);return r!=null&&r!==""?String(r):"—"})()})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.reservationTime)??(i==null?void 0:i.time)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.itemsCount)??((i==null?void 0:i.itemsReady)!=null&&(i==null?void 0:i.itemsPending)!=null?i.itemsReady+i.itemsPending:null)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.subtotal)??(i==null?void 0:i.orderTotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:e.jsxs("div",{className:"sbv-actions-row",children:[q?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"sbv-secondary-btn",onClick:r=>{r.stopPropagation(),Z(j,"dirty"),window.dispatchEvent(new Event("sb-floor-refresh"))},children:"סמן מלוכלך"}),e.jsx("button",{className:"sbv-secondary-btn",onClick:r=>{r.stopPropagation(),Z(j,"empty"),window.dispatchEvent(new Event("sb-floor-refresh"))},children:"סמן נקי"})]}):null,(()=>{const r=te(S),b=!!(i!=null&&i.orderId),l=!!r&&(!q||b),m=r?`/pos/${encodeURIComponent(t)}/table/${encodeURIComponent(String(r))}`:"";return e.jsx("button",{type:"button",className:"sbv-primary-btn",disabled:!l,onClick:A=>{A.stopPropagation(),l&&(window.location.href=m)},title:q&&!b?"אין הזמנה פתוחה לשולחן הזה":void 0,children:"למסך ההזמנה"})})()]})})]})]}),document.body):null]})}const G=document.getElementById("sb-floor-root");if(!G)throw new Error("Missing #sb-floor-root");const ie=G.getAttribute("data-rid")||G.getAttribute("data-restaurant-id")||"",re=G.getAttribute("data-click-mode")||G.getAttribute("data-mode")||"page",le=re==="lobby"?"lobby":re==="host"?"host":"page";console.info("[FloorView] mount",{rid:ie,mountMode:le,clickMode:re});de.createRoot(G).render(e.jsx(p.StrictMode,{children:e.jsx(xe,{restaurantId:ie,mountMode:le})}));
