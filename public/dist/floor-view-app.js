import{r as g,j as e,R as h,c as ce}from"./floor-index.js";const m="/floor_assets/",te=(r,a=1)=>{const v=Number(r);return Number.isFinite(v)?Math.max(.5,Math.min(1.6,v)):a},re=r=>{const a=Number(r);return Number.isFinite(a)?Math.round(a/45)*45:0},ue=r=>{if(!r||r.startsWith("#"))return"parquet_blue";const a=r;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function de(r){return{parquet_blue:{bg:`url(${m}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${m}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${m}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${m}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${m}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[r]}function ve(r,a){const v=String(r||"square").toLowerCase(),j=Number(a||0);return v==="round"?`${m}${j>=9?"round_table_10.svg":"round_table4.svg"}`:v==="booth"?`${m}${j>=6?"large_booth.svg":"booth4.svg"}`:v==="rect"?`${m}${j>=10?"square_table10.svg":j>=6?"square_table6.svg":j>=4?"square_table4.svg":"square_table2.svg"}`:`${m}${j>=10?"square_table10.svg":j>=6?"square_table6.svg":j>=4?"square_table4.svg":"square_table2.svg"}`}function be(r,a){const v=String(r||"").toLowerCase();return v==="door"?`${m}door.svg`:v==="wall"?`${m}wall.svg`:v==="divider"?`${m}divider.svg`:v==="chair"?`${m}chair.svg`:v==="bar"?`${m}bar.svg`:v==="plant"?`${m}plant.svg`:a?`${m}${a}.svg`:`${m}divider.svg`}function me({layout:r,mode:a,onTableClick:v,selectedTableId:j,selectedTableIds:J}){const X=a==="edit",y=g.useRef(null),P=g.useRef(null),[E,D]=g.useState(1),[T,z]=g.useState({x:0,y:0}),[N,B]=g.useState(!1),[H,k]=g.useState(!1),_=g.useRef(E);g.useEffect(()=>{_.current=E},[E]);const b=g.useRef(null),x=60,d=g.useMemo(()=>ue(r.floorColor),[r==null?void 0:r.id]),M=g.useMemo(()=>de(d),[d]);g.useEffect(()=>{const s=n=>{n.code==="Space"&&B(!0)},t=n=>{n.code==="Space"&&(B(!1),k(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",t)}},[]);const $=s=>Math.max(.4,Math.min(2.5,s)),W=()=>{if(!y.current||!P.current)return;const s=y.current,t=P.current,n=getComputedStyle(t),p=(parseFloat(n.marginLeft)||0)+(parseFloat(n.marginRight)||0),o=(parseFloat(n.marginTop)||0)+(parseFloat(n.marginBottom)||0),S=t.offsetWidth+p,l=t.offsetHeight+o;if(!S||!l)return;const C=getComputedStyle(s),L=parseFloat(C.paddingLeft||"0")||0,O=parseFloat(C.paddingRight||"0")||0,R=parseFloat(C.paddingTop||"0")||0,q=parseFloat(C.paddingBottom||"0")||0,u=24,F=Math.max(1,s.clientWidth-L-O-u*2),I=Math.max(1,s.clientHeight-R-q-u*2),A=$(Math.min(F/S,I/l,1.2));D(A);const V=Math.round(L+u+(F-S*A)/2),ee=Math.round(R+u+(I-l*A)/2);z({x:V,y:ee})};g.useEffect(()=>{requestAnimationFrame(W)},[r==null?void 0:r.id]),g.useEffect(()=>{if(!y.current)return;let s=0;const t=new ResizeObserver(()=>{cancelAnimationFrame(s),s=requestAnimationFrame(W)});return t.observe(y.current),()=>{cancelAnimationFrame(s),t.disconnect()}},[r==null?void 0:r.id]);const K=(s,t,n)=>{if(!y.current)return;const p=y.current.getBoundingClientRect(),o=t-p.left,S=n-p.top;z(l=>{const C=s/(_.current||1);return{x:Math.round(o-(o-l.x)*C),y:Math.round(S-(S-l.y)*C)}}),D(s)};g.useEffect(()=>{const s=y.current;if(!s)return;const t=n=>{if(!!!(n.ctrlKey||n.metaKey)||(n.preventDefault(),!X))return;const o=n.deltaY>0?.9:1.1,S=$((_.current||1)*o);K(S,n.clientX,n.clientY)};return s.addEventListener("wheel",t,{passive:!1}),()=>s.removeEventListener("wheel",t)},[X]);const U=s=>{const t=s.target;if(a==="view"){if(s.button!==0||t!=null&&t.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),b.current={moved:!1};const L={x:s.clientX,y:s.clientY},O={...T};let R=!1;const q=F=>{const I=F.clientX-L.x,A=F.clientY-L.y,V=Math.abs(I)+Math.abs(A);!R&&V>4&&(R=!0,b.current&&(b.current.moved=!0),k(!0)),R&&z({x:O.x+I,y:O.y+A})},u=()=>{R&&k(!1),window.removeEventListener("mousemove",q),window.removeEventListener("mouseup",u),b.current&&!b.current.moved&&(b.current=null)};window.addEventListener("mousemove",q),window.addEventListener("mouseup",u);return}const n=s.button===1,p=N&&s.button===0;if(!n&&!p)return;s.preventDefault(),k(!0);const o={x:s.clientX,y:s.clientY},S={...T},l=L=>{z({x:S.x+(L.clientX-o.x),y:S.y+(L.clientY-o.y)})},C=()=>{k(!1),window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",C)};window.addEventListener("mousemove",l),window.addEventListener("mouseup",C)},Y=g.useRef(null),G=s=>{if(a!=="view"||s.touches.length!==1)return;const t=s.touches[0],n=s.target;n!=null&&n.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),k(!0),Y.current={startX:t.clientX,startY:t.clientY,panX:T.x,panY:T.y,active:!0})},i=s=>{if(a!=="view")return;const t=Y.current;if(!t||!t.active||s.touches.length!==1)return;const n=s.touches[0];s.preventDefault(),z({x:t.panX+(n.clientX-t.startX),y:t.panY+(n.clientY-t.startY)})},f=()=>{a==="view"&&(Y.current=null,k(!1))},c=s=>Math.max(1,Number(s)||1)*x,w=s=>{const t=(s||"").toLowerCase();return t.includes("occup")||t==="busy"||t==="taken"?"occupied":t.includes("reserv")||t.includes("book")?"reserved":t.includes("dirty")||t.includes("need")||t.includes("clean")?"dirty":"empty"},Q=g.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=t&&t.tableId?String(t.tableId):"";n&&s.set(n,{status:w(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),oe=g.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=Number(t&&(t.tableNumber??0));!Number.isFinite(n)||n<=0||s.set(n,{status:w(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),ie=s=>{const t=s.id?Q.get(String(s.id)):void 0;if(t)return t;const n=Number(s.tableNumber??0);if(Number.isFinite(n)&&n>0){const p=oe.get(n);if(p)return p}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${H?"is-panning":""}`,ref:y,onMouseDown:U,onTouchStart:G,onTouchMove:i,onTouchEnd:f,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[X?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=y.current)==null?void 0:t.getBoundingClientRect();K($(E*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=y.current)==null?void 0:t.getBoundingClientRect();K($(E*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"})]}):null,e.jsx("button",{className:"btn-icon-small",onClick:W,title:"Center",children:"⤢"}),X?e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(E*100),"%"]}):null,e.jsx("div",{className:"fe-hint",children:a==="view"?"Drag to pan":N?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:P,onClickCapture:s=>{var t;a==="view"&&(t=b.current)!=null&&t.moved&&(s.preventDefault(),s.stopPropagation(),b.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${r.gridCols}, ${x}px)`,gridTemplateRows:`repeat(${r.gridRows}, ${x}px)`,transform:`translate(${T.x}px, ${T.y}px) scale(${E})`,transformOrigin:"0 0","--cell":`${x}px`,"--floor-bg":M.bg,"--floor-bg-size":M.size,"--floor-bg-repeat":M.repeat,"--floor-bg-position":M.pos},children:Array.from({length:r.gridRows*r.gridCols}).map((s,t)=>{var q;const n=Math.floor(t/r.gridCols),p=t%r.gridCols,o=r.tables.find(u=>p>=u.gridX&&p<u.gridX+(u.spanX||1)&&n>=u.gridY&&n<u.gridY+(u.spanY||1)),l=(r.objects??[]).find(u=>p>=u.gridX&&p<u.gridX+(u.spanX||1)&&n>=u.gridY&&n<u.gridY+(u.spanY||1)),C=!!o&&o.gridX===p&&o.gridY===n,L=!!l&&l.gridX===p&&l.gridY===n,O=n*r.gridCols+p,R=(((q=r.gridMask)==null?void 0:q[O])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${R?"active":"inactive"}`,children:[L&&l&&e.jsxs("div",{className:`floor-object type-${l.type}`,style:{width:`${c(l.spanX)}px`,height:`${c(l.spanY)}px`,transform:`rotate(${re(l.rotationDeg??l.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(l.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${te(l.scale,1)})`},src:l.assetFile?`${m}${l.assetFile}`:be(l.type,l.label),alt:""}),l.label&&e.jsx("div",{className:"obj-label",children:l.label})]}),C&&o&&(()=>{const u=ie(o),F=String(u.status||"empty"),I=j&&String(j)===String(o.id)||Array.isArray(J)&&J.some(le=>String(le)===String(o.id)),A=a==="view",V=F==="occupied"?"תפוס":F==="reserved"?"שמור":F==="dirty"?"מלוכלך":"פנוי",ee=u.guestCount!=null&&u.guestCount!==""?` · ${u.guestCount}`:"";return e.jsxs("div",{className:`table ${String(o.shape||"square")} ${I?"selected":""}`,onClick:()=>v==null?void 0:v(o.id),style:{position:"absolute",top:0,left:0,width:`${c(o.spanX)}px`,height:`${c(o.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":o.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(o.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${re(o.rotationDeg??o.rotation??0)}deg) scale(${te(o.scale,1)})`},src:o.assetFile?`${m}${o.assetFile}`:ve(o.shape,o.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:o.name||(o.tableNumber!=null?`Table ${o.tableNumber}`:"Table")}),o.seats!=null&&e.jsxs("div",{className:"table-seats",children:[o.seats," seats"]})]}),A&&e.jsxs("div",{className:`sbv-status-pill is-${F}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[V,ee]})]})]})})()]},t)})})]})}function fe(r){const a=(r||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function pe(r){switch(r){case"occupied":return"תפוס";case"reserved":return"שמור";case"dirty":return"מלוכלך";default:return"פנוי"}}function ge({restaurantId:r,mountMode:a="page"}){const[v,j]=h.useState([]),[J,X]=h.useState(null),[y,P]=h.useState(null),[E,D]=h.useState(!0),[T,z]=h.useState(null),[N,B]=h.useState(null),[H,k]=h.useState([]),_=h.useCallback(async()=>{try{const i=await fetch(`/api/floor-layouts/${r}/active`,{headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error(`HTTP ${i.status}`);const f=await i.json(),c=f&&f.id?f:(f==null?void 0:f.activeLayout)??null;if(!c){j([]),X(null),P(null),z("אין מפת מסעדה פעילה"),D(!1);return}j([c]),X(c.id),P(w=>w??c.id),z(null),D(!1),N&&((c.tables||[]).some(Q=>String(Q.id)===String(N))||B(null))}catch(i){z(`שגיאה בטעינת המפה: ${(i==null?void 0:i.message)??"unknown"}`),D(!1)}},[r,N]);h.useEffect(()=>{_();const i=setInterval(_,5e3);return()=>clearInterval(i)},[_]);const b=h.useMemo(()=>y?v.find(i=>i.id===y)??null:null,[v,y]),x=h.useMemo(()=>!b||!N?null:(b.tables||[]).find(i=>String(i.id)===String(N))??null,[b,N]),d=h.useMemo(()=>{if(!b||!x)return null;const i=b.tableStatuses;if(!Array.isArray(i))return null;const f=i.find(c=>String(c.tableId)===String(x.id));return f||(i.find(c=>c.tableNumber===x.number)??null)},[b,x]),M=h.useMemo(()=>fe(d==null?void 0:d.status),[d]),$=a==="host",W=a==="lobby",K=i=>{if($){k(f=>{const c=new Set(f);return c.has(i)?c.delete(i):c.add(i),Array.from(c)});return}B(i)},U=()=>B(null);h.useEffect(()=>{if(!$)return;const i=b;if(!i)return;const f=new Map;(i.tables||[]).forEach(w=>f.set(String(w.id),w));const c=H.map(w=>f.get(String(w))).filter(Boolean).map(w=>Number(w.tableNumber??w.number??0)).filter(w=>Number.isFinite(w)&&w>0);window.dispatchEvent(new CustomEvent("sb-floor-selection",{detail:{tableIds:H,tableNumbers:c}}))},[$,b,H]),h.useEffect(()=>{if(!$)return;const i=()=>k([]);return window.addEventListener("sb-floor-clear-selection",i),()=>window.removeEventListener("sb-floor-clear-selection",i)},[$]);const Y=h.useCallback(async(i,f)=>{try{const c=await fetch(`/api/tables/${r}/${i}/status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:f})});if(!c.ok)throw new Error(`HTTP ${c.status}`);await _()}catch(c){console.warn("Failed to update table status",c)}},[r,_]),G=`floor-editor sb-floor-view ${a==="lobby"||a==="host"?"is-embed":""}`;return E?e.jsx("div",{className:G,children:e.jsx("div",{className:"sbv-loading",children:"טוען מפת מסעדה…"})}):T||!b?e.jsx("div",{className:G,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:"לא ניתן לטעון את מפת המסעדה"}),e.jsx("div",{className:"sbv-error-sub",children:T??"קרתה שגיאה בטעינת המפה"}),e.jsx("button",{className:"sbv-retry",onClick:_,children:"נסה שוב"})]})}):e.jsxs("div",{className:G,children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:"עדכון סידור שולחנות"}),e.jsx("div",{className:"sbv-topbar-sub",children:"גרור כדי להזיז • ⤢ למרכז למסך"})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," פנוי"]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," תפוס"]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," שמור"]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," מלוכלך"]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(me,{layout:b,selectedTableId:N,selectedTableIds:$?H:null,onTableClick:K,mode:"view"})}),N&&!$&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:U}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-close",onClick:U,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:["שולחן ",(x==null?void 0:x.number)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${M}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:"סטטוס שולחן"}),e.jsx("span",{className:"sbv-status-value",children:pe(M)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שם המזמין"}),e.jsx("div",{className:"sbv-kv-val",children:(d==null?void 0:d.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-kv-val",children:(d==null?void 0:d.guestCount)!=null?String(d.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-kv-val",children:(d==null?void 0:d.reservationTime)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-kv-val",children:(d==null?void 0:d.itemsCount)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-kv-val",children:(d==null?void 0:d.subtotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:e.jsxs("div",{className:"sbv-actions-row",children:[W&&M!=="occupied"?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"sbv-secondary-btn",onClick:()=>Y(N,"dirty"),children:"סמן מלוכלך"}),e.jsx("button",{className:"sbv-secondary-btn",onClick:()=>Y(N,"empty"),children:"סמן פנוי"})]}):null,!W&&M!=="occupied"?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"sbv-secondary-btn",onClick:()=>Y(N,"reserved"),children:"סמן שמור"}),e.jsx("button",{className:"sbv-secondary-btn",onClick:()=>Y(N,"empty"),children:"סמן פנוי"})]}):null,M==="occupied"&&(x!=null&&x.number)?e.jsx("a",{className:"sbv-primary-btn",href:`/waiter/${r}/${x.number}`,children:"פתח הזמנה"}):e.jsx("button",{className:"sbv-secondary-btn",onClick:U,children:"סגור"})]})})]})]})]})}const Z=document.getElementById("sb-floor-root");if(!Z)throw new Error("Missing #sb-floor-root");const ne=Z.getAttribute("data-rid")||Z.getAttribute("data-restaurant-id")||"",se=Z.getAttribute("data-click-mode")||Z.getAttribute("data-mode")||"page",ae=se==="lobby"?"lobby":se==="host"?"host":"page";console.info("[FloorView] mount",{rid:ne,mountMode:ae,clickMode:se});ce.createRoot(Z).render(e.jsx(h.StrictMode,{children:e.jsx(ge,{restaurantId:ne,mountMode:ae})}));
