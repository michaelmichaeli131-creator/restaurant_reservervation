import{r as f,j as e,R as j,t as d,c as le}from"./floor-index.js";const b="/floor_assets/",ee=(r,a=1)=>{const m=Number(r);return Number.isFinite(m)?Math.max(.5,Math.min(1.6,m)):a},se=r=>{const a=Number(r);return Number.isFinite(a)?Math.round(a/45)*45:0},ce=r=>{if(!r||r.startsWith("#"))return"parquet_blue";const a=r;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function ue(r){return{parquet_blue:{bg:`url(${b}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${b}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${b}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${b}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${b}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[r]}function de(r,a){const m=String(r||"square").toLowerCase(),g=Number(a||0);return m==="round"?`${b}${g>=9?"round_table_10.svg":"round_table4.svg"}`:m==="booth"?`${b}${g>=6?"large_booth.svg":"booth4.svg"}`:m==="rect"?`${b}${g>=10?"square_table10.svg":g>=6?"square_table6.svg":g>=4?"square_table4.svg":"square_table2.svg"}`:`${b}${g>=10?"square_table10.svg":g>=6?"square_table6.svg":g>=4?"square_table4.svg":"square_table2.svg"}`}function ve(r,a){const m=String(r||"").toLowerCase();return m==="door"?`${b}door.svg`:m==="wall"?`${b}wall.svg`:m==="divider"?`${b}divider.svg`:m==="chair"?`${b}chair.svg`:m==="bar"?`${b}bar.svg`:m==="plant"?`${b}plant.svg`:a?`${b}${a}.svg`:`${b}divider.svg`}function me({layout:r,mode:a,onTableClick:m,selectedTableId:g}){const C=f.useRef(null),q=f.useRef(null),[k,O]=f.useState(1),[z,F]=f.useState({x:0,y:0}),[H,A]=f.useState(!1),[S,_]=f.useState(!1),h=f.useRef(null),x=60,v=f.useMemo(()=>ce(r.floorColor),[r==null?void 0:r.id]),u=f.useMemo(()=>ue(v),[v]);f.useEffect(()=>{const s=n=>{n.code==="Space"&&A(!0)},t=n=>{n.code==="Space"&&(A(!1),_(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",t)}},[]);const R=s=>Math.max(.4,Math.min(2.5,s)),W=()=>{if(!C.current||!q.current)return;const s=C.current,t=q.current,n=getComputedStyle(t),p=(parseFloat(n.marginLeft)||0)+(parseFloat(n.marginRight)||0),o=(parseFloat(n.marginTop)||0)+(parseFloat(n.marginBottom)||0),M=t.offsetWidth+p,i=t.offsetHeight+o;if(!M||!i)return;const w=getComputedStyle(s),L=parseFloat(w.paddingLeft||"0")||0,D=parseFloat(w.paddingRight||"0")||0,T=parseFloat(w.paddingTop||"0")||0,X=parseFloat(w.paddingBottom||"0")||0,c=24,$=Math.max(1,s.clientWidth-L-D-c*2),E=Math.max(1,s.clientHeight-T-X-c*2),Y=R(Math.min($/M,E/i,1.2));O(Y);const U=Math.round(L+c+($-M*Y)/2),J=Math.round(T+c+(E-i*Y)/2);F({x:U,y:J})};f.useEffect(()=>{requestAnimationFrame(W)},[r==null?void 0:r.id]),f.useEffect(()=>{if(!C.current)return;let s=0;const t=new ResizeObserver(()=>{cancelAnimationFrame(s),s=requestAnimationFrame(W)});return t.observe(C.current),()=>{cancelAnimationFrame(s),t.disconnect()}},[r==null?void 0:r.id]);const I=(s,t,n)=>{if(!C.current)return;const p=C.current.getBoundingClientRect(),o=t-p.left,M=n-p.top;F(i=>{const w=s/k;return{x:Math.round(o-(o-i.x)*w),y:Math.round(M-(M-i.y)*w)}}),O(s)},V=s=>{if(!(s.ctrlKey||s.metaKey))return;s.preventDefault();const t=R(k*(s.deltaY>0?.9:1.1));I(t,s.clientX,s.clientY)},K=s=>{const t=s.target;if(a==="view"){if(s.button!==0||t!=null&&t.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),h.current={moved:!1};const L={x:s.clientX,y:s.clientY},D={...z};let T=!1;const X=$=>{const E=$.clientX-L.x,Y=$.clientY-L.y,U=Math.abs(E)+Math.abs(Y);!T&&U>4&&(T=!0,h.current&&(h.current.moved=!0),_(!0)),T&&F({x:D.x+E,y:D.y+Y})},c=()=>{T&&_(!1),window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",c),h.current&&!h.current.moved&&(h.current=null)};window.addEventListener("mousemove",X),window.addEventListener("mouseup",c);return}const n=s.button===1,p=H&&s.button===0;if(!n&&!p)return;s.preventDefault(),_(!0);const o={x:s.clientX,y:s.clientY},M={...z},i=L=>{F({x:M.x+(L.clientX-o.x),y:M.y+(L.clientY-o.y)})},w=()=>{_(!1),window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",w)};window.addEventListener("mousemove",i),window.addEventListener("mouseup",w)},l=f.useRef(null),N=s=>{if(a!=="view"||s.touches.length!==1)return;const t=s.touches[0],n=s.target;n!=null&&n.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),_(!0),l.current={startX:t.clientX,startY:t.clientY,panX:z.x,panY:z.y,active:!0})},y=s=>{if(a!=="view")return;const t=l.current;if(!t||!t.active||s.touches.length!==1)return;const n=s.touches[0];s.preventDefault(),F({x:t.panX+(n.clientX-t.startX),y:t.panY+(n.clientY-t.startY)})},G=()=>{a==="view"&&(l.current=null,_(!1))},P=s=>Math.max(1,Number(s)||1)*x,Q=s=>{const t=(s||"").toLowerCase();return t.includes("occup")||t==="busy"||t==="taken"?"occupied":t.includes("reserv")||t.includes("book")?"reserved":t.includes("dirty")||t.includes("need")||t.includes("clean")?"dirty":"empty"},ae=f.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=t&&t.tableId?String(t.tableId):"";n&&s.set(n,{status:Q(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),oe=f.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=Number(t&&(t.tableNumber??0));!Number.isFinite(n)||n<=0||s.set(n,{status:Q(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),ie=s=>{const t=s.id?ae.get(String(s.id)):void 0;if(t)return t;const n=Number(s.tableNumber??0);if(Number.isFinite(n)&&n>0){const p=oe.get(n);if(p)return p}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${S?"is-panning":""}`,ref:C,onWheel:V,onMouseDown:K,onTouchStart:N,onTouchMove:y,onTouchEnd:G,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=C.current)==null?void 0:t.getBoundingClientRect();I(R(k*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=C.current)==null?void 0:t.getBoundingClientRect();I(R(k*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"}),e.jsx("button",{className:"btn-icon-small",onClick:W,title:"Fit to screen",children:"⤢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(k*100),"%"]}),e.jsx("div",{className:"fe-hint",children:H?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:q,onClickCapture:s=>{var t;a==="view"&&(t=h.current)!=null&&t.moved&&(s.preventDefault(),s.stopPropagation(),h.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${r.gridCols}, ${x}px)`,gridTemplateRows:`repeat(${r.gridRows}, ${x}px)`,transform:`translate(${z.x}px, ${z.y}px) scale(${k})`,transformOrigin:"0 0","--cell":`${x}px`,"--floor-bg":u.bg,"--floor-bg-size":u.size,"--floor-bg-repeat":u.repeat,"--floor-bg-position":u.pos},children:Array.from({length:r.gridRows*r.gridCols}).map((s,t)=>{var X;const n=Math.floor(t/r.gridCols),p=t%r.gridCols,o=r.tables.find(c=>p>=c.gridX&&p<c.gridX+(c.spanX||1)&&n>=c.gridY&&n<c.gridY+(c.spanY||1)),i=(r.objects??[]).find(c=>p>=c.gridX&&p<c.gridX+(c.spanX||1)&&n>=c.gridY&&n<c.gridY+(c.spanY||1)),w=!!o&&o.gridX===p&&o.gridY===n,L=!!i&&i.gridX===p&&i.gridY===n,D=n*r.gridCols+p,T=(((X=r.gridMask)==null?void 0:X[D])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${T?"active":"inactive"}`,children:[L&&i&&e.jsxs("div",{className:`floor-object type-${i.type}`,style:{width:`${P(i.spanX)}px`,height:`${P(i.spanY)}px`,transform:`rotate(${se(i.rotationDeg??i.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(i.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${ee(i.scale,1)})`},src:i.assetFile?`${b}${i.assetFile}`:ve(i.type,i.label),alt:""}),i.label&&e.jsx("div",{className:"obj-label",children:i.label})]}),w&&o&&(()=>{const c=ie(o),$=String(c.status||"empty"),E=g&&String(g)===String(o.id),Y=a==="view",U=$==="occupied"?"תפוס":$==="reserved"?"שמור":$==="dirty"?"מלוכלך":"פנוי",J=c.guestCount!=null&&c.guestCount!==""?` · ${c.guestCount}`:"";return e.jsxs("div",{className:`table floor-table status-${$} ${String(o.shape||"square")} ${E?"is-selected":""}`,onClick:()=>m==null?void 0:m(o.id),style:{position:"absolute",top:0,left:0,width:`${P(o.spanX)}px`,height:`${P(o.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":o.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(o.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${se(o.rotationDeg??o.rotation??0)}deg) scale(${ee(o.scale,1)})`},src:o.assetFile?`${b}${o.assetFile}`:de(o.shape,o.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:o.name||(o.tableNumber!=null?`Table ${o.tableNumber}`:"Table")}),o.seats!=null&&e.jsxs("div",{className:"table-seats",children:[o.seats," seats"]})]}),Y&&e.jsxs("div",{className:`sbv-status-pill is-${$}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[U,J]})]})]})})()]},t)})})]})}function be(r){const a=(r||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function Z(r){return d(`floor.status.${r}`,r)}function pe({restaurantId:r,mountMode:a="page"}){const[m,g]=j.useState([]),[C,q]=j.useState(null),[k,O]=j.useState(null),[z,F]=j.useState(!0),[H,A]=j.useState(null),[S,_]=j.useState(null),h=j.useCallback(async()=>{try{const l=await fetch(`/api/floor-layouts/${r}/active`,{headers:{"Content-Type":"application/json"}});if(!l.ok)throw new Error(`HTTP ${l.status}`);const N=await l.json(),y=N&&N.id?N:(N==null?void 0:N.activeLayout)??null;if(!y){g([]),q(null),O(null),A(d("host.no_floor_plan","No active floor plan")),F(!1);return}g([y]),q(y.id),O(G=>G??y.id),A(null),F(!1),S&&((y.tables||[]).some(P=>String(P.id)===String(S))||_(null))}catch(l){A(d("host.err_load_map","Error loading floor map")+`: ${(l==null?void 0:l.message)??"unknown"}`),F(!1)}},[r,S]);j.useEffect(()=>{h();const l=setInterval(h,5e3);return()=>clearInterval(l)},[h]);const x=j.useMemo(()=>k?m.find(l=>l.id===k)??null:null,[m,k]),v=j.useMemo(()=>!x||!S?null:(x.tables||[]).find(l=>String(l.id)===String(S))??null,[x,S]),u=j.useMemo(()=>{if(!x||!v)return null;const l=x.tableStatuses;if(!Array.isArray(l))return null;const N=l.find(y=>String(y.tableId)===String(v.id));return N||(l.find(y=>y.tableNumber===v.number)??null)},[x,v]),R=j.useMemo(()=>be(u==null?void 0:u.status),[u]),W=l=>{_(l)},I=()=>_(null),V=async()=>{const l=(v==null?void 0:v.number)??(v==null?void 0:v.tableNumber);if(l)try{await fetch("/api/host/table/clean",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({restaurantId:r,table:l})}),await h()}catch(N){console.error("Failed to mark table clean:",N)}},K=`floor-editor sb-floor-view ${a==="lobby"?"is-embed":""}`;return z?e.jsx("div",{className:K,children:e.jsx("div",{className:"sbv-loading",children:d("floor.loading","Loading floor plan...")})}):H||!x?e.jsx("div",{className:K,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:d("host.err_load_map","Cannot load floor map")}),e.jsx("div",{className:"sbv-error-sub",children:H??d("host.err_load_map","Error loading floor map")}),e.jsx("button",{className:"sbv-retry",onClick:h,children:d("common.btn_refresh","Retry")})]})}):e.jsx("div",{className:K,children:e.jsxs("div",{className:"sbv-shell",children:[e.jsxs("div",{className:"sbv-left",children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:d("host.floor_map_title","Restaurant Map (Live)")}),e.jsx("div",{className:"sbv-topbar-sub",children:d("floor.hints.controls","Drag to pan, Ctrl+wheel to zoom")})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," ",Z("empty")]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," ",Z("occupied")]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," ",Z("reserved")]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," ",Z("dirty")]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(me,{layout:x,selectedTableId:S,onTableClick:W,mode:"view"})})]}),e.jsx("aside",{className:"sbv-right","aria-label":d("host.table_details","Table details"),children:S?e.jsxs("div",{className:"sbv-right-panel",role:"dialog","aria-modal":"false",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:d("host.table_details","Table Details")}),e.jsx("button",{className:"sbv-close",onClick:I,"aria-label":d("common.btn_close","Close"),children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:[d("host.table_label","Table")," ",(v==null?void 0:v.number)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${R}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:d("host.table_status_label","Table Status")}),e.jsx("span",{className:"sbv-status-value",children:Z(R)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:d("host.guest_name","Guest Name")}),e.jsx("div",{className:"sbv-kv-val",children:(u==null?void 0:u.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:d("host.num_guests","Guests")}),e.jsx("div",{className:"sbv-kv-val",children:(u==null?void 0:u.guestCount)!=null?String(u.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:d("host.reservation_time","Reservation Time")}),e.jsx("div",{className:"sbv-kv-val",children:(u==null?void 0:u.reservationTime)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:d("pos.waiter.items_label","Items")}),e.jsx("div",{className:"sbv-kv-val",children:(u==null?void 0:u.itemsCount)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:d("pos.waiter.subtotal","Subtotal")}),e.jsx("div",{className:"sbv-kv-val",children:(u==null?void 0:u.subtotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:R==="dirty"&&(v!=null&&v.number)?e.jsx("button",{className:"sbv-success-btn",onClick:V,children:d("floor.btn_mark_clean","Mark as Clean")}):R==="occupied"&&(v!=null&&v.number)?e.jsx("a",{className:"sbv-primary-btn",href:`/waiter/${r}/${v.number}`,children:d("pos.waiter.btn_open_order","Open Order")}):e.jsx("button",{className:"sbv-secondary-btn",onClick:I,children:d("common.btn_close","Close")})})]}):e.jsxs("div",{className:"sbv-right-empty",children:[e.jsx("div",{className:"sbv-right-empty-title",children:d("host.table_details","Table Details")}),e.jsx("div",{className:"sbv-right-empty-sub",children:d("host.floor_map_help","Select a table on the map to view details.")})]})})]})})}const B=document.getElementById("sb-floor-root");if(!B)throw new Error("Missing #sb-floor-root");const te=B.getAttribute("data-rid")||B.getAttribute("data-restaurant-id")||"",re=B.getAttribute("data-click-mode")||B.getAttribute("data-mode")||"page",ne=re==="lobby"?"lobby":"page";console.info("[FloorView] mount",{rid:te,mountMode:ne,clickMode:re});le.createRoot(B).render(e.jsx(j.StrictMode,{children:e.jsx(pe,{restaurantId:te,mountMode:ne})}));
