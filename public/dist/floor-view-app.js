import{r as g,j as s,c as G,R as J}from"./floor-index.js";const p="/floor_assets/",Y=(t,c=1)=>{const l=Number(t);return Number.isFinite(l)?Math.max(.5,Math.min(1.6,l)):c},X=t=>{const c=Number(t);return Number.isFinite(c)?Math.round(c/45)*45:0},Q=t=>{if(!t||t.startsWith("#"))return"parquet_blue";const c=t;return c==="parquet_blue"||c==="parquet_brown"||c==="slate_dark"||c==="navy_carpet"||c==="teal_terrazzo"?c:"parquet_blue"};function ee(t){return{parquet_blue:{bg:`url(${p}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${p}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${p}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${p}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${p}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[t]}function te(t,c){const l=String(t||"square").toLowerCase(),a=Number(c||0);return l==="round"?`${p}${a>=9?"round_table_10.svg":"round_table4.svg"}`:l==="booth"?`${p}${a>=6?"large_booth.svg":"booth4.svg"}`:l==="rect"?`${p}${a>=10?"square_table10.svg":a>=6?"square_table6.svg":a>=4?"square_table4.svg":"square_table2.svg"}`:`${p}${a>=10?"square_table10.svg":a>=6?"square_table6.svg":a>=4?"square_table4.svg":"square_table2.svg"}`}function se(t,c){const l=String(t||"").toLowerCase();return l==="door"?`${p}door.svg`:l==="wall"?`${p}wall.svg`:l==="divider"?`${p}divider.svg`:l==="chair"?`${p}chair.svg`:l==="bar"?`${p}bar.svg`:l==="plant"?`${p}plant.svg`:c?`${p}${c}.svg`:`${p}divider.svg`}function re({layout:t,mode:c,onTableClick:l,selectedTableId:a}){const h=g.useRef(null),q=g.useRef(null),[N,x]=g.useState(1),[M,I]=g.useState({x:0,y:0}),[L,S]=g.useState(!1),[_,z]=g.useState(!1),$=60,R=10,k=g.useMemo(()=>Q(t.floorColor),[t==null?void 0:t.id]),n=g.useMemo(()=>ee(k),[k]);g.useEffect(()=>{const e=i=>{i.code==="Space"&&S(!0)},r=i=>{i.code==="Space"&&(S(!1),z(!1))};return window.addEventListener("keydown",e),window.addEventListener("keyup",r),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",r)}},[]);const m=e=>Math.max(.4,Math.min(2.5,e)),v=()=>{if(!h.current)return;const e=h.current.getBoundingClientRect(),r=t.gridCols*$+R*2,i=t.gridRows*$+R*2,f=24,o=m(Math.min((e.width-f*2)/r,(e.height-f*2)/i,1.2));x(o);const j=Math.round((e.width-r*o)/2),d=Math.round((e.height-i*o)/2);I({x:j,y:d})};g.useEffect(()=>{requestAnimationFrame(v)},[t==null?void 0:t.id]);const u=(e,r,i)=>{if(!h.current)return;const f=h.current.getBoundingClientRect(),o=r-f.left,j=i-f.top;I(d=>{const y=e/N;return{x:Math.round(o-(o-d.x)*y),y:Math.round(j-(j-d.y)*y)}}),x(e)},E=e=>{if(!(e.ctrlKey||e.metaKey))return;e.preventDefault();const r=m(N*(e.deltaY>0?.9:1.1));u(r,e.clientX,e.clientY)},A=e=>{const r=e.button===1,i=L&&e.button===0;if(!r&&!i)return;e.preventDefault(),z(!0);const f={x:e.clientX,y:e.clientY},o={...M},j=y=>{I({x:o.x+(y.clientX-f.x),y:o.y+(y.clientY-f.y)})},d=()=>{z(!1),window.removeEventListener("mousemove",j),window.removeEventListener("mouseup",d)};window.addEventListener("mousemove",j),window.addEventListener("mouseup",d)},w=e=>Math.max(1,Number(e)||1)*$,F=g.useMemo(()=>{const e=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(r=>{const i=r&&r.tableId?String(r.tableId):"";i&&e.set(i,{status:String(r.status||"empty"),guestName:r.guestName??null,guestCount:r.guestCount??null,orderId:r.orderId??null})}),e},[t]),D=g.useMemo(()=>{const e=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(r=>{const i=Number(r&&(r.tableNumber??0));!Number.isFinite(i)||i<=0||e.set(i,{status:String(r.status||"empty"),guestName:r.guestName??null,guestCount:r.guestCount??null,orderId:r.orderId??null})}),e},[t]),B=e=>{const r=e.id?F.get(String(e.id)):void 0;if(r)return r;const i=Number(e.tableNumber??0);if(Number.isFinite(i)&&i>0){const f=D.get(i);if(f)return f}return{status:"empty"}};return s.jsxs("div",{className:`editor-canvas ${_?"is-panning":""}`,ref:h,onWheel:E,onMouseDown:A,style:{position:"relative"},children:[s.jsxs("div",{className:"fe-canvas-controls",children:[s.jsx("button",{className:"btn-icon-small",onClick:()=>{var r;const e=(r=h.current)==null?void 0:r.getBoundingClientRect();u(m(N*1.1),((e==null?void 0:e.left)||0)+40,((e==null?void 0:e.top)||0)+40)},title:"Zoom in",children:"＋"}),s.jsx("button",{className:"btn-icon-small",onClick:()=>{var r;const e=(r=h.current)==null?void 0:r.getBoundingClientRect();u(m(N*.9),((e==null?void 0:e.left)||0)+40,((e==null?void 0:e.top)||0)+40)},title:"Zoom out",children:"－"}),s.jsx("button",{className:"btn-icon-small",onClick:v,title:"Fit to screen",children:"⤢"}),s.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(N*100),"%"]}),s.jsx("div",{className:"fe-hint",children:L?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),s.jsx("div",{className:"fe-grid",ref:q,style:{direction:"ltr",gridTemplateColumns:`repeat(${t.gridCols}, ${$}px)`,gridTemplateRows:`repeat(${t.gridRows}, ${$}px)`,transform:`translate(${M.x}px, ${M.y}px) scale(${N})`,transformOrigin:"0 0","--cell":`${$}px`,"--floor-bg":n.bg,"--floor-bg-size":n.size,"--floor-bg-repeat":n.repeat,"--floor-bg-position":n.pos},children:Array.from({length:t.gridRows*t.gridCols}).map((e,r)=>{var T;const i=Math.floor(r/t.gridCols),f=r%t.gridCols,o=t.tables.find(b=>f>=b.gridX&&f<b.gridX+(b.spanX||1)&&i>=b.gridY&&i<b.gridY+(b.spanY||1)),d=(t.objects??[]).find(b=>f>=b.gridX&&f<b.gridX+(b.spanX||1)&&i>=b.gridY&&i<b.gridY+(b.spanY||1)),y=!!o&&o.gridX===f&&o.gridY===i,U=!!d&&d.gridX===f&&d.gridY===i,K=i*t.gridCols+f,W=(((T=t.gridMask)==null?void 0:T[K])??1)===1;return s.jsxs("div",{className:`fe-grid-cell ${W?"active":"inactive"}`,children:[U&&d&&s.jsxs("div",{className:`floor-object type-${d.type}`,style:{left:R,top:R,width:`${w(d.spanX)}px`,height:`${w(d.spanY)}px`,transform:`rotate(${X(d.rotationDeg??d.rotation??0)}deg)`},children:[s.jsx("img",{className:`fe-asset fe-asset--${(d.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${Y(d.scale,1)})`},src:d.assetFile?`${p}${d.assetFile}`:se(d.type,d.label),alt:""}),d.label&&s.jsx("div",{className:"obj-label",children:d.label})]}),y&&o&&(()=>{const b=B(o),C=String(b.status||"empty"),H=a&&String(a)===String(o.id),O=c==="view"&&C&&C!=="empty",Z=C==="occupied"?"תפוס":C==="reserved"?"שמור":C==="dirty"?"מלוכלך":"פנוי",V=b.guestCount!=null&&b.guestCount!==""?` · ${b.guestCount}`:"";return s.jsxs("div",{className:`floor-table shape-${String(o.shape||"square")} status-${C} ${H?"is-selected":""}`,onClick:()=>l==null?void 0:l(o.id),style:{position:"relative",width:`${w(o.spanX)}px`,height:`${w(o.spanY)}px`,transform:`rotate(${X(o.rotationDeg??o.rotation??0)}deg)`,cursor:c==="view"?"pointer":"default"},children:[s.jsx("img",{className:`fe-asset fe-asset--${(o.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${Y(o.scale,1)})`},src:o.assetFile?`${p}${o.assetFile}`:te(o.shape,o.seats),alt:""}),o.tableNumber!=null&&s.jsx("div",{className:"table-number",children:o.tableNumber}),O&&s.jsxs("div",{className:`sbv-status-pill is-${C}`,children:[s.jsx("span",{className:"sbv-dot"}),s.jsxs("span",{className:"sbv-status-text",children:[Z,V]})]})]})})()]},r)})})]})}function ne({restaurantId:t}){const[c,l]=g.useState({kind:"loading"}),[a,h]=g.useState(null),[q,N]=g.useState(null),[x,M]=g.useState(""),[I,L]=g.useState(0),S=g.useRef(null),_=g.useMemo(()=>String(t||"").trim(),[t]),z=g.useMemo(()=>{const n=new Set;((a==null?void 0:a.tables)||[]).forEach(v=>{const u=String(v.sectionId||"").trim();u&&n.add(u)});const m=Array.from(n);return[""].concat(m)},[a==null?void 0:a.id,a==null?void 0:a.tables]),$=(n,m)=>{if(!n)return"כל המסעדה";const v=String(n);return v.length<=22?v:`אזור ${m}`},R=n=>{const m=a==null?void 0:a.tableStatuses;if(!Array.isArray(m))return{status:"empty"};const v=m.find(u=>u&&String(u.tableId||"")===String(n));return v?{status:String(v.status||"empty")}:{status:"empty"}};g.useEffect(()=>{let n=!1;const m=async(v=!1)=>{if(!_){l({kind:"error",message:"Missing restaurant id (rid)"});return}v||l({kind:"loading"});try{const u=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`);if(!u.ok){const w=await u.json().catch(()=>({})),F=w&&(w.error||w.message)||`${u.status} ${u.statusText}`;throw new Error(F)}const E=await u.json();if(n)return;h(E),l({kind:"ready"}),L(Date.now()),!x||(E.tables||[]).some(w=>String(w.sectionId||"")===String(x))||M("")}catch(u){if(n)return;h(null),l({kind:"error",message:u instanceof Error?u.message:String(u)})}};return m(),S.current&&window.clearInterval(S.current),S.current=window.setInterval(()=>{m(!0)},5e3),()=>{n=!0,S.current&&window.clearInterval(S.current),S.current=null}},[_]);const k=g.useMemo(()=>{if(!a)return null;if(!x)return a;const n=String(x);return{...a,tables:(a.tables||[]).filter(m=>String(m.sectionId||"")===n)}},[a,x]);return c.kind==="loading"?s.jsx("div",{className:"sb-floor-view-shell",children:s.jsx("div",{className:"sb-floor-view-loading",children:"Loading floor map…"})}):c.kind==="error"?s.jsx("div",{className:"sb-floor-view-shell",children:s.jsxs("div",{className:"sb-floor-view-error",children:[s.jsx("div",{className:"title",children:"לא ניתן לטעון את מפת המסעדה."}),s.jsx("div",{className:"desc",children:c.message}),s.jsx("div",{className:"hint",children:"(בדוק את ה-Console לפרטי דיבוג)"})]})}):s.jsxs("div",{className:"floor-editor sb-floor-view",children:[s.jsxs("div",{className:"layout-tabs-bar",children:[s.jsx("div",{className:"layout-tabs",role:"tablist","aria-label":"Sections",children:z.map((n,m)=>s.jsx("button",{className:`layout-tab ${String(x)===String(n)?"active":""}`,onClick:()=>M(String(n)),type:"button",role:"tab","aria-selected":String(x)===String(n),children:$(String(n),m)},n||"all"))}),s.jsxs("div",{className:"layout-actions",children:[s.jsxs("div",{className:"sbv-legend",title:"Legend",children:[s.jsxs("span",{className:"sbv-leg",children:[s.jsx("span",{className:"sbv-dot empty"}),"פנוי"]}),s.jsxs("span",{className:"sbv-leg",children:[s.jsx("span",{className:"sbv-dot occupied"}),"תפוס"]}),s.jsxs("span",{className:"sbv-leg",children:[s.jsx("span",{className:"sbv-dot reserved"}),"שמור"]}),s.jsxs("span",{className:"sbv-leg",children:[s.jsx("span",{className:"sbv-dot dirty"}),"מלוכלך"]})]}),s.jsx("button",{type:"button",className:"btn-icon-small",title:"Refresh",onClick:async()=>{try{const n=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`,{cache:"no-store"});if(!n.ok)throw new Error(`${n.status} ${n.statusText}`);const m=await n.json();h(m),L(Date.now())}catch(n){console.error("[FloorView] manual refresh failed",n)}},children:"↻"}),s.jsx("div",{className:"sbv-refresh",children:I?`עודכן: ${new Date(I).toLocaleTimeString()}`:""})]})]}),s.jsx("div",{className:"editor-content sbv-content",children:s.jsx("div",{className:"editor-main sbv-main",children:k&&s.jsx(re,{layout:k,mode:"view",selectedTableId:q,onTableClick:n=>{if(N(n),R(n).status==="occupied"){const v=((a==null?void 0:a.tables)||[]).find(E=>String(E.id)===String(n)),u=v==null?void 0:v.tableNumber;if(u!=null){window.location.href=`/waiter/${encodeURIComponent(_)}/${encodeURIComponent(String(u))}`;return}}alert("שולחן לא תפוס כרגע. הושבה נעשית דרך מסך המארחת.")}})})})]})}function ae(){const t=document.getElementById("sb-floor-root"),c=(t==null?void 0:t.getAttribute("data-rid"))||"";if(c)return c;const l=new URLSearchParams(window.location.search);return l.get("rid")||l.get("restaurantId")||""}const P=document.getElementById("sb-floor-root");if(P){const t=ae();G.createRoot(P).render(s.jsx(J.StrictMode,{children:s.jsx(ne,{restaurantId:t})}))}
