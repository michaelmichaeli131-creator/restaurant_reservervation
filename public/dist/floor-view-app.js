import{r as f,j as e,R as g,c as ae}from"./floor-index.js";const v="/floor_assets/",O=(r,a=1)=>{const d=Number(r);return Number.isFinite(d)?Math.max(.5,Math.min(1.6,d)):a},U=r=>{const a=Number(r);return Number.isFinite(a)?Math.round(a/45)*45:0},ie=r=>{if(!r||r.startsWith("#"))return"parquet_blue";const a=r;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function oe(r){return{parquet_blue:{bg:`url(${v}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${v}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${v}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${v}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${v}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[r]}function le(r,a){const d=String(r||"square").toLowerCase(),p=Number(a||0);return d==="round"?`${v}${p>=9?"round_table_10.svg":"round_table4.svg"}`:d==="booth"?`${v}${p>=6?"large_booth.svg":"booth4.svg"}`:d==="rect"?`${v}${p>=10?"square_table10.svg":p>=6?"square_table6.svg":p>=4?"square_table4.svg":"square_table2.svg"}`:`${v}${p>=10?"square_table10.svg":p>=6?"square_table6.svg":p>=4?"square_table4.svg":"square_table2.svg"}`}function ce(r,a){const d=String(r||"").toLowerCase();return d==="door"?`${v}door.svg`:d==="wall"?`${v}wall.svg`:d==="divider"?`${v}divider.svg`:d==="chair"?`${v}chair.svg`:d==="bar"?`${v}bar.svg`:d==="plant"?`${v}plant.svg`:a?`${v}${a}.svg`:`${v}divider.svg`}function ue({layout:r,mode:a,onTableClick:d,selectedTableId:p}){const _=f.useRef(null),Y=f.useRef(null),[j,R]=f.useState(1),[M,k]=f.useState({x:0,y:0}),[A,T]=f.useState(!1),[w,h]=f.useState(!1),S=60,x=f.useMemo(()=>ie(r.floorColor),[r==null?void 0:r.id]),b=f.useMemo(()=>oe(x),[x]);f.useEffect(()=>{const s=n=>{n.code==="Space"&&T(!0)},t=n=>{n.code==="Space"&&(T(!1),h(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",t)}},[]);const l=s=>Math.max(.4,Math.min(2.5,s)),X=()=>{if(!_.current||!Y.current)return;const s=_.current,t=Y.current,n=getComputedStyle(t),m=(parseFloat(n.marginLeft)||0)+(parseFloat(n.marginRight)||0),i=(parseFloat(n.marginTop)||0)+(parseFloat(n.marginBottom)||0),y=t.offsetWidth+m,o=t.offsetHeight+i;if(!y||!o)return;const $=24,C=Math.max(1,s.clientWidth-$*2),I=Math.max(1,s.clientHeight-$*2),z=l(Math.min(C/y,I/o,1.2));R(z);const F=Math.round((s.clientWidth-y*z)/2),u=Math.round((s.clientHeight-o*z)/2);k({x:F,y:u})};f.useEffect(()=>{requestAnimationFrame(X)},[r==null?void 0:r.id]);const P=(s,t,n)=>{if(!_.current)return;const m=_.current.getBoundingClientRect(),i=t-m.left,y=n-m.top;k(o=>{const $=s/j;return{x:Math.round(i-(i-o.x)*$),y:Math.round(y-(y-o.y)*$)}}),R(s)},D=s=>{if(!(s.ctrlKey||s.metaKey))return;s.preventDefault();const t=l(j*(s.deltaY>0?.9:1.1));P(t,s.clientX,s.clientY)},H=s=>{const t=s.target;if(a==="view"){if(s.button!==0||t!=null&&t.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),h(!0);const C={x:s.clientX,y:s.clientY},I={...M},z=u=>{k({x:I.x+(u.clientX-C.x),y:I.y+(u.clientY-C.y)})},F=()=>{h(!1),window.removeEventListener("mousemove",z),window.removeEventListener("mouseup",F)};window.addEventListener("mousemove",z),window.addEventListener("mouseup",F);return}const n=s.button===1,m=A&&s.button===0;if(!n&&!m)return;s.preventDefault(),h(!0);const i={x:s.clientX,y:s.clientY},y={...M},o=C=>{k({x:y.x+(C.clientX-i.x),y:y.y+(C.clientY-i.y)})},$=()=>{h(!1),window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",$)};window.addEventListener("mousemove",o),window.addEventListener("mouseup",$)},c=f.useRef(null),L=s=>{if(a!=="view"||s.touches.length!==1)return;const t=s.touches[0],n=s.target;n!=null&&n.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),h(!0),c.current={startX:t.clientX,startY:t.clientY,panX:M.x,panY:M.y,active:!0})},N=s=>{if(a!=="view")return;const t=c.current;if(!t||!t.active||s.touches.length!==1)return;const n=s.touches[0];s.preventDefault(),k({x:t.panX+(n.clientX-t.startX),y:t.panY+(n.clientY-t.startY)})},B=()=>{a==="view"&&(c.current=null,h(!1))},q=s=>Math.max(1,Number(s)||1)*S,K=s=>{const t=(s||"").toLowerCase();return t.includes("occup")||t==="busy"||t==="taken"?"occupied":t.includes("reserv")||t.includes("book")?"reserved":t.includes("dirty")||t.includes("need")||t.includes("clean")?"dirty":"empty"},J=f.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=t&&t.tableId?String(t.tableId):"";n&&s.set(n,{status:K(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),Q=f.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=Number(t&&(t.tableNumber??0));!Number.isFinite(n)||n<=0||s.set(n,{status:K(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),ee=s=>{const t=s.id?J.get(String(s.id)):void 0;if(t)return t;const n=Number(s.tableNumber??0);if(Number.isFinite(n)&&n>0){const m=Q.get(n);if(m)return m}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${w?"is-panning":""}`,ref:_,onWheel:D,onMouseDown:H,onTouchStart:L,onTouchMove:N,onTouchEnd:B,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=_.current)==null?void 0:t.getBoundingClientRect();P(l(j*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=_.current)==null?void 0:t.getBoundingClientRect();P(l(j*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"}),e.jsx("button",{className:"btn-icon-small",onClick:X,title:"Fit to screen",children:"⤢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(j*100),"%"]}),e.jsx("div",{className:"fe-hint",children:A?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:Y,style:{direction:"ltr",gridTemplateColumns:`repeat(${r.gridCols}, ${S}px)`,gridTemplateRows:`repeat(${r.gridRows}, ${S}px)`,transform:`translate(${M.x}px, ${M.y}px) scale(${j})`,transformOrigin:"0 0","--cell":`${S}px`,"--floor-bg":b.bg,"--floor-bg-size":b.size,"--floor-bg-repeat":b.repeat,"--floor-bg-position":b.pos},children:Array.from({length:r.gridRows*r.gridCols}).map((s,t)=>{var F;const n=Math.floor(t/r.gridCols),m=t%r.gridCols,i=r.tables.find(u=>m>=u.gridX&&m<u.gridX+(u.spanX||1)&&n>=u.gridY&&n<u.gridY+(u.spanY||1)),o=(r.objects??[]).find(u=>m>=u.gridX&&m<u.gridX+(u.spanX||1)&&n>=u.gridY&&n<u.gridY+(u.spanY||1)),$=!!i&&i.gridX===m&&i.gridY===n,C=!!o&&o.gridX===m&&o.gridY===n,I=n*r.gridCols+m,z=(((F=r.gridMask)==null?void 0:F[I])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${z?"active":"inactive"}`,children:[C&&o&&e.jsxs("div",{className:`floor-object type-${o.type}`,style:{width:`${q(o.spanX)}px`,height:`${q(o.spanY)}px`,transform:`rotate(${U(o.rotationDeg??o.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(o.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${O(o.scale,1)})`},src:o.assetFile?`${v}${o.assetFile}`:ce(o.type,o.label),alt:""}),o.label&&e.jsx("div",{className:"obj-label",children:o.label})]}),$&&i&&(()=>{const u=ee(i),W=String(u.status||"empty"),se=p&&String(p)===String(i.id),te=a==="view",re=W==="occupied"?"תפוס":W==="reserved"?"שמור":W==="dirty"?"מלוכלך":"פנוי",ne=u.guestCount!=null&&u.guestCount!==""?` · ${u.guestCount}`:"";return e.jsxs("div",{className:`table ${String(i.shape||"square")} ${se?"selected":""}`,onClick:()=>d==null?void 0:d(i.id),style:{position:"absolute",top:0,left:0,width:`${q(i.spanX)}px`,height:`${q(i.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":i.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(i.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${U(i.rotationDeg??i.rotation??0)}deg) scale(${O(i.scale,1)})`},src:i.assetFile?`${v}${i.assetFile}`:le(i.shape,i.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:i.name||(i.tableNumber!=null?`Table ${i.tableNumber}`:"Table")}),i.seats!=null&&e.jsxs("div",{className:"table-seats",children:[i.seats," seats"]})]}),te&&e.jsxs("div",{className:`sbv-status-pill is-${W}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[re,ne]})]})]})})()]},t)})})]})}function de(r){const a=(r||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function ve(r){switch(r){case"occupied":return"תפוס";case"reserved":return"שמור";case"dirty":return"מלוכלך";default:return"פנוי"}}function me({restaurantId:r,mountMode:a="page"}){const[d,p]=g.useState([]),[_,Y]=g.useState(null),[j,R]=g.useState(null),[M,k]=g.useState(!0),[A,T]=g.useState(null),[w,h]=g.useState(null),S=g.useCallback(async()=>{try{const c=await fetch(`/api/floor-layouts/${r}/active`,{headers:{"Content-Type":"application/json"}});if(!c.ok)throw new Error(`HTTP ${c.status}`);const L=await c.json(),N=(L==null?void 0:L.activeLayout)??null;if(!N){p([]),Y(null),R(null),T("אין מפת מסעדה פעילה"),k(!1);return}p([N]),Y(N.id),R(B=>B??N.id),T(null),k(!1),w&&((N.tables||[]).some(q=>String(q.id)===String(w))||h(null))}catch(c){T(`שגיאה בטעינת המפה: ${(c==null?void 0:c.message)??"unknown"}`),k(!1)}},[r,w]);g.useEffect(()=>{S();const c=setInterval(S,5e3);return()=>clearInterval(c)},[S]);const x=g.useMemo(()=>j?d.find(c=>c.id===j)??null:null,[d,j]),b=g.useMemo(()=>!x||!w?null:(x.tables||[]).find(c=>String(c.id)===String(w))??null,[x,w]),l=g.useMemo(()=>{if(!x||!b)return null;const c=x.tableStatuses;if(!Array.isArray(c))return null;const L=c.find(N=>String(N.tableId)===String(b.id));return L||(c.find(N=>N.tableNumber===b.number)??null)},[x,b]),X=g.useMemo(()=>de(l==null?void 0:l.status),[l]),P=c=>{h(c)},D=()=>h(null),H=`floor-editor sb-floor-view ${a==="lobby"?"is-embed":""}`;return M?e.jsx("div",{className:H,children:e.jsx("div",{className:"sbv-loading",children:"טוען מפת מסעדה…"})}):A||!x?e.jsx("div",{className:H,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:"לא ניתן לטעון את מפת המסעדה"}),e.jsx("div",{className:"sbv-error-sub",children:A??"קרתה שגיאה בטעינת המפה"}),e.jsx("button",{className:"sbv-retry",onClick:S,children:"נסה שוב"})]})}):e.jsxs("div",{className:H,children:[e.jsxs("div",{className:"layout-tabs",children:[e.jsxs("div",{className:"layout-tabs-left",children:[e.jsx("div",{className:"layout-tabs-title",children:"תצוגת מפת מסעדה"}),e.jsx("div",{className:"layout-tabs-sub",children:"גרור כדי להזיז • גלגלת כדי להגדיל"})]}),e.jsx("div",{className:"layout-tabs-right",children:e.jsxs("div",{className:"sbv-legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," פנוי"]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," תפוס"]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," שמור"]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," מלוכלך"]})]})})]}),e.jsx("div",{className:"editor-content",children:e.jsx("div",{className:"editor-main",children:e.jsx(ue,{layout:x,selectedTableId:w,onTableClick:P,mode:"view"})})}),w&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:D}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-close",onClick:D,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:["שולחן ",(b==null?void 0:b.number)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${X}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:"סטטוס שולחן"}),e.jsx("span",{className:"sbv-status-value",children:ve(X)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שם המזמין"}),e.jsx("div",{className:"sbv-kv-val",children:(l==null?void 0:l.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-kv-val",children:(l==null?void 0:l.guestCount)!=null?String(l.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-kv-val",children:(l==null?void 0:l.reservationTime)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-kv-val",children:(l==null?void 0:l.itemsCount)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-kv-val",children:(l==null?void 0:l.subtotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:X==="occupied"&&(b!=null&&b.number)?e.jsx("a",{className:"sbv-primary-btn",href:`/waiter/${r}/${b.number}`,children:"פתח הזמנה"}):e.jsx("button",{className:"sbv-secondary-btn",onClick:D,children:"סגור"})})]})]})]})}const E=document.getElementById("sb-floor-root");if(!E)throw new Error("Missing #sb-floor-root");const Z=E.getAttribute("data-rid")||E.getAttribute("data-restaurant-id")||"",V=E.getAttribute("data-click-mode")||E.getAttribute("data-mode")||"page",G=V==="lobby"?"lobby":"page";console.info("[FloorView] mount",{rid:Z,mountMode:G,clickMode:V});ae.createRoot(E).render(e.jsx(g.StrictMode,{children:e.jsx(me,{restaurantId:Z,mountMode:G})}));
