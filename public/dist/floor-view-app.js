import{r as x,j as e,R as w,a as ue,c as de}from"./floor-index.js";const f="/floor_assets/",ne=(s,o=1)=>{const v=Number(s);return Number.isFinite(v)?Math.max(.5,Math.min(1.6,v)):o},re=s=>{const o=Number(s);return Number.isFinite(o)?Math.round(o/45)*45:0},ve=s=>{if(!s||s.startsWith("#"))return"parquet_blue";const o=s;return o==="parquet_blue"||o==="parquet_brown"||o==="slate_dark"||o==="navy_carpet"||o==="teal_terrazzo"?o:"parquet_blue"};function be(s){return{parquet_blue:{bg:`url(${f}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${f}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${f}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${f}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${f}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[s]}function me(s,o){const v=String(s||"square").toLowerCase(),p=Number(o||0);return v==="round"?`${f}${p>=9?"round_table_10.svg":"round_table4.svg"}`:v==="booth"?`${f}${p>=6?"large_booth.svg":"booth4.svg"}`:v==="rect"?`${f}${p>=10?"square_table10.svg":p>=6?"square_table6.svg":p>=4?"square_table4.svg":"square_table2.svg"}`:`${f}${p>=10?"square_table10.svg":p>=6?"square_table6.svg":p>=4?"square_table4.svg":"square_table2.svg"}`}function fe(s,o){const v=String(s||"").toLowerCase();return v==="door"?`${f}door.svg`:v==="wall"?`${f}wall.svg`:v==="divider"?`${f}divider.svg`:v==="chair"?`${f}chair.svg`:v==="bar"?`${f}bar.svg`:v==="plant"?`${f}plant.svg`:o?`${f}${o}.svg`:`${f}divider.svg`}function pe({layout:s,mode:o,onTableClick:v,selectedTableId:p,selectedTableIds:A}){const _=o==="edit",g=x.useRef(null),D=x.useRef(null),[F,B]=x.useState(1),[R,E]=x.useState({x:0,y:0}),[j,H]=x.useState(!1),[O,L]=x.useState(!1),y=x.useRef(F);x.useEffect(()=>{y.current=F},[F]);const m=x.useRef(null),S=60,i=x.useMemo(()=>ve(s.floorColor),[s==null?void 0:s.id]),P=x.useMemo(()=>be(i),[i]);x.useEffect(()=>{const t=a=>{a.code==="Space"&&H(!0)},n=a=>{a.code==="Space"&&(H(!1),L(!1))};return window.addEventListener("keydown",t),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",n)}},[]);const $=t=>Math.max(.4,Math.min(2.5,t)),X=()=>{if(!g.current||!D.current)return;const t=g.current,n=D.current,a=getComputedStyle(n),h=(parseFloat(a.marginLeft)||0)+(parseFloat(a.marginRight)||0),l=(parseFloat(a.marginTop)||0)+(parseFloat(a.marginBottom)||0),C=n.offsetWidth+h,u=n.offsetHeight+l;if(!C||!u)return;const k=getComputedStyle(t),M=parseFloat(k.paddingLeft||"0")||0,Z=parseFloat(k.paddingRight||"0")||0,z=parseFloat(k.paddingTop||"0")||0,I=parseFloat(k.paddingBottom||"0")||0,d=24,T=Math.max(1,t.clientWidth-M-Z-d*2),q=Math.max(1,t.clientHeight-z-I-d*2),Y=$(Math.min(T/C,q/u,1.2));B(Y);const J=Math.round(M+d+(T-C*Y)/2),se=Math.round(z+d+(q-u*Y)/2);E({x:J,y:se})};x.useEffect(()=>{requestAnimationFrame(X)},[s==null?void 0:s.id]),x.useEffect(()=>{if(!g.current)return;let t=0;const n=new ResizeObserver(()=>{cancelAnimationFrame(t),t=requestAnimationFrame(X)});return n.observe(g.current),()=>{cancelAnimationFrame(t),n.disconnect()}},[s==null?void 0:s.id]);const U=(t,n,a)=>{if(!g.current)return;const h=g.current.getBoundingClientRect(),l=n-h.left,C=a-h.top;E(u=>{const k=t/(y.current||1);return{x:Math.round(l-(l-u.x)*k),y:Math.round(C-(C-u.y)*k)}}),B(t)};x.useEffect(()=>{const t=g.current;if(!t)return;const n=a=>{if(!!!(a.ctrlKey||a.metaKey)||(a.preventDefault(),!_))return;const l=a.deltaY>0?.9:1.1,C=$((y.current||1)*l);U(C,a.clientX,a.clientY)};return t.addEventListener("wheel",n,{passive:!1}),()=>t.removeEventListener("wheel",n)},[_]);const Q=t=>{const n=t.target;if(o==="view"){if(t.button!==0||n!=null&&n.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;t.preventDefault(),m.current={moved:!1};const M={x:t.clientX,y:t.clientY},Z={...R};let z=!1;const I=T=>{const q=T.clientX-M.x,Y=T.clientY-M.y,J=Math.abs(q)+Math.abs(Y);!z&&J>4&&(z=!0,m.current&&(m.current.moved=!0),L(!0)),z&&E({x:Z.x+q,y:Z.y+Y})},d=()=>{z&&L(!1),window.removeEventListener("mousemove",I),window.removeEventListener("mouseup",d),m.current&&!m.current.moved&&(m.current=null)};window.addEventListener("mousemove",I),window.addEventListener("mouseup",d);return}const a=t.button===1,h=j&&t.button===0;if(!a&&!h)return;t.preventDefault(),L(!0);const l={x:t.clientX,y:t.clientY},C={...R},u=M=>{E({x:C.x+(M.clientX-l.x),y:C.y+(M.clientY-l.y)})},k=()=>{L(!1),window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",k)};window.addEventListener("mousemove",u),window.addEventListener("mouseup",k)},W=x.useRef(null),G=t=>{if(o!=="view"||t.touches.length!==1)return;const n=t.touches[0],a=t.target;a!=null&&a.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(t.preventDefault(),L(!0),W.current={startX:n.clientX,startY:n.clientY,panX:R.x,panY:R.y,active:!0})},r=t=>{if(o!=="view")return;const n=W.current;if(!n||!n.active||t.touches.length!==1)return;const a=t.touches[0];t.preventDefault(),E({x:n.panX+(a.clientX-n.startX),y:n.panY+(a.clientY-n.startY)})},b=()=>{o==="view"&&(W.current=null,L(!1))},c=t=>Math.max(1,Number(t)||1)*S,N=t=>{const n=(t||"").toLowerCase();return n.includes("occup")||n==="busy"||n==="taken"?"occupied":n.includes("reserv")||n.includes("book")?"reserved":n.includes("dirty")||n.includes("need")||n.includes("clean")?"dirty":"empty"},V=x.useMemo(()=>{const t=new Map;return(Array.isArray(s.tableStatuses)?s.tableStatuses:[]).forEach(n=>{const a=n&&n.tableId?String(n.tableId):"";a&&t.set(a,{status:N(String(n.status||"empty")),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),t},[s]),ie=x.useMemo(()=>{const t=new Map;return(Array.isArray(s.tableStatuses)?s.tableStatuses:[]).forEach(n=>{const a=Number(n&&(n.tableNumber??0));!Number.isFinite(a)||a<=0||t.set(a,{status:N(String(n.status||"empty")),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),t},[s]),le=t=>{const n=t.id?V.get(String(t.id)):void 0;if(n)return n;const a=Number(t.tableNumber??0);if(Number.isFinite(a)&&a>0){const h=ie.get(a);if(h)return h}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${O?"is-panning":""}`,ref:g,onMouseDown:Q,onTouchStart:G,onTouchMove:r,onTouchEnd:b,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[_?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const t=(n=g.current)==null?void 0:n.getBoundingClientRect();U($(F*1.1),((t==null?void 0:t.left)||0)+40,((t==null?void 0:t.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const t=(n=g.current)==null?void 0:n.getBoundingClientRect();U($(F*.9),((t==null?void 0:t.left)||0)+40,((t==null?void 0:t.top)||0)+40)},title:"Zoom out",children:"－"})]}):null,e.jsx("button",{className:"btn-icon-small",onClick:X,title:"Center",children:"⤢"}),_?e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(F*100),"%"]}):null,e.jsx("div",{className:"fe-hint",children:o==="view"?"Drag to pan":j?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:D,onClickCapture:t=>{var n;o==="view"&&(n=m.current)!=null&&n.moved&&(t.preventDefault(),t.stopPropagation(),m.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${s.gridCols}, ${S}px)`,gridTemplateRows:`repeat(${s.gridRows}, ${S}px)`,transform:`translate(${R.x}px, ${R.y}px) scale(${F})`,transformOrigin:"0 0","--cell":`${S}px`,"--floor-bg":P.bg,"--floor-bg-size":P.size,"--floor-bg-repeat":P.repeat,"--floor-bg-position":P.pos},children:Array.from({length:s.gridRows*s.gridCols}).map((t,n)=>{var I;const a=Math.floor(n/s.gridCols),h=n%s.gridCols,l=s.tables.find(d=>h>=d.gridX&&h<d.gridX+(d.spanX||1)&&a>=d.gridY&&a<d.gridY+(d.spanY||1)),u=(s.objects??[]).find(d=>h>=d.gridX&&h<d.gridX+(d.spanX||1)&&a>=d.gridY&&a<d.gridY+(d.spanY||1)),k=!!l&&l.gridX===h&&l.gridY===a,M=!!u&&u.gridX===h&&u.gridY===a,Z=a*s.gridCols+h,z=(((I=s.gridMask)==null?void 0:I[Z])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${z?"active":"inactive"}`,children:[M&&u&&e.jsxs("div",{className:`floor-object type-${u.type}`,style:{width:`${c(u.spanX)}px`,height:`${c(u.spanY)}px`,transform:`rotate(${re(u.rotationDeg??u.rotation??0)}deg)`,cursor:o==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(u.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${ne(u.scale,1)})`},src:u.assetFile?`${f}${u.assetFile}`:fe(u.type,u.label),alt:""}),u.label&&e.jsx("div",{className:"obj-label",children:u.label})]}),k&&l&&(()=>{const d=le(l),T=String(d.status||"empty"),q=p&&String(p)===String(l.id)||Array.isArray(A)&&A.some(ce=>String(ce)===String(l.id)),Y=o==="view",J=T==="occupied"?"תפוס":T==="reserved"?"שמור":T==="dirty"?"מלוכלך":"פנוי",se=d.guestCount!=null&&d.guestCount!==""?` · ${d.guestCount}`:"";return e.jsxs("div",{className:`table ${String(l.shape||"square")} ${q?"selected":""}`,onClick:()=>v==null?void 0:v(l.id),style:{position:"absolute",top:0,left:0,width:`${c(l.spanX)}px`,height:`${c(l.spanY)}px`,cursor:o==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":l.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(l.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${re(l.rotationDeg??l.rotation??0)}deg) scale(${ne(l.scale,1)})`},src:l.assetFile?`${f}${l.assetFile}`:me(l.shape,l.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:l.name||(l.tableNumber!=null?`Table ${l.tableNumber}`:"Table")}),l.seats!=null&&e.jsxs("div",{className:"table-seats",children:[l.seats," seats"]})]}),Y&&e.jsxs("div",{className:`sbv-status-pill is-${T}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[J,se]})]})]})})()]},n)})})]})}function ge(s){const o=(s||"").toLowerCase();return o==="occupied"||o==="busy"||o==="taken"?"occupied":o==="reserved"||o==="booked"?"reserved":o==="dirty"||o==="needs_cleaning"?"dirty":"empty"}function ee(s){const o=[s==null?void 0:s.tableNumber,s==null?void 0:s.number,s==null?void 0:s.table_number,s==null?void 0:s.tableNum,s==null?void 0:s.table,s==null?void 0:s.name,s==null?void 0:s.label];for(const v of o){if(v==null)continue;const p=String(v).trim();if(!p)continue;const A=Number(p);if(Number.isFinite(A)&&A>0)return A;const _=p.match(/(\d{1,4})/);if(_){const g=Number(_[1]);if(Number.isFinite(g)&&g>0)return g}}return null}function he(s){switch(s){case"occupied":return"תפוס";case"reserved":return"שמור";case"dirty":return"מלוכלך";default:return"פנוי"}}function xe({restaurantId:s,mountMode:o="page"}){const[v,p]=w.useState([]),[A,_]=w.useState(null),[g,D]=w.useState(null),[F,B]=w.useState(!0),[R,E]=w.useState(null),[j,H]=w.useState(null),[O,L]=w.useState([]),y=w.useCallback(async()=>{try{const r=await fetch(`/api/floor-layouts/${s}/active`,{headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const b=await r.json(),c=b&&b.id?b:(b==null?void 0:b.activeLayout)??null;if(!c){p([]),_(null),D(null),E("אין מפת מסעדה פעילה"),B(!1);return}p([c]),_(c.id),D(N=>N??c.id),E(null),B(!1),j&&((c.tables||[]).some(V=>String(V.id)===String(j))||H(null))}catch(r){E(`שגיאה בטעינת המפה: ${(r==null?void 0:r.message)??"unknown"}`),B(!1)}},[s,j]);w.useEffect(()=>{y();const r=setInterval(y,5e3);return()=>clearInterval(r)},[y]),w.useEffect(()=>{const r=()=>y();return window.addEventListener("sb-floor-refresh",r),()=>window.removeEventListener("sb-floor-refresh",r)},[y]);const m=w.useMemo(()=>g?v.find(r=>r.id===g)??null:null,[v,g]),S=w.useMemo(()=>!m||!j?null:(m.tables||[]).find(r=>String(r.id)===String(j))??null,[m,j]),i=w.useMemo(()=>{if(!m||!S)return null;const r=m.tableStatuses;if(!Array.isArray(r))return null;const b=r.find(c=>String(c.tableId)===String(S.id));return b||(r.find(c=>c.tableNumber===ee(S))??null)},[m,S]),P=w.useMemo(()=>ge(i==null?void 0:i.status),[i]),$=o==="host",X=o==="lobby",U=r=>{if($){L(b=>{const c=new Set(b);return c.has(r)?c.delete(r):c.add(r),Array.from(c)});return}H(r)},Q=()=>H(null);w.useEffect(()=>{if(!$)return;const r=m;if(!r)return;const b=new Map;(r.tables||[]).forEach(N=>b.set(String(N.id),N));const c=O.map(N=>b.get(String(N))).filter(Boolean).map(N=>ee(N)??0).filter(N=>Number.isFinite(N)&&N>0);window.dispatchEvent(new CustomEvent("sb-floor-selection",{detail:{tableIds:O,tableNumbers:c}}))},[$,m,O]),w.useEffect(()=>{if(!$)return;const r=()=>L([]);return window.addEventListener("sb-floor-clear-selection",r),()=>window.removeEventListener("sb-floor-clear-selection",r)},[$]);const W=w.useCallback(async(r,b)=>{try{const c=await fetch(`/api/tables/${s}/${r}/status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:b})});if(!c.ok)throw new Error(`HTTP ${c.status}`);await y()}catch(c){console.warn("Failed to update table status",c)}},[s,y]),G=`floor-editor sb-floor-view ${o==="lobby"||o==="host"?"is-embed":""}`;return F?e.jsx("div",{className:G,children:e.jsx("div",{className:"sbv-loading",children:"טוען מפת מסעדה…"})}):R||!m?e.jsx("div",{className:G,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:"לא ניתן לטעון את מפת המסעדה"}),e.jsx("div",{className:"sbv-error-sub",children:R??"קרתה שגיאה בטעינת המפה"}),e.jsx("button",{className:"sbv-retry",onClick:y,children:"נסה שוב"})]})}):e.jsxs("div",{className:G,children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:"עדכון סידור שולחנות"}),e.jsx("div",{className:"sbv-topbar-sub",children:"גרור כדי להזיז • ⤢ למרכז למסך"})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," פנוי"]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," תפוס"]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," שמור"]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," מלוכלך"]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(pe,{layout:m,selectedTableId:j,selectedTableIds:$?O:null,onTableClick:U,mode:"view"})}),j&&!$?ue.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:Q}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-close",onClick:Q,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:["שולחן ",ee(S)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${P}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:"סטטוס שולחן"}),e.jsx("span",{className:"sbv-status-value",children:he(P)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שם המזמין"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-kv-val",children:(()=>{const r=(i==null?void 0:i.guestCount)??(i==null?void 0:i.people);return r!=null&&r!==""?String(r):"—"})()})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.reservationTime)??(i==null?void 0:i.time)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.itemsCount)??((i==null?void 0:i.itemsReady)!=null&&(i==null?void 0:i.itemsPending)!=null?i.itemsReady+i.itemsPending:null)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.subtotal)??(i==null?void 0:i.orderTotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:e.jsxs("div",{className:"sbv-actions-row",children:[X?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"sbv-secondary-btn",onClick:r=>{r.stopPropagation(),W(j,"dirty"),window.dispatchEvent(new Event("sb-floor-refresh"))},children:"סמן מלוכלך"}),e.jsx("button",{className:"sbv-secondary-btn",onClick:r=>{r.stopPropagation(),W(j,"empty"),window.dispatchEvent(new Event("sb-floor-refresh"))},children:"סמן נקי"})]}):null,(()=>{const r=ee(S),b=!!(i!=null&&i.orderId),c=!!r&&(!X||b),N=r?`/pos/${encodeURIComponent(s)}/table/${encodeURIComponent(String(r))}`:"";return e.jsx("button",{type:"button",className:"sbv-primary-btn",disabled:!c,onClick:V=>{V.stopPropagation(),c&&(window.location.href=N)},title:X&&!b?"אין הזמנה פתוחה לשולחן הזה":void 0,children:"למסך ההזמנה"})})()]})})]})]}),document.body):null]})}const K=document.getElementById("sb-floor-root");if(!K)throw new Error("Missing #sb-floor-root");const ae=K.getAttribute("data-rid")||K.getAttribute("data-restaurant-id")||"",te=K.getAttribute("data-click-mode")||K.getAttribute("data-mode")||"page",oe=te==="lobby"?"lobby":te==="host"?"host":"page";console.info("[FloorView] mount",{rid:ae,mountMode:oe,clickMode:te});de.createRoot(K).render(e.jsx(w.StrictMode,{children:e.jsx(xe,{restaurantId:ae,mountMode:oe})}));
