import{r as g,j as e,R as h,a as ue,c as de}from"./floor-index.js";const p="/floor_assets/",ne=(n,a=1)=>{const v=Number(n);return Number.isFinite(v)?Math.max(.5,Math.min(1.6,v)):a},re=n=>{const a=Number(n);return Number.isFinite(a)?Math.round(a/45)*45:0},ve=n=>{if(!n||n.startsWith("#"))return"parquet_blue";const a=n;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function be(n){return{parquet_blue:{bg:`url(${p}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${p}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${p}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${p}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${p}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[n]}function me(n,a){const v=String(n||"square").toLowerCase(),N=Number(a||0);return v==="round"?`${p}${N>=9?"round_table_10.svg":"round_table4.svg"}`:v==="booth"?`${p}${N>=6?"large_booth.svg":"booth4.svg"}`:v==="rect"?`${p}${N>=10?"square_table10.svg":N>=6?"square_table6.svg":N>=4?"square_table4.svg":"square_table2.svg"}`:`${p}${N>=10?"square_table10.svg":N>=6?"square_table6.svg":N>=4?"square_table4.svg":"square_table2.svg"}`}function pe(n,a){const v=String(n||"").toLowerCase();return v==="door"?`${p}door.svg`:v==="wall"?`${p}wall.svg`:v==="divider"?`${p}divider.svg`:v==="chair"?`${p}chair.svg`:v==="bar"?`${p}bar.svg`:v==="plant"?`${p}plant.svg`:a?`${p}${a}.svg`:`${p}divider.svg`}function fe({layout:n,mode:a,onTableClick:v,selectedTableId:N,selectedTableIds:J}){const A=a==="edit",w=g.useRef(null),q=g.useRef(null),[T,I]=g.useState(1),[F,R]=g.useState({x:0,y:0}),[j,D]=g.useState(!1),[B,S]=g.useState(!1),_=g.useRef(T);g.useEffect(()=>{_.current=T},[T]);const b=g.useRef(null),y=60,i=g.useMemo(()=>ve(n.floorColor),[n==null?void 0:n.id]),P=g.useMemo(()=>be(i),[i]);g.useEffect(()=>{const s=r=>{r.code==="Space"&&D(!0)},t=r=>{r.code==="Space"&&(D(!1),S(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",t)}},[]);const $=s=>Math.max(.4,Math.min(2.5,s)),Z=()=>{if(!w.current||!q.current)return;const s=w.current,t=q.current,r=getComputedStyle(t),f=(parseFloat(r.marginLeft)||0)+(parseFloat(r.marginRight)||0),l=(parseFloat(r.marginTop)||0)+(parseFloat(r.marginBottom)||0),C=t.offsetWidth+f,c=t.offsetHeight+l;if(!C||!c)return;const k=getComputedStyle(s),M=parseFloat(k.paddingLeft||"0")||0,O=parseFloat(k.paddingRight||"0")||0,z=parseFloat(k.paddingTop||"0")||0,X=parseFloat(k.paddingBottom||"0")||0,d=24,L=Math.max(1,s.clientWidth-M-O-d*2),E=Math.max(1,s.clientHeight-z-X-d*2),Y=$(Math.min(L/C,E/c,1.2));I(Y);const G=Math.round(M+d+(L-C*Y)/2),ee=Math.round(z+d+(E-c*Y)/2);R({x:G,y:ee})};g.useEffect(()=>{requestAnimationFrame(Z)},[n==null?void 0:n.id]),g.useEffect(()=>{if(!w.current)return;let s=0;const t=new ResizeObserver(()=>{cancelAnimationFrame(s),s=requestAnimationFrame(Z)});return t.observe(w.current),()=>{cancelAnimationFrame(s),t.disconnect()}},[n==null?void 0:n.id]);const K=(s,t,r)=>{if(!w.current)return;const f=w.current.getBoundingClientRect(),l=t-f.left,C=r-f.top;R(c=>{const k=s/(_.current||1);return{x:Math.round(l-(l-c.x)*k),y:Math.round(C-(C-c.y)*k)}}),I(s)};g.useEffect(()=>{const s=w.current;if(!s)return;const t=r=>{if(!!!(r.ctrlKey||r.metaKey)||(r.preventDefault(),!A))return;const l=r.deltaY>0?.9:1.1,C=$((_.current||1)*l);K(C,r.clientX,r.clientY)};return s.addEventListener("wheel",t,{passive:!1}),()=>s.removeEventListener("wheel",t)},[A]);const V=s=>{const t=s.target;if(a==="view"){if(s.button!==0||t!=null&&t.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),b.current={moved:!1};const M={x:s.clientX,y:s.clientY},O={...F};let z=!1;const X=L=>{const E=L.clientX-M.x,Y=L.clientY-M.y,G=Math.abs(E)+Math.abs(Y);!z&&G>4&&(z=!0,b.current&&(b.current.moved=!0),S(!0)),z&&R({x:O.x+E,y:O.y+Y})},d=()=>{z&&S(!1),window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",d),b.current&&!b.current.moved&&(b.current=null)};window.addEventListener("mousemove",X),window.addEventListener("mouseup",d);return}const r=s.button===1,f=j&&s.button===0;if(!r&&!f)return;s.preventDefault(),S(!0);const l={x:s.clientX,y:s.clientY},C={...F},c=M=>{R({x:C.x+(M.clientX-l.x),y:C.y+(M.clientY-l.y)})},k=()=>{S(!1),window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",k)};window.addEventListener("mousemove",c),window.addEventListener("mouseup",k)},H=g.useRef(null),U=s=>{if(a!=="view"||s.touches.length!==1)return;const t=s.touches[0],r=s.target;r!=null&&r.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),S(!0),H.current={startX:t.clientX,startY:t.clientY,panX:F.x,panY:F.y,active:!0})},o=s=>{if(a!=="view")return;const t=H.current;if(!t||!t.active||s.touches.length!==1)return;const r=s.touches[0];s.preventDefault(),R({x:t.panX+(r.clientX-t.startX),y:t.panY+(r.clientY-t.startY)})},m=()=>{a==="view"&&(H.current=null,S(!1))},u=s=>Math.max(1,Number(s)||1)*y,x=s=>{const t=(s||"").toLowerCase();return t.includes("occup")||t==="busy"||t==="taken"?"occupied":t.includes("reserv")||t.includes("book")?"reserved":t.includes("dirty")||t.includes("need")||t.includes("clean")?"dirty":"empty"},Q=g.useMemo(()=>{const s=new Map;return(Array.isArray(n.tableStatuses)?n.tableStatuses:[]).forEach(t=>{const r=t&&t.tableId?String(t.tableId):"";r&&s.set(r,{status:x(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[n]),ie=g.useMemo(()=>{const s=new Map;return(Array.isArray(n.tableStatuses)?n.tableStatuses:[]).forEach(t=>{const r=Number(t&&(t.tableNumber??0));!Number.isFinite(r)||r<=0||s.set(r,{status:x(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[n]),le=s=>{const t=s.id?Q.get(String(s.id)):void 0;if(t)return t;const r=Number(s.tableNumber??0);if(Number.isFinite(r)&&r>0){const f=ie.get(r);if(f)return f}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${B?"is-panning":""}`,ref:w,onMouseDown:V,onTouchStart:U,onTouchMove:o,onTouchEnd:m,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[A?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=w.current)==null?void 0:t.getBoundingClientRect();K($(T*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=w.current)==null?void 0:t.getBoundingClientRect();K($(T*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"})]}):null,e.jsx("button",{className:"btn-icon-small",onClick:Z,title:"Center",children:"⤢"}),A?e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(T*100),"%"]}):null,e.jsx("div",{className:"fe-hint",children:a==="view"?"Drag to pan":j?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:q,onClickCapture:s=>{var t;a==="view"&&(t=b.current)!=null&&t.moved&&(s.preventDefault(),s.stopPropagation(),b.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${n.gridCols}, ${y}px)`,gridTemplateRows:`repeat(${n.gridRows}, ${y}px)`,transform:`translate(${F.x}px, ${F.y}px) scale(${T})`,transformOrigin:"0 0","--cell":`${y}px`,"--floor-bg":P.bg,"--floor-bg-size":P.size,"--floor-bg-repeat":P.repeat,"--floor-bg-position":P.pos},children:Array.from({length:n.gridRows*n.gridCols}).map((s,t)=>{var X;const r=Math.floor(t/n.gridCols),f=t%n.gridCols,l=n.tables.find(d=>f>=d.gridX&&f<d.gridX+(d.spanX||1)&&r>=d.gridY&&r<d.gridY+(d.spanY||1)),c=(n.objects??[]).find(d=>f>=d.gridX&&f<d.gridX+(d.spanX||1)&&r>=d.gridY&&r<d.gridY+(d.spanY||1)),k=!!l&&l.gridX===f&&l.gridY===r,M=!!c&&c.gridX===f&&c.gridY===r,O=r*n.gridCols+f,z=(((X=n.gridMask)==null?void 0:X[O])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${z?"active":"inactive"}`,children:[M&&c&&e.jsxs("div",{className:`floor-object type-${c.type}`,style:{width:`${u(c.spanX)}px`,height:`${u(c.spanY)}px`,transform:`rotate(${re(c.rotationDeg??c.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(c.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${ne(c.scale,1)})`},src:c.assetFile?`${p}${c.assetFile}`:pe(c.type,c.label),alt:""}),c.label&&e.jsx("div",{className:"obj-label",children:c.label})]}),k&&l&&(()=>{const d=le(l),L=String(d.status||"empty"),E=N&&String(N)===String(l.id)||Array.isArray(J)&&J.some(ce=>String(ce)===String(l.id)),Y=a==="view",G=L==="occupied"?"תפוס":L==="reserved"?"שמור":L==="dirty"?"מלוכלך":"פנוי",ee=d.guestCount!=null&&d.guestCount!==""?` · ${d.guestCount}`:"";return e.jsxs("div",{className:`table ${String(l.shape||"square")} ${E?"selected":""}`,onClick:()=>v==null?void 0:v(l.id),style:{position:"absolute",top:0,left:0,width:`${u(l.spanX)}px`,height:`${u(l.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":l.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(l.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${re(l.rotationDeg??l.rotation??0)}deg) scale(${ne(l.scale,1)})`},src:l.assetFile?`${p}${l.assetFile}`:me(l.shape,l.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:l.name||(l.tableNumber!=null?`Table ${l.tableNumber}`:"Table")}),l.seats!=null&&e.jsxs("div",{className:"table-seats",children:[l.seats," seats"]})]}),Y&&e.jsxs("div",{className:`sbv-status-pill is-${L}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[G,ee]})]})]})})()]},t)})})]})}function ge(n){const a=(n||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function se(n){const a=(n==null?void 0:n.tableNumber)??(n==null?void 0:n.number)??(n==null?void 0:n.table_number)??(n==null?void 0:n.tableNum)??(n==null?void 0:n.table),v=Number(a);return Number.isFinite(v)&&v>0?v:null}function he(n){switch(n){case"occupied":return"תפוס";case"reserved":return"שמור";case"dirty":return"מלוכלך";default:return"פנוי"}}function xe({restaurantId:n,mountMode:a="page"}){const[v,N]=h.useState([]),[J,A]=h.useState(null),[w,q]=h.useState(null),[T,I]=h.useState(!0),[F,R]=h.useState(null),[j,D]=h.useState(null),[B,S]=h.useState([]),_=h.useCallback(async()=>{try{const o=await fetch(`/api/floor-layouts/${n}/active`,{headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`HTTP ${o.status}`);const m=await o.json(),u=m&&m.id?m:(m==null?void 0:m.activeLayout)??null;if(!u){N([]),A(null),q(null),R("אין מפת מסעדה פעילה"),I(!1);return}N([u]),A(u.id),q(x=>x??u.id),R(null),I(!1),j&&((u.tables||[]).some(Q=>String(Q.id)===String(j))||D(null))}catch(o){R(`שגיאה בטעינת המפה: ${(o==null?void 0:o.message)??"unknown"}`),I(!1)}},[n,j]);h.useEffect(()=>{_();const o=setInterval(_,5e3);return()=>clearInterval(o)},[_]);const b=h.useMemo(()=>w?v.find(o=>o.id===w)??null:null,[v,w]),y=h.useMemo(()=>!b||!j?null:(b.tables||[]).find(o=>String(o.id)===String(j))??null,[b,j]),i=h.useMemo(()=>{if(!b||!y)return null;const o=b.tableStatuses;if(!Array.isArray(o))return null;const m=o.find(u=>String(u.tableId)===String(y.id));return m||(o.find(u=>u.tableNumber===y.number)??null)},[b,y]),P=h.useMemo(()=>ge(i==null?void 0:i.status),[i]),$=a==="host",Z=a==="lobby",K=o=>{if($){S(m=>{const u=new Set(m);return u.has(o)?u.delete(o):u.add(o),Array.from(u)});return}D(o)},V=()=>D(null);h.useEffect(()=>{if(!$)return;const o=b;if(!o)return;const m=new Map;(o.tables||[]).forEach(x=>m.set(String(x.id),x));const u=B.map(x=>m.get(String(x))).filter(Boolean).map(x=>Number(x.tableNumber??x.number??0)).filter(x=>Number.isFinite(x)&&x>0);window.dispatchEvent(new CustomEvent("sb-floor-selection",{detail:{tableIds:B,tableNumbers:u}}))},[$,b,B]),h.useEffect(()=>{if(!$)return;const o=()=>S([]);return window.addEventListener("sb-floor-clear-selection",o),()=>window.removeEventListener("sb-floor-clear-selection",o)},[$]);const H=h.useCallback(async(o,m)=>{try{const u=await fetch(`/api/tables/${n}/${o}/status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:m})});if(!u.ok)throw new Error(`HTTP ${u.status}`);await _()}catch(u){console.warn("Failed to update table status",u)}},[n,_]),U=`floor-editor sb-floor-view ${a==="lobby"||a==="host"?"is-embed":""}`;return T?e.jsx("div",{className:U,children:e.jsx("div",{className:"sbv-loading",children:"טוען מפת מסעדה…"})}):F||!b?e.jsx("div",{className:U,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:"לא ניתן לטעון את מפת המסעדה"}),e.jsx("div",{className:"sbv-error-sub",children:F??"קרתה שגיאה בטעינת המפה"}),e.jsx("button",{className:"sbv-retry",onClick:_,children:"נסה שוב"})]})}):e.jsxs("div",{className:U,children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:"עדכון סידור שולחנות"}),e.jsx("div",{className:"sbv-topbar-sub",children:"גרור כדי להזיז • ⤢ למרכז למסך"})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," פנוי"]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," תפוס"]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," שמור"]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," מלוכלך"]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(fe,{layout:b,selectedTableId:j,selectedTableIds:$?B:null,onTableClick:K,mode:"view"})}),j&&!$?ue.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:V}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-close",onClick:V,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:["שולחן ",se(y)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${P}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:"סטטוס שולחן"}),e.jsx("span",{className:"sbv-status-value",children:he(P)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שם המזמין"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.guestCount)??(i==null?void 0:i.people)!=null?String(i.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.reservationTime)??(i==null?void 0:i.time)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.itemsCount)??((i==null?void 0:i.itemsReady)!=null&&(i==null?void 0:i.itemsPending)!=null?i.itemsReady+i.itemsPending:null)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.subtotal)??(i==null?void 0:i.orderTotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:e.jsxs("div",{className:"sbv-actions-row",children:[Z?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"sbv-secondary-btn",onClick:o=>{o.stopPropagation(),H(j,"dirty")},children:"סמן מלוכלך"}),e.jsx("button",{className:"sbv-secondary-btn",onClick:o=>{o.stopPropagation(),H(j,"clean")},children:"סמן נקי"})]}):null,e.jsx("a",{className:"sbv-primary-btn",href:(()=>{const o=se(y);return o?`/pos/${encodeURIComponent(n)}/table/${encodeURIComponent(String(o))}`:"#"})(),onClick:o=>{se(y)||o.preventDefault(),o.stopPropagation()},children:"למסך ההזמנה"})]})})]})]}),document.body):null]})}const W=document.getElementById("sb-floor-root");if(!W)throw new Error("Missing #sb-floor-root");const ae=W.getAttribute("data-rid")||W.getAttribute("data-restaurant-id")||"",te=W.getAttribute("data-click-mode")||W.getAttribute("data-mode")||"page",oe=te==="lobby"?"lobby":te==="host"?"host":"page";console.info("[FloorView] mount",{rid:ae,mountMode:oe,clickMode:te});de.createRoot(W).render(e.jsx(h.StrictMode,{children:e.jsx(xe,{restaurantId:ae,mountMode:oe})}));
