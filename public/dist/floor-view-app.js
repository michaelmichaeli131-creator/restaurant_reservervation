import{r as N,j as e,R as p,a as ue,c as de}from"./floor-index.js";const g="/floor_assets/",oe=(t,a=1)=>{const d=Number(t);return Number.isFinite(d)?Math.max(.5,Math.min(1.6,d)):a},ie=t=>{const a=Number(t);return Number.isFinite(a)?Math.round(a/45)*45:0},ve=t=>{if(!t||t.startsWith("#"))return"parquet_blue";const a=t;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function be(t){return{parquet_blue:{bg:`url(${g}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${g}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${g}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${g}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${g}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[t]}function me(t,a){const d=String(t||"square").toLowerCase(),h=Number(a||0);return d==="round"?`${g}${h>=9?"round_table_10.svg":"round_table4.svg"}`:d==="booth"?`${g}${h>=6?"large_booth.svg":"booth4.svg"}`:d==="rect"?`${g}${h>=10?"square_table10.svg":h>=6?"square_table6.svg":h>=4?"square_table4.svg":"square_table2.svg"}`:`${g}${h>=10?"square_table10.svg":h>=6?"square_table6.svg":h>=4?"square_table4.svg":"square_table2.svg"}`}function fe(t,a){const d=String(t||"").toLowerCase();return d==="door"?`${g}door.svg`:d==="wall"?`${g}wall.svg`:d==="divider"?`${g}divider.svg`:d==="chair"?`${g}chair.svg`:d==="bar"?`${g}bar.svg`:d==="plant"?`${g}plant.svg`:a?`${g}${a}.svg`:`${g}divider.svg`}function pe({layout:t,mode:a,onTableClick:d,selectedTableId:h,selectedTableIds:Y}){const _=a==="edit",x=N.useRef(null),H=N.useRef(null),[F,O]=N.useState(1),[R,E]=N.useState({x:0,y:0}),[j,P]=N.useState(!1),[W,S]=N.useState(!1),y=N.useRef(F);N.useEffect(()=>{y.current=F},[F]);const f=N.useRef(null),L=60,i=N.useMemo(()=>ve(t.floorColor),[t==null?void 0:t.id]),X=N.useMemo(()=>be(i),[i]);N.useEffect(()=>{const s=o=>{o.code==="Space"&&P(!0)},n=o=>{o.code==="Space"&&(P(!1),S(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",n)}},[]);const $=s=>Math.max(.4,Math.min(2.5,s)),I=()=>{if(!x.current||!H.current)return;const s=x.current,n=H.current,o=getComputedStyle(n),w=(parseFloat(o.marginLeft)||0)+(parseFloat(o.marginRight)||0),c=(parseFloat(o.marginTop)||0)+(parseFloat(o.marginBottom)||0),C=n.offsetWidth+w,u=n.offsetHeight+c;if(!C||!u)return;const k=getComputedStyle(s),M=parseFloat(k.paddingLeft||"0")||0,U=parseFloat(k.paddingRight||"0")||0,A=parseFloat(k.paddingTop||"0")||0,q=parseFloat(k.paddingBottom||"0")||0,v=24,T=Math.max(1,s.clientWidth-M-U-v*2),D=Math.max(1,s.clientHeight-A-q-v*2),G=Math.min(T/C,D/u),B=$(Math.min(G*.96,1.2));O(B);const ne=Math.round(M+v+(T-C*B)/2),re=Math.round(A+v+(D-u*B)/2);E({x:ne,y:re})};N.useEffect(()=>{requestAnimationFrame(I)},[t==null?void 0:t.id]),N.useEffect(()=>{if(!x.current)return;let s=0;const n=new ResizeObserver(()=>{cancelAnimationFrame(s),s=requestAnimationFrame(I)});return n.observe(x.current),()=>{cancelAnimationFrame(s),n.disconnect()}},[t==null?void 0:t.id]);const J=(s,n,o)=>{if(!x.current)return;const w=x.current.getBoundingClientRect(),c=n-w.left,C=o-w.top;E(u=>{const k=s/(y.current||1);return{x:Math.round(c-(c-u.x)*k),y:Math.round(C-(C-u.y)*k)}}),O(s)};N.useEffect(()=>{const s=x.current;if(!s)return;const n=o=>{if(!!!(o.ctrlKey||o.metaKey)||(o.preventDefault(),!_))return;const c=o.deltaY>0?.9:1.1,C=$((y.current||1)*c);J(C,o.clientX,o.clientY)};return s.addEventListener("wheel",n,{passive:!1}),()=>s.removeEventListener("wheel",n)},[_]);const se=s=>{const n=s.target;if(a==="view"){if(s.button!==0||n!=null&&n.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),f.current={moved:!1};const M={x:s.clientX,y:s.clientY},U={...R};let A=!1;const q=T=>{const D=T.clientX-M.x,G=T.clientY-M.y,B=Math.abs(D)+Math.abs(G);!A&&B>4&&(A=!0,f.current&&(f.current.moved=!0),S(!0)),A&&E({x:U.x+D,y:U.y+G})},v=()=>{A&&S(!1),window.removeEventListener("mousemove",q),window.removeEventListener("mouseup",v),f.current&&!f.current.moved&&(f.current=null)};window.addEventListener("mousemove",q),window.addEventListener("mouseup",v);return}const o=s.button===1,w=j&&s.button===0;if(!o&&!w)return;s.preventDefault(),S(!0);const c={x:s.clientX,y:s.clientY},C={...R},u=M=>{E({x:C.x+(M.clientX-c.x),y:C.y+(M.clientY-c.y)})},k=()=>{S(!1),window.removeEventListener("mousemove",u),window.removeEventListener("mouseup",k)};window.addEventListener("mousemove",u),window.addEventListener("mouseup",k)},Z=N.useRef(null),Q=s=>{if(a!=="view"||s.touches.length!==1)return;const n=s.touches[0],o=s.target;o!=null&&o.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),S(!0),Z.current={startX:n.clientX,startY:n.clientY,panX:R.x,panY:R.y,active:!0})},r=s=>{if(a!=="view")return;const n=Z.current;if(!n||!n.active||s.touches.length!==1)return;const o=s.touches[0];s.preventDefault(),E({x:n.panX+(o.clientX-n.startX),y:n.panY+(o.clientY-n.startY)})},b=()=>{a==="view"&&(Z.current=null,S(!1))},l=s=>Math.max(1,Number(s)||1)*L,m=s=>{const n=(s||"").toLowerCase();return n.includes("occup")||n==="busy"||n==="taken"?"occupied":n.includes("reserv")||n.includes("book")?"reserved":n.includes("dirty")||n.includes("need")?"dirty":"empty"},z=N.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(n=>{const o=n&&n.tableId?String(n.tableId):"";o&&s.set(o,{status:m(String(n.status||"empty")),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[t]),te=N.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(n=>{const o=Number(n&&(n.tableNumber??0));!Number.isFinite(o)||o<=0||s.set(o,{status:m(String(n.status||"empty")),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[t]),K=s=>{const n=s.id?z.get(String(s.id)):void 0;if(n)return n;const o=Number(s.tableNumber??0);if(Number.isFinite(o)&&o>0){const w=te.get(o);if(w)return w}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${W?"is-panning":""}`,ref:x,onMouseDown:se,onTouchStart:Q,onTouchMove:r,onTouchEnd:b,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[_?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=x.current)==null?void 0:n.getBoundingClientRect();J($(F*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=x.current)==null?void 0:n.getBoundingClientRect();J($(F*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"})]}):null,e.jsx("button",{className:"btn-icon-small",onClick:I,title:"Center",children:"⤢"}),_?e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(F*100),"%"]}):null,e.jsx("div",{className:"fe-hint",children:a==="view"?"Drag to pan":j?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:H,onClickCapture:s=>{var n;a==="view"&&(n=f.current)!=null&&n.moved&&(s.preventDefault(),s.stopPropagation(),f.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${t.gridCols}, ${L}px)`,gridTemplateRows:`repeat(${t.gridRows}, ${L}px)`,transform:`translate(${R.x}px, ${R.y}px) scale(${F})`,transformOrigin:"0 0","--cell":`${L}px`,"--floor-bg":X.bg,"--floor-bg-size":X.size,"--floor-bg-repeat":X.repeat,"--floor-bg-position":X.pos},children:Array.from({length:t.gridRows*t.gridCols}).map((s,n)=>{var q;const o=Math.floor(n/t.gridCols),w=n%t.gridCols,c=t.tables.find(v=>w>=v.gridX&&w<v.gridX+(v.spanX||1)&&o>=v.gridY&&o<v.gridY+(v.spanY||1)),u=(t.objects??[]).find(v=>w>=v.gridX&&w<v.gridX+(v.spanX||1)&&o>=v.gridY&&o<v.gridY+(v.spanY||1)),k=!!c&&c.gridX===w&&c.gridY===o,M=!!u&&u.gridX===w&&u.gridY===o,U=o*t.gridCols+w,A=(((q=t.gridMask)==null?void 0:q[U])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${A?"active":"inactive"}`,children:[M&&u&&e.jsxs("div",{className:`floor-object type-${u.type}`,style:{width:`${l(u.spanX)}px`,height:`${l(u.spanY)}px`,transform:`rotate(${ie(u.rotationDeg??u.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(u.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${oe(u.scale,1)})`},src:u.assetFile?`${g}${u.assetFile}`:fe(u.type,u.label),alt:""}),u.label&&e.jsx("div",{className:"obj-label",children:u.label})]}),k&&c&&(()=>{const v=K(c),T=String(v.status||"empty"),D=h&&String(h)===String(c.id)||Array.isArray(Y)&&Y.some(re=>String(re)===String(c.id)),G=a==="view",B=T==="occupied"?"תפוס":T==="reserved"?"שמור":T==="dirty"?"מלוכלך":"פנוי",ne=v.guestCount!=null&&v.guestCount!==""?` · ${v.guestCount}`:"";return e.jsxs("div",{className:`table ${String(c.shape||"square")} ${D?"selected":""}`,onClick:()=>d==null?void 0:d(c.id),style:{position:"absolute",top:0,left:0,width:`${l(c.spanX)}px`,height:`${l(c.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":c.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(c.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${ie(c.rotationDeg??c.rotation??0)}deg) scale(${oe(c.scale,1)})`},src:c.assetFile?`${g}${c.assetFile}`:me(c.shape,c.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:c.name||(c.tableNumber!=null?`Table ${c.tableNumber}`:"Table")}),c.seats!=null&&e.jsxs("div",{className:"table-seats",children:[c.seats," seats"]})]}),G&&e.jsxs("div",{className:`sbv-status-pill is-${T}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[B,ne]})]})]})})()]},n)})})]})}function ge(t){const a=(t||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function ee(t){const a=[t==null?void 0:t.tableNumber,t==null?void 0:t.number,t==null?void 0:t.table_number,t==null?void 0:t.tableNum,t==null?void 0:t.table,t==null?void 0:t.name,t==null?void 0:t.label];for(const d of a){if(d==null)continue;const h=String(d).trim();if(!h)continue;const Y=Number(h);if(Number.isFinite(Y)&&Y>0)return Y;const _=h.match(/(\d{1,4})/);if(_){const x=Number(_[1]);if(Number.isFinite(x)&&x>0)return x}}return null}function he(t){switch(t){case"occupied":return"תפוס";case"reserved":return"שמור";case"dirty":return"מלוכלך";default:return"פנוי"}}function xe({restaurantId:t,mountMode:a="page"}){const[d,h]=p.useState([]),[Y,_]=p.useState(null),[x,H]=p.useState(null),[F,O]=p.useState(!0),[R,E]=p.useState(null),[j,P]=p.useState(null),[W,S]=p.useState([]),y=p.useCallback(async()=>{try{const r=await fetch(`/api/floor-layouts/${t}/active`,{headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const b=await r.json(),l=b&&b.id?b:(b==null?void 0:b.activeLayout)??null;if(!l){h([]),_(null),H(null),E("אין מפת מסעדה פעילה"),O(!1);return}h([l]),_(l.id),H(m=>m??l.id),E(null),O(!1),j&&((l.tables||[]).some(z=>String(z.id)===String(j))||P(null))}catch(r){E(`שגיאה בטעינת המפה: ${(r==null?void 0:r.message)??"unknown"}`),O(!1)}},[t,j]);p.useEffect(()=>{y();const r=setInterval(y,5e3);return()=>clearInterval(r)},[y]),p.useEffect(()=>{const r=()=>y();return window.addEventListener("sb-floor-refresh",r),()=>window.removeEventListener("sb-floor-refresh",r)},[y]);const f=p.useMemo(()=>x?d.find(r=>r.id===x)??null:null,[d,x]),L=p.useMemo(()=>!f||!j?null:(f.tables||[]).find(r=>String(r.id)===String(j))??null,[f,j]),i=p.useMemo(()=>{if(!f||!L)return null;const r=f.tableStatuses;if(!Array.isArray(r))return null;const b=r.find(l=>String(l.tableId)===String(L.id));return b||(r.find(l=>l.tableNumber===ee(L))??null)},[f,L]),X=p.useMemo(()=>ge(i==null?void 0:i.status),[i]),$=a==="host",I=a==="lobby",J=r=>{if($){S(b=>{const l=new Set(b);return l.has(r)?l.delete(r):l.add(r),Array.from(l)});return}P(r)},se=()=>P(null);p.useEffect(()=>{if(!$)return;const r=f;if(!r)return;const b=new Map;(r.tables||[]).forEach(m=>b.set(String(m.id),m));const l=W.map(m=>b.get(String(m))).filter(Boolean).map(m=>ee(m)??0).filter(m=>Number.isFinite(m)&&m>0);window.dispatchEvent(new CustomEvent("sb-floor-selection",{detail:{tableIds:W,tableNumbers:l}}))},[$,f,W]),p.useEffect(()=>{if(!$)return;const r=()=>S([]);return window.addEventListener("sb-floor-clear-selection",r),()=>window.removeEventListener("sb-floor-clear-selection",r)},[$]),p.useEffect(()=>{if(a!=="lobby")return;const r=b=>{var s;const l=b,m=Number((s=l==null?void 0:l.detail)==null?void 0:s.tableNumber);if(!Number.isFinite(m)||m<=0)return;const z=f??(d.length?d[0]:null),te=z==null?void 0:z.tables;if(!Array.isArray(te))return;const K=te.find(n=>ee(n)===m);K!=null&&K.id&&(P(String(K.id)),S([]))};return window.addEventListener("sb-floor-select-table-number",r),()=>window.removeEventListener("sb-floor-select-table-number",r)},[a,f,d]);const Z=p.useCallback(async(r,b)=>{try{const l=await fetch(`/api/tables/${t}/${r}/status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:b})});if(!l.ok)throw new Error(`HTTP ${l.status}`);await y()}catch(l){console.warn("Failed to update table status",l);try{const m=l!=null&&l.message?String(l.message):"unknown";alert("שגיאה בעדכון סטטוס שולחן: "+m)}catch{}}},[t,y]),Q=`floor-editor sb-floor-view ${a==="lobby"||a==="host"?"is-embed":""}`;return F?e.jsx("div",{className:Q,children:e.jsx("div",{className:"sbv-loading",children:"טוען מפת מסעדה…"})}):R||!f?e.jsx("div",{className:Q,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:"לא ניתן לטעון את מפת המסעדה"}),e.jsx("div",{className:"sbv-error-sub",children:R??"קרתה שגיאה בטעינת המפה"}),e.jsx("button",{className:"sbv-retry",onClick:y,children:"נסה שוב"})]})}):e.jsxs("div",{className:Q,children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:"עדכון סידור שולחנות"}),e.jsx("div",{className:"sbv-topbar-sub",children:"גרור כדי להזיז • ⤢ למרכז למסך"})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," פנוי"]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," תפוס"]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," שמור"]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," מלוכלך"]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(pe,{layout:f,selectedTableId:j,selectedTableIds:$?W:null,onTableClick:J,mode:"view"})}),j&&!$?ue.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:se}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-close",onClick:se,"aria-label":"Close",children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:["שולחן ",ee(L)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${X}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:"סטטוס שולחן"}),e.jsx("span",{className:"sbv-status-value",children:he(X)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שם המזמין"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-kv-val",children:(()=>{const r=(i==null?void 0:i.guestCount)??(i==null?void 0:i.people);return r!=null&&r!==""?String(r):"—"})()})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.reservationTime)??(i==null?void 0:i.time)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.itemsCount)??((i==null?void 0:i.itemsReady)!=null&&(i==null?void 0:i.itemsPending)!=null?i.itemsReady+i.itemsPending:null)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.subtotal)??(i==null?void 0:i.orderTotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:e.jsxs("div",{className:"sbv-actions-row",children:[I?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"sbv-secondary-btn",onClick:async r=>{r.stopPropagation(),await Z(j,"dirty"),window.dispatchEvent(new Event("sb-floor-refresh"))},children:"סמן מלוכלך"}),e.jsx("button",{className:"sbv-secondary-btn",onClick:async r=>{r.stopPropagation(),await Z(j,"empty"),window.dispatchEvent(new Event("sb-floor-refresh"))},children:"סמן נקי"})]}):null,(()=>{const r=ee(L),b=!!(i!=null&&i.orderId),l=!!r&&(!I||b),m=r?`/pos/${encodeURIComponent(t)}/table/${encodeURIComponent(String(r))}`:"";return e.jsx("button",{type:"button",className:"sbv-primary-btn",disabled:!l,onClick:z=>{z.stopPropagation(),l&&(window.location.href=m)},title:I&&!b?"אין הזמנה פתוחה לשולחן הזה":void 0,children:"למסך ההזמנה"})})()]})})]})]}),document.body):null]})}const V=document.getElementById("sb-floor-root");if(!V)throw new Error("Missing #sb-floor-root");const le=V.getAttribute("data-rid")||V.getAttribute("data-restaurant-id")||"",ae=V.getAttribute("data-click-mode")||V.getAttribute("data-mode")||"page",ce=ae==="lobby"?"lobby":ae==="host"?"host":"page";console.info("[FloorView] mount",{rid:le,mountMode:ce,clickMode:ae});de.createRoot(V).render(e.jsx(p.StrictMode,{children:e.jsx(xe,{restaurantId:le,mountMode:ce})}));
