import{r as f,j as e,R as j,t as v,c as ve}from"./floor-index.js";const b="/floor_assets/",te=(r,a=1)=>{const m=Number(r);return Number.isFinite(m)?Math.max(.5,Math.min(1.6,m)):a},re=r=>{const a=Number(r);return Number.isFinite(a)?Math.round(a/45)*45:0},me=r=>{if(!r||r.startsWith("#"))return"parquet_blue";const a=r;return a==="parquet_blue"||a==="parquet_brown"||a==="slate_dark"||a==="navy_carpet"||a==="teal_terrazzo"?a:"parquet_blue"};function be(r){return{parquet_blue:{bg:`url(${b}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${b}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${b}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${b}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${b}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[r]}function pe(r,a){const m=String(r||"square").toLowerCase(),x=Number(a||0);return m==="round"?`${b}${x>=9?"round_table_10.svg":"round_table4.svg"}`:m==="booth"?`${b}${x>=6?"large_booth.svg":"booth4.svg"}`:m==="rect"?`${b}${x>=10?"square_table10.svg":x>=6?"square_table6.svg":x>=4?"square_table4.svg":"square_table2.svg"}`:`${b}${x>=10?"square_table10.svg":x>=6?"square_table6.svg":x>=4?"square_table4.svg":"square_table2.svg"}`}function fe(r,a){const m=String(r||"").toLowerCase();return m==="door"?`${b}door.svg`:m==="wall"?`${b}wall.svg`:m==="divider"?`${b}divider.svg`:m==="chair"?`${b}chair.svg`:m==="bar"?`${b}bar.svg`:m==="plant"?`${b}plant.svg`:a?`${b}${a}.svg`:`${b}divider.svg`}function ge({layout:r,mode:a,onTableClick:m,selectedTableId:x,selectedTableIds:U}){const E=a==="edit",N=f.useRef(null),I=f.useRef(null),[k,D]=f.useState(1),[M,L]=f.useState({x:0,y:0}),[y,P]=f.useState(!1),[T,g]=f.useState(!1),d=f.useRef(k);f.useEffect(()=>{d.current=k},[k]);const i=f.useRef(null),F=60,K=f.useMemo(()=>me(r.floorColor),[r==null?void 0:r.id]),Y=f.useMemo(()=>be(K),[K]);f.useEffect(()=>{const s=n=>{n.code==="Space"&&P(!0)},t=n=>{n.code==="Space"&&(P(!1),g(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",t)}},[]);const V=a==="view"?.08:.4,z=s=>Math.max(V,Math.min(2.5,s)),c=()=>{if(!N.current||!I.current)return;const s=N.current,t=I.current,n=getComputedStyle(t),p=(parseFloat(n.marginLeft)||0)+(parseFloat(n.marginRight)||0),o=(parseFloat(n.marginTop)||0)+(parseFloat(n.marginBottom)||0),w=t.offsetWidth+p,l=t.offsetHeight+o;if(!w||!l)return;const _=getComputedStyle(s),C=parseFloat(_.paddingLeft||"0")||0,O=parseFloat(_.paddingRight||"0")||0,R=parseFloat(_.paddingTop||"0")||0,X=parseFloat(_.paddingBottom||"0")||0,u=24,S=Math.max(1,s.clientWidth-C-O-u*2),A=Math.max(1,s.clientHeight-R-X-u*2),H=Math.min(S/w,A/l),q=z(Math.min(H*.96,1.2));D(q);const Q=Math.round(C+u+(S-w*q)/2),ee=Math.round(R+u+(A-l*q)/2);L({x:Q,y:ee})};f.useEffect(()=>{requestAnimationFrame(c)},[r==null?void 0:r.id]),f.useEffect(()=>{if(!N.current)return;let s=0;const t=new ResizeObserver(()=>{cancelAnimationFrame(s),s=requestAnimationFrame(c)});return t.observe(N.current),()=>{cancelAnimationFrame(s),t.disconnect()}},[r==null?void 0:r.id]);const h=(s,t,n)=>{if(!N.current)return;const p=N.current.getBoundingClientRect(),o=t-p.left,w=n-p.top;L(l=>{const _=s/(d.current||1);return{x:Math.round(o-(o-l.x)*_),y:Math.round(w-(w-l.y)*_)}}),D(s)};f.useEffect(()=>{const s=N.current;if(!s)return;const t=n=>{if(!!!(n.ctrlKey||n.metaKey)||(n.preventDefault(),!E))return;const o=n.deltaY>0?.9:1.1,w=z((d.current||1)*o);h(w,n.clientX,n.clientY)};return s.addEventListener("wheel",t,{passive:!1}),()=>s.removeEventListener("wheel",t)},[E]);const $=s=>{const t=s.target;if(a==="view"){if(s.button!==0||t!=null&&t.closest(".fe-canvas-controls, button, a, input, textarea, select"))return;s.preventDefault(),i.current={moved:!1};const C={x:s.clientX,y:s.clientY},O={...M};let R=!1;const X=S=>{const A=S.clientX-C.x,H=S.clientY-C.y,q=Math.abs(A)+Math.abs(H);!R&&q>4&&(R=!0,i.current&&(i.current.moved=!0),g(!0)),R&&L({x:O.x+A,y:O.y+H})},u=()=>{R&&g(!1),window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",u),i.current&&!i.current.moved&&(i.current=null)};window.addEventListener("mousemove",X),window.addEventListener("mouseup",u);return}const n=s.button===1,p=y&&s.button===0;if(!n&&!p)return;s.preventDefault(),g(!0);const o={x:s.clientX,y:s.clientY},w={...M},l=C=>{L({x:w.x+(C.clientX-o.x),y:w.y+(C.clientY-o.y)})},_=()=>{g(!1),window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",_)};window.addEventListener("mousemove",l),window.addEventListener("mouseup",_)},B=f.useRef(null),J=s=>{if(a!=="view"||s.touches.length!==1)return;const t=s.touches[0],n=s.target;n!=null&&n.closest(".table, .floor-object, .fe-canvas-controls, button, a, input, textarea, select")||(s.preventDefault(),g(!0),B.current={startX:t.clientX,startY:t.clientY,panX:M.x,panY:M.y,active:!0})},ie=s=>{if(a!=="view")return;const t=B.current;if(!t||!t.active||s.touches.length!==1)return;const n=s.touches[0];s.preventDefault(),L({x:t.panX+(n.clientX-t.startX),y:t.panY+(n.clientY-t.startY)})},le=()=>{a==="view"&&(B.current=null,g(!1))},G=s=>Math.max(1,Number(s)||1)*F,se=s=>{const t=(s||"").toLowerCase();return t.includes("occup")||t==="busy"||t==="taken"?"occupied":t.includes("reserv")||t.includes("book")?"reserved":t.includes("dirty")||t.includes("need")?"dirty":"empty"},ce=f.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=t&&t.tableId?String(t.tableId):"";n&&s.set(n,{status:se(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),ue=f.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(t=>{const n=Number(t&&(t.tableNumber??0));!Number.isFinite(n)||n<=0||s.set(n,{status:se(String(t.status||"empty")),guestName:t.guestName??null,guestCount:t.guestCount??null,orderId:t.orderId??null})}),s},[r]),de=s=>{const t=s.id?ce.get(String(s.id)):void 0;if(t)return t;const n=Number(s.tableNumber??0);if(Number.isFinite(n)&&n>0){const p=ue.get(n);if(p)return p}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${T?"is-panning":""}`,ref:N,onMouseDown:$,onTouchStart:J,onTouchMove:ie,onTouchEnd:le,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[E?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=N.current)==null?void 0:t.getBoundingClientRect();h(z(k*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var t;const s=(t=N.current)==null?void 0:t.getBoundingClientRect();h(z(k*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"})]}):null,e.jsx("button",{className:"btn-icon-small",onClick:c,title:"Center",children:"⤢"}),E?e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(k*100),"%"]}):null,e.jsx("div",{className:"fe-hint",children:a==="view"?"Drag to pan":y?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:I,onClickCapture:s=>{var t;a==="view"&&(t=i.current)!=null&&t.moved&&(s.preventDefault(),s.stopPropagation(),i.current=null)},style:{direction:"ltr",gridTemplateColumns:`repeat(${r.gridCols}, ${F}px)`,gridTemplateRows:`repeat(${r.gridRows}, ${F}px)`,transform:`translate(${M.x}px, ${M.y}px) scale(${k})`,transformOrigin:"0 0","--cell":`${F}px`,"--floor-bg":Y.bg,"--floor-bg-size":Y.size,"--floor-bg-repeat":Y.repeat,"--floor-bg-position":Y.pos},children:Array.from({length:r.gridRows*r.gridCols}).map((s,t)=>{var X;const n=Math.floor(t/r.gridCols),p=t%r.gridCols,o=r.tables.find(u=>p>=u.gridX&&p<u.gridX+(u.spanX||1)&&n>=u.gridY&&n<u.gridY+(u.spanY||1)),l=(r.objects??[]).find(u=>p>=u.gridX&&p<u.gridX+(u.spanX||1)&&n>=u.gridY&&n<u.gridY+(u.spanY||1)),_=!!o&&o.gridX===p&&o.gridY===n,C=!!l&&l.gridX===p&&l.gridY===n,O=n*r.gridCols+p,R=(((X=r.gridMask)==null?void 0:X[O])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${R?"active":"inactive"}`,children:[C&&l&&e.jsxs("div",{className:`floor-object type-${l.type}`,style:{width:`${G(l.spanX)}px`,height:`${G(l.spanY)}px`,transform:`rotate(${re(l.rotationDeg??l.rotation??0)}deg)`,cursor:a==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(l.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${te(l.scale,1)})`},src:l.assetFile?`${b}${l.assetFile}`:fe(l.type,l.label),alt:""}),l.label&&e.jsx("div",{className:"obj-label",children:l.label})]}),_&&o&&(()=>{const u=de(o),S=String(u.status||"empty"),A=x&&String(x)===String(o.id)||Array.isArray(U)&&U.some(ee=>String(ee)===String(o.id)),H=a==="view",q=S==="occupied"?"תפוס":S==="reserved"?"שמור":S==="dirty"?"מלוכלך":"פנוי",Q=u.guestCount!=null&&u.guestCount!==""?` · ${u.guestCount}`:"";return e.jsxs("div",{className:`table ${String(o.shape||"square")} ${A?"selected":""}`,onClick:()=>m==null?void 0:m(o.id),style:{position:"absolute",top:0,left:0,width:`${G(o.spanX)}px`,height:`${G(o.spanY)}px`,cursor:a==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":o.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(o.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${re(o.rotationDeg??o.rotation??0)}deg) scale(${te(o.scale,1)})`},src:o.assetFile?`${b}${o.assetFile}`:pe(o.shape,o.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:o.name||(o.tableNumber!=null?`Table ${o.tableNumber}`:"Table")}),o.seats!=null&&e.jsxs("div",{className:"table-seats",children:[o.seats," seats"]})]}),H&&e.jsxs("div",{className:`sbv-status-pill is-${S}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[q,Q]})]})]})})()]},t)})})]})}function he(r){const a=(r||"").toLowerCase();return a==="occupied"||a==="busy"||a==="taken"?"occupied":a==="reserved"||a==="booked"?"reserved":a==="dirty"||a==="needs_cleaning"?"dirty":"empty"}function W(r){return v(`floor.status.${r}`,r)}function xe({restaurantId:r,mountMode:a="page"}){const[m,x]=j.useState([]),[U,E]=j.useState(null),[N,I]=j.useState(null),[k,D]=j.useState(!0),[M,L]=j.useState(null),[y,P]=j.useState(null),T=j.useCallback(async()=>{try{const c=await fetch(`/api/floor-layouts/${r}/active`,{headers:{"Content-Type":"application/json"}});if(!c.ok)throw new Error(`HTTP ${c.status}`);const h=await c.json(),$=h&&h.id?h:(h==null?void 0:h.activeLayout)??null;if(!$){x([]),E(null),I(null),L(v("host.no_floor_plan","No active floor plan")),D(!1);return}x([$]),E($.id),I(B=>B??$.id),L(null),D(!1),y&&(($.tables||[]).some(J=>String(J.id)===String(y))||P(null))}catch(c){L(v("host.err_load_map","Error loading floor map")+`: ${(c==null?void 0:c.message)??"unknown"}`),D(!1)}},[r,y]);j.useEffect(()=>{T();const c=setInterval(T,5e3);return()=>clearInterval(c)},[T]);const g=j.useMemo(()=>N?m.find(c=>c.id===N)??null:null,[m,N]),d=j.useMemo(()=>!g||!y?null:(g.tables||[]).find(c=>String(c.id)===String(y))??null,[g,y]),i=j.useMemo(()=>{if(!g||!d)return null;const c=g.tableStatuses;if(!Array.isArray(c))return null;const h=c.find($=>String($.tableId)===String(d.id));return h||(c.find($=>$.tableNumber===d.number)??null)},[g,d]),F=j.useMemo(()=>he(i==null?void 0:i.status),[i]),K=c=>{P(c)},Y=()=>P(null),V=async()=>{const c=(d==null?void 0:d.number)??(d==null?void 0:d.tableNumber);if(c)try{await fetch("/api/host/table/clean",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({restaurantId:r,table:c})}),await T()}catch(h){console.error("Failed to mark table clean:",h)}},z=`floor-editor sb-floor-view ${a==="lobby"?"is-embed":""}`;return k?e.jsx("div",{className:z,children:e.jsx("div",{className:"sbv-loading",children:v("floor.loading","Loading floor plan...")})}):M||!g?e.jsx("div",{className:z,children:e.jsxs("div",{className:"sbv-error",children:[e.jsx("div",{className:"sbv-error-title",children:v("host.err_load_map","Cannot load floor map")}),e.jsx("div",{className:"sbv-error-sub",children:M??v("host.err_load_map","Error loading floor map")}),e.jsx("button",{className:"sbv-retry",onClick:T,children:v("common.btn_refresh","Retry")})]})}):e.jsx("div",{className:z,children:e.jsxs("div",{className:"sbv-shell",children:[e.jsxs("div",{className:"sbv-left",children:[e.jsxs("div",{className:"layout-tabs-bar sbv-view-topbar",children:[e.jsxs("div",{className:"sbv-topbar-left",children:[e.jsx("div",{className:"sbv-topbar-title",children:v("host.floor_map_title","Restaurant Map (Live)")}),e.jsx("div",{className:"sbv-topbar-sub",children:v("floor.hints.controls","Drag to pan, Ctrl+wheel to zoom")})]}),e.jsxs("div",{className:"sbv-legend","aria-label":"Legend",children:[e.jsxs("span",{className:"sbv-pill is-empty",children:[e.jsx("span",{className:"sbv-dot"})," ",W("empty")]}),e.jsxs("span",{className:"sbv-pill is-occupied",children:[e.jsx("span",{className:"sbv-dot"})," ",W("occupied")]}),e.jsxs("span",{className:"sbv-pill is-reserved",children:[e.jsx("span",{className:"sbv-dot"})," ",W("reserved")]}),e.jsxs("span",{className:"sbv-pill is-dirty",children:[e.jsx("span",{className:"sbv-dot"})," ",W("dirty")]})]})]}),e.jsx("div",{className:"editor-content sbv-editor-content",children:e.jsx(ge,{layout:g,selectedTableId:y,onTableClick:K,mode:"view"})})]}),e.jsx("aside",{className:"sbv-right","aria-label":v("host.table_details","Table details"),children:y?e.jsxs("div",{className:"sbv-right-panel",role:"dialog","aria-modal":"false",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:v("host.table_details","Table Details")}),e.jsx("button",{className:"sbv-close",onClick:Y,"aria-label":v("common.btn_close","Close"),children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-table-number",children:[v("host.table_label","Table")," ",(d==null?void 0:d.number)??"—"]}),e.jsxs("div",{className:`sbv-status-row is-${F}`,children:[e.jsx("span",{className:"sbv-status-dot"}),e.jsx("span",{className:"sbv-status-label",children:v("host.table_status_label","Table Status")}),e.jsx("span",{className:"sbv-status-value",children:W(F)})]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:v("host.guest_name","Guest Name")}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.guestName)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:v("host.num_guests","Guests")}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.guestCount)!=null?String(i.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:v("host.reservation_time","Reservation Time")}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.reservationTime)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:v("pos.waiter.items_label","Items")}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.itemsCount)??"—"})]}),e.jsxs("div",{className:"sbv-kv-row",children:[e.jsx("div",{className:"sbv-kv-key",children:v("pos.waiter.subtotal","Subtotal")}),e.jsx("div",{className:"sbv-kv-val",children:(i==null?void 0:i.subtotal)??"—"})]})]})]}),e.jsx("div",{className:"sbv-drawer-footer",children:F==="dirty"&&(d!=null&&d.number)?e.jsx("button",{className:"sbv-success-btn",onClick:V,children:v("floor.btn_mark_clean","Mark as Clean")}):F==="occupied"&&(d!=null&&d.number)?e.jsx("a",{className:"sbv-primary-btn",href:`/waiter/${r}/${d.number}`,children:v("pos.waiter.btn_open_order","Open Order")}):e.jsx("button",{className:"sbv-secondary-btn",onClick:Y,children:v("common.btn_close","Close")})})]}):e.jsxs("div",{className:"sbv-right-empty",children:[e.jsx("div",{className:"sbv-right-empty-title",children:v("host.table_details","Table Details")}),e.jsx("div",{className:"sbv-right-empty-sub",children:v("host.floor_map_help","Select a table on the map to view details.")})]})})]})})}const Z=document.getElementById("sb-floor-root");if(!Z)throw new Error("Missing #sb-floor-root");const ne=Z.getAttribute("data-rid")||Z.getAttribute("data-restaurant-id")||"",ae=Z.getAttribute("data-click-mode")||Z.getAttribute("data-mode")||"page",oe=ae==="lobby"?"lobby":"page";console.info("[FloorView] mount",{rid:ne,mountMode:oe,clickMode:ae});ve.createRoot(Z).render(e.jsx(j.StrictMode,{children:e.jsx(xe,{restaurantId:ne,mountMode:oe})}));
