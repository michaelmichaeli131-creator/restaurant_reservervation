import{r as u,j as e,c as G,R as J}from"./floor-index.js";const g="/floor_assets/",P=(t,l=1)=>{const c=Number(t);return Number.isFinite(c)?Math.max(.5,Math.min(1.6,c)):l},D=t=>{const l=Number(t);return Number.isFinite(l)?Math.round(l/45)*45:0},Q=t=>{if(!t||t.startsWith("#"))return"parquet_blue";const l=t;return l==="parquet_blue"||l==="parquet_brown"||l==="slate_dark"||l==="navy_carpet"||l==="teal_terrazzo"?l:"parquet_blue"};function ee(t){return{parquet_blue:{bg:`url(${g}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${g}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${g}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${g}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${g}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[t]}function se(t,l){const c=String(t||"square").toLowerCase(),a=Number(l||0);return c==="round"?`${g}${a>=9?"round_table_10.svg":"round_table4.svg"}`:c==="booth"?`${g}${a>=6?"large_booth.svg":"booth4.svg"}`:c==="rect"?`${g}${a>=10?"square_table10.svg":a>=6?"square_table6.svg":a>=4?"square_table4.svg":"square_table2.svg"}`:`${g}${a>=10?"square_table10.svg":a>=6?"square_table6.svg":a>=4?"square_table4.svg":"square_table2.svg"}`}function te(t,l){const c=String(t||"").toLowerCase();return c==="door"?`${g}door.svg`:c==="wall"?`${g}wall.svg`:c==="divider"?`${g}divider.svg`:c==="chair"?`${g}chair.svg`:c==="bar"?`${g}bar.svg`:c==="plant"?`${g}plant.svg`:l?`${g}${l}.svg`:`${g}divider.svg`}function re({layout:t,mode:l,onTableClick:c,selectedTableId:a}){const x=u.useRef(null),N=u.useRef(null),[j,S]=u.useState(1),[I,R]=u.useState({x:0,y:0}),[L,$]=u.useState(!1),[_,z]=u.useState(!1),C=60,q=10,w=u.useMemo(()=>Q(t.floorColor),[t==null?void 0:t.id]),b=u.useMemo(()=>ee(w),[w]);u.useEffect(()=>{const s=o=>{o.code==="Space"&&$(!0)},r=o=>{o.code==="Space"&&($(!1),z(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",r),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",r)}},[]);const k=s=>Math.max(.4,Math.min(2.5,s)),F=()=>{if(!x.current)return;const s=x.current.getBoundingClientRect(),r=t.gridCols*C+q*2,o=t.gridRows*C+q*2,v=24,i=k(Math.min((s.width-v*2)/r,(s.height-v*2)/o,1.2));S(i);const y=Math.round((s.width-r*i)/2),d=Math.round((s.height-o*i)/2);R({x:y,y:d})};u.useEffect(()=>{requestAnimationFrame(F)},[t==null?void 0:t.id]),u.useEffect(()=>{if(!x.current)return;const s=x.current;let r=null;const o=new ResizeObserver(()=>{r&&window.clearTimeout(r),r=window.setTimeout(()=>F(),60)});return o.observe(s),()=>{o.disconnect(),r&&window.clearTimeout(r),r=null}},[t==null?void 0:t.id]);const E=(s,r,o)=>{if(!x.current)return;const v=x.current.getBoundingClientRect(),i=r-v.left,y=o-v.top;R(d=>{const M=s/j;return{x:Math.round(i-(i-d.x)*M),y:Math.round(y-(y-d.y)*M)}}),S(s)},n=s=>{if(!(s.ctrlKey||s.metaKey))return;s.preventDefault();const r=k(j*(s.deltaY>0?.9:1.1));E(r,s.clientX,s.clientY)},p=s=>{const r=s.button===1,o=L&&s.button===0;if(!r&&!o)return;s.preventDefault(),z(!0);const v={x:s.clientX,y:s.clientY},i={...I},y=M=>{R({x:i.x+(M.clientX-v.x),y:i.y+(M.clientY-v.y)})},d=()=>{z(!1),window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",d)};window.addEventListener("mousemove",y),window.addEventListener("mouseup",d)},m=s=>Math.max(1,Number(s)||1)*C,h=u.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(r=>{const o=r&&r.tableId?String(r.tableId):"";o&&s.set(o,{status:String(r.status||"empty"),guestName:r.guestName??null,guestCount:r.guestCount??null,orderId:r.orderId??null})}),s},[t]),A=u.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(r=>{const o=Number(r&&(r.tableNumber??0));!Number.isFinite(o)||o<=0||s.set(o,{status:String(r.status||"empty"),guestName:r.guestName??null,guestCount:r.guestCount??null,orderId:r.orderId??null})}),s},[t]),Y=s=>{const r=s.id?h.get(String(s.id)):void 0;if(r)return r;const o=Number(s.tableNumber??0);if(Number.isFinite(o)&&o>0){const v=A.get(o);if(v)return v}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${_?"is-panning":""}`,ref:x,onWheel:n,onMouseDown:p,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var r;const s=(r=x.current)==null?void 0:r.getBoundingClientRect();E(k(j*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var r;const s=(r=x.current)==null?void 0:r.getBoundingClientRect();E(k(j*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"}),e.jsx("button",{className:"btn-icon-small",onClick:F,title:"Fit to screen",children:"⤢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(j*100),"%"]}),e.jsx("div",{className:"fe-hint",children:L?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:N,style:{direction:"ltr",gridTemplateColumns:`repeat(${t.gridCols}, ${C}px)`,gridTemplateRows:`repeat(${t.gridRows}, ${C}px)`,transform:`translate(${I.x}px, ${I.y}px) scale(${j})`,transformOrigin:"0 0","--cell":`${C}px`,"--floor-bg":b.bg,"--floor-bg-size":b.size,"--floor-bg-repeat":b.repeat,"--floor-bg-position":b.pos},children:Array.from({length:t.gridRows*t.gridCols}).map((s,r)=>{var X;const o=Math.floor(r/t.gridCols),v=r%t.gridCols,i=t.tables.find(f=>v>=f.gridX&&v<f.gridX+(f.spanX||1)&&o>=f.gridY&&o<f.gridY+(f.spanY||1)),d=(t.objects??[]).find(f=>v>=f.gridX&&v<f.gridX+(f.spanX||1)&&o>=f.gridY&&o<f.gridY+(f.spanY||1)),M=!!i&&i.gridX===v&&i.gridY===o,U=!!d&&d.gridX===v&&d.gridY===o,K=o*t.gridCols+v,O=(((X=t.gridMask)==null?void 0:X[K])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${O?"active":"inactive"}`,children:[U&&d&&e.jsxs("div",{className:`floor-object type-${d.type}`,style:{width:`${m(d.spanX)}px`,height:`${m(d.spanY)}px`,transform:`rotate(${D(d.rotationDeg??d.rotation??0)}deg)`,cursor:l==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(d.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${P(d.scale,1)})`},src:d.assetFile?`${g}${d.assetFile}`:te(d.type,d.label),alt:""}),d.label&&e.jsx("div",{className:"obj-label",children:d.label})]}),M&&i&&(()=>{const f=Y(i),T=String(f.status||"empty"),W=a&&String(a)===String(i.id),H=l==="view",Z=T==="occupied"?"תפוס":T==="reserved"?"שמור":T==="dirty"?"מלוכלך":"פנוי",V=f.guestCount!=null&&f.guestCount!==""?` · ${f.guestCount}`:"";return e.jsxs("div",{className:`table ${String(i.shape||"square")} ${W?"selected":""} sbv-table sbv-${T||"empty"}`,onClick:()=>c==null?void 0:c(i.id),style:{position:"absolute",top:0,left:0,width:`${m(i.spanX)}px`,height:`${m(i.spanY)}px`,cursor:l==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":i.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(i.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${D(i.rotationDeg??i.rotation??0)}deg) scale(${P(i.scale,1)})`},src:i.assetFile?`${g}${i.assetFile}`:se(i.shape,i.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:i.name||(i.tableNumber!=null?`Table ${i.tableNumber}`:"Table")}),i.seats!=null&&e.jsxs("div",{className:"table-seats",children:[i.seats," seats"]})]}),H&&e.jsxs("div",{className:`sbv-status-pill is-${T}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[Z,V]})]})]})})()]},r)})})]})}function ne({restaurantId:t}){const[l,c]=u.useState({kind:"loading"}),[a,x]=u.useState(null),[N,j]=u.useState(null),[S,I]=u.useState(""),[R,L]=u.useState(0),$=u.useRef(null),_=u.useMemo(()=>String(t||"").trim(),[t]),z=u.useMemo(()=>{const n=new Set;((a==null?void 0:a.tables)||[]).forEach(m=>{const h=String(m.sectionId||"").trim();h&&n.add(h)});const p=Array.from(n);return[""].concat(p)},[a==null?void 0:a.id,a==null?void 0:a.tables]),C=(n,p)=>{if(!n)return"כל המסעדה";const m=String(n);return m.length<=22?m:`אזור ${p}`},q=n=>{const p=a==null?void 0:a.tableStatuses;if(!Array.isArray(p))return{status:"empty"};const m=p.find(h=>h&&String(h.tableId||"")===String(n));return m?{status:String(m.status||"empty"),guestName:m.guestName??null,guestCount:m.guestCount??null,reservationTime:m.reservationTime??m.time??null,itemsCount:m.itemsCount??m.items??null,subtotal:m.subtotal??m.total??null,orderId:m.orderId??null}:{status:"empty"}},w=u.useMemo(()=>!N||!a?null:(a.tables||[]).find(n=>String(n.id)===String(N))||null,[N,a==null?void 0:a.id,a==null?void 0:a.tables]),b=u.useMemo(()=>N?q(N):{status:"empty"},[N,a]),k=n=>n==="occupied"?"תפוס":n==="reserved"?"שמור":n==="dirty"?"מלוכלך":"פנוי",F=n=>n==="occupied"?"occupied":n==="reserved"?"reserved":n==="dirty"?"dirty":"empty";u.useEffect(()=>{let n=!1;const p=async(m=!1)=>{if(!_){c({kind:"error",message:"Missing restaurant id (rid)"});return}m||c({kind:"loading"});try{const h=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`);if(!h.ok){const s=await h.json().catch(()=>({})),r=s&&(s.error||s.message)||`${h.status} ${h.statusText}`;throw new Error(r)}const A=await h.json();if(n)return;x(A),c({kind:"ready"}),L(Date.now()),!S||(A.tables||[]).some(s=>String(s.sectionId||"")===String(S))||I("")}catch(h){if(n)return;x(null),c({kind:"error",message:h instanceof Error?h.message:String(h)})}};return p(),$.current&&window.clearInterval($.current),$.current=window.setInterval(()=>{p(!0)},5e3),()=>{n=!0,$.current&&window.clearInterval($.current),$.current=null}},[_]);const E=u.useMemo(()=>{if(!a)return null;if(!S)return a;const n=String(S);return{...a,tables:(a.tables||[]).filter(p=>String(p.sectionId||"")===n)}},[a,S]);return l.kind==="loading"?e.jsx("div",{className:"sb-floor-view-shell",children:e.jsx("div",{className:"sb-floor-view-loading",children:"Loading floor map…"})}):l.kind==="error"?e.jsx("div",{className:"sb-floor-view-shell",children:e.jsxs("div",{className:"sb-floor-view-error",children:[e.jsx("div",{className:"title",children:"לא ניתן לטעון את מפת המסעדה."}),e.jsx("div",{className:"desc",children:l.message}),e.jsx("div",{className:"hint",children:"(בדוק את ה-Console לפרטי דיבוג)"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`floor-editor sb-floor-view ${N?"sbv-has-drawer":""}`,children:[e.jsxs("div",{className:"layout-tabs-bar",children:[e.jsx("div",{className:"layout-tabs",role:"tablist","aria-label":"Sections",children:z.map((n,p)=>e.jsx("button",{className:`layout-tab ${String(S)===String(n)?"active":""}`,onClick:()=>I(String(n)),type:"button",role:"tab","aria-selected":String(S)===String(n),children:C(String(n),p)},n||"all"))}),e.jsxs("div",{className:"layout-actions",children:[e.jsxs("div",{className:"sbv-legend",title:"Legend",children:[e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot empty"}),"פנוי"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot occupied"}),"תפוס"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot reserved"}),"שמור"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot dirty"}),"מלוכלך"]})]}),e.jsx("button",{type:"button",className:"btn-icon-small",title:"Refresh",onClick:async()=>{try{const n=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`,{cache:"no-store"});if(!n.ok)throw new Error(`${n.status} ${n.statusText}`);const p=await n.json();x(p),L(Date.now())}catch(n){console.error("[FloorView] manual refresh failed",n)}},children:"↻"}),e.jsx("div",{className:"sbv-refresh",children:R?`עודכן: ${new Date(R).toLocaleTimeString()}`:""})]})]}),e.jsx("div",{className:"editor-content sbv-content",children:e.jsx("div",{className:"editor-main sbv-main",children:E&&e.jsx(re,{layout:E,mode:"view",selectedTableId:N,onTableClick:n=>{j(n)}})})})]}),N&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sbv-drawer-backdrop",onMouseDown:()=>j(null),"aria-hidden":"true"}),e.jsxs("aside",{className:"sbv-drawer",role:"dialog","aria-modal":"true","aria-label":"פרטי שולחן",children:[e.jsxs("div",{className:"sbv-drawer-header",children:[e.jsx("div",{className:"sbv-drawer-title",children:"פרטי שולחן"}),e.jsxs("div",{className:"sbv-drawer-sub",children:["שולחן ",(w==null?void 0:w.tableNumber)??(w==null?void 0:w.name)??N]}),e.jsx("button",{className:"sbv-drawer-close",type:"button","aria-label":"Close",onClick:()=>j(null),children:"✕"})]}),e.jsxs("div",{className:"sbv-drawer-body",children:[e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-label",children:"שם המזמין"}),e.jsx("div",{className:"sbv-value",children:b.guestName?String(b.guestName):"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-label",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-value",children:b.guestCount!=null&&b.guestCount!==""?String(b.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-label",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-value",children:b.reservationTime?String(b.reservationTime):"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-label",children:"סטטוס שולחן"}),e.jsxs("div",{className:"sbv-value sbv-status",children:[e.jsx("span",{className:`sbv-dot ${F(String(b.status||"empty"))}`}),k(String(b.status||"empty"))]})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-label",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-value",children:b.itemsCount!=null&&b.itemsCount!==""?String(b.itemsCount):"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-label",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-value",children:b.subtotal!=null&&b.subtotal!==""?String(b.subtotal):"—"})]}),e.jsxs("div",{className:"sbv-actions",children:[e.jsx("button",{type:"button",className:"btn-primary",onClick:()=>{const n=w==null?void 0:w.tableNumber;n!=null&&(window.location.href=`/waiter/${encodeURIComponent(_)}/${encodeURIComponent(String(n))}`)},children:"פתח הזמנה"}),e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>j(null),children:"סגור"})]})]})]})]})]})}function ae(){const t=document.getElementById("sb-floor-root"),l=(t==null?void 0:t.getAttribute("data-rid"))||"";if(l)return l;const c=new URLSearchParams(window.location.search);return c.get("rid")||c.get("restaurantId")||""}const B=document.getElementById("sb-floor-root");if(B){const t=ae();G.createRoot(B).render(e.jsx(J.StrictMode,{children:e.jsx(ne,{restaurantId:t})}))}
