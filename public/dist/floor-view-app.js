import{r as u,j as e,c as G,R as J}from"./floor-index.js";const v="/floor_assets/",X=(r,l=1)=>{const c=Number(r);return Number.isFinite(c)?Math.max(.5,Math.min(1.6,c)):l},D=r=>{const l=Number(r);return Number.isFinite(l)?Math.round(l/45)*45:0},Q=r=>{if(!r||r.startsWith("#"))return"parquet_blue";const l=r;return l==="parquet_blue"||l==="parquet_brown"||l==="slate_dark"||l==="navy_carpet"||l==="teal_terrazzo"?l:"parquet_blue"};function ee(r){return{parquet_blue:{bg:`url(${v}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${v}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${v}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${v}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${v}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[r]}function te(r,l){const c=String(r||"square").toLowerCase(),o=Number(l||0);return c==="round"?`${v}${o>=9?"round_table_10.svg":"round_table4.svg"}`:c==="booth"?`${v}${o>=6?"large_booth.svg":"booth4.svg"}`:c==="rect"?`${v}${o>=10?"square_table10.svg":o>=6?"square_table6.svg":o>=4?"square_table4.svg":"square_table2.svg"}`:`${v}${o>=10?"square_table10.svg":o>=6?"square_table6.svg":o>=4?"square_table4.svg":"square_table2.svg"}`}function se(r,l){const c=String(r||"").toLowerCase();return c==="door"?`${v}door.svg`:c==="wall"?`${v}wall.svg`:c==="divider"?`${v}divider.svg`:c==="chair"?`${v}chair.svg`:c==="bar"?`${v}bar.svg`:c==="plant"?`${v}plant.svg`:l?`${v}${l}.svg`:`${v}divider.svg`}function re({layout:r,mode:l,onTableClick:c,selectedTableId:o}){const N=u.useRef(null),w=u.useRef(null),[j,S]=u.useState(1),[I,R]=u.useState({x:0,y:0}),[z,$]=u.useState(!1),[_,T]=u.useState(!1),y=60,q=10,A=u.useMemo(()=>Q(r.floorColor),[r==null?void 0:r.id]),L=u.useMemo(()=>ee(A),[A]);u.useEffect(()=>{const s=i=>{i.code==="Space"&&$(!0)},n=i=>{i.code==="Space"&&($(!1),T(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",n)}},[]);const p=s=>Math.max(.4,Math.min(2.5,s)),M=()=>{if(!N.current)return;const s=N.current.getBoundingClientRect(),n=r.gridCols*y+q*2,i=r.gridRows*y+q*2,m=24,a=p(Math.min((s.width-m*2)/n,(s.height-m*2)/i,1.2));S(a);const x=Math.round((s.width-n*a)/2),d=Math.round((s.height-i*a)/2);R({x,y:d})};u.useEffect(()=>{requestAnimationFrame(M)},[r==null?void 0:r.id]);const E=(s,n,i)=>{if(!N.current)return;const m=N.current.getBoundingClientRect(),a=n-m.left,x=i-m.top;R(d=>{const k=s/j;return{x:Math.round(a-(a-d.x)*k),y:Math.round(x-(x-d.y)*k)}}),S(s)},C=s=>{if(!(s.ctrlKey||s.metaKey))return;s.preventDefault();const n=p(j*(s.deltaY>0?.9:1.1));E(n,s.clientX,s.clientY)},P=s=>{const n=s.button===1,i=z&&s.button===0;if(!n&&!i)return;s.preventDefault(),T(!0);const m={x:s.clientX,y:s.clientY},a={...I},x=k=>{R({x:a.x+(k.clientX-m.x),y:a.y+(k.clientY-m.y)})},d=()=>{T(!1),window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",d)};window.addEventListener("mousemove",x),window.addEventListener("mouseup",d)},t=s=>Math.max(1,Number(s)||1)*y,g=u.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(n=>{const i=n&&n.tableId?String(n.tableId):"";i&&s.set(i,{status:String(n.status||"empty"),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[r]),h=u.useMemo(()=>{const s=new Map;return(Array.isArray(r.tableStatuses)?r.tableStatuses:[]).forEach(n=>{const i=Number(n&&(n.tableNumber??0));!Number.isFinite(i)||i<=0||s.set(i,{status:String(n.status||"empty"),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[r]),b=s=>{const n=s.id?g.get(String(s.id)):void 0;if(n)return n;const i=Number(s.tableNumber??0);if(Number.isFinite(i)&&i>0){const m=h.get(i);if(m)return m}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${_?"is-panning":""}`,ref:N,onWheel:C,onMouseDown:P,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=N.current)==null?void 0:n.getBoundingClientRect();E(p(j*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=N.current)==null?void 0:n.getBoundingClientRect();E(p(j*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"}),e.jsx("button",{className:"btn-icon-small",onClick:M,title:"Fit to screen",children:"⤢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(j*100),"%"]}),e.jsx("div",{className:"fe-hint",children:z?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:w,style:{direction:"ltr",gridTemplateColumns:`repeat(${r.gridCols}, ${y}px)`,gridTemplateRows:`repeat(${r.gridRows}, ${y}px)`,transform:`translate(${I.x}px, ${I.y}px) scale(${j})`,transformOrigin:"0 0","--cell":`${y}px`,"--floor-bg":L.bg,"--floor-bg-size":L.size,"--floor-bg-repeat":L.repeat,"--floor-bg-position":L.pos},children:Array.from({length:r.gridRows*r.gridCols}).map((s,n)=>{var Y;const i=Math.floor(n/r.gridCols),m=n%r.gridCols,a=r.tables.find(f=>m>=f.gridX&&m<f.gridX+(f.spanX||1)&&i>=f.gridY&&i<f.gridY+(f.spanY||1)),d=(r.objects??[]).find(f=>m>=f.gridX&&m<f.gridX+(f.spanX||1)&&i>=f.gridY&&i<f.gridY+(f.spanY||1)),k=!!a&&a.gridX===m&&a.gridY===i,U=!!d&&d.gridX===m&&d.gridY===i,K=i*r.gridCols+m,H=(((Y=r.gridMask)==null?void 0:Y[K])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${H?"active":"inactive"}`,children:[U&&d&&e.jsxs("div",{className:`floor-object type-${d.type}`,style:{width:`${t(d.spanX)}px`,height:`${t(d.spanY)}px`,transform:`rotate(${D(d.rotationDeg??d.rotation??0)}deg)`,cursor:l==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(d.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${X(d.scale,1)})`},src:d.assetFile?`${v}${d.assetFile}`:se(d.type,d.label),alt:""}),d.label&&e.jsx("div",{className:"obj-label",children:d.label})]}),k&&a&&(()=>{const f=b(a),F=String(f.status||"empty"),W=o&&String(o)===String(a.id),O=l==="view"&&F&&F!=="empty",Z=F==="occupied"?"תפוס":F==="reserved"?"שמור":F==="dirty"?"מלוכלך":"פנוי",V=f.guestCount!=null&&f.guestCount!==""?` · ${f.guestCount}`:"";return e.jsxs("div",{className:`table ${String(a.shape||"square")} ${W?"selected":""}`,onClick:()=>c==null?void 0:c(a.id),style:{position:"absolute",top:0,left:0,width:`${t(a.spanX)}px`,height:`${t(a.spanY)}px`,cursor:l==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":a.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(a.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${D(a.rotationDeg??a.rotation??0)}deg) scale(${X(a.scale,1)})`},src:a.assetFile?`${v}${a.assetFile}`:te(a.shape,a.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:a.name||(a.tableNumber!=null?`Table ${a.tableNumber}`:"Table")}),a.seats!=null&&e.jsxs("div",{className:"table-seats",children:[a.seats," seats"]})]}),O&&e.jsxs("div",{className:`sbv-status-pill is-${F}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[Z,V]})]})]})})()]},n)})})]})}function ne({restaurantId:r}){const[l,c]=u.useState({kind:"loading"}),[o,N]=u.useState(null),[w,j]=u.useState(null),[S,I]=u.useState(""),[R,z]=u.useState(0),$=u.useRef(null),_=u.useMemo(()=>String(r||"").trim(),[r]),T=u.useMemo(()=>{const t=new Set;((o==null?void 0:o.tables)||[]).forEach(h=>{const b=String(h.sectionId||"").trim();b&&t.add(b)});const g=Array.from(t);return[""].concat(g)},[o==null?void 0:o.id,o==null?void 0:o.tables]),y=(t,g)=>{if(!t)return"כל המסעדה";const h=String(t);return h.length<=22?h:`אזור ${g}`},q=t=>{const g=o==null?void 0:o.tableStatuses;if(!Array.isArray(g))return{status:"empty"};const h=g.find(b=>b&&String(b.tableId||"")===String(t));return h?{status:String(h.status||"empty")}:{status:"empty"}},A=t=>t==="occupied"?"תפוס":t==="reserved"?"שמור":t==="dirty"?"מלוכלך":"פנוי",L=t=>t==="occupied"?"occupied":t==="reserved"?"reserved":t==="dirty"?"dirty":"empty",p=u.useMemo(()=>!o||!w?null:(o.tables||[]).find(t=>String(t.id)===String(w))||null,[o,w]),M=u.useMemo(()=>w?q(w):{status:"empty"},[o,w]),E=(p==null?void 0:p.tableNumber)??null,C=u.useMemo(()=>{const t=M,g=t.guestName??t.customerName??null,h=t.guestCount??t.partySize??null,b=t.reservationTime??t.reservedAt??null,s=t.occupiedSince??null,n=t.orderTotal??t.subtotal??null,i=t.itemsCount??(Number.isFinite(t.itemsReady)||Number.isFinite(t.itemsPending)?Number(t.itemsReady||0)+Number(t.itemsPending||0):null),m=(()=>{const a=b??s;if(!a)return null;const x=Number(a);if(Number.isFinite(x)&&x>1e9)try{return new Date(x).toLocaleTimeString()}catch{return null}return typeof a=="string"?a:null})();return{guestName:g,guestCount:h,timeStr:m,itemsCount:i,orderTotal:n}},[M]);u.useEffect(()=>{let t=!1;const g=async(h=!1)=>{if(!_){c({kind:"error",message:"Missing restaurant id (rid)"});return}h||c({kind:"loading"});try{const b=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`);if(!b.ok){const i=await b.json().catch(()=>({})),m=i&&(i.error||i.message)||`${b.status} ${b.statusText}`;throw new Error(m)}const s=await b.json();if(t)return;N(s),c({kind:"ready"}),z(Date.now()),!S||(s.tables||[]).some(i=>String(i.sectionId||"")===String(S))||I("")}catch(b){if(t)return;N(null),c({kind:"error",message:b instanceof Error?b.message:String(b)})}};return g(),$.current&&window.clearInterval($.current),$.current=window.setInterval(()=>{g(!0)},5e3),()=>{t=!0,$.current&&window.clearInterval($.current),$.current=null}},[_]);const P=u.useMemo(()=>{if(!o)return null;if(!S)return o;const t=String(S);return{...o,tables:(o.tables||[]).filter(g=>String(g.sectionId||"")===t)}},[o,S]);return l.kind==="loading"?e.jsx("div",{className:"sb-floor-view-shell",children:e.jsx("div",{className:"sb-floor-view-loading",children:"Loading floor map…"})}):l.kind==="error"?e.jsx("div",{className:"sb-floor-view-shell",children:e.jsxs("div",{className:"sb-floor-view-error",children:[e.jsx("div",{className:"title",children:"לא ניתן לטעון את מפת המסעדה."}),e.jsx("div",{className:"desc",children:l.message}),e.jsx("div",{className:"hint",children:"(בדוק את ה-Console לפרטי דיבוג)"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"floor-editor sb-floor-view",children:[e.jsxs("div",{className:"layout-tabs-bar",children:[e.jsx("div",{className:"layout-tabs",role:"tablist","aria-label":"Sections",children:T.map((t,g)=>e.jsx("button",{className:`layout-tab ${String(S)===String(t)?"active":""}`,onClick:()=>I(String(t)),type:"button",role:"tab","aria-selected":String(S)===String(t),children:y(String(t),g)},t||"all"))}),e.jsxs("div",{className:"layout-actions",children:[e.jsxs("div",{className:"sbv-legend",title:"Legend",children:[e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot empty"}),"פנוי"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot occupied"}),"תפוס"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot reserved"}),"שמור"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot dirty"}),"מלוכלך"]})]}),e.jsx("button",{type:"button",className:"btn-icon-small",title:"Refresh",onClick:async()=>{try{const t=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`,{cache:"no-store"});if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);const g=await t.json();N(g),z(Date.now())}catch(t){console.error("[FloorView] manual refresh failed",t)}},children:"↻"}),e.jsx("div",{className:"sbv-refresh",children:R?`עודכן: ${new Date(R).toLocaleTimeString()}`:""})]})]}),e.jsx("div",{className:"editor-content sbv-content",children:e.jsx("div",{className:"editor-main sbv-main",children:P&&e.jsx(re,{layout:P,mode:"view",selectedTableId:w,onTableClick:t=>{j(t)}})})})]}),w&&e.jsx("div",{className:"sbv-modal-backdrop",role:"dialog","aria-modal":"true",onMouseDown:t=>{t.target===t.currentTarget&&j(null)},children:e.jsxs("div",{className:"sbv-modal",dir:"rtl",children:[e.jsxs("div",{className:"sbv-modal-header",children:[e.jsx("div",{className:"sbv-modal-title",children:"פרטי שולחן"}),e.jsx("button",{className:"sbv-x",type:"button","aria-label":"Close",onClick:()=>j(null),children:"✕"})]}),e.jsxs("div",{className:"sbv-modal-subtitle",children:["שולחן ",(p==null?void 0:p.tableNumber)??(p==null?void 0:p.name)??"—"]}),e.jsxs("div",{className:"sbv-kv",children:[e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"k",children:"שם המזמין"}),e.jsx("div",{className:"v",children:C.guestName||"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"k",children:"מספר סועדים"}),e.jsx("div",{className:"v",children:C.guestCount??"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"k",children:"שעת ההזמנה"}),e.jsx("div",{className:"v",children:C.timeStr||"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"k",children:"סטטוס שולחן"}),e.jsxs("div",{className:"v",children:[e.jsx("span",{className:`sbv-dot ${L(String(M.status||"empty"))}`}),e.jsx("span",{className:"sbv-status-label",children:A(String(M.status||"empty"))})]})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"k",children:"מספר פריטים"}),e.jsx("div",{className:"v",children:C.itemsCount??"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"k",children:"סכום ביניים"}),e.jsx("div",{className:"v",children:C.orderTotal!=null?`${Number(C.orderTotal).toFixed(2)} ₪`:"—"})]})]}),e.jsxs("div",{className:"sbv-modal-actions",children:[E!=null&&e.jsx("a",{className:"btn primary",href:`/waiter/${encodeURIComponent(_)}/${encodeURIComponent(String(E))}`,children:"פתח הזמנה"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>j(null),children:"סגור"})]})]})})]})}function ae(){const r=document.getElementById("sb-floor-root"),l=(r==null?void 0:r.getAttribute("data-rid"))||"";if(l)return l;const c=new URLSearchParams(window.location.search);return c.get("rid")||c.get("restaurantId")||""}const B=document.getElementById("sb-floor-root");if(B){const r=ae();G.createRoot(B).render(e.jsx(J.StrictMode,{children:e.jsx(ne,{restaurantId:r})}))}
