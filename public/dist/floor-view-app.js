import{r as g,j as t,c as G,R as J}from"./floor-index.js";const p="/floor_assets/",Y=(s,c=1)=>{const l=Number(s);return Number.isFinite(l)?Math.max(.5,Math.min(1.6,l)):c},X=s=>{const c=Number(s);return Number.isFinite(c)?Math.round(c/45)*45:0},Q=s=>{if(!s||s.startsWith("#"))return"parquet_blue";const c=s;return c==="parquet_blue"||c==="parquet_brown"||c==="slate_dark"||c==="navy_carpet"||c==="teal_terrazzo"?c:"parquet_blue"};function ee(s){return{parquet_blue:{bg:`url(${p}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${p}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${p}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${p}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${p}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[s]}function te(s,c){const l=String(s||"square").toLowerCase(),o=Number(c||0);return l==="round"?`${p}${o>=9?"round_table_10.svg":"round_table4.svg"}`:l==="booth"?`${p}${o>=6?"large_booth.svg":"booth4.svg"}`:l==="rect"?`${p}${o>=10?"square_table10.svg":o>=6?"square_table6.svg":o>=4?"square_table4.svg":"square_table2.svg"}`:`${p}${o>=10?"square_table10.svg":o>=6?"square_table6.svg":o>=4?"square_table4.svg":"square_table2.svg"}`}function se(s,c){const l=String(s||"").toLowerCase();return l==="door"?`${p}door.svg`:l==="wall"?`${p}wall.svg`:l==="divider"?`${p}divider.svg`:l==="chair"?`${p}chair.svg`:l==="bar"?`${p}bar.svg`:l==="plant"?`${p}plant.svg`:c?`${p}${c}.svg`:`${p}divider.svg`}function re({layout:s,mode:c,onTableClick:l,selectedTableId:o}){const h=g.useRef(null),q=g.useRef(null),[S,x]=g.useState(1),[C,M]=g.useState({x:0,y:0}),[E,N]=g.useState(!1),[_,L]=g.useState(!1),$=60,k=10,z=g.useMemo(()=>Q(s.floorColor),[s==null?void 0:s.id]),n=g.useMemo(()=>ee(z),[z]);g.useEffect(()=>{const e=i=>{i.code==="Space"&&N(!0)},r=i=>{i.code==="Space"&&(N(!1),L(!1))};return window.addEventListener("keydown",e),window.addEventListener("keyup",r),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",r)}},[]);const m=e=>Math.max(.4,Math.min(2.5,e)),v=()=>{if(!h.current)return;const e=h.current.getBoundingClientRect(),r=s.gridCols*$+k*2,i=s.gridRows*$+k*2,f=24,a=m(Math.min((e.width-f*2)/r,(e.height-f*2)/i,1.2));x(a);const j=Math.round((e.width-r*a)/2),d=Math.round((e.height-i*a)/2);M({x:j,y:d})};g.useEffect(()=>{requestAnimationFrame(v)},[s==null?void 0:s.id]);const u=(e,r,i)=>{if(!h.current)return;const f=h.current.getBoundingClientRect(),a=r-f.left,j=i-f.top;M(d=>{const y=e/S;return{x:Math.round(a-(a-d.x)*y),y:Math.round(j-(j-d.y)*y)}}),x(e)},I=e=>{if(!(e.ctrlKey||e.metaKey))return;e.preventDefault();const r=m(S*(e.deltaY>0?.9:1.1));u(r,e.clientX,e.clientY)},T=e=>{const r=e.button===1,i=E&&e.button===0;if(!r&&!i)return;e.preventDefault(),L(!0);const f={x:e.clientX,y:e.clientY},a={...C},j=y=>{M({x:a.x+(y.clientX-f.x),y:a.y+(y.clientY-f.y)})},d=()=>{L(!1),window.removeEventListener("mousemove",j),window.removeEventListener("mouseup",d)};window.addEventListener("mousemove",j),window.addEventListener("mouseup",d)},w=e=>Math.max(1,Number(e)||1)*$,F=g.useMemo(()=>{const e=new Map;return(Array.isArray(s.tableStatuses)?s.tableStatuses:[]).forEach(r=>{const i=r&&r.tableId?String(r.tableId):"";i&&e.set(i,{status:String(r.status||"empty"),guestName:r.guestName??null,guestCount:r.guestCount??null,orderId:r.orderId??null})}),e},[s]),D=g.useMemo(()=>{const e=new Map;return(Array.isArray(s.tableStatuses)?s.tableStatuses:[]).forEach(r=>{const i=Number(r&&(r.tableNumber??0));!Number.isFinite(i)||i<=0||e.set(i,{status:String(r.status||"empty"),guestName:r.guestName??null,guestCount:r.guestCount??null,orderId:r.orderId??null})}),e},[s]),B=e=>{const r=e.id?F.get(String(e.id)):void 0;if(r)return r;const i=Number(e.tableNumber??0);if(Number.isFinite(i)&&i>0){const f=D.get(i);if(f)return f}return{status:"empty"}};return t.jsxs("div",{className:`editor-canvas ${_?"is-panning":""}`,ref:h,onWheel:I,onMouseDown:T,style:{position:"relative"},children:[t.jsxs("div",{className:"fe-canvas-controls",children:[t.jsx("button",{className:"btn-icon-small",onClick:()=>{var r;const e=(r=h.current)==null?void 0:r.getBoundingClientRect();u(m(S*1.1),((e==null?void 0:e.left)||0)+40,((e==null?void 0:e.top)||0)+40)},title:"Zoom in",children:"＋"}),t.jsx("button",{className:"btn-icon-small",onClick:()=>{var r;const e=(r=h.current)==null?void 0:r.getBoundingClientRect();u(m(S*.9),((e==null?void 0:e.left)||0)+40,((e==null?void 0:e.top)||0)+40)},title:"Zoom out",children:"－"}),t.jsx("button",{className:"btn-icon-small",onClick:v,title:"Fit to screen",children:"⤢"}),t.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(S*100),"%"]}),t.jsx("div",{className:"fe-hint",children:E?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),t.jsx("div",{className:"fe-grid",ref:q,style:{direction:"ltr",gridTemplateColumns:`repeat(${s.gridCols}, ${$}px)`,gridTemplateRows:`repeat(${s.gridRows}, ${$}px)`,transform:`translate(${C.x}px, ${C.y}px) scale(${S})`,transformOrigin:"0 0","--cell":`${$}px`,"--floor-bg":n.bg,"--floor-bg-size":n.size,"--floor-bg-repeat":n.repeat,"--floor-bg-position":n.pos},children:Array.from({length:s.gridRows*s.gridCols}).map((e,r)=>{var A;const i=Math.floor(r/s.gridCols),f=r%s.gridCols,a=s.tables.find(b=>f>=b.gridX&&f<b.gridX+(b.spanX||1)&&i>=b.gridY&&i<b.gridY+(b.spanY||1)),d=(s.objects??[]).find(b=>f>=b.gridX&&f<b.gridX+(b.spanX||1)&&i>=b.gridY&&i<b.gridY+(b.spanY||1)),y=!!a&&a.gridX===f&&a.gridY===i,U=!!d&&d.gridX===f&&d.gridY===i,K=i*s.gridCols+f,W=(((A=s.gridMask)==null?void 0:A[K])??1)===1;return t.jsxs("div",{className:`fe-grid-cell ${W?"active":"inactive"}`,children:[U&&d&&t.jsxs("div",{className:`floor-object type-${d.type}`,style:{width:`${w(d.spanX)}px`,height:`${w(d.spanY)}px`,transform:`rotate(${X(d.rotationDeg??d.rotation??0)}deg)`,cursor:c==="view"?"default":"grab"},children:[t.jsx("img",{className:`fe-asset fe-asset--${(d.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${Y(d.scale,1)})`},src:d.assetFile?`${p}${d.assetFile}`:se(d.type,d.label),alt:""}),d.label&&t.jsx("div",{className:"obj-label",children:d.label})]}),y&&a&&(()=>{const b=B(a),R=String(b.status||"empty"),H=o&&String(o)===String(a.id),O=c==="view"&&R&&R!=="empty",Z=R==="occupied"?"תפוס":R==="reserved"?"שמור":R==="dirty"?"מלוכלך":"פנוי",V=b.guestCount!=null&&b.guestCount!==""?` · ${b.guestCount}`:"";return t.jsxs("div",{className:`table ${String(a.shape||"square")} ${H?"selected":""}`,onClick:()=>l==null?void 0:l(a.id),style:{position:"absolute",top:0,left:0,width:`${w(a.spanX)}px`,height:`${w(a.spanY)}px`,cursor:c==="view"?"pointer":"default"},children:[t.jsx("div",{className:"fe-table-visual","data-asset":a.assetFile||"",children:t.jsx("img",{className:`fe-asset fe-asset--${(a.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${X(a.rotationDeg??a.rotation??0)}deg) scale(${Y(a.scale,1)})`},src:a.assetFile?`${p}${a.assetFile}`:te(a.shape,a.seats),alt:""})}),t.jsxs("div",{className:"fe-table-overlay",children:[t.jsx("div",{className:"table-label",children:a.name||(a.tableNumber!=null?`Table ${a.tableNumber}`:"Table")}),a.seats!=null&&t.jsxs("div",{className:"table-seats",children:[a.seats," seats"]})]}),O&&t.jsxs("div",{className:`sbv-status-pill is-${R}`,children:[t.jsx("span",{className:"sbv-dot"}),t.jsxs("span",{className:"sbv-status-text",children:[Z,V]})]})]})})()]},r)})})]})}function ne({restaurantId:s}){const[c,l]=g.useState({kind:"loading"}),[o,h]=g.useState(null),[q,S]=g.useState(null),[x,C]=g.useState(""),[M,E]=g.useState(0),N=g.useRef(null),_=g.useMemo(()=>String(s||"").trim(),[s]),L=g.useMemo(()=>{const n=new Set;((o==null?void 0:o.tables)||[]).forEach(v=>{const u=String(v.sectionId||"").trim();u&&n.add(u)});const m=Array.from(n);return[""].concat(m)},[o==null?void 0:o.id,o==null?void 0:o.tables]),$=(n,m)=>{if(!n)return"כל המסעדה";const v=String(n);return v.length<=22?v:`אזור ${m}`},k=n=>{const m=o==null?void 0:o.tableStatuses;if(!Array.isArray(m))return{status:"empty"};const v=m.find(u=>u&&String(u.tableId||"")===String(n));return v?{status:String(v.status||"empty")}:{status:"empty"}};g.useEffect(()=>{let n=!1;const m=async(v=!1)=>{if(!_){l({kind:"error",message:"Missing restaurant id (rid)"});return}v||l({kind:"loading"});try{const u=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`);if(!u.ok){const w=await u.json().catch(()=>({})),F=w&&(w.error||w.message)||`${u.status} ${u.statusText}`;throw new Error(F)}const I=await u.json();if(n)return;h(I),l({kind:"ready"}),E(Date.now()),!x||(I.tables||[]).some(w=>String(w.sectionId||"")===String(x))||C("")}catch(u){if(n)return;h(null),l({kind:"error",message:u instanceof Error?u.message:String(u)})}};return m(),N.current&&window.clearInterval(N.current),N.current=window.setInterval(()=>{m(!0)},5e3),()=>{n=!0,N.current&&window.clearInterval(N.current),N.current=null}},[_]);const z=g.useMemo(()=>{if(!o)return null;if(!x)return o;const n=String(x);return{...o,tables:(o.tables||[]).filter(m=>String(m.sectionId||"")===n)}},[o,x]);return c.kind==="loading"?t.jsx("div",{className:"sb-floor-view-shell",children:t.jsx("div",{className:"sb-floor-view-loading",children:"Loading floor map…"})}):c.kind==="error"?t.jsx("div",{className:"sb-floor-view-shell",children:t.jsxs("div",{className:"sb-floor-view-error",children:[t.jsx("div",{className:"title",children:"לא ניתן לטעון את מפת המסעדה."}),t.jsx("div",{className:"desc",children:c.message}),t.jsx("div",{className:"hint",children:"(בדוק את ה-Console לפרטי דיבוג)"})]})}):t.jsxs("div",{className:"floor-editor sb-floor-view",children:[t.jsxs("div",{className:"layout-tabs-bar",children:[t.jsx("div",{className:"layout-tabs",role:"tablist","aria-label":"Sections",children:L.map((n,m)=>t.jsx("button",{className:`layout-tab ${String(x)===String(n)?"active":""}`,onClick:()=>C(String(n)),type:"button",role:"tab","aria-selected":String(x)===String(n),children:$(String(n),m)},n||"all"))}),t.jsxs("div",{className:"layout-actions",children:[t.jsxs("div",{className:"sbv-legend",title:"Legend",children:[t.jsxs("span",{className:"sbv-leg",children:[t.jsx("span",{className:"sbv-dot empty"}),"פנוי"]}),t.jsxs("span",{className:"sbv-leg",children:[t.jsx("span",{className:"sbv-dot occupied"}),"תפוס"]}),t.jsxs("span",{className:"sbv-leg",children:[t.jsx("span",{className:"sbv-dot reserved"}),"שמור"]}),t.jsxs("span",{className:"sbv-leg",children:[t.jsx("span",{className:"sbv-dot dirty"}),"מלוכלך"]})]}),t.jsx("button",{type:"button",className:"btn-icon-small",title:"Refresh",onClick:async()=>{try{const n=await fetch(`/api/floor-layouts/${encodeURIComponent(_)}/active`,{cache:"no-store"});if(!n.ok)throw new Error(`${n.status} ${n.statusText}`);const m=await n.json();h(m),E(Date.now())}catch(n){console.error("[FloorView] manual refresh failed",n)}},children:"↻"}),t.jsx("div",{className:"sbv-refresh",children:M?`עודכן: ${new Date(M).toLocaleTimeString()}`:""})]})]}),t.jsx("div",{className:"editor-content sbv-content",children:t.jsx("div",{className:"editor-main sbv-main",children:z&&t.jsx(re,{layout:z,mode:"view",selectedTableId:q,onTableClick:n=>{if(S(n),k(n).status==="occupied"){const v=((o==null?void 0:o.tables)||[]).find(I=>String(I.id)===String(n)),u=v==null?void 0:v.tableNumber;if(u!=null){window.location.href=`/waiter/${encodeURIComponent(_)}/${encodeURIComponent(String(u))}`;return}}alert("שולחן לא תפוס כרגע. הושבה נעשית דרך מסך המארחת.")}})})})]})}function ae(){const s=document.getElementById("sb-floor-root"),c=(s==null?void 0:s.getAttribute("data-rid"))||"";if(c)return c;const l=new URLSearchParams(window.location.search);return l.get("rid")||l.get("restaurantId")||""}const P=document.getElementById("sb-floor-root");if(P){const s=ae();G.createRoot(P).render(t.jsx(J.StrictMode,{children:t.jsx(ne,{restaurantId:s})}))}
