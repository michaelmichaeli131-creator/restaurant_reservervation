import{r as m,j as e,c as G,R as J}from"./floor-index.js";const f="/floor_assets/",X=(t,o=1)=>{const d=Number(t);return Number.isFinite(d)?Math.max(.5,Math.min(1.6,d)):o},D=t=>{const o=Number(t);return Number.isFinite(o)?Math.round(o/45)*45:0},Q=t=>{if(!t||t.startsWith("#"))return"parquet_blue";const o=t;return o==="parquet_blue"||o==="parquet_brown"||o==="slate_dark"||o==="navy_carpet"||o==="teal_terrazzo"?o:"parquet_blue"};function ee(t){return{parquet_blue:{bg:`url(${f}floor_parquet_blue.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},parquet_brown:{bg:`url(${f}floor_parquet_brown.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},slate_dark:{bg:`url(${f}floor_slate_dark.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},navy_carpet:{bg:`url(${f}floor_navy_carpet.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"},teal_terrazzo:{bg:`url(${f}floor_teal_terrazzo.svg)`,size:"240px 240px",repeat:"repeat",pos:"center"}}[t]}function se(t,o){const d=String(t||"square").toLowerCase(),a=Number(o||0);return d==="round"?`${f}${a>=9?"round_table_10.svg":"round_table4.svg"}`:d==="booth"?`${f}${a>=6?"large_booth.svg":"booth4.svg"}`:d==="rect"?`${f}${a>=10?"square_table10.svg":a>=6?"square_table6.svg":a>=4?"square_table4.svg":"square_table2.svg"}`:`${f}${a>=10?"square_table10.svg":a>=6?"square_table6.svg":a>=4?"square_table4.svg":"square_table2.svg"}`}function te(t,o){const d=String(t||"").toLowerCase();return d==="door"?`${f}door.svg`:d==="wall"?`${f}wall.svg`:d==="divider"?`${f}divider.svg`:d==="chair"?`${f}chair.svg`:d==="bar"?`${f}bar.svg`:d==="plant"?`${f}plant.svg`:o?`${f}${o}.svg`:`${f}divider.svg`}function re({layout:t,mode:o,onTableClick:d,selectedTableId:a}){const x=m.useRef(null),w=m.useRef(null),[N,S]=m.useState(1),[I,R]=m.useState({x:0,y:0}),[z,$]=m.useState(!1),[y,T]=m.useState(!1),C=60,q=10,F=m.useMemo(()=>Q(t.floorColor),[t==null?void 0:t.id]),E=m.useMemo(()=>ee(F),[F]);m.useEffect(()=>{const s=l=>{l.code==="Space"&&$(!0)},n=l=>{l.code==="Space"&&($(!1),T(!1))};return window.addEventListener("keydown",s),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",s),window.removeEventListener("keyup",n)}},[]);const j=s=>Math.max(.4,Math.min(2.5,s)),b=()=>{if(!x.current)return;const s=x.current.getBoundingClientRect(),n=t.gridCols*C+q*2,l=t.gridRows*C+q*2,g=24,i=j(Math.min((s.width-g*2)/n,(s.height-g*2)/l,1.2));S(i);const _=Math.round((s.width-n*i)/2),u=Math.round((s.height-l*i)/2);R({x:_,y:u})};m.useEffect(()=>{requestAnimationFrame(b)},[t==null?void 0:t.id]),m.useEffect(()=>{const s=()=>{requestAnimationFrame(b)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[t==null?void 0:t.id]);const L=(s,n,l)=>{if(!x.current)return;const g=x.current.getBoundingClientRect(),i=n-g.left,_=l-g.top;R(u=>{const M=s/N;return{x:Math.round(i-(i-u.x)*M),y:Math.round(_-(_-u.y)*M)}}),S(s)},r=s=>{if(!(s.ctrlKey||s.metaKey))return;s.preventDefault();const n=j(N*(s.deltaY>0?.9:1.1));L(n,s.clientX,s.clientY)},c=s=>{const n=s.button===1,l=z&&s.button===0;if(!n&&!l)return;s.preventDefault(),T(!0);const g={x:s.clientX,y:s.clientY},i={...I},_=M=>{R({x:i.x+(M.clientX-g.x),y:i.y+(M.clientY-g.y)})},u=()=>{T(!1),window.removeEventListener("mousemove",_),window.removeEventListener("mouseup",u)};window.addEventListener("mousemove",_),window.addEventListener("mouseup",u)},v=s=>Math.max(1,Number(s)||1)*C,h=m.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(n=>{const l=n&&n.tableId?String(n.tableId):"";l&&s.set(l,{status:String(n.status||"empty"),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[t]),A=m.useMemo(()=>{const s=new Map;return(Array.isArray(t.tableStatuses)?t.tableStatuses:[]).forEach(n=>{const l=Number(n&&(n.tableNumber??0));!Number.isFinite(l)||l<=0||s.set(l,{status:String(n.status||"empty"),guestName:n.guestName??null,guestCount:n.guestCount??null,orderId:n.orderId??null})}),s},[t]),Y=s=>{const n=s.id?h.get(String(s.id)):void 0;if(n)return n;const l=Number(s.tableNumber??0);if(Number.isFinite(l)&&l>0){const g=A.get(l);if(g)return g}return{status:"empty"}};return e.jsxs("div",{className:`editor-canvas ${y?"is-panning":""}`,ref:x,onWheel:r,onMouseDown:c,style:{position:"relative"},children:[e.jsxs("div",{className:"fe-canvas-controls",children:[e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=x.current)==null?void 0:n.getBoundingClientRect();L(j(N*1.1),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom in",children:"＋"}),e.jsx("button",{className:"btn-icon-small",onClick:()=>{var n;const s=(n=x.current)==null?void 0:n.getBoundingClientRect();L(j(N*.9),((s==null?void 0:s.left)||0)+40,((s==null?void 0:s.top)||0)+40)},title:"Zoom out",children:"－"}),e.jsx("button",{className:"btn-icon-small",onClick:b,title:"Fit to screen",children:"⤢"}),e.jsxs("div",{className:"fe-zoom-readout",children:[Math.round(N*100),"%"]}),e.jsx("div",{className:"fe-hint",children:z?"Pan: drag":"Tip: hold Space to pan, Ctrl+wheel to zoom"})]}),e.jsx("div",{className:"fe-grid",ref:w,style:{direction:"ltr",gridTemplateColumns:`repeat(${t.gridCols}, ${C}px)`,gridTemplateRows:`repeat(${t.gridRows}, ${C}px)`,transform:`translate(${I.x}px, ${I.y}px) scale(${N})`,transformOrigin:"0 0","--cell":`${C}px`,"--floor-bg":E.bg,"--floor-bg-size":E.size,"--floor-bg-repeat":E.repeat,"--floor-bg-position":E.pos},children:Array.from({length:t.gridRows*t.gridCols}).map((s,n)=>{var P;const l=Math.floor(n/t.gridCols),g=n%t.gridCols,i=t.tables.find(p=>g>=p.gridX&&g<p.gridX+(p.spanX||1)&&l>=p.gridY&&l<p.gridY+(p.spanY||1)),u=(t.objects??[]).find(p=>g>=p.gridX&&g<p.gridX+(p.spanX||1)&&l>=p.gridY&&l<p.gridY+(p.spanY||1)),M=!!i&&i.gridX===g&&i.gridY===l,U=!!u&&u.gridX===g&&u.gridY===l,K=l*t.gridCols+g,H=(((P=t.gridMask)==null?void 0:P[K])??1)===1;return e.jsxs("div",{className:`fe-grid-cell ${H?"active":"inactive"}`,children:[U&&u&&e.jsxs("div",{className:`floor-object type-${u.type}`,style:{width:`${v(u.spanX)}px`,height:`${v(u.spanY)}px`,transform:`rotate(${D(u.rotationDeg??u.rotation??0)}deg)`,cursor:o==="view"?"default":"grab"},children:[e.jsx("img",{className:`fe-asset fe-asset--${(u.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`scale(${X(u.scale,1)})`},src:u.assetFile?`${f}${u.assetFile}`:te(u.type,u.label),alt:""}),u.label&&e.jsx("div",{className:"obj-label",children:u.label})]}),M&&i&&(()=>{const p=Y(i),k=String(p.status||"empty"),W=a&&String(a)===String(i.id),O=o==="view"&&k&&k!=="empty",Z=k==="occupied"?"תפוס":k==="reserved"?"שמור":k==="dirty"?"מלוכלך":"פנוי",V=p.guestCount!=null&&p.guestCount!==""?` · ${p.guestCount}`:"";return e.jsxs("div",{className:`table ${String(i.shape||"square")} ${o==="view"?`status-${k}`:""} ${W?"selected":""}`,onClick:()=>d==null?void 0:d(i.id),style:{position:"absolute",top:0,left:0,width:`${v(i.spanX)}px`,height:`${v(i.spanY)}px`,cursor:o==="view"?"pointer":"default"},children:[e.jsx("div",{className:"fe-table-visual","data-asset":i.assetFile||"",children:e.jsx("img",{className:`fe-asset fe-asset--${(i.assetFile||"").replace(/[^a-z0-9]+/gi,"_").toLowerCase()}`,style:{transform:`rotate(${D(i.rotationDeg??i.rotation??0)}deg) scale(${X(i.scale,1)})`},src:i.assetFile?`${f}${i.assetFile}`:se(i.shape,i.seats),alt:""})}),e.jsxs("div",{className:"fe-table-overlay",children:[e.jsx("div",{className:"table-label",children:i.name||(i.tableNumber!=null?`Table ${i.tableNumber}`:"Table")}),i.seats!=null&&e.jsxs("div",{className:"table-seats",children:[i.seats," seats"]})]}),O&&e.jsxs("div",{className:`sbv-status-pill is-${k}`,children:[e.jsx("span",{className:"sbv-dot"}),e.jsxs("span",{className:"sbv-status-text",children:[Z,V]})]})]})})()]},n)})})]})}function ne({restaurantId:t}){const[o,d]=m.useState({kind:"loading"}),[a,x]=m.useState(null),[w,N]=m.useState(null),[S,I]=m.useState(""),[R,z]=m.useState(0),$=m.useRef(null),y=m.useMemo(()=>String(t||"").trim(),[t]),T=m.useMemo(()=>{const r=new Set;((a==null?void 0:a.tables)||[]).forEach(v=>{const h=String(v.sectionId||"").trim();h&&r.add(h)});const c=Array.from(r);return[""].concat(c)},[a==null?void 0:a.id,a==null?void 0:a.tables]),C=(r,c)=>{if(!r)return"כל המסעדה";const v=String(r);return v.length<=22?v:`אזור ${c}`},q=r=>{const c=a==null?void 0:a.tableStatuses;if(!Array.isArray(c))return{status:"empty"};const v=c.find(h=>h&&String(h.tableId||"")===String(r));return v?{status:String(v.status||"empty"),guestName:v.guestName??null,guestCount:v.guestCount??null,orderId:v.orderId??null,reservationTime:v.reservationTime??null,itemsCount:v.itemsCount??null,subtotal:v.subtotal??null}:{status:"empty"}},F=r=>{const c=String(r||"").toLowerCase();return c==="occupied"||c==="busy"||c==="taken"?"occupied":c==="reserved"||c==="booked"?"reserved":c==="dirty"?"dirty":"empty"},E=r=>r==="occupied"?"תפוס":r==="reserved"?"שמור":r==="dirty"?"מלוכלך":"פנוי",j=m.useMemo(()=>w&&((a==null?void 0:a.tables)||[]).find(r=>String(r.id)===String(w))||null,[a==null?void 0:a.id,a==null?void 0:a.tables,w]),b=m.useMemo(()=>{if(!w)return null;const r=q(w),c=F(r.status);return{...r,status:c,label:E(c),dotClass:c}},[a,w]);m.useEffect(()=>{let r=!1;const c=async(v=!1)=>{if(!y){d({kind:"error",message:"Missing restaurant id (rid)"});return}v||d({kind:"loading"});try{const h=await fetch(`/api/floor-layouts/${encodeURIComponent(y)}/active`);if(!h.ok){const s=await h.json().catch(()=>({})),n=s&&(s.error||s.message)||`${h.status} ${h.statusText}`;throw new Error(n)}const A=await h.json();if(r)return;x(A),d({kind:"ready"}),z(Date.now()),!S||(A.tables||[]).some(s=>String(s.sectionId||"")===String(S))||I("")}catch(h){if(r)return;x(null),d({kind:"error",message:h instanceof Error?h.message:String(h)})}};return c(),$.current&&window.clearInterval($.current),$.current=window.setInterval(()=>{c(!0)},5e3),()=>{r=!0,$.current&&window.clearInterval($.current),$.current=null}},[y]);const L=m.useMemo(()=>{if(!a)return null;if(!S)return a;const r=String(S);return{...a,tables:(a.tables||[]).filter(c=>String(c.sectionId||"")===r)}},[a,S]);return o.kind==="loading"?e.jsx("div",{className:"sb-floor-view-shell",children:e.jsx("div",{className:"sb-floor-view-loading",children:"Loading floor map…"})}):o.kind==="error"?e.jsx("div",{className:"sb-floor-view-shell",children:e.jsxs("div",{className:"sb-floor-view-error",children:[e.jsx("div",{className:"title",children:"לא ניתן לטעון את מפת המסעדה."}),e.jsx("div",{className:"desc",children:o.message}),e.jsx("div",{className:"hint",children:"(בדוק את ה-Console לפרטי דיבוג)"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"floor-editor sb-floor-view",children:[e.jsxs("div",{className:"layout-tabs-bar",children:[e.jsx("div",{className:"layout-tabs",role:"tablist","aria-label":"Sections",children:T.map((r,c)=>e.jsx("button",{className:`layout-tab ${String(S)===String(r)?"active":""}`,onClick:()=>I(String(r)),type:"button",role:"tab","aria-selected":String(S)===String(r),children:C(String(r),c)},r||"all"))}),e.jsxs("div",{className:"layout-actions",children:[e.jsxs("div",{className:"sbv-legend",title:"Legend",children:[e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot empty"}),"פנוי"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot occupied"}),"תפוס"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot reserved"}),"שמור"]}),e.jsxs("span",{className:"sbv-leg",children:[e.jsx("span",{className:"sbv-dot dirty"}),"מלוכלך"]})]}),e.jsx("button",{type:"button",className:"btn-icon-small",title:"Refresh",onClick:async()=>{try{const r=await fetch(`/api/floor-layouts/${encodeURIComponent(y)}/active`,{cache:"no-store"});if(!r.ok)throw new Error(`${r.status} ${r.statusText}`);const c=await r.json();x(c),z(Date.now())}catch(r){console.error("[FloorView] manual refresh failed",r)}},children:"↻"}),e.jsx("div",{className:"sbv-refresh",children:R?`עודכן: ${new Date(R).toLocaleTimeString()}`:""})]})]}),e.jsx("div",{className:"editor-content sbv-content",children:e.jsx("div",{className:"editor-main sbv-main",children:L&&e.jsx(re,{layout:L,mode:"view",selectedTableId:w,onTableClick:r=>{N(r)}})})})]}),w&&j&&b&&e.jsx("div",{className:"sbv-modal-backdrop",role:"dialog","aria-modal":"true",onMouseDown:r=>{r.target===r.currentTarget&&N(null)},children:e.jsxs("div",{className:"sbv-modal",dir:"rtl",onMouseDown:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"sbv-modal-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"sbv-modal-title",children:"פרטי שולחן"}),e.jsxs("div",{className:"sbv-modal-sub",children:["שולחן ",j.tableNumber??j.name??j.id]})]}),e.jsx("button",{className:"sbv-close",type:"button","aria-label":"Close",onClick:()=>N(null),children:"✕"})]}),e.jsxs("div",{className:"sbv-modal-body",children:[e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-k",children:"שם המזמין"}),e.jsx("div",{className:"sbv-v",children:b.guestName||"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-k",children:"מספר סועדים"}),e.jsx("div",{className:"sbv-v",children:b.guestCount!=null&&b.guestCount!==""?String(b.guestCount):"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-k",children:"שעת ההזמנה"}),e.jsx("div",{className:"sbv-v",children:b.reservationTime||"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-k",children:"סטטוס שולחן"}),e.jsx("div",{className:"sbv-v",children:e.jsxs("span",{className:"sbv-status",children:[e.jsx("span",{className:`sbv-dot ${b.dotClass}`}),b.label]})})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-k",children:"מספר פריטים"}),e.jsx("div",{className:"sbv-v",children:b.itemsCount!=null&&b.itemsCount!==""?String(b.itemsCount):"—"})]}),e.jsxs("div",{className:"sbv-row",children:[e.jsx("div",{className:"sbv-k",children:"סכום ביניים"}),e.jsx("div",{className:"sbv-v",children:b.subtotal!=null&&b.subtotal!==""?String(b.subtotal):"—"})]})]}),e.jsxs("div",{className:"sbv-modal-actions",children:[e.jsx("button",{className:"sbv-btn",type:"button",onClick:()=>N(null),children:"סגור"}),(b.status==="occupied"||b.orderId)&&j.tableNumber!=null&&e.jsx("button",{className:"sbv-btn",type:"button",onClick:()=>{window.location.href=`/waiter/${encodeURIComponent(y)}/${encodeURIComponent(String(j.tableNumber))}`},children:"פתח הזמנה"})]})]})})]})}function ae(){const t=document.getElementById("sb-floor-root"),o=(t==null?void 0:t.getAttribute("data-rid"))||"";if(o)return o;const d=new URLSearchParams(window.location.search);return d.get("rid")||d.get("restaurantId")||""}const B=document.getElementById("sb-floor-root");if(B){const t=ae();G.createRoot(B).render(e.jsx(J.StrictMode,{children:e.jsx(ne,{restaurantId:t})}))}
